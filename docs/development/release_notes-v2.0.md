# リリースノート - v2.0.0 機能拡張版

## リリース情報

| 項目 | 内容 |
|------|------|
| バージョン | 2.0.0 |
| リリース日 | 2026-02-17 |
| リリース種別 | 機能拡張版（Feature Extension） |
| 対象イテレーション | イテレーション 5〜8 |
| 消化ストーリーポイント | 57SP |
| 累計ストーリーポイント | 119SP（v1.0: 62SP + v2.0: 57SP） |

## 概要

財務会計システムの第 2 リリースとして、仕訳承認ワークフロー、財務諸表（貸借対照表・損益計算書）、残高管理機能を提供します。v1.0 の仕訳入力・元帳照会を基盤に、承認申請から確定（元帳転記）までの業務フローを完成させ、試算表・財務諸表による経営状況の可視化を実現します。

## v1.0 からの主な変更点

- 仕訳承認ワークフロー（申請 → 承認 → 差し戻し → 確定）の完全実装
- ユーザー管理（編集・削除・一覧）による管理機能の完成
- 貸借対照表・損益計算書の表示と PDF/Excel エクスポート
- 残高試算表による貸借一致検証
- 月次残高照会と月次推移グラフ
- 補助元帳照会による補助科目レベルの詳細分析
- フロントエンド権限チェック（ロールに応じたボタン表示制御）
- PMD 関数型プログラミングルールの導入によるコード品質向上

## 実装済み機能

### ユーザー管理（イテレーション 5）

| ストーリーID | 機能 | SP |
|-------------|------|-----|
| US-AUTH-004 | ユーザー編集 | 3 |
| US-AUTH-005 | ユーザー削除 | 3 |
| US-AUTH-006 | ユーザー一覧表示 | 5 |

- ユーザー情報の編集（名前、メールアドレス、ロール変更）
- ユーザーの無効化・削除
- ユーザー一覧のページネーション表示
- ADMIN ロール限定の管理機能

### 仕訳承認ワークフロー（イテレーション 5〜6）

| ストーリーID | 機能 | SP |
|-------------|------|-----|
| US-JNL-007 | 仕訳承認申請 | 3 |
| US-JNL-008 | 仕訳承認 | 3 |
| US-JNL-009 | 仕訳差し戻し | 3 |
| US-JNL-010 | 仕訳確定 | 5 |

- **承認申請**: 下書き → 承認待ちへのステータス遷移
- **承認**: 承認待ち → 承認済みへのステータス遷移（MANAGER 以上）
- **差し戻し**: 承認待ち → 下書きへの差し戻し（理由入力付き）
- **確定**: 承認済み → 確定へのステータス遷移、元帳への自動転記
- 確定済み仕訳の編集・削除防止バリデーション
- フロントエンドでのロールに応じたボタン表示制御

**ステータス遷移図**:

```
[作成] → DRAFT → [承認申請] → PENDING → [承認] → APPROVED → [確定] → CONFIRMED
                               ↓
                        [差し戻し（理由付き）]
                               ↓
                             DRAFT
```

### 月次残高照会（イテレーション 6）

| ストーリーID | 機能 | SP |
|-------------|------|-----|
| US-LDG-004 | 月次残高照会 | 5 |

- 勘定科目別の月次残高推移表示
- 年度指定による絞り込み
- 月次推移グラフ表示（recharts ライブラリ）
- データソース: `monthly_account_balances` テーブル（事前集計済み）

### 残高試算表（イテレーション 6）

| ストーリーID | 機能 | SP |
|-------------|------|-----|
| US-LDG-005 | 残高試算表表示 | 6 |

- 全勘定科目の借方残高・貸方残高の一覧表示
- 貸借合計の一致検証（不一致時はアラート表示）
- 基準日指定による残高計算
- 勘定科目種別（資産・負債・純資産・収益・費用）ごとの小計表示

### 貸借対照表（イテレーション 7）

| ストーリーID | 機能 | SP |
|-------------|------|-----|
| US-FS-001 | 貸借対照表表示 | 8 |

- 勘定式レイアウト（CSS Grid 2 カラム: 資産 / 負債・純資産）
- 期間指定と前期比較（差額・増減率の自動計算）
- PDF エクスポート（OpenPDF）
- Excel エクスポート（Apache POI）
- API: `GET /api/balance-sheet`, `GET /api/balance-sheet/export`

### 補助元帳照会（イテレーション 7）

| ストーリーID | 機能 | SP |
|-------------|------|-----|
| US-LDG-002 | 補助元帳照会 | 5 |

- 勘定科目 + 補助科目コードによるフィルタリング
- 期間指定による絞り込み
- 仕訳明細行の借方・貸方表示
- ページネーション対応

### 損益計算書（イテレーション 8）

| ストーリーID | 機能 | SP |
|-------------|------|-----|
| US-FS-002 | 損益計算書表示 | 8 |

- 報告式レイアウト（収益の部 → 費用の部 → 当期純利益）
- 期間指定（dateFrom / dateTo）と前期比較
- 当期純利益の自動計算（収益合計 - 費用合計）
- PDF エクスポート（OpenPDF）
- Excel エクスポート（Apache POI）
- API: `GET /api/profit-and-loss`, `GET /api/profit-and-loss/export`

## API 一覧（v2.0 追加分）

| メソッド | エンドポイント | 説明 | 権限 |
|---------|---------------|------|------|
| PUT | /api/users/{id} | ユーザー編集 | ADMIN |
| DELETE | /api/users/{id} | ユーザー削除 | ADMIN |
| GET | /api/users | ユーザー一覧 | ADMIN |
| POST | /api/journal-entries/{id}/submit | 仕訳承認申請 | 全ロール |
| POST | /api/journal-entries/{id}/approve | 仕訳承認 | MANAGER 以上 |
| POST | /api/journal-entries/{id}/reject | 仕訳差し戻し | MANAGER 以上 |
| POST | /api/journal-entries/{id}/confirm | 仕訳確定 | MANAGER 以上 |
| GET | /api/monthly-balance | 月次残高照会 | 全ロール |
| GET | /api/trial-balance | 残高試算表表示 | 全ロール |
| GET | /api/balance-sheet | 貸借対照表表示 | 全ロール |
| GET | /api/balance-sheet/export | 貸借対照表エクスポート | 全ロール |
| GET | /api/subsidiary-ledger | 補助元帳照会 | 全ロール |
| GET | /api/profit-and-loss | 損益計算書表示 | 全ロール |
| GET | /api/profit-and-loss/export | 損益計算書エクスポート | 全ロール |

## データベースマイグレーション（v2.0 追加分）

| マイグレーション | 説明 |
|----------------|------|
| V11 | journal_entries に version カラム追加（楽観的ロック） |
| V12 | journal_entries に承認フィールド追加（submitted_by, approved_by 等） |
| V13 | journal_entries に差し戻しフィールド追加（rejected_by, rejection_reason 等） |
| V14 | journal_entries に確定フィールド追加（confirmed_by, confirmed_at 等） |

## 技術スタック

v1.0 からの変更・追加は以下の通り:

| 技術 | 用途 | 備考 |
|------|------|------|
| Apache POI | Excel エクスポート | v2.0 新規追加 |
| OpenPDF | PDF エクスポート | v2.0 新規追加 |
| recharts | グラフ表示 | 月次推移グラフ |

## アーキテクチャ改善

### PMD 関数型プログラミングルールの導入

v2.0 開発期間中に以下の PMD ルールを導入し、コードベース全体に適用:

- **AvoidThrowStatement**: Domain Value Object に `validated()` パターン、Command/Query に `Either` factory パターンを導入
- **AvoidCheckedExceptionDeclaration**: チェック例外の宣言を排除
- **AvoidMutableCollectionInstantiation**: `List.of()` / `Collections.unmodifiable` に統一
- **DataAccessMustReturnIO**: Repository 全メソッドの戻り値を `Try<T>` でラップ

### パターンの確立

- **財務諸表パターン**: Repository/Service/Controller + PDF/Excel エクスポートの再利用可能なパターンを確立
- **承認ワークフローパターン**: Command → UseCase → Service → Domain method → Repository の一貫したフロー
- **フロントエンド権限チェック**: ロールに応じた UI 要素の表示制御パターン

## 品質指標

| 指標 | 値 |
|------|-----|
| バックエンドテスト | 718 件全件パス |
| フロントエンドテスト | 585 件全件パス |
| 合計テスト数 | 1,303 件 |
| E2E テスト | 全件パス |
| テストカバレッジ（バックエンド） | 90%+ |
| テストカバレッジ（フロントエンド） | 90%+ |
| ビルド状態 | 成功 |

## 開発統計

| 指標 | 値 |
|------|-----|
| イテレーション数 | 4（IT-5〜IT-8） |
| 完了ストーリー数 | 12 |
| 消化ストーリーポイント | 57SP |
| コミット数 | 約 100 |
| 変更ファイル数 | 816 |
| 追加行数 | 110,906 |
| 削除行数 | 3,326 |

## 既知の制限事項

1. **段階利益計算の簡略化**: 損益計算書の利益計算は「収益合計 - 費用合計 = 当期純利益」のシンプル構造。売上総利益・営業利益・経常利益の段階計算は勘定科目コード体系の拡張で将来対応予定
2. **SonarQube Quality Gate 未確認**: テストカバレッジは高水準を維持しているが、SonarQube による最終 Quality Gate 確認が保留
3. **自動仕訳未対応**: 自動仕訳生成はリリース 3.0 で提供
4. **財務分析未対応**: 財務分析指標（ROE、流動比率等）はリリース 3.0 で提供
5. **監査ログ未対応**: 監査ログ照会はリリース 3.0 で提供
6. **データダウンロード未対応**: CSV/Excel 一括ダウンロードはリリース 3.0 で提供

## v1.0 からのアップグレード手順

### データベースマイグレーション

Flyway により自動適用されます。V11〜V14 のマイグレーションが自動実行され、journal_entries テーブルに承認ワークフロー関連のカラムが追加されます。

### 依存パッケージの更新

```bash
# バックエンド（自動）
cd apps/backend && ./gradlew build

# フロントエンド
cd apps/frontend && npm install
```

### 新規ルーティング

以下のページが追加されます:

| パス | 画面 |
|------|------|
| /users | ユーザー管理 |
| /monthly-balance | 月次残高照会 |
| /trial-balance | 残高試算表 |
| /subsidiary-ledger | 補助元帳照会 |
| /financial-statements/balance-sheet | 貸借対照表 |
| /financial-statements/profit-and-loss | 損益計算書 |

## 次期リリース予定

**リリース 3.0（完成版）** では以下を予定:

- 勘定科目構成管理（勘定科目構成登録・編集）
- 自動仕訳設定・自動仕訳生成
- 財務分析表示（ROE、流動比率等の経営指標）
- 監査ログ照会
- データダウンロード（CSV/Excel 一括出力）
