# リリースノート - v3.0.0 完成版

## リリース情報

| 項目 | 内容 |
|------|------|
| バージョン | 3.0.0 |
| リリース日 | 2026-02-24 |
| リリース種別 | 完成版（Final Release） |
| 対象イテレーション | イテレーション 9〜12 |
| 消化ストーリーポイント | 36SP（機能） + 10SP（品質保証） |
| 累計ストーリーポイント | 155SP（v1.0: 62SP + v2.0: 57SP + v3.0: 36SP） |

## 概要

財務会計システムの最終リリースとして、高度な分析機能とシステム管理機能を提供します。v2.0 の仕訳承認ワークフローと財務諸表を基盤に、勘定科目構成管理、自動仕訳生成、財務分析指標、監査ログ照会、データダウンロード機能を実装し、全 34 ユーザーストーリー（155SP）を完成させました。

## v2.0 からの主な変更点

- 勘定科目構成の階層管理（親子関係の登録・編集）
- 自動仕訳パターンの設定・管理と自動仕訳生成
- 財務分析指標（ROE、ROA、流動比率、自己資本比率等）の表示と業界平均比較
- 監査ログ照会（全操作の追跡・検索）
- データダウンロード（仕訳一覧・元帳の CSV/Excel エクスポート）
- SonarQube BLOCKER 脆弱性の修正（トークンハードコードの排除）
- E2E テスト安定性ガイドラインの標準化

## 実装済み機能

### 勘定科目構成管理（イテレーション 9）

| ストーリーID | 機能 | SP |
|-------------|------|-----|
| US-MST-005 | 勘定科目構成登録 | 5 |
| US-MST-006 | 勘定科目構成編集 | 3 |

- 勘定科目の親子関係（階層構造）の登録・編集・削除
- 表示順の設定
- 勘定科目コードによる紐付け
- ADMIN/MANAGER ロール限定の管理機能

### 自動仕訳パターン管理（イテレーション 9）

| ストーリーID | 機能 | SP |
|-------------|------|-----|
| US-MST-007 | 自動仕訳設定登録 | 3 |
| US-MST-008 | 自動仕訳設定編集 | 2 |

- パターンコード・パターン名による自動仕訳テンプレート管理
- 明細行（借方・貸方）の動的追加・削除
- 金額計算式（`amount`, `amount * 0.1` 等）の設定
- パターン一覧・検索・削除機能

### 自動仕訳生成（イテレーション 10）

| ストーリーID | 機能 | SP |
|-------------|------|-----|
| US-JNL-006 | 自動仕訳生成 | 5 |

- 登録済みパターンから仕訳を自動生成
- 金額変数の入力ダイアログ（パターンの計算式から変数を自動抽出）
- 実行ログ（SUCCESS/PARTIAL/FAILED）の記録
- ADMIN/MANAGER ロール限定

### 財務分析表示（イテレーション 10）

| ストーリーID | 機能 | SP |
|-------------|------|-----|
| US-FS-003 | 財務分析表示 | 5 |

- **収益性指標**: ROE（自己資本利益率）、ROA（総資産利益率）、売上高利益率
- **安全性指標**: 流動比率、自己資本比率、負債比率
- **効率性指標**: 総資産回転率
- 業界平均との比較チャート
- 前期比較（当期 vs 前期の指標推移）
- 計算根拠（計算式）の表示
- ADMIN/MANAGER ロール限定

### 監査ログ照会（イテレーション 11）

| ストーリーID | 機能 | SP |
|-------------|------|-----|
| US-SYS-001 | 監査ログ照会 | 8 |

- 全操作（ログイン、作成、更新、削除、承認等）の監査ログ記録
- ユーザー ID、アクション種別、日付範囲による検索・フィルタリング
- 監査ログテーブルの一覧表示（タイムスタンプ、ユーザー、アクション、詳細）
- ADMIN ロール限定のアクセス制御

### データダウンロード（イテレーション 11）

| ストーリーID | 機能 | SP |
|-------------|------|-----|
| US-SYS-002 | データダウンロード | 5 |

- 仕訳一覧の CSV/Excel ダウンロード
- 総勘定元帳の CSV/Excel ダウンロード
- フィルタ条件を適用した状態でのエクスポート
- ダウンロードボタンの UI 統合

## API 一覧（v3.0 追加分）

| メソッド | エンドポイント | 説明 | 権限 |
|---------|---------------|------|------|
| GET | /api/account-structures | 勘定科目構成一覧 | ADMIN, MANAGER |
| POST | /api/account-structures | 勘定科目構成登録 | ADMIN, MANAGER |
| PUT | /api/account-structures/{code} | 勘定科目構成編集 | ADMIN, MANAGER |
| DELETE | /api/account-structures/{code} | 勘定科目構成削除 | ADMIN, MANAGER |
| GET | /api/auto-journal-patterns | 自動仕訳パターン一覧 | ADMIN, MANAGER |
| POST | /api/auto-journal-patterns | 自動仕訳パターン登録 | ADMIN, MANAGER |
| GET | /api/auto-journal-patterns/{id} | 自動仕訳パターン詳細 | ADMIN, MANAGER |
| PUT | /api/auto-journal-patterns/{id} | 自動仕訳パターン編集 | ADMIN, MANAGER |
| DELETE | /api/auto-journal-patterns/{id} | 自動仕訳パターン削除 | ADMIN, MANAGER |
| POST | /api/journal-entries/generate | 自動仕訳生成 | ADMIN, MANAGER |
| GET | /api/financial-analysis | 財務分析表示 | ADMIN, MANAGER |
| GET | /api/audit-logs | 監査ログ照会 | ADMIN |
| GET | /api/journal-entries/download | 仕訳データダウンロード | 全ロール |
| GET | /api/general-ledger/download | 元帳データダウンロード | 全ロール |

## データベースマイグレーション（v3.0 追加分）

| マイグレーション | 説明 |
|----------------|------|
| V7 | account_structures テーブル作成（勘定科目構成の階層管理） |
| V8 | auto_journal_patterns / auto_journal_pattern_items テーブル作成 |
| V9 | auto_journal_logs テーブル作成（自動仕訳実行ログ） |
| V10 | trial_balance ビュー、daily/monthly_account_balances ビュー更新 |
| V11 | audit_logs テーブル作成（監査ログ） |

## 技術スタック

v2.0 からの変更・追加は以下の通り:

| 技術 | 用途 | 備考 |
|------|------|------|
| AmountFormulaEvaluator | 金額計算式の評価 | パターンマッチベース（ScriptEngine 不使用） |
| SonarCloud | 静的解析・品質管理 | Quality Gate 統合 |

## アーキテクチャ改善

### 自動仕訳パターンの設計

- **1:N リレーション**: AutoJournalPattern（親）→ AutoJournalPatternItem（明細）
- **保存戦略**: insert/update + deleteItems + insertItems（JournalEntry と同一パターン）
- **ID 型**: Long（BIGSERIAL）— Integer ではなく Long を採用

### 財務分析の集約設計

- 新規 Repository を作成せず、既存の BalanceSheetRepository + ProfitAndLossRepository を集約
- 7 つの財務指標を GetFinancialAnalysisService で一元計算
- 業界平均値はハードコード定数として管理

### 監査ログの横断的関心事

- Spring AOP による自動記録（Controller メソッドのアノテーションベース）
- 全操作（CRUD + ワークフロー操作）の統一的な記録

## 品質指標

| 指標 | 値 |
|------|-----|
| バックエンドテスト | 905 件全件パス |
| フロントエンドテスト | 777 件全件パス |
| E2E テスト | 370 件全件パス（31 スペック） |
| 合計テスト数 | 2,052 件 |
| テストカバレッジ（LINE） | 95.4% |
| テストカバレッジ（BRANCH） | 84.4% |
| 静的解析（Checkstyle） | パス |
| 静的解析（PMD） | パス |
| 静的解析（SpotBugs） | パス |
| ESLint | 0 エラー |
| Flaky テスト率 | 0% |

## 開発統計

| 指標 | 値 |
|------|-----|
| イテレーション数 | 4（IT-9〜IT-12） |
| 完了ストーリー数 | 8（+ 品質保証タスク 7 件） |
| 消化ストーリーポイント | 36SP（機能） + 10SP（品質保証） |
| 累計完了ストーリー | 34 |
| 累計ストーリーポイント | 155SP |
| プロジェクト全イテレーション | 12 |

## 全リリース累計

| リリース | 期間 | ストーリー数 | SP | 主要機能 |
|---------|------|------------|-----|---------|
| v1.0 MVP | IT-1〜4 | 15 | 62 | 認証、勘定科目 CRUD、仕訳 CRUD、元帳照会 |
| v2.0 機能拡張版 | IT-5〜8 | 12 | 57 | 承認ワークフロー、財務諸表、残高管理 |
| v3.0 完成版 | IT-9〜12 | 8+7 | 36+10 | 自動仕訳、財務分析、監査ログ、品質保証 |
| **合計** | **24 週間** | **34+7** | **155+10** | |

## 既知の制限事項

1. **段階利益計算の簡略化**: 損益計算書は「収益合計 - 費用合計 = 当期純利益」のシンプル構造。売上総利益・営業利益・経常利益の段階計算は未対応
2. **業界平均値のハードコード**: 財務分析の業界平均値は定数として実装。外部データソースからの動的取得は未対応
3. **SonarCloud セキュリティホットスポット**: テストコードのハードコードパスワード（63 件）が未レビュー状態。本番コードのセキュリティ問題はなし
4. **SonarCloud 新規コード重複率**: 5.7%（閾値 3%）。全体重複率は 4.3% で許容範囲内
5. **自動仕訳の計算式**: パターンマッチベースの評価（`amount`, `amount * N` のみ対応）。複雑な数式には未対応

## v2.0 からのアップグレード手順

### データベースマイグレーション

Flyway により自動適用されます。V7〜V11 のマイグレーションが自動実行されます。

### 依存パッケージの更新

```bash
# バックエンド（自動）
cd apps/backend && ./gradlew build

# フロントエンド
cd apps/frontend && npm install
```

### 新規ルーティング

以下のページが追加されます:

| パス | 画面 |
|------|------|
| /master/account-structures | 勘定科目構成管理 |
| /master/account-structures/new | 勘定科目構成登録 |
| /master/account-structures/:code/edit | 勘定科目構成編集 |
| /master/auto-journal-patterns | 自動仕訳パターン管理 |
| /master/auto-journal-patterns/new | 自動仕訳パターン登録 |
| /master/auto-journal-patterns/:id/edit | 自動仕訳パターン編集 |
| /financial-statements/analysis | 財務分析 |
| /system/audit-logs | 監査ログ照会 |

### 環境変数

以下の環境変数が必要です:

| 変数名 | 用途 | 備考 |
|--------|------|------|
| SONAR_TOKEN | SonarQube 認証トークン | ローカル SonarQube 使用時 |

## プロジェクト完了サマリー

本リリースをもって、財務会計システムの全 34 ユーザーストーリー（155SP）の実装が完了しました。12 イテレーション・24 週間の開発を通じて、認証・勘定科目管理・仕訳管理・元帳照会・財務諸表・財務分析・監査ログの全機能を TDD（テスト駆動開発）で実装し、2,052 件のテスト（バックエンド 905 件 + フロントエンド 777 件 + E2E 370 件）で品質を保証しています。
