# バックエンドデモ環境構築手順書

## 概要

本ドキュメントは、財務会計システムのバックエンドデモ環境について説明します。
デモ環境は H2 インメモリデータベースを使用し、外部データベースなしで動作する自己完結型の構成です。

## デモ環境の特徴

| 項目 | 内容 |
|------|------|
| データベース | H2 インメモリ |
| データ永続性 | なし（再起動でリセット） |
| 初期データ | 起動時に自動投入（勘定科目マスタ 31 件） |
| 用途 | デモ、プレゼンテーション、機能確認 |
| 外部依存 | なし（PostgreSQL 不要） |

## 技術スタック

- **Java**: 25
- **Spring Boot**: 4.0.0
- **データベース**: H2 Database（インメモリモード）
- **ORM**: MyBatis
- **ビルドツール**: Gradle

## ローカル実行

### 前提条件

- JDK 25 以上
- Gradle 9.x（または Gradle Wrapper 使用）

### 起動方法

#### コマンドラインから起動

```bash
cd apps/backend
./gradlew bootRun --args='--spring.profiles.active=demo'
```

#### IntelliJ IDEA から起動

1. `Application.java` を右クリック
2. `Run 'Application'` または `Debug 'Application'` を選択
3. 実行構成で VM オプションを追加:
   ```
   -Dspring.profiles.active=demo
   ```

または環境変数で設定:
```
SPRING_PROFILES_ACTIVE=demo
```

### 動作確認

起動後、以下のエンドポイントで動作確認できます。

#### ヘルスチェック

```bash
curl http://localhost:8080/api/health
```

#### Actuator エンドポイント

```bash
# ヘルスチェック（データベース接続状態含む）
curl http://localhost:8080/actuator/health

# アプリケーション情報
curl http://localhost:8080/actuator/info

# 環境変数
curl http://localhost:8080/actuator/env
```

#### H2 コンソール

ブラウザで以下にアクセス:
```
http://localhost:8080/h2-console
```

**接続情報:**

| 項目 | 値 |
|------|-----|
| JDBC URL | `jdbc:h2:mem:accounting_demo` |
| User Name | `sa` |
| Password | (空) |

## 設定ファイル

### application-demo.yml

デモ環境専用の設定ファイルです。

```yaml
spring:
  application:
    name: accounting-backend

  # Flyway 自動構成を除外（H2 では不要）
  autoconfigure:
    exclude:
      - org.springframework.boot.autoconfigure.flyway.FlywayAutoConfiguration

  # H2 インメモリデータベース
  datasource:
    url: jdbc:h2:mem:accounting_demo;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE;MODE=PostgreSQL
    driver-class-name: org.h2.Driver
    username: sa
    password:

  # H2 コンソール
  h2:
    console:
      enabled: true
      path: /h2-console
      settings:
        web-allow-others: true

  # SQL 初期化
  sql:
    init:
      mode: always
      schema-locations: classpath:db/schema.sql
      data-locations: classpath:db/demo-data.sql

server:
  port: ${PORT:8080}
```

### 初期データ

#### スキーマ（db/schema.sql）

```sql
CREATE TABLE IF NOT EXISTS accounts (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    code VARCHAR(10) NOT NULL UNIQUE,
    name VARCHAR(100) NOT NULL,
    account_type VARCHAR(20) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### デモデータ（db/demo-data.sql）

起動時に以下の勘定科目マスタが自動投入されます:

| 区分 | 科目数 | 例 |
|------|--------|-----|
| 資産 | 10 件 | 現金、当座預金、売掛金、商品 等 |
| 負債 | 5 件 | 買掛金、未払金、借入金 等 |
| 純資産 | 2 件 | 資本金、利益剰余金 |
| 収益 | 3 件 | 売上高、受取利息、雑収入 |
| 費用 | 11 件 | 仕入高、給与手当、旅費交通費 等 |

## Heroku デプロイ

### 前提条件

- Heroku CLI インストール済み
- Heroku アカウント作成済み
- Docker Desktop インストール済み

### デプロイ手順

#### 1. Heroku アプリ作成

```bash
heroku create accounting-demo --stack container
```

#### 2. 環境変数設定

```bash
heroku config:set SPRING_PROFILES_ACTIVE=demo
heroku config:set JWT_SECRET=$(openssl rand -base64 32)
```

**注意:** `JWT_SECRET` は必須です。設定しないと起動時にエラーになります。

#### 3. Dockerfile 確認

`apps/backend/Dockerfile` に以下の内容が配置されています:

```dockerfile
# ビルドステージ
FROM gradle:8-jdk21 AS builder
WORKDIR /app
COPY apps/backend/ ./
RUN gradle build -x test --no-daemon

# 実行ステージ
# OpenJDK 公式は Docker Hub での更新を停止しているため eclipse-temurin を使用
FROM eclipse-temurin:21-jre-jammy
WORKDIR /app
COPY --from=builder /app/build/libs/*.jar app.jar

# Heroku では EXPOSE は無視されるが、ドキュメントとして残す
EXPOSE 8080

# $PORT 変数をシェル形式で渡す
CMD java -Dserver.port=$PORT -jar app.jar
```

**ビルドコンテキストについて:**

この Dockerfile はプロジェクトルートをビルドコンテキストとして使用します。
`COPY apps/backend/ ./` でバックエンドのソースコードをコピーしています。

**Docker イメージのバージョン番号について:**

Docker Hub のタグ名に含まれる数字は複数の意味を持つ場合があります:
- `openjdk:25` → Java 25
- `nanoserver-ltsc2025` → Windows Server 2025（Java バージョンではない）

混同しやすいため、イメージ選択時は注意してください。

#### 4. heroku.yml 確認

プロジェクトルートの `heroku.yml` で Dockerfile のパスを指定しています:

```yaml
build:
  docker:
    web: ./apps/backend/Dockerfile

run:
  web: java -Dserver.port=$PORT -Dspring.profiles.active=demo -jar app.jar
```

`heroku.yml` を使用する場合は、Git push でデプロイします:

```bash
heroku stack:set container
git add heroku.yml
git commit -m "Add heroku.yml"
git push heroku main
```

#### 5. Heroku Container Registry にログイン

**重要:** デプロイ前に必ず認証が必要です。

```bash
heroku container:login
```

`Login Succeeded` と表示されれば成功です。

#### 6. デプロイ実行

**方法 A: heroku container:push を使用（Dockerfile が標準名の場合）**

```bash
heroku container:push web -a アプリ名
heroku container:release web -a アプリ名
```

**方法 B: Docker コマンドで直接ビルド・プッシュ**

`heroku container:push` は `--dockerfile` オプションをサポートしていないため、
`apps/backend/Dockerfile` を使用する場合は Docker コマンドで直接ビルドします:

```bash
# プロジェクトルートで実行（ビルドコンテキストがルートになる）
docker build -t registry.heroku.com/アプリ名/web -f apps/backend/Dockerfile .

# プッシュ
docker push registry.heroku.com/アプリ名/web

# リリース
heroku container:release web -a アプリ名
```

#### 7. 動作確認

```bash
# ログ確認
heroku logs --tail -a アプリ名

# アプリを開く
heroku open -a アプリ名

# ヘルスチェック
curl https://アプリ名.herokuapp.com/api/health
```

### データリセット

Dyno を再起動するとデータがリセットされ、初期データが再投入されます。

```bash
heroku restart -a アプリ名
```

## プロファイル比較

| 項目 | dev（開発） | demo（デモ） |
|------|-------------|--------------|
| データベース | PostgreSQL | H2 インメモリ |
| マイグレーション | Flyway | SQL init |
| データ永続性 | あり | なし |
| 外部依存 | Docker 必要 | 不要 |
| H2 コンソール | 無効 | 有効 |
| 用途 | 開発・テスト | デモ・検証 |

## トラブルシューティング

### H2 コンソールにアクセスできない

1. `spring.h2.console.enabled=true` が設定されているか確認
2. `spring-boot-h2console` 依存関係が含まれているか確認
3. プロファイルが `demo` になっているか確認

### データが初期化されない

1. `spring.sql.init.mode=always` が設定されているか確認
2. `db/schema.sql` と `db/demo-data.sql` が存在するか確認
3. SQL 構文が H2 互換か確認

### Actuator エンドポイントにアクセスできない

1. `spring-boot-starter-actuator` 依存関係が含まれているか確認
2. `management.endpoints.web.exposure.include` が設定されているか確認

### Heroku: no basic auth credentials エラー

Docker が Heroku Container Registry にログインできていません。

```bash
# Heroku CLI 経由で認証
heroku container:login
```

それでも解決しない場合は、手動で認証:

```bash
# API キーを使用して手動ログイン
docker login registry.heroku.com -u _ -p $(heroku auth:token)
```

### Heroku: WeakKeyException (JWT_SECRET)

```
io.jsonwebtoken.security.WeakKeyException: The specified key byte array is 0 bits
```

`JWT_SECRET` 環境変数が設定されていないか、空です。

```bash
# JWT_SECRET を設定（最低 32 文字必要）
heroku config:set JWT_SECRET=$(openssl rand -base64 32) -a アプリ名

# 設定確認
heroku config -a アプリ名
```

### Heroku: サブディレクトリの Dockerfile を使用したい

`heroku container:push` は `--dockerfile` オプションをサポートしていません。

**解決策:**
1. `heroku.yml` でパスを指定して Git push でデプロイ（推奨）
2. `docker build -f apps/backend/Dockerfile .` で直接ビルドしてプッシュ

詳細は「デプロイ実行」セクションを参照してください。

### Heroku: App crashed (H10 エラー)

起動に失敗しています。ログを確認:

```bash
heroku logs --tail -a アプリ名
```

よくある原因:
1. `JWT_SECRET` が未設定
2. `SPRING_PROFILES_ACTIVE=demo` が未設定
3. Dockerfile の CMD が正しくない（`$PORT` を使用しているか確認）

## 制約事項

| 制約 | 説明 |
|------|------|
| データ非永続 | アプリ再起動でデータはリセット |
| シングルインスタンス | 複数インスタンスでのデータ共有不可 |
| 本番利用不可 | あくまでデモ・検証用途 |
| 大量データ非対応 | インメモリのため大量データには不向き |

## 関連ドキュメント

- [バックエンド構築手順書](backend_setup.md) - 開発環境のセットアップ
- [インフラストラクチャ設計](../design/architecture_infrastructure.md) - インフラ全体設計
- [開発コンテナ構築手順書](dev_container.md) - Docker 環境のセットアップ
