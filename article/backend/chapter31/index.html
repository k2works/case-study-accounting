
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="財務会計システムの設計・開発ドキュメント">
      
      
        <meta name="author" content="Project Team">
      
      
      
        <link rel="prev" href="../chapter30/">
      
      
        <link rel="next" href="../chapter32/">
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>chapter31 - 財務会計システム ケーススタディ</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#31" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="財務会計システム ケーススタディ" class="md-header__button md-logo" aria-label="財務会計システム ケーススタディ" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            財務会計システム ケーススタディ
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              chapter31
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/k2works/case-study-accounting" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    case-study-accounting
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../requirements/requirements_definition/" class="md-tabs__link">
          
  
  
  要件定義

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../design/architecture_backend/" class="md-tabs__link">
          
  
  
  設計

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../development/release_plan/" class="md-tabs__link">
          
  
  
  開発

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../operation/dev_container/" class="md-tabs__link">
          
  
  
  運用

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../reference/%E9%96%8B%E7%99%BA%E3%82%AC%E3%82%A4%E3%83%89/" class="md-tabs__link">
          
  
  
  リファレンス

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../template/ADR/" class="md-tabs__link">
          
  
  
  テンプレート

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../" class="md-tabs__link">
          
  
  
  実践ガイド

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="財務会計システム ケーススタディ" class="md-nav__button md-logo" aria-label="財務会計システム ケーススタディ" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    財務会計システム ケーススタディ
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/k2works/case-study-accounting" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    case-study-accounting
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    要件定義
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    要件定義
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../requirements/requirements_definition/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    要件定義書
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../requirements/business_usecase/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ビジネスユースケース
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../requirements/system_usecase/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    システムユースケース
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../requirements/user_story/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ユーザーストーリー
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    設計
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    設計
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    アーキテクチャ
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    アーキテクチャ
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/architecture_backend/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    バックエンド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/architecture_frontend/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    フロントエンド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/architecture_infrastructure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    インフラストラクチャ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    モデル設計
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    モデル設計
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/data-model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    データモデル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/domain-model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ドメインモデル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/ui-design/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    UI 設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/test_strategy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    テスト戦略
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/non_functional/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    非機能要件
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/operation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    運用要件
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/tech_stack/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    技術スタック選定
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    開発
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    開発
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../development/release_plan/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    リリース計画
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    イテレーション計画
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    イテレーション計画
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../development/iteration_plan-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    イテレーション1
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    運用
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    運用
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/dev_container/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    開発コンテナ構築手順書
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/backend_setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    バックエンド構築手順書
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/backend_demo_env/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    バックエンドデモ環境
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/frontend_setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    フロントエンド構築手順書
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/frontend_demo_env/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    フロントエンドデモ環境
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/deploy_demo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    デモ環境デプロイ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/third_party_service/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    外部サービス連携
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/sonarqube_setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SonarQube セットアップガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    リファレンス
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    リファレンス
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E9%96%8B%E7%99%BA%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    開発ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%82%88%E3%81%84%E3%82%BD%E3%83%95%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A2%E3%81%A8%E3%81%AF/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    よいソフトウェアとは
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%82%B3%E3%83%BC%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0%E3%81%A8%E3%83%86%E3%82%B9%E3%83%88%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    コーディングとテストガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3%E8%A8%AD%E8%A8%88%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    アーキテクチャ設計ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%83%87%E3%83%BC%E3%82%BF%E3%83%A2%E3%83%87%E3%83%AB%E8%A8%AD%E8%A8%88%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    データモデル設計ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%83%A2%E3%83%87%E3%83%AB%E8%A8%AD%E8%A8%88%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ドメインモデル設計ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/UI%E8%A8%AD%E8%A8%88%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    UI設計ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%83%86%E3%82%B9%E3%83%88%E6%88%A6%E7%95%A5%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    テスト戦略ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E9%9D%9E%E6%A9%9F%E8%83%BD%E8%A6%81%E4%BB%B6%E5%AE%9A%E7%BE%A9%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    非機能要件定義ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E9%81%8B%E7%94%A8%E8%A6%81%E4%BB%B6%E5%AE%9A%E7%BE%A9%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    運用要件定義ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E8%A6%81%E4%BB%B6%E5%AE%9A%E7%BE%A9%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    要件定義ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%83%A6%E3%83%BC%E3%82%B9%E3%82%B1%E3%83%BC%E3%82%B9%E4%BD%9C%E6%88%90%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ユースケース作成ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%83%AA%E3%83%AA%E3%83%BC%E3%82%B9%E3%83%BB%E3%82%A4%E3%83%86%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E8%A8%88%E7%94%BB%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    リリース・イテレーション計画ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%A0%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    エクストリームプログラミング
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%82%A4%E3%83%B3%E3%83%95%E3%83%A9%E8%A8%AD%E8%A8%88%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    インフラ設計ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/Java%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Javaアプリケーション環境構築ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/TypeScript%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    TypeScriptアプリケーション環境構築ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    テンプレート
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    テンプレート
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../template/ADR/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../template/%E3%82%A4%E3%83%86%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E5%AE%8C%E4%BA%86%E5%A0%B1%E5%91%8A%E6%9B%B8/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    イテレーション完了報告書
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../template/%E3%82%A4%E3%83%B3%E3%82%BB%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%87%E3%83%83%E3%82%AD/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    インセプションデッキ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../template/%E3%81%BE%E3%81%9A%E3%81%93%E3%82%8C%E3%82%92%E8%AA%AD%E3%82%82%E3%81%86%E3%83%AA%E3%82%B9%E3%83%88/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    まずこれを読もうリスト
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../template/%E5%AE%8C%E5%85%A8%E5%BD%A2%E5%BC%8F%E3%81%AE%E3%83%A6%E3%83%BC%E3%82%B9%E3%82%B1%E3%83%BC%E3%82%B9/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    完全形式のユースケース
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../template/%E8%A6%81%E4%BB%B6%E5%AE%9A%E7%BE%A9/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    要件定義
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../template/%E8%A8%AD%E8%A8%88/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    実践ガイド
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    実践ガイド
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2" checked>
        
          
          <label class="md-nav__link" for="__nav_8_2" id="__nav_8_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    バックエンド編（Java版）
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    バックエンド編（Java版）
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter00/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    はじめに
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter01/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第1章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter02/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第2章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter03/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第3章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter04/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第4章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter05/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第5章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter06/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第6章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter07/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第7章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter08/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第8章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter09/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第9章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter10/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第10章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter11/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第11章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter12/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第12章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter13/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第13章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter14/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第14章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter15/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第15章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter16/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第16章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter17/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第17章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter18/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第18章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter19/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第19章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter20/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第20章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter21/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第21章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter22/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第22章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter23/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第23章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter24/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第24章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter25/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第25章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter26/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第26章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter27/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第27章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter28/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第28章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter29/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第29章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter30/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第30章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    第31章
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    第31章
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#311" class="md-nav__link">
    <span class="md-ellipsis">
      
        31.1 イベントソーシングの基礎
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="31.1 イベントソーシングの基礎">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        イベントソーシングとは
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      
        イベントソーシングの3つの原則
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#crud" class="md-nav__link">
    <span class="md-ellipsis">
      
        CRUD との違い
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        イベントソーシングの利点
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        イベントソーシングの課題
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        適用ケース
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#312" class="md-nav__link">
    <span class="md-ellipsis">
      
        31.2 イベントストアの設計
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="31.2 イベントストアの設計">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        イベントストアの要件
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#postgresql" class="md-nav__link">
    <span class="md-ellipsis">
      
        テーブル設計（PostgreSQL）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      
        スキーマの詳細説明
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#correlation_id-causation_id" class="md-nav__link">
    <span class="md-ellipsis">
      
        correlation_id と causation_id
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      
        イベントのバージョニング
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#313" class="md-nav__link">
    <span class="md-ellipsis">
      
        31.3 仕訳のイベントソーシング実装
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="31.3 仕訳のイベントソーシング実装">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      
        ドメインイベントの定義
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggregate" class="md-nav__link">
    <span class="md-ellipsis">
      
        Aggregate パターンの実装
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      
        イベントストアリポジトリ
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#314-cqrs" class="md-nav__link">
    <span class="md-ellipsis">
      
        31.4 CQRS パターン
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="31.4 CQRS パターン">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cqrs" class="md-nav__link">
    <span class="md-ellipsis">
      
        CQRS とは
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#command-side" class="md-nav__link">
    <span class="md-ellipsis">
      
        Command Side の実装
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#query-side" class="md-nav__link">
    <span class="md-ellipsis">
      
        Query Side（読み取りモデル）の実装
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      
        読み取りモデルのテーブル
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#query-service" class="md-nav__link">
    <span class="md-ellipsis">
      
        Query Service
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#315" class="md-nav__link">
    <span class="md-ellipsis">
      
        31.5 スナップショットと最適化
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="31.5 スナップショットと最適化">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      
        スナップショットの必要性
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      
        スナップショットテーブル
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      
        スナップショットの実装
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggregate_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        スナップショット対応の Aggregate 再生
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#316-tdd" class="md-nav__link">
    <span class="md-ellipsis">
      
        31.6 TDD による実装例
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="31.6 TDD による実装例">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      
        イベントソーシングのテスト
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#317" class="md-nav__link">
    <span class="md-ellipsis">
      
        31.7 まとめ
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="31.7 まとめ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      
        学んだこと
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      
        財務会計システムへの適用
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      
        導入の判断基準
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter32/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第32章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_3" >
        
          
          <label class="md-nav__link" for="__nav_8_3" id="__nav_8_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    フロントエンド編（React版）
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    フロントエンド編（React版）
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter00/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    はじめに
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter01/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第1章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter02/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第2章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter03/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第3章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter04/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第4章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter05/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第5章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter06/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第6章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter07/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第7章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter08/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第8章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter09/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第9章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter10/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第10章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter11/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第11章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter12/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第12章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter13/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第13章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter14/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第14章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter15/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第15章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter16/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第16章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter17/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第17章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter18/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第18章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter19/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第19章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter20/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第20章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter21/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第21章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter22/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第22章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter23/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第23章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter24/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第24章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="31">第31章: イベントソーシング<a class="headerlink" href="#31" title="Permanent link">&para;</a></h1>
<h2 id="311">31.1 イベントソーシングの基礎<a class="headerlink" href="#311" title="Permanent link">&para;</a></h2>
<h3 id="_1">イベントソーシングとは<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<p>イベントソーシングは、アプリケーションの状態をイベントの連続として記録する設計パターンです。従来の CRUD アプローチでは「現在の状態」のみを保存しますが、イベントソーシングでは「状態に至った経緯（イベント）」を保存します。</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjQ2M3B4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NzYzcHg7aGVpZ2h0OjQ2M3B4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDc2MyA0NjMiIHdpZHRoPSI3NjNweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PHRpdGxlPkNSVUQgdnMgJiMxMjQ1MjsmIzEyNTA1OyYjMTI1MzE7JiMxMjQ4ODsmIzEyNDc3OyYjMTI1NDA7JiMxMjQ3MTsmIzEyNTMxOyYjMTI0NjQ7PC90aXRsZT48ZGVmcy8+PGc+PGcgY2xhc3M9InRpdGxlIiBkYXRhLXNvdXJjZS1saW5lPSIxIj48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTk3LjI1MDQiIHg9IjI3NS45MzQ4IiB5PSIyMi45OTUxIj5DUlVEIHZzICYjMTI0NTI7JiMxMjUwNTsmIzEyNTMxOyYjMTI0ODg7JiMxMjQ3NzsmIzEyNTQwOyYjMTI0NzE7JiMxMjUzMTsmIzEyNDY0OzwvdGV4dD48L2c+PCEtLWNsdXN0ZXIgQ1JVRCA/Pz8/Py0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0iQ1JVRCAuLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iNCIgZGF0YS11aWQ9ImVudDAwMDIiIGlkPSJjbHVzdGVyX0NSVUQgLi4uLi4iPjxwYXRoIGQ9Ik00NS4wNiwyNjkuMjk2OSBMMTY0Ljk3NzcsMjY5LjI5NjkgQTMuNzUsMy43NSAwIDAgMSAxNjcuNDc3NywyNzEuNzk2OSBMMTc0LjQ3NzcsMjkxLjU5MzggTDIxMC4wNiwyOTEuNTkzOCBBMi41LDIuNSAwIDAgMSAyMTIuNTYsMjk0LjA5MzggTDIxMi41Niw0NTMuNzk2OSBBMi41LDIuNSAwIDAgMSAyMTAuMDYsNDU2LjI5NjkgTDQ1LjA2LDQ1Ni4yOTY5IEEyLjUsMi41IDAgMCAxIDQyLjU2LDQ1My43OTY5IEw0Mi41NiwyNzEuNzk2OSBBMi41LDIuNSAwIDAgMSA0NS4wNiwyNjkuMjk2OSIgZmlsbD0ibm9uZSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxLjU7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxLjU7IiB4MT0iNDIuNTYiIHgyPSIxNzQuNDc3NyIgeTE9IjI5MS41OTM4IiB5Mj0iMjkxLjU5MzgiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTE4LjkxNzciIHg9IjQ2LjU2IiB5PSIyODQuMjkyIj5DUlVEICYjMTI0NTA7JiMxMjUwMzsmIzEyNTI1OyYjMTI1NDA7JiMxMjQ4MTs8L3RleHQ+PC9nPjwhLS1jbHVzdGVyID8/Pz8/Pz8/Py0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0iLi4uLi4uLi4uIiBkYXRhLXNvdXJjZS1saW5lPSIxMyIgZGF0YS11aWQ9ImVudDAwMDciIGlkPSJjbHVzdGVyXy4uLi4uLi4uLiI+PHBhdGggZD0iTTguNSw0My4yOTY5IEwxMzUuNDk5NSw0My4yOTY5IEEzLjc1LDMuNzUgMCAwIDEgMTM3Ljk5OTUsNDUuNzk2OSBMMTQ0Ljk5OTUsNjUuNTkzOCBMNzUzLjYyLDY1LjU5MzggQTIuNSwyLjUgMCAwIDEgNzU2LjEyLDY4LjA5MzggTDc1Ni4xMiwyNDIuNzk2OSBBMi41LDIuNSAwIDAgMSA3NTMuNjIsMjQ1LjI5NjkgTDguNSwyNDUuMjk2OSBBMi41LDIuNSAwIDAgMSA2LDI0Mi43OTY5IEw2LDQ1Ljc5NjkgQTIuNSwyLjUgMCAwIDEgOC41LDQzLjI5NjkiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MS41OyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MS41OyIgeDE9IjYiIHgyPSIxNDQuOTk5NSIgeTE9IjY1LjU5MzgiIHkyPSI2NS41OTM4Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyNS45OTk1IiB4PSIxMCIgeT0iNTguMjkyIj4mIzEyNDUyOyYjMTI1MDU7JiMxMjUzMTsmIzEyNDg4OyYjMTI0Nzc7JiMxMjU0MDsmIzEyNDcxOyYjMTI1MzE7JiMxMjQ2NDs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgY3J1ZF9kYi0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJjcnVkX2RiIiBkYXRhLXNvdXJjZS1saW5lPSI1IiBkYXRhLXVpZD0iZW50MDAwMyIgaWQ9ImVudGl0eV9jcnVkX2RiIj48cGF0aCBkPSJNODYuMDMsNDA0LjY0NjkgQzg2LjAzLDM5NC42NDY5IDEyNy41NjQyLDM5NC42NDY5IDEyNy41NjQyLDM5NC42NDY5IEMxMjcuNTY0MiwzOTQuNjQ2OSAxNjkuMDk4NCwzOTQuNjQ2OSAxNjkuMDk4NCw0MDQuNjQ2OSBMMTY5LjA5ODQsNDI5Ljk0MzggQzE2OS4wOTg0LDQzOS45NDM4IDEyNy41NjQyLDQzOS45NDM4IDEyNy41NjQyLDQzOS45NDM4IEMxMjcuNTY0Miw0MzkuOTQzOCA4Ni4wMyw0MzkuOTQzOCA4Ni4wMyw0MjkuOTQzOCBMODYuMDMsNDA0LjY0NjkiIGZpbGw9IiNGMUYxRjEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik04Ni4wMyw0MDQuNjQ2OSBDODYuMDMsNDE0LjY0NjkgMTI3LjU2NDIsNDE0LjY0NjkgMTI3LjU2NDIsNDE0LjY0NjkgQzEyNy41NjQyLDQxNC42NDY5IDE2OS4wOTg0LDQxNC42NDY5IDE2OS4wOTg0LDQwNC42NDY5IiBmaWxsPSJub25lIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2My4wNjg0IiB4PSI5Ni4wMyIgeT0iNDMxLjY0MiI+YWNjb3VudHM8L3RleHQ+PC9nPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJHTU40IiBkYXRhLXNvdXJjZS1saW5lPSI3IiBkYXRhLXVpZD0iZW50MDAwNSIgaWQ9ImVudGl0eV9HTU40Ij48cGF0aCBkPSJNNTguNTYsMzA0LjU5NjkgTDU4LjU2LDM1OS45OTUzIEEwLDAgMCAwIDAgNTguNTYsMzU5Ljk5NTMgTDEyMy41NiwzNTkuOTk1MyBMMTI3LjU2LDM5NC4zODY5IEwxMzEuNTYsMzU5Ljk5NTMgTDE5Ni41NjAxLDM1OS45OTUzIEEwLDAgMCAwIDAgMTk2LjU2MDEsMzU5Ljk5NTMgTDE5Ni41NjAxLDMxNC41OTY5IEwxODYuNTYwMSwzMDQuNTk2OSBMNTguNTYsMzA0LjU5NjkgQTAsMCAwIDAgMCA1OC41NiwzMDQuNTk2OSIgZmlsbD0iI0ZFRkZERCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHBhdGggZD0iTTE4Ni41NjAxLDMwNC41OTY5IEwxODYuNTYwMSwzMTQuNTk2OSBMMTk2LjU2MDEsMzE0LjU5NjkgTDE4Ni41NjAxLDMwNC41OTY5IiBmaWxsPSIjRkVGRkREIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTcuMDAwMSIgeD0iNjQuNTYiIHk9IjMyMS42NjM4Ij4mIzI5Njk0OyYjMjIzMTI7JiMxMjM5ODsmIzI5MzY2OyYjMjQ5MDc7JiMxMjM5ODsmIzEyNDE1OyYjMjA0NDU7JiMyMzM4NDs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTEuMDAwMSIgeD0iNjQuNTYiIHk9IjMzNi43OTY2Ij4mIzI2MzU2OyYjMjYwMzI7JiMyNjE3ODsmIzEyMzk1OyYjMTk5Nzg7JiMyNjM2MDsmIzEyMzY1OzwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5MS4wMDAxIiB4PSI2NC41NiIgeT0iMzUxLjkyOTQiPiYjMjM2NTM7JiMyNzUwODsmIzEyMzk5OyYjMjI4MzM7JiMxMjQzMTsmIzEyNDI4OyYjMTI0Mjc7PC90ZXh0PjwvZz48IS0tZW50aXR5IGVzX2RiLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9ImVzX2RiIiBkYXRhLXNvdXJjZS1saW5lPSIxNCIgZGF0YS11aWQ9ImVudDAwMDgiIGlkPSJlbnRpdHlfZXNfZGIiPjxwYXRoIGQ9Ik03Ni4yNiwxOTMuNjQ2OSBDNzYuMjYsMTgzLjY0NjkgMTI3LjU1NTksMTgzLjY0NjkgMTI3LjU1NTksMTgzLjY0NjkgQzEyNy41NTU5LDE4My42NDY5IDE3OC44NTE4LDE4My42NDY5IDE3OC44NTE4LDE5My42NDY5IEwxNzguODUxOCwyMTguOTQzOCBDMTc4Ljg1MTgsMjI4Ljk0MzggMTI3LjU1NTksMjI4Ljk0MzggMTI3LjU1NTksMjI4Ljk0MzggQzEyNy41NTU5LDIyOC45NDM4IDc2LjI2LDIyOC45NDM4IDc2LjI2LDIxOC45NDM4IEw3Ni4yNiwxOTMuNjQ2OSIgZmlsbD0iI0YxRjFGMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHBhdGggZD0iTTc2LjI2LDE5My42NDY5IEM3Ni4yNiwyMDMuNjQ2OSAxMjcuNTU1OSwyMDMuNjQ2OSAxMjcuNTU1OSwyMDMuNjQ2OSBDMTI3LjU1NTksMjAzLjY0NjkgMTc4Ljg1MTgsMjAzLjY0NjkgMTc4Ljg1MTgsMTkzLjY0NjkiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjgyLjU5MTgiIHg9Ijg2LjI2IiB5PSIyMjAuNjQyIj5ldmVudF9zdG9yZTwvdGV4dD48L2c+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkdNTjkiIGRhdGEtc291cmNlLWxpbmU9IjE2IiBkYXRhLXVpZD0iZW50MDAxMCIgaWQ9ImVudGl0eV9HTU45Ij48cGF0aCBkPSJNMjIsNzguMDI2OSBMMjIsMTQ4LjU1ODEgQTAsMCAwIDAgMCAyMiwxNDguNTU4MSBMMTIzLjU2LDE0OC41NTgxIEwxMjcuNTYsMTgzLjQwNjkgTDEzMS41NiwxNDguNTU4MSBMMjMzLjExODcsMTQ4LjU1ODEgQTAsMCAwIDAgMCAyMzMuMTE4NywxNDguNTU4MSBMMjMzLjExODcsODguMDI2OSBMMjIzLjExODcsNzguMDI2OSBMMjIsNzguMDI2OSBBMCwwIDAgMCAwIDIyLDc4LjAyNjkiIGZpbGw9IiNGRUZGREQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik0yMjMuMTE4Nyw3OC4wMjY5IEwyMjMuMTE4Nyw4OC4wMjY5IEwyMzMuMTE4Nyw4OC4wMjY5IEwyMjMuMTE4Nyw3OC4wMjY5IiBmaWxsPSIjRkVGRkREIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNzMuMjMzOSIgeD0iMjgiIHk9Ijk1LjA5MzgiPiYjMTI0NTI7JiMxMjUwNTsmIzEyNTMxOyYjMTI0ODg7MTogQWNjb3VudENyZWF0ZWQ8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTg0LjE4MzciIHg9IjI4IiB5PSIxMTAuMjI2NiI+JiMxMjQ1MjsmIzEyNTA1OyYjMTI1MzE7JiMxMjQ4ODsyOiBCYWxhbmNlSW5jcmVhc2VkPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE5MC4xMTg3IiB4PSIyOCIgeT0iMTI1LjM1OTQiPiYjMTI0NTI7JiMxMjUwNTsmIzEyNTMxOyYjMTI0ODg7MzogQmFsYW5jZURlY3JlYXNlZDwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNjIuMzU0MSIgeD0iMjgiIHk9IjE0MC40OTIyIj4mIzM2ODYxOyYjMzUzNTI7JiMyMzU1NDsmIzI5OTkyOyYjNjUyODg7QXBwZW5kLU9ubHkmIzY1Mjg5OzwvdGV4dD48L2c+PCEtLWVudGl0eSByZXBsYXktLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0icmVwbGF5IiBkYXRhLXNvdXJjZS1saW5lPSIyMiIgZGF0YS11aWQ9ImVudDAwMTIiIGlkPSJlbnRpdHlfcmVwbGF5Ij48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjQ2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjEyMy45OTk2IiB4PSIzOTkuMTIiIHk9IjE3MS4xNDY5Ii8+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIxMCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTUiIHg9IjUwMy4xMTk2IiB5PSIxNzYuMTQ2OSIvPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNCIgeD0iNTAxLjExOTYiIHk9IjE3OC4xNDY5Ii8+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI0IiB4PSI1MDEuMTE5NiIgeT0iMTgyLjE0NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI4My45OTk2IiB4PSI0MTQuMTIiIHk9IjIwNC4xNDIiPiYjMTI0NTI7JiMxMjUwNTsmIzEyNTMxOyYjMTI0ODg7JiMyMDg3NzsmIzI5OTgzOzwvdGV4dD48L2c+PCEtLWVudGl0eSBzdGF0ZS0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJzdGF0ZSIgZGF0YS1zb3VyY2UtbGluZT0iMjMiIGRhdGEtdWlkPSJlbnQwMDEzIiBpZD0iZW50aXR5X3N0YXRlIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9Ijg5Ljk5OTciIHg9IjY1MC4xMiIgeT0iMTc2LjE0NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2OS45OTk3IiB4PSI2NjAuMTIiIHk9IjE5OS4xNDIiPiYjMjk2OTQ7JiMyMjMxMjsmIzEyMzk4OyYjMjkzNjY7JiMyNDkwNzs8L3RleHQ+PC9nPjwhLS1saW5rIGVzX2RiIHRvIHJlcGxheS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJlc19kYiIgZGF0YS1lbnRpdHktMj0icmVwbGF5IiBkYXRhLXNvdXJjZS1saW5lPSIyNSIgZGF0YS11aWQ9ImxuazE0IiBpZD0ibGlua19lc19kYl9yZXBsYXkiPjxwYXRoIGQ9Ik0xNzkuMjgsMjA0LjQ1NjkgQzIzOC4yMywyMDIuMzI2OSAzMjkuNTAzOSwxOTkuMDI0MiAzOTIuNjkzOSwxOTYuNzM0MiIgZmlsbD0ibm9uZSIgaWQ9ImVzX2RiLXRvLXJlcGxheSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzk4LjY5LDE5Ni41MTY5LDM4OS41NTEsMTkyLjg0NTQsMzkzLjY5MzMsMTk2LjY5OCwzODkuODQwOCwyMDAuODQwMiwzOTguNjksMTk2LjUxNjkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMDQuMDAwMSIgeD0iMjY0LjEyIiB5PSIxOTMuOTEzOCI+JiMxMjQ1MjsmIzEyNTA1OyYjMTI1MzE7JiMxMjQ4ODsmIzM1NTAxOyYjMTI0MTU7JiMzNjc5NjsmIzEyNDE1OzwvdGV4dD48L2c+PCEtLWxpbmsgcmVwbGF5IHRvIHN0YXRlLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9InJlcGxheSIgZGF0YS1lbnRpdHktMj0ic3RhdGUiIGRhdGEtc291cmNlLWxpbmU9IjI2IiBkYXRhLXVpZD0ibG5rMTUiIGlkPSJsaW5rX3JlcGxheV9zdGF0ZSI+PHBhdGggZD0iTTUyMy4zOCwxOTQuMjk2OSBDNTYzLjExLDE5NC4yOTY5IDYwNy45NywxOTQuMjk2OSA2NDMuODEsMTk0LjI5NjkiIGZpbGw9Im5vbmUiIGlkPSJyZXBsYXktdG8tc3RhdGUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjY0OS44MSwxOTQuMjk2OSw2NDAuODEsMTkwLjI5NjksNjQ0LjgxLDE5NC4yOTY5LDY0MC44MSwxOTguMjk2OSw2NDkuODEsMTk0LjI5NjkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2NS4wMDAxIiB4PSI1NTQuMTIiIHk9IjE5MC4zNjM4Ij4mIzI5MzY2OyYjMjQ5MDc7JiMxMjQzNDsmIzI0NDg5OyYjMjA4MDM7PC90ZXh0PjwvZz48IS0tU1JDPVtWTDlESW1DbjVCcGRMcG53eHE2enpJM3VTVjRhMjl2QmtYamhTUGlpa3NiMW5DRGNLUkhRMTE2ckwxNmFHYk1nQk9md2dFc0ZVVXZzUl91NWlza2pMaUhCSUR4Q1V2ZDlIMVFhbk0xa1FOYVVvWXdXUWcxVkdfeTFfSHJLaC1YdEtKdDdIektjNWJrSDgwS3VYVm9nMUJGV0M0Q00xMlY0ZmlPUXBKRDg5TERHTlE5X1dkdWhSbFF6NTZtR2FxZ1Fld3ZjS0NDRzlJeFQ1NTBOM0FUYVBpcVN1SzhvbzBhZkhINzRvZ1d5RUVXNVBxdHF4V1FMZnQxaEpzX0d3eF9ycHVGTUFHZGhaLTVuRXdtZno2eFZOWWZYX0dNekFXYXdMczdoNFJ0eGVENTFUTzFnN3pLVU9UbzQtMGdvLUtGZ0ZxUjc1UkNvdXBCaElrNm1IM0hwX3YzeU1WbXZTbzgzQ3Z6VXZubjY5SkY3cUNhQ3A1QUJTZUNqUzRGWnhZenlRZUpGaW95eXdoejZwVEVXaEdQN3BWVmtwZW5qUXNGZkhNd2psdFR0bHFxSUduSGptUk5lU1BGMVRkTG1UOTVPUzlYanFOS0l2cVR2TmdVVi1sTksyU2tMRDF3Tk04RHFVZGhPMWZjbkpuQlRqN0dnS1EtaExwOWFuRUlhTXRFN3NRZDNlN1NUUkZiYXltQzBdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<h3 id="3">イベントソーシングの3つの原則<a class="headerlink" href="#3" title="Permanent link">&para;</a></h3>
<p><strong>1. イベントが真実の源（Source of Truth）</strong></p>
<p>従来の CRUD では「現在の状態」がデータベースに保存されますが、イベントソーシングでは「過去に発生したイベント」が真実の源となります。</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjUyNXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NjAwcHg7aGVpZ2h0OjUyNXB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDYwMCA1MjUiIHdpZHRoPSI2MDBweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PHRpdGxlPiYjMzA0OTU7JiMyMzQ1NTsmIzEyMzk4OyYjMjgzMDQ7JiMxMjM5ODsmIzM2OTQ5OyYjMTIzNTY7PC90aXRsZT48ZGVmcy8+PGc+PGcgY2xhc3M9InRpdGxlIiBkYXRhLXNvdXJjZS1saW5lPSIxIj48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTcuOTk5NiIgeD0iMjQ0LjQxMDIiIHk9IjIyLjk5NTEiPiYjMzA0OTU7JiMyMzQ1NTsmIzEyMzk4OyYjMjgzMDQ7JiMxMjM5ODsmIzM2OTQ5OyYjMTIzNTY7PC90ZXh0PjwvZz48IS0tY2x1c3RlciBDUlVELS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJDUlVEIiBkYXRhLXNvdXJjZS1saW5lPSI0IiBkYXRhLXVpZD0iZW50MDAwMiIgaWQ9ImNsdXN0ZXJfQ1JVRCI+PHBhdGggZD0iTTguNSwzNDYuMjk2OSBMNTMuNTQzOSwzNDYuMjk2OSBBMy43NSwzLjc1IDAgMCAxIDU2LjA0MzksMzQ4Ljc5NjkgTDYzLjA0MzksMzY4LjU5MzggTDMxOC4wMiwzNjguNTkzOCBBMi41LDIuNSAwIDAgMSAzMjAuNTIsMzcxLjA5MzggTDMyMC41Miw1MTUuNzk2OSBBMi41LDIuNSAwIDAgMSAzMTguMDIsNTE4LjI5NjkgTDguNSw1MTguMjk2OSBBMi41LDIuNSAwIDAgMSA2LDUxNS43OTY5IEw2LDM0OC43OTY5IEEyLjUsMi41IDAgMCAxIDguNSwzNDYuMjk2OSIgZmlsbD0ibm9uZSIgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxLjU7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDoxLjU7IiB4MT0iNiIgeDI9IjYzLjA0MzkiIHkxPSIzNjguNTkzOCIgeTI9IjM2OC41OTM4Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQ0LjA0MzkiIHg9IjEwIiB5PSIzNjEuMjkyIj5DUlVEPC90ZXh0PjwvZz48IS0tY2x1c3RlciA/Pz8/Pz8/Pz8tLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9Ii4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTIiIGRhdGEtdWlkPSJlbnQwMDA3IiBpZD0iY2x1c3Rlcl8uLi4uLi4uLi4iPjxwYXRoIGQ9Ik01NC43Niw0My4yOTY5IEwxODEuNzU5NSw0My4yOTY5IEEzLjc1LDMuNzUgMCAwIDEgMTg0LjI1OTUsNDUuNzk2OSBMMTkxLjI1OTUsNjUuNTkzOCBMNTkxLjMyLDY1LjU5MzggQTIuNSwyLjUgMCAwIDEgNTkzLjgyLDY4LjA5MzggTDU5My44MiwzMTkuNzk2OSBBMi41LDIuNSAwIDAgMSA1OTEuMzIsMzIyLjI5NjkgTDU0Ljc2LDMyMi4yOTY5IEEyLjUsMi41IDAgMCAxIDUyLjI2LDMxOS43OTY5IEw1Mi4yNiw0NS43OTY5IEEyLjUsMi41IDAgMCAxIDU0Ljc2LDQzLjI5NjkiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MS41OyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzAwMDAwMDtzdHJva2Utd2lkdGg6MS41OyIgeDE9IjUyLjI2IiB4Mj0iMTkxLjI1OTUiIHkxPSI2NS41OTM4IiB5Mj0iNjUuNTkzOCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjUuOTk5NSIgeD0iNTYuMjYiIHk9IjU4LjI5MiI+JiMxMjQ1MjsmIzEyNTA1OyYjMTI1MzE7JiMxMjQ4ODsmIzEyNDc3OyYjMTI1NDA7JiMxMjQ3MTsmIzEyNTMxOyYjMTI0NjQ7PC90ZXh0PjwvZz48IS0tZW50aXR5IGNydWQtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iY3J1ZCIgZGF0YS1zb3VyY2UtbGluZT0iNSIgZGF0YS11aWQ9ImVudDAwMDMiIGlkPSJlbnRpdHlfY3J1ZCI+PHBhdGggZD0iTTkxLjUsNDY2LjY0NjkgQzkxLjUsNDU2LjY0NjkgMTYzLjI1OTIsNDU2LjY0NjkgMTYzLjI1OTIsNDU2LjY0NjkgQzE2My4yNTkyLDQ1Ni42NDY5IDIzNS4wMTgzLDQ1Ni42NDY5IDIzNS4wMTgzLDQ2Ni42NDY5IEwyMzUuMDE4Myw0OTEuOTQzOCBDMjM1LjAxODMsNTAxLjk0MzggMTYzLjI1OTIsNTAxLjk0MzggMTYzLjI1OTIsNTAxLjk0MzggQzE2My4yNTkyLDUwMS45NDM4IDkxLjUsNTAxLjk0MzggOTEuNSw0OTEuOTQzOCBMOTEuNSw0NjYuNjQ2OSIgZmlsbD0iI0YxRjFGMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHBhdGggZD0iTTkxLjUsNDY2LjY0NjkgQzkxLjUsNDc2LjY0NjkgMTYzLjI1OTIsNDc2LjY0NjkgMTYzLjI1OTIsNDc2LjY0NjkgQzE2My4yNTkyLDQ3Ni42NDY5IDIzNS4wMTgzLDQ3Ni42NDY5IDIzNS4wMTgzLDQ2Ni42NDY5IiBmaWxsPSJub25lIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjMuNTE4MyIgeD0iMTAxLjUiIHk9IjQ5My42NDIiPmFjY291bnRzICYjMTI0ODY7JiMxMjU0MDsmIzEyNTAyOyYjMTI1MjM7PC90ZXh0PjwvZz48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iR01ONCIgZGF0YS1zb3VyY2UtbGluZT0iNyIgZGF0YS11aWQ9ImVudDAwMDUiIGlkPSJlbnRpdHlfR01ONCI+PHBhdGggZD0iTTIyLDM4MS4xNjY5IEwyMiw0MjEuNDMyNSBBMCwwIDAgMCAwIDIyLDQyMS40MzI1IEwxNTkuMjYsNDIxLjQzMjUgTDE2My4yNiw0NTYuNDQ2OSBMMTY3LjI2LDQyMS40MzI1IEwzMDQuNTE3MSw0MjEuNDMyNSBBMCwwIDAgMCAwIDMwNC41MTcxLDQyMS40MzI1IEwzMDQuNTE3MSwzOTEuMTY2OSBMMjk0LjUxNzEsMzgxLjE2NjkgTDIyLDM4MS4xNjY5IEEwLDAgMCAwIDAgMjIsMzgxLjE2NjkiIGZpbGw9IiNGRUZGREQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik0yOTQuNTE3MSwzODEuMTY2OSBMMjk0LjUxNzEsMzkxLjE2NjkgTDMwNC41MTcxLDM5MS4xNjY5IEwyOTQuNTE3MSwzODEuMTY2OSIgZmlsbD0iI0ZFRkZERCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjYxLjUxNzEiIHg9IjI4IiB5PSIzOTguMjMzOCI+aWQ9MTAwMSwgbmFtZT0iJiMyOTY5NDsmIzM3MzI5OyIsIGJhbGFuY2U9NTAwMDA8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTEuMDAwMSIgeD0iMjgiIHk9IjQxMy4zNjY2Ij4mIzI5Njk0OyYjMjIzMTI7JiMxMjM5ODsmIzI5MzY2OyYjMjQ5MDc7JiMxMjM5ODsmIzEyNDE1OzwvdGV4dD48L2c+PCEtLWVudGl0eSBlcy0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJlcyIgZGF0YS1zb3VyY2UtbGluZT0iMTMiIGRhdGEtdWlkPSJlbnQwMDA4IiBpZD0iZW50aXR5X2VzIj48cGF0aCBkPSJNMTExLjk2LDE3OS42NDY5IEMxMTEuOTYsMTY5LjY0NjkgMTYzLjI1NTksMTY5LjY0NjkgMTYzLjI1NTksMTY5LjY0NjkgQzE2My4yNTU5LDE2OS42NDY5IDIxNC41NTE4LDE2OS42NDY5IDIxNC41NTE4LDE3OS42NDY5IEwyMTQuNTUxOCwyMDQuOTQzOCBDMjE0LjU1MTgsMjE0Ljk0MzggMTYzLjI1NTksMjE0Ljk0MzggMTYzLjI1NTksMjE0Ljk0MzggQzE2My4yNTU5LDIxNC45NDM4IDExMS45NiwyMTQuOTQzOCAxMTEuOTYsMjA0Ljk0MzggTDExMS45NiwxNzkuNjQ2OSIgZmlsbD0iI0YxRjFGMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHBhdGggZD0iTTExMS45NiwxNzkuNjQ2OSBDMTExLjk2LDE4OS42NDY5IDE2My4yNTU5LDE4OS42NDY5IDE2My4yNTU5LDE4OS42NDY5IEMxNjMuMjU1OSwxODkuNjQ2OSAyMTQuNTUxOCwxODkuNjQ2OSAyMTQuNTUxOCwxNzkuNjQ2OSIgZmlsbD0ibm9uZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODIuNTkxOCIgeD0iMTIxLjk2IiB5PSIyMDYuNjQyIj5ldmVudF9zdG9yZTwvdGV4dD48L2c+PCEtLWVudGl0eSBldjEtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iZXYxIiBkYXRhLXNvdXJjZS1saW5lPSIxNSIgZGF0YS11aWQ9ImVudDAwMDkiIGlkPSJlbnRpdHlfZXYxIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjUyLjU5MzgiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjE5NS4xMTYyIiB4PSIzNzMuNjEiIHk9IjI1My45OTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTc1LjExNjIiIHg9IjM4My42MSIgeT0iMjc2Ljk5MiI+RXZlbnQgMTogQWNjb3VudENyZWF0ZWQ8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTQ0Ljc5MiIgeD0iMzgzLjYxIiB5PSIyOTMuMjg4OSI+aWQ9MTAwMSwgYmFsYW5jZT0wPC90ZXh0PjwvZz48IS0tZW50aXR5IGV2Mi0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJldjIiIGRhdGEtc291cmNlLWxpbmU9IjE2IiBkYXRhLXVpZD0iZW50MDAxMCIgaWQ9ImVudGl0eV9ldjIiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iNTIuNTkzOCIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjA2LjkwODIiIHg9IjM2Ny43MSIgeT0iMTY1Ljk5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxODYuOTA4MiIgeD0iMzc3LjcxIiB5PSIxODguOTkyIj5FdmVudCAyOiBCYWxhbmNlSW5jcmVhc2VkPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExOS4xOTE0IiB4PSIzNzcuNzEiIHk9IjIwNS4yODg5Ij5hbW91bnQ9MTAwMDAwPC90ZXh0PjwvZz48IS0tZW50aXR5IGV2My0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJldjMiIGRhdGEtc291cmNlLWxpbmU9IjE3IiBkYXRhLXVpZD0iZW50MDAxMSIgaWQ9ImVudGl0eV9ldjMiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iNTIuNTkzOCIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjEzLjI5OTgiIHg9IjM2NC41MiIgeT0iNzcuOTk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE5My4yOTk4IiB4PSIzNzQuNTIiIHk9IjEwMC45OTIiPkV2ZW50IDM6IEJhbGFuY2VEZWNyZWFzZWQ8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTEwLjI4NDIiIHg9IjM3NC41MiIgeT0iMTE3LjI4ODkiPmFtb3VudD01MDAwMDwvdGV4dD48L2c+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkdNTjE1IiBkYXRhLXNvdXJjZS1saW5lPSIyNCIgZGF0YS11aWQ9ImVudDAwMTYiIGlkPSJlbnRpdHlfR01OMTUiPjxwYXRoIGQ9Ik02OC4yNiw5NC4xNjY5IEw2OC4yNiwxMzQuNDMyNSBBMCwwIDAgMCAwIDY4LjI2LDEzNC40MzI1IEwxNTkuMjYsMTM0LjQzMjUgTDE2My4yNiwxNjkuNDQ2OSBMMTY3LjI2LDEzNC40MzI1IEwyNTguMjYwMiwxMzQuNDMyNSBBMCwwIDAgMCAwIDI1OC4yNjAyLDEzNC40MzI1IEwyNTguMjYwMiwxMDQuMTY2OSBMMjQ4LjI2MDIsOTQuMTY2OSBMNjguMjYsOTQuMTY2OSBBMCwwIDAgMCAwIDY4LjI2LDk0LjE2NjkiIGZpbGw9IiNGRUZGREQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik0yNDguMjYwMiw5NC4xNjY5IEwyNDguMjYwMiwxMDQuMTY2OSBMMjU4LjI2MDIsMTA0LjE2NjkgTDI0OC4yNjAyLDk0LjE2NjkiIGZpbGw9IiNGRUZGREQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0My4wMDAyIiB4PSI3NC4yNiIgeT0iMTExLjIzMzgiPiYjMTIzNzc7JiMxMjQwOTsmIzEyMzkwOyYjMTIzOTg7JiMxMjQ1MjsmIzEyNTA1OyYjMTI1MzE7JiMxMjQ4ODsmIzEyNDM0OyYjMjA0NDU7JiMyMzM4NDs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTY5LjAwMDIiIHg9Ijc0LjI2IiB5PSIxMjYuMzY2NiI+JiMyMDIxOTsmIzI0ODQ3OyYjMTIzOTg7JiMyNjE3ODsmIzI4ODU3OyYjMTIzOTg7JiMyOTM2NjsmIzI0OTA3OyYjMTI0MzQ7JiMyNDQ4OTsmIzIwODAzOyYjMjE0ODc7JiMzMzAyMTs8L3RleHQ+PC9nPjwhLS1saW5rIGVzIHRvIGV2MS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJlcyIgZGF0YS1lbnRpdHktMj0iZXYxIiBkYXRhLXNvdXJjZS1saW5lPSIxOSIgZGF0YS11aWQ9ImxuazEyIiBpZD0ibGlua19lc19ldjEiPjxwYXRoIGQ9Ik0yMTQuNzcsMjA2LjgyNjkgQzI1OC44MSwyMTkuNDk2OSAzMTguMDQzNywyMzYuNTM4NiAzNzEuNDUzNywyNTEuODk4NiIgZmlsbD0ibm9uZSIgaWQ9ImVzLXRvLWV2MSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzc3LjIyLDI1My41NTY5LDM2OS42NzYxLDI0Ny4yMjUyLDM3Mi40MTQ4LDI1Mi4xNzUsMzY3LjQ2NSwyNTQuOTEzNiwzNzcuMjIsMjUzLjU1NjkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48L2c+PCEtLWxpbmsgZXMgdG8gZXYyLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9ImVzIiBkYXRhLWVudGl0eS0yPSJldjIiIGRhdGEtc291cmNlLWxpbmU9IjIwIiBkYXRhLXVpZD0ibG5rMTMiIGlkPSJsaW5rX2VzX2V2MiI+PHBhdGggZD0iTTIxNC43NywxOTIuMjk2OSBDMjU2LjEsMTkyLjI5NjkgMzA5Ljg4LDE5Mi4yOTY5IDM2MS4yMiwxOTIuMjk2OSIgZmlsbD0ibm9uZSIgaWQ9ImVzLXRvLWV2MiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzY3LjIyLDE5Mi4yOTY5LDM1OC4yMiwxODguMjk2OSwzNjIuMjIsMTkyLjI5NjksMzU4LjIyLDE5Ni4yOTY5LDM2Ny4yMiwxOTIuMjk2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tbGluayBlcyB0byBldjMtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iZXMiIGRhdGEtZW50aXR5LTI9ImV2MyIgZGF0YS1zb3VyY2UtbGluZT0iMjEiIGRhdGEtdWlkPSJsbmsxNCIgaWQ9ImxpbmtfZXNfZXYzIj48cGF0aCBkPSJNMjE0Ljg5LDE4MS4xNzY5IEMyNDcuNTIsMTczLjcxNjkgMjkwLjc1LDE2My4yNjY5IDMyOC41MiwxNTIuMjk2OSBDMzUwLjMzLDE0NS45NTY5IDM2OC4xMDkxLDE0MC4yNzc2IDM4OS41MjkxLDEzMi45OTc2IiBmaWxsPSJub25lIiBpZD0iZXMtdG8tZXYzIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzOTUuMjEsMTMxLjA2NjksMzg1LjQwMTUsMTMwLjE3NTgsMzkwLjQ3NTksMTMyLjY3NTgsMzg3Ljk3NTksMTM3Ljc1MDIsMzk1LjIxLDEzMS4wNjY5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PC9nPjwhLS1TUkM9W1BQOUZJbTkxNkNSbHlvYlV6Z3BXN3htODFnS1RrV1JUV1hYdEhybElzVFdUbEtJN3RUNkFFYlgyYU0xdVlJV1kydUIySkZxbXVzZi1Zc1FxXzNrN3VQcnR2dGR1bFN5aUNyY0VtQjNVeTlpRHVKTzdOdlRvN3hkTm1Zc1g3Q2FtTzFST1BkUVZXTTdRSDZVY0hINHduRmUxcFhCR2FqaXhBR3NFYTg0UEpjRDdUaDJrTW1OQTcxM3lIRjFsbU15NFZ6TzBFdzNSMUdESFluNThNdW5QVVIwb2F2dmY5Q0FYSzNXMDVFVDlHWGpNa2dGSkFvcTBRUHAzTDJVOU00V2s5RGotX0w3MjNTeV8xa0tCTUdZdFhtV3JHN2NZdXBhZ3VUcUJOWEZ5TlYwcHVOS0tYbFVmWmp4UjhZbWY0aWhzNzZSUFA4bjg3OEpLYTlYY1BJWlFmbGVDdUpZaUp1UEFzV0dwT2twSUFWNF9PY1dZQnVQTnZQNHVSNG5rUkw1VDZaWkEwRVVMZHBBSHdxeVJNVEw2ZnplS01UUjZ2Z0hIWDhXM21VM1E2NjVRSGNRYmxCNEtsUG5MazNOWGplSnhlQzlTb0FwUXh6dHZCeFVldHN1RklYTnJOekl5ZVRVUWZVekxfVXdKTi1QLXZWTTdULVFVdUhTMF0tLT48L2c+PC9zdmc+" class="uml" alt="uml diagram" title="" /></p>
<p><strong>2. Append-Only（追記専用）</strong></p>
<p>イベントは一度記録されたら変更・削除されません。新しいイベントを追加することで状態を変更します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// ❌ 悪い例: 既存レコードを更新</span>
<span class="n">UPDATE</span><span class="w"> </span><span class="n">accounts</span><span class="w"> </span><span class="n">SET</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50000</span><span class="w"> </span><span class="n">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1001</span><span class="p">;</span>

<span class="c1">// ✅ 良い例: イベントを追加</span>
<span class="n">INSERT</span><span class="w"> </span><span class="n">INTO</span><span class="w"> </span><span class="nf">event_store</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">aggregate_id</span><span class="p">,</span><span class="w"> </span><span class="n">event_type</span><span class="p">,</span><span class="w"> </span><span class="n">event_data</span>
<span class="p">)</span><span class="w"> </span><span class="n">VALUES</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="err">&#39;</span><span class="mi">1001</span><span class="err">&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="err">&#39;</span><span class="n">BalanceDecreased</span><span class="err">&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="err">&#39;</span><span class="p">{</span><span class="s">&quot;amount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">50000</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;reason&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;支払い&quot;</span><span class="p">}</span><span class="err">&#39;</span>
<span class="p">);</span>
</code></pre></div>
<p><strong>3. イベント再生（Event Replay）</strong></p>
<p>保存されたイベントを順番に再生することで、任意の時点の状態を復元できます。</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AccountAggregate</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">.</span><span class="na">ZERO</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DomainEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">uncommittedEvents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// イベント再生</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">AccountAggregate</span><span class="w"> </span><span class="nf">replay</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">DomainEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">events</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">AccountAggregate</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AccountAggregate</span><span class="p">();</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">DomainEvent</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">events</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">account</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">account</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// イベント適用</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">DomainEvent</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">AccountCreatedEvent</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getAccountId</span><span class="p">();</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getName</span><span class="p">();</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getInitialBalance</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">BalanceIncreasedEvent</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">balance</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">getAmount</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">BalanceDecreasedEvent</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">balance</span><span class="p">.</span><span class="na">subtract</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">getAmount</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="crud">CRUD との違い<a class="headerlink" href="#crud" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>観点</th>
<th>CRUD アプローチ</th>
<th>イベントソーシング</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>保存対象</strong></td>
<td>現在の状態</td>
<td>変更イベントの履歴</td>
</tr>
<tr>
<td><strong>データベース操作</strong></td>
<td>UPDATE/DELETE で上書き</td>
<td>INSERT のみ（Append-Only）</td>
</tr>
<tr>
<td><strong>履歴の扱い</strong></td>
<td>別テーブルで管理（監査ログ）</td>
<td>イベントストア自体が履歴</td>
</tr>
<tr>
<td><strong>状態の復元</strong></td>
<td>データベースから直接読み取り</td>
<td>イベント再生で復元</td>
</tr>
<tr>
<td><strong>時間軸</strong></td>
<td>現在の状態のみ</td>
<td>任意の時点の状態を復元可能</td>
</tr>
<tr>
<td><strong>変更の理由</strong></td>
<td>記録されない（または別テーブル）</td>
<td>イベントに含まれる</td>
</tr>
<tr>
<td><strong>整合性</strong></td>
<td>トランザクションで保証</td>
<td>イベントの順序で保証</td>
</tr>
<tr>
<td><strong>複雑さ</strong></td>
<td>シンプル</td>
<td>高い（イベント設計、再生ロジック）</td>
</tr>
</tbody>
</table>
<h3 id="_2">イベントソーシングの利点<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p><strong>1. 完全な監査証跡</strong></p>
<p>すべての変更がイベントとして記録されるため、完全な監査証跡が自動的に得られます。財務会計システムでは法的要件を満たすために不可欠です。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// イベントストアから特定期間のすべての操作を取得</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">DomainEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">auditTrail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eventStore</span><span class="p">.</span><span class="na">getEvents</span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;journal-1001&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">    </span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">31</span><span class="p">,</span><span class="w"> </span><span class="mi">23</span><span class="p">,</span><span class="w"> </span><span class="mi">59</span><span class="p">)</span>
<span class="p">);</span>

<span class="c1">// 誰が、いつ、何をしたかが完全に記録されている</span>
<span class="n">auditTrail</span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">event</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">printf</span><span class="p">(</span><span class="s">&quot;%s: %s by %s%n&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">event</span><span class="p">.</span><span class="na">getTimestamp</span><span class="p">(),</span>
<span class="w">        </span><span class="n">event</span><span class="p">.</span><span class="na">getEventType</span><span class="p">(),</span>
<span class="w">        </span><span class="n">event</span><span class="p">.</span><span class="na">getUserId</span><span class="p">()</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p><strong>2. タイムトラベル（時間軸の復元）</strong></p>
<p>任意の時点の状態を復元できるため、「2024年1月1日時点の残高」などを正確に再現できます。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 2024年1月1日時点の残高を復元</span>
<span class="n">LocalDateTime</span><span class="w"> </span><span class="n">pointInTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">DomainEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">eventsUntil</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eventStore</span><span class="p">.</span><span class="na">getEventsUntil</span><span class="p">(</span><span class="s">&quot;account-1001&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pointInTime</span><span class="p">);</span>
<span class="n">AccountAggregate</span><span class="w"> </span><span class="n">accountAtPast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AccountAggregate</span><span class="p">.</span><span class="na">replay</span><span class="p">(</span><span class="n">eventsUntil</span><span class="p">);</span>

<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;2024/01/01時点の残高: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">accountAtPast</span><span class="p">.</span><span class="na">getBalance</span><span class="p">());</span>
</code></pre></div>
<p><strong>3. デバッグとトラブルシューティング</strong></p>
<p>バグや不正な操作が発生した場合、イベントを再生することで問題の原因を特定できます。</p>
<p><strong>4. 柔軟なビジネスロジック</strong></p>
<p>新しいビジネス要件が発生した場合、過去のイベントを再生して新しいモデルを構築できます。</p>
<h3 id="_3">イベントソーシングの課題<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>課題</th>
<th>説明</th>
<th>解決策</th>
</tr>
</thead>
<tbody>
<tr>
<td>複雑性の増加</td>
<td>CRUD より実装が複雑</td>
<td>段階的な導入、チーム教育</td>
</tr>
<tr>
<td>学習曲線</td>
<td>チーム全体が理解必要</td>
<td>ドキュメント、ペアプログラミング</td>
</tr>
<tr>
<td>パフォーマンス</td>
<td>大量イベントの再生が遅い</td>
<td>スナップショット（7.5節）</td>
</tr>
<tr>
<td>イベント定義変更</td>
<td>過去との互換性維持が必要</td>
<td>イベントバージョニング</td>
</tr>
<tr>
<td>削除の扱い</td>
<td>GDPR 対応が難しい</td>
<td>暗号化キー削除、論理削除</td>
</tr>
</tbody>
</table>
<h3 id="_4">適用ケース<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p><strong>適している場合</strong>:
- ✅ 監査証跡が重要（財務会計、医療、金融）
- ✅ 履歴の分析が必要（行動分析、レポート）
- ✅ ドメインが複雑（DDD と組み合わせ）
- ✅ イベント駆動アーキテクチャを採用</p>
<p><strong>適していない場合</strong>:
- ❌ シンプルな CRUD で十分
- ❌ チームの経験が不足
- ❌ パフォーマンスが最優先
- ❌ イベント再生の必要性が低い</p>
<hr />
<h2 id="312">31.2 イベントストアの設計<a class="headerlink" href="#312" title="Permanent link">&para;</a></h2>
<h3 id="_5">イベントストアの要件<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>イベントストアは、イベントソーシングの中核となるデータベーステーブルです。以下の要件を満たす必要があります：</p>
<ol>
<li><strong>Append-Only（追記専用）</strong>: 一度保存されたイベントは変更・削除されない</li>
<li><strong>順序保証</strong>: イベントの発生順序が正確に記録される</li>
<li><strong>高速な読み取り</strong>: 特定の Aggregate のイベントを高速に取得できる</li>
<li><strong>トランザクション保証</strong>: 複数のイベントをアトミックに保存できる</li>
<li><strong>スケーラビリティ</strong>: 大量のイベントを効率的に保存・検索できる</li>
</ol>
<h3 id="postgresql">テーブル設計（PostgreSQL）<a class="headerlink" href="#postgresql" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- イベントストアテーブル</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">event_store</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="c1">-- 主キー（シーケンス番号）</span>
<span class="w">    </span><span class="n">event_id</span><span class="w"> </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>

<span class="w">    </span><span class="c1">-- Aggregate 識別子</span>
<span class="w">    </span><span class="n">aggregate_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">aggregate_type</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>

<span class="w">    </span><span class="c1">-- イベントメタデータ</span>
<span class="w">    </span><span class="n">event_type</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">event_version</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>

<span class="w">    </span><span class="c1">-- イベントデータ（JSONB形式）</span>
<span class="w">    </span><span class="n">event_data</span><span class="w"> </span><span class="n">JSONB</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>

<span class="w">    </span><span class="c1">-- メタデータ</span>
<span class="w">    </span><span class="n">occurred_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span>
<span class="w">    </span><span class="n">user_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<span class="w">    </span><span class="n">correlation_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<span class="w">    </span><span class="n">causation_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>

<span class="w">    </span><span class="c1">-- 楽観的ロック（同時実行制御）</span>
<span class="w">    </span><span class="n">sequence_number</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>

<span class="w">    </span><span class="c1">-- 一意性制約（同一 Aggregate の sequence_number は一意）</span>
<span class="w">    </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="n">uk_aggregate_sequence</span>
<span class="w">        </span><span class="k">UNIQUE</span><span class="w"> </span><span class="p">(</span><span class="n">aggregate_id</span><span class="p">,</span><span class="w"> </span><span class="n">sequence_number</span><span class="p">)</span>
<span class="p">);</span>

<span class="c1">-- インデックス設計</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_event_store_aggregate_id</span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">event_store</span><span class="p">(</span><span class="n">aggregate_id</span><span class="p">,</span><span class="w"> </span><span class="n">sequence_number</span><span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_event_store_event_type</span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">event_store</span><span class="p">(</span><span class="n">event_type</span><span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_event_store_occurred_at</span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">event_store</span><span class="p">(</span><span class="n">occurred_at</span><span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_event_store_correlation_id</span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">event_store</span><span class="p">(</span><span class="n">correlation_id</span><span class="p">);</span>

<span class="c1">-- JSONB用のGINインデックス</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_event_store_event_data</span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">event_store</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">GIN</span><span class="w"> </span><span class="p">(</span><span class="n">event_data</span><span class="p">);</span>
</code></pre></div>
<h3 id="_6">スキーマの詳細説明<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>カラム</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>event_id</code></td>
<td>グローバルな順序を保証するシーケンス番号</td>
</tr>
<tr>
<td><code>aggregate_id</code></td>
<td>Aggregate のユニーク識別子（例: "journal-1001"）</td>
</tr>
<tr>
<td><code>aggregate_type</code></td>
<td>Aggregate の型（例: "JournalEntry"）</td>
</tr>
<tr>
<td><code>event_type</code></td>
<td>イベントの型（例: "JournalCreatedEvent"）</td>
</tr>
<tr>
<td><code>event_version</code></td>
<td>イベント定義のバージョン（スキーマ進化に対応）</td>
</tr>
<tr>
<td><code>event_data</code></td>
<td>イベントのペイロード（JSONB形式）</td>
</tr>
<tr>
<td><code>occurred_at</code></td>
<td>イベントが発生した日時</td>
</tr>
<tr>
<td><code>user_id</code></td>
<td>イベントを発生させたユーザー ID</td>
</tr>
<tr>
<td><code>correlation_id</code></td>
<td>関連する一連のイベントをグループ化</td>
</tr>
<tr>
<td><code>causation_id</code></td>
<td>因果関係のあるイベント ID</td>
</tr>
<tr>
<td><code>sequence_number</code></td>
<td>Aggregate 内でのイベントの順序番号</td>
</tr>
</tbody>
</table>
<h3 id="correlation_id-causation_id">correlation_id と causation_id<a class="headerlink" href="#correlation_id-causation_id" title="Permanent link">&para;</a></h3>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IlNFUVVFTkNFIiBoZWlnaHQ9IjMzN3B4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6ODA4cHg7aGVpZ2h0OjMzN3B4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDgwOCAzMzciIHdpZHRoPSI4MDhweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PHRpdGxlPmNvcnJlbGF0aW9uX2lkICYjMTIzOTI7IGNhdXNhdGlvbl9pZDwvdGl0bGU+PGRlZnMvPjxnPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMzAuNTAwOSIgeD0iMjg5Ljk5NzQiIHk9IjI3Ljk5NTEiPmNvcnJlbGF0aW9uX2lkICYjMTIzOTI7IGNhdXNhdGlvbl9pZDwvdGV4dD48Zz48dGl0bGU+Li4uLjwvdGl0bGU+PHJlY3QgZmlsbD0iIzAwMDAwMCIgZmlsbC1vcGFjaXR5PSIwLjAwMDAwIiBoZWlnaHQ9IjE1NC41MzEzIiB3aWR0aD0iOCIgeD0iMzUuOTk5OSIgeT0iMTA0LjU5MzgiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTtzdHJva2UtZGFzaGFycmF5OjUsNTsiIHgxPSIzOSIgeDI9IjM5IiB5MT0iMTA0LjU5MzgiIHkyPSIyNTkuMTI1Ii8+PC9nPjxnPjx0aXRsZT4uLi4uPC90aXRsZT48cmVjdCBmaWxsPSIjMDAwMDAwIiBmaWxsLW9wYWNpdHk9IjAuMDAwMDAiIGhlaWdodD0iMTU0LjUzMTMiIHdpZHRoPSI4IiB4PSIyODYuOTc5NCIgeT0iMTA0LjU5MzgiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTtzdHJva2UtZGFzaGFycmF5OjUsNTsiIHgxPSIyODkuOTc5NiIgeDI9IjI4OS45Nzk2IiB5MT0iMTA0LjU5MzgiIHkyPSIyNTkuMTI1Ii8+PC9nPjxnPjx0aXRsZT5ldmVudF9zdG9yZTwvdGl0bGU+PHJlY3QgZmlsbD0iIzAwMDAwMCIgZmlsbC1vcGFjaXR5PSIwLjAwMDAwIiBoZWlnaHQ9IjE1NC41MzEzIiB3aWR0aD0iOCIgeD0iNjgwLjQ5NTYiIHk9IjEwNC41OTM4Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7c3Ryb2tlLWRhc2hhcnJheTo1LDU7IiB4MT0iNjg0LjE5OTciIHgyPSI2ODQuMTk5NyIgeTE9IjEwNC41OTM4IiB5Mj0iMjU5LjEyNSIvPjwvZz48ZyBjbGFzcz0icGFydGljaXBhbnQgcGFydGljaXBhbnQtaGVhZCIgZGF0YS1wYXJ0aWNpcGFudD0idXNlciI+PHJlY3QgZmlsbD0iI0UyRTJGMCIgaGVpZ2h0PSIzMC4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI2OS45OTk4IiB4PSI1IiB5PSI3My4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTUuOTk5OCIgeD0iMTIiIHk9IjkzLjI5MiI+JiMxMjUxODsmIzEyNTQwOyYjMTI0NzA7JiMxMjU0MDs8L3RleHQ+PC9nPjxnIGNsYXNzPSJwYXJ0aWNpcGFudCBwYXJ0aWNpcGFudC10YWlsIiBkYXRhLXBhcnRpY2lwYW50PSJ1c2VyIj48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjY5Ljk5OTgiIHg9IjUiIHk9IjI1OC4xMjUiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1NS45OTk4IiB4PSIxMiIgeT0iMjc4LjEyMDEiPiYjMTI1MTg7JiMxMjU0MDsmIzEyNDcwOyYjMTI1NDA7PC90ZXh0PjwvZz48ZyBjbGFzcz0icGFydGljaXBhbnQgcGFydGljaXBhbnQtaGVhZCIgZGF0YS1wYXJ0aWNpcGFudD0ic3lzIj48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjY5Ljk5OTgiIHg9IjI1NS45Nzk2IiB5PSI3My4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTUuOTk5OCIgeD0iMjYyLjk3OTYiIHk9IjkzLjI5MiI+JiMxMjQ3MTsmIzEyNDczOyYjMTI0ODY7JiMxMjUxMjs8L3RleHQ+PC9nPjxnIGNsYXNzPSJwYXJ0aWNpcGFudCBwYXJ0aWNpcGFudC10YWlsIiBkYXRhLXBhcnRpY2lwYW50PSJzeXMiPjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNjkuOTk5OCIgeD0iMjU1Ljk3OTYiIHk9IjI1OC4xMjUiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1NS45OTk4IiB4PSIyNjIuOTc5NiIgeT0iMjc4LjEyMDEiPiYjMTI0NzE7JiMxMjQ3MzsmIzEyNDg2OyYjMTI1MTI7PC90ZXh0PjwvZz48ZyBjbGFzcz0icGFydGljaXBhbnQgcGFydGljaXBhbnQtaGVhZCIgZGF0YS1wYXJ0aWNpcGFudD0iZGIiPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjgyLjU5MTgiIHg9IjY0MC4xOTk3IiB5PSIxMDEuMjkyIj5ldmVudF9zdG9yZTwvdGV4dD48cGF0aCBkPSJNNjY2LjQ5NTYsNTIuMjk2OSBDNjY2LjQ5NTYsNDIuMjk2OSA2ODQuNDk1Niw0Mi4yOTY5IDY4NC40OTU2LDQyLjI5NjkgQzY4NC40OTU2LDQyLjI5NjkgNzAyLjQ5NTYsNDIuMjk2OSA3MDIuNDk1Niw1Mi4yOTY5IEw3MDIuNDk1Niw3OC4yOTY5IEM3MDIuNDk1Niw4OC4yOTY5IDY4NC40OTU2LDg4LjI5NjkgNjg0LjQ5NTYsODguMjk2OSBDNjg0LjQ5NTYsODguMjk2OSA2NjYuNDk1Niw4OC4yOTY5IDY2Ni40OTU2LDc4LjI5NjkgTDY2Ni40OTU2LDUyLjI5NjkiIGZpbGw9IiNFMkUyRjAiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik02NjYuNDk1Niw1Mi4yOTY5IEM2NjYuNDk1Niw2Mi4yOTY5IDY4NC40OTU2LDYyLjI5NjkgNjg0LjQ5NTYsNjIuMjk2OSBDNjg0LjQ5NTYsNjIuMjk2OSA3MDIuNDk1Niw2Mi4yOTY5IDcwMi40OTU2LDUyLjI5NjkiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjwvZz48ZyBjbGFzcz0icGFydGljaXBhbnQgcGFydGljaXBhbnQtdGFpbCIgZGF0YS1wYXJ0aWNpcGFudD0iZGIiPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjgyLjU5MTgiIHg9IjY0MC4xOTk3IiB5PSIyNzEuMTIwMSI+ZXZlbnRfc3RvcmU8L3RleHQ+PHBhdGggZD0iTTY2Ni40OTU2LDI4NC40MjE5IEM2NjYuNDk1NiwyNzQuNDIxOSA2ODQuNDk1NiwyNzQuNDIxOSA2ODQuNDk1NiwyNzQuNDIxOSBDNjg0LjQ5NTYsMjc0LjQyMTkgNzAyLjQ5NTYsMjc0LjQyMTkgNzAyLjQ5NTYsMjg0LjQyMTkgTDcwMi40OTU2LDMxMC40MjE5IEM3MDIuNDk1NiwzMjAuNDIxOSA2ODQuNDk1NiwzMjAuNDIxOSA2ODQuNDk1NiwzMjAuNDIxOSBDNjg0LjQ5NTYsMzIwLjQyMTkgNjY2LjQ5NTYsMzIwLjQyMTkgNjY2LjQ5NTYsMzEwLjQyMTkgTDY2Ni40OTU2LDI4NC40MjE5IiBmaWxsPSIjRTJFMkYwIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNNjY2LjQ5NTYsMjg0LjQyMTkgQzY2Ni40OTU2LDI5NC40MjE5IDY4NC40OTU2LDI5NC40MjE5IDY4NC40OTU2LDI5NC40MjE5IEM2ODQuNDk1NiwyOTQuNDIxOSA3MDIuNDk1NiwyOTQuNDIxOSA3MDIuNDk1NiwyODQuNDIxOSIgZmlsbD0ibm9uZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PC9nPjxnIGNsYXNzPSJtZXNzYWdlIiBkYXRhLXBhcnRpY2lwYW50LTE9InVzZXIiIGRhdGEtcGFydGljaXBhbnQtMj0ic3lzIj48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjI3OC45Nzk0LDEzMS43MjY2LDI4OC45Nzk0LDEzNS43MjY2LDI3OC45Nzk0LDEzOS43MjY2LDI4Mi45Nzk0LDEzNS43MjY2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgeDE9IjM5Ljk5OTkiIHgyPSIyODQuOTc5NCIgeTE9IjEzNS43MjY2IiB5Mj0iMTM1LjcyNjYiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMjYuOTc5NiIgeD0iNDYuOTk5OSIgeT0iMTMwLjY2MDYiPiYjMTI1MjI7JiMxMjQ2MzsmIzEyNDU2OyYjMTI0NzM7JiMxMjQ4ODsgKGNvcnJlbGF0aW9uX2lkPWFiYzEyMyk8L3RleHQ+PC9nPjxnIGNsYXNzPSJtZXNzYWdlIiBkYXRhLXBhcnRpY2lwYW50LTE9InN5cyIgZGF0YS1wYXJ0aWNpcGFudC0yPSJkYiI+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI2NzIuNDk1NiwxNjMuODU5NCw2ODIuNDk1NiwxNjcuODU5NCw2NzIuNDk1NiwxNzEuODU5NCw2NzYuNDk1NiwxNjcuODU5NCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHgxPSIyOTAuOTc5NCIgeDI9IjY3OC40OTU2IiB5MT0iMTY3Ljg1OTQiIHkyPSIxNjcuODU5NCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjMzMS43MDk1IiB4PSIyOTcuOTc5NCIgeT0iMTYyLjc5MzUiPkV2ZW50MSAoY29ycmVsYXRpb25faWQ9YWJjMTIzLCBjYXVzYXRpb25faWQ9bnVsbCk8L3RleHQ+PC9nPjxwYXRoIGQ9Ik02ODksMTQ4LjcyNjYgTDY4OSwxNzMuNzI2NiBMODAxLDE3My43MjY2IEw4MDEsMTU4LjcyNjYgTDc5MSwxNDguNzI2NiBMNjg5LDE0OC43MjY2IiBmaWxsPSIjRkVGRkREIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNNzkxLDE0OC43MjY2IEw3OTEsMTU4LjcyNjYgTDgwMSwxNTguNzI2NiBMNzkxLDE0OC43MjY2IiBmaWxsPSIjRkVGRkREIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5MS4wMDAxIiB4PSI2OTUiIHk9IjE2NS43OTM1Ij4mIzI2MzY4OyYjMjEwMjE7JiMxMjM5ODsmIzEyNDUyOyYjMTI1MDU7JiMxMjUzMTsmIzEyNDg4OzwvdGV4dD48ZyBjbGFzcz0ibWVzc2FnZSIgZGF0YS1wYXJ0aWNpcGFudC0xPSJzeXMiIGRhdGEtcGFydGljaXBhbnQtMj0iZGIiPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNjcyLjQ5NTYsMTk4Ljk5MjIsNjgyLjQ5NTYsMjAyLjk5MjIsNjcyLjQ5NTYsMjA2Ljk5MjIsNjc2LjQ5NTYsMjAyLjk5MjIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7IiB4MT0iMjkwLjk3OTQiIHgyPSI2NzguNDk1NiIgeTE9IjIwMi45OTIyIiB5Mj0iMjAyLjk5MjIiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIzNjkuNTE2MSIgeD0iMjk3Ljk3OTQiIHk9IjE5Ny45MjYzIj5FdmVudDIgKGNvcnJlbGF0aW9uX2lkPWFiYzEyMywgY2F1c2F0aW9uX2lkPUV2ZW50MS5pZCk8L3RleHQ+PC9nPjxwYXRoIGQ9Ik02ODksMTgzLjg1OTQgTDY4OSwyMDguODU5NCBMNzk0LDIwOC44NTk0IEw3OTQsMTkzLjg1OTQgTDc4NCwxODMuODU5NCBMNjg5LDE4My44NTk0IiBmaWxsPSIjRkVGRkREIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNNzg0LDE4My44NTk0IEw3ODQsMTkzLjg1OTQgTDc5NCwxOTMuODU5NCBMNzg0LDE4My44NTk0IiBmaWxsPSIjRkVGRkREIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI4NC41MTI3IiB4PSI2OTUiIHk9IjIwMC45MjYzIj5FdmVudDEmIzEyMzY0OyYjMjE0MDc7JiMyMjI0MDs8L3RleHQ+PGcgY2xhc3M9Im1lc3NhZ2UiIGRhdGEtcGFydGljaXBhbnQtMT0ic3lzIiBkYXRhLXBhcnRpY2lwYW50LTI9ImRiIj48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjY3Mi40OTU2LDIzNC4xMjUsNjgyLjQ5NTYsMjM4LjEyNSw2NzIuNDk1NiwyNDIuMTI1LDY3Ni40OTU2LDIzOC4xMjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7IiB4MT0iMjkwLjk3OTQiIHgyPSI2NzguNDk1NiIgeTE9IjIzOC4xMjUiIHkyPSIyMzguMTI1Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMzY5LjUxNjEiIHg9IjI5Ny45Nzk0IiB5PSIyMzMuMDU5MSI+RXZlbnQzIChjb3JyZWxhdGlvbl9pZD1hYmMxMjMsIGNhdXNhdGlvbl9pZD1FdmVudDEuaWQpPC90ZXh0PjwvZz48cGF0aCBkPSJNNjg5LDIxOC45OTIyIEw2ODksMjQzLjk5MjIgTDc5NCwyNDMuOTkyMiBMNzk0LDIyOC45OTIyIEw3ODQsMjE4Ljk5MjIgTDY4OSwyMTguOTkyMiIgZmlsbD0iI0ZFRkZERCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHBhdGggZD0iTTc4NCwyMTguOTkyMiBMNzg0LDIyOC45OTIyIEw3OTQsMjI4Ljk5MjIgTDc4NCwyMTguOTkyMiIgZmlsbD0iI0ZFRkZERCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODQuNTEyNyIgeD0iNjk1IiB5PSIyMzYuMDU5MSI+RXZlbnQxJiMxMjM2NDsmIzIxNDA3OyYjMjIyNDA7PC90ZXh0PjwhLS1TUkM9W2hPLW5JV0QxNDhSeFZPaFhBV0RISUQ4VG5DeGQyN0V0WW91U1VzNXRKaDNwVGE1SVlCc2VjNDhhTTlXWWEyM3VEaUZiRU45dDhTS1AxMGtSQU1RLSAtVU9WcWZHZkk3RGhMT1FhU3BGSDRoWFNHOGc1RXBJNGNBOGJkVWVmNmVBOG1wazdSX1Joa2FRMDNXZ2R4MF80UnpYX1NSWlpDNnlIVC1FNEhDODRkTzk4TklqMzRxVXZMVXJLOWE4cTRaV3pSeVdPRTdvbU54OVZqOU9QZDdHSlpaNTkxeURISnVZUVJmUGE0aUQ1OG50eVdsT3gzdXJEYU1Lek9OOUlPRk5iNVNNbVZSd2pQWXpTVmg5X3VfMzhPTE5WRlZPRl8tUlZQcGRKaWRqYXQtUm9sZGZ1aFB4Y25faEhWLWZ0XS0tPjwvZz48L3N2Zz4=" class="uml" alt="uml diagram" title="" /></p>
<h3 id="_7">イベントのバージョニング<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>イベント定義は時間とともに変化します。互換性を保つために <code>event_version</code> フィールドを使用します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Version 1</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">record</span> <span class="nc">JournalCreatedEventV1</span><span class="p">(</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">journalId</span><span class="p">,</span>
<span class="w">    </span><span class="n">LocalDate</span><span class="w"> </span><span class="n">entryDate</span><span class="p">,</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">description</span><span class="p">,</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">LineItem</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lineItems</span>
<span class="p">)</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">DomainEvent</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getEventVersion</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Version 2（新フィールド追加）</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">record</span> <span class="nc">JournalCreatedEventV2</span><span class="p">(</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">journalId</span><span class="p">,</span>
<span class="w">    </span><span class="n">LocalDate</span><span class="w"> </span><span class="n">entryDate</span><span class="p">,</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">description</span><span class="p">,</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">LineItem</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lineItems</span><span class="p">,</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">fiscalYear</span><span class="w">  </span><span class="c1">// 新フィールド</span>
<span class="p">)</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">DomainEvent</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getEventVersion</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// V1からV2へのマイグレーション</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">JournalCreatedEventV2</span><span class="w"> </span><span class="nf">fromV1</span><span class="p">(</span><span class="n">JournalCreatedEventV1</span><span class="w"> </span><span class="n">v1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JournalCreatedEventV2</span><span class="p">(</span>
<span class="w">            </span><span class="n">v1</span><span class="p">.</span><span class="na">journalId</span><span class="p">(),</span>
<span class="w">            </span><span class="n">v1</span><span class="p">.</span><span class="na">entryDate</span><span class="p">(),</span>
<span class="w">            </span><span class="n">v1</span><span class="p">.</span><span class="na">description</span><span class="p">(),</span>
<span class="w">            </span><span class="n">v1</span><span class="p">.</span><span class="na">lineItems</span><span class="p">(),</span>
<span class="w">            </span><span class="n">deriveFiscalYear</span><span class="p">(</span><span class="n">v1</span><span class="p">.</span><span class="na">entryDate</span><span class="p">())</span><span class="w">  </span><span class="c1">// 日付から推定</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="313">31.3 仕訳のイベントソーシング実装<a class="headerlink" href="#313" title="Permanent link">&para;</a></h2>
<h3 id="_8">ドメインイベントの定義<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// domain/event/DomainEvent.java</span>
<span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.domain.event</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDateTime</span><span class="p">;</span>

<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">DomainEvent</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="nf">getAggregateId</span><span class="p">();</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="nf">getEventType</span><span class="p">();</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">getEventVersion</span><span class="p">();</span>
<span class="w">    </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="nf">getOccurredAt</span><span class="p">();</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="nf">getUserId</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>仕訳作成イベント</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// domain/event/JournalEntryCreatedEvent.java</span>
<span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.domain.event</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.Builder</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.Value</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.math.BigDecimal</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDate</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDateTime</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span>

<span class="nd">@Value</span>
<span class="nd">@Builder</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JournalEntryCreatedEvent</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">DomainEvent</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">journalEntryId</span><span class="p">;</span>
<span class="w">    </span><span class="n">LocalDate</span><span class="w"> </span><span class="n">entryDate</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">description</span><span class="p">;</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">LineItem</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lineItems</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">;</span>
<span class="w">    </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">occurredAt</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getAggregateId</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">journalEntryId</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getEventType</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;JournalEntryCreatedEvent&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getEventVersion</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Value</span>
<span class="w">    </span><span class="nd">@Builder</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LineItem</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">accountCode</span><span class="p">;</span>
<span class="w">        </span><span class="n">DebitCredit</span><span class="w"> </span><span class="n">debitCredit</span><span class="p">;</span>
<span class="w">        </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">amount</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">enum</span><span class="w"> </span><span class="n">DebitCredit</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">DEBIT</span><span class="p">,</span><span class="w"> </span><span class="n">CREDIT</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>仕訳承認イベント</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// domain/event/JournalEntryApprovedEvent.java</span>
<span class="nd">@Value</span>
<span class="nd">@Builder</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JournalEntryApprovedEvent</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">DomainEvent</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">journalEntryId</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">approvedBy</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">approvalComment</span><span class="p">;</span>
<span class="w">    </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">occurredAt</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getAggregateId</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">journalEntryId</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getEventType</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;JournalEntryApprovedEvent&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getEventVersion</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>仕訳取消イベント</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// domain/event/JournalEntryCancelledEvent.java</span>
<span class="nd">@Value</span>
<span class="nd">@Builder</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JournalEntryCancelledEvent</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">DomainEvent</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">journalEntryId</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">reason</span><span class="p">;</span>
<span class="w">    </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">occurredAt</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getAggregateId</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">journalEntryId</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getEventType</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;JournalEntryCancelledEvent&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getEventVersion</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="aggregate">Aggregate パターンの実装<a class="headerlink" href="#aggregate" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// domain/aggregate/JournalEntryAggregate.java</span>
<span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.domain.aggregate</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.event.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.Getter</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.math.BigDecimal</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDate</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDateTime</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.ArrayList</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span>

<span class="nd">@Getter</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JournalEntryAggregate</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">LocalDate</span><span class="w"> </span><span class="n">entryDate</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">description</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">LineItem</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lineItems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">JournalEntryStatus</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JournalEntryStatus</span><span class="p">.</span><span class="na">DRAFT</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">cancelled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 未コミットイベント（まだイベントストアに保存されていない）</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DomainEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">uncommittedEvents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// バージョン（楽観的ロック用）</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// イベント再生（Event Replay）</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">JournalEntryAggregate</span><span class="w"> </span><span class="nf">replay</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">DomainEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">events</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">JournalEntryAggregate</span><span class="w"> </span><span class="n">aggregate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JournalEntryAggregate</span><span class="p">();</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">DomainEvent</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">events</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">aggregate</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="w">            </span><span class="n">aggregate</span><span class="p">.</span><span class="na">version</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">aggregate</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// コマンド: 仕訳を作成</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">JournalEntryAggregate</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span>
<span class="w">            </span><span class="n">LocalDate</span><span class="w"> </span><span class="n">entryDate</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">description</span><span class="p">,</span>
<span class="w">            </span><span class="n">List</span><span class="o">&lt;</span><span class="n">LineItem</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lineItems</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="c1">// ビジネスルール検証: 貸借一致</span>
<span class="w">        </span><span class="n">validateBalance</span><span class="p">(</span><span class="n">lineItems</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// イベント発行</span>
<span class="w">        </span><span class="n">JournalEntryCreatedEvent</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JournalEntryCreatedEvent</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">journalEntryId</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">entryDate</span><span class="p">(</span><span class="n">entryDate</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">description</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">lineItems</span><span class="p">(</span><span class="n">toEventLineItems</span><span class="p">(</span><span class="n">lineItems</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">userId</span><span class="p">(</span><span class="n">userId</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">occurredAt</span><span class="p">(</span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>

<span class="w">        </span><span class="n">JournalEntryAggregate</span><span class="w"> </span><span class="n">aggregate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JournalEntryAggregate</span><span class="p">();</span>
<span class="w">        </span><span class="n">aggregate</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="w">        </span><span class="n">aggregate</span><span class="p">.</span><span class="na">uncommittedEvents</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">aggregate</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// コマンド: 仕訳を承認</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">approve</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">approvedBy</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">approvalComment</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cancelled</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;取消済みの仕訳は承認できません&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">JournalEntryStatus</span><span class="p">.</span><span class="na">APPROVED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;すでに承認済みです&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">JournalEntryApprovedEvent</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JournalEntryApprovedEvent</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">journalEntryId</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">approvedBy</span><span class="p">(</span><span class="n">approvedBy</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">approvalComment</span><span class="p">(</span><span class="n">approvalComment</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">occurredAt</span><span class="p">(</span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">userId</span><span class="p">(</span><span class="n">approvedBy</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>

<span class="w">        </span><span class="n">apply</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="w">        </span><span class="n">uncommittedEvents</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// コマンド: 仕訳を取消</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">cancel</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">reason</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cancelled</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;すでに取消済みです&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">JournalEntryCancelledEvent</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JournalEntryCancelledEvent</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">journalEntryId</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">reason</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">occurredAt</span><span class="p">(</span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">userId</span><span class="p">(</span><span class="n">userId</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>

<span class="w">        </span><span class="n">apply</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="w">        </span><span class="n">uncommittedEvents</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// イベント適用（Apply）</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">DomainEvent</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">JournalEntryCreatedEvent</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getJournalEntryId</span><span class="p">();</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">entryDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getEntryDate</span><span class="p">();</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getDescription</span><span class="p">();</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">lineItems</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fromEventLineItems</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">getLineItems</span><span class="p">());</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JournalEntryStatus</span><span class="p">.</span><span class="na">DRAFT</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">JournalEntryApprovedEvent</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JournalEntryStatus</span><span class="p">.</span><span class="na">APPROVED</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">JournalEntryCancelledEvent</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">cancelled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 未コミットイベントをクリア</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">markEventsAsCommitted</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">uncommittedEvents</span><span class="p">.</span><span class="na">clear</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// ビジネスルール: 貸借一致の検証</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">validateBalance</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">LineItem</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lineItems</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lineItems</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">lineItems</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">&quot;仕訳明細が必要です&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">debitTotal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lineItems</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">item</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="na">getDebitCredit</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DebitCredit</span><span class="p">.</span><span class="na">DEBIT</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">LineItem</span><span class="p">::</span><span class="n">getAmount</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">reduce</span><span class="p">(</span><span class="n">BigDecimal</span><span class="p">.</span><span class="na">ZERO</span><span class="p">,</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">::</span><span class="n">add</span><span class="p">);</span>

<span class="w">        </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">creditTotal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lineItems</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">item</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="na">getDebitCredit</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DebitCredit</span><span class="p">.</span><span class="na">CREDIT</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">LineItem</span><span class="p">::</span><span class="n">getAmount</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">reduce</span><span class="p">(</span><span class="n">BigDecimal</span><span class="p">.</span><span class="na">ZERO</span><span class="p">,</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">::</span><span class="n">add</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">debitTotal</span><span class="p">.</span><span class="na">compareTo</span><span class="p">(</span><span class="n">creditTotal</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span>
<span class="w">                </span><span class="s">&quot;借方合計と貸方合計が一致しません: 借方=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debitTotal</span><span class="w"> </span><span class="o">+</span>
<span class="w">                </span><span class="s">&quot;, 貸方=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">creditTotal</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// ドメインモデル</span>
<span class="w">    </span><span class="nd">@Getter</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LineItem</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">accountCode</span><span class="p">;</span>
<span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">DebitCredit</span><span class="w"> </span><span class="n">debitCredit</span><span class="p">;</span>
<span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">amount</span><span class="p">;</span>

<span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="nf">LineItem</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">accountCode</span><span class="p">,</span><span class="w"> </span><span class="n">DebitCredit</span><span class="w"> </span><span class="n">debitCredit</span><span class="p">,</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">accountCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accountCode</span><span class="p">;</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">debitCredit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">debitCredit</span><span class="p">;</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">amount</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">enum</span><span class="w"> </span><span class="n">DebitCredit</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">DEBIT</span><span class="p">,</span><span class="w"> </span><span class="n">CREDIT</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">enum</span><span class="w"> </span><span class="n">JournalEntryStatus</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">DRAFT</span><span class="p">,</span><span class="w"> </span><span class="n">APPROVED</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_9">イベントストアリポジトリ<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// domain/repository/EventStoreRepository.java</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">EventStoreRepository</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// イベントを保存</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">aggregateId</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DomainEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">events</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">expectedVersion</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Aggregate のすべてのイベントを取得</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DomainEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getEvents</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">aggregateId</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 特定時点までのイベントを取得</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DomainEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getEventsUntil</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">aggregateId</span><span class="p">,</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">pointInTime</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Aggregate の現在のバージョンを取得</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">getCurrentVersion</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">aggregateId</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// infrastructure/persistence/EventStoreRepositoryImpl.java</span>
<span class="nd">@Repository</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">EventStoreRepositoryImpl</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">EventStoreRepository</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">EventStoreMapper</span><span class="w"> </span><span class="n">eventStoreMapper</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ObjectMapper</span><span class="w"> </span><span class="n">objectMapper</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="nd">@Transactional</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">aggregateId</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DomainEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">events</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">expectedVersion</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">currentVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCurrentVersion</span><span class="p">(</span><span class="n">aggregateId</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">currentVersion</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">expectedVersion</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentModificationException</span><span class="p">(</span>
<span class="w">                </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;Expected version %d but was %d&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">expectedVersion</span><span class="p">,</span><span class="w"> </span><span class="n">currentVersion</span><span class="p">)</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">sequenceNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">currentVersion</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">DomainEvent</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">events</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">eventData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toJson</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>

<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">eventStoreMapper</span><span class="p">.</span><span class="na">insertEvent</span><span class="p">(</span>
<span class="w">                    </span><span class="n">aggregateId</span><span class="p">,</span>
<span class="w">                    </span><span class="s">&quot;JournalEntry&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">event</span><span class="p">.</span><span class="na">getEventType</span><span class="p">(),</span>
<span class="w">                    </span><span class="n">event</span><span class="p">.</span><span class="na">getEventVersion</span><span class="p">(),</span>
<span class="w">                    </span><span class="n">eventData</span><span class="p">,</span>
<span class="w">                    </span><span class="n">event</span><span class="p">.</span><span class="na">getOccurredAt</span><span class="p">(),</span>
<span class="w">                    </span><span class="n">event</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span>
<span class="w">                    </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="c1">// correlation_id</span>
<span class="w">                    </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="c1">// causation_id</span>
<span class="w">                    </span><span class="n">sequenceNumber</span>
<span class="w">                </span><span class="p">);</span>
<span class="w">                </span><span class="n">sequenceNumber</span><span class="o">++</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">DuplicateKeyException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentModificationException</span><span class="p">(</span>
<span class="w">                    </span><span class="s">&quot;Concurrent modification detected for aggregate: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">aggregateId</span><span class="p">,</span><span class="w"> </span><span class="n">e</span>
<span class="w">                </span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DomainEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getEvents</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">aggregateId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">EventStoreEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">entities</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">eventStoreMapper</span><span class="p">.</span><span class="na">selectEventsByAggregateId</span><span class="p">(</span><span class="n">aggregateId</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">entities</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="k">this</span><span class="p">::</span><span class="n">toDomainEvent</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">toList</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DomainEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getEventsUntil</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">aggregateId</span><span class="p">,</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">pointInTime</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">EventStoreEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">entities</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">eventStoreMapper</span><span class="p">.</span><span class="na">selectEventsByAggregateIdUntil</span><span class="p">(</span><span class="n">aggregateId</span><span class="p">,</span><span class="w"> </span><span class="n">pointInTime</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">entities</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="k">this</span><span class="p">::</span><span class="n">toDomainEvent</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">toList</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getCurrentVersion</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">aggregateId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Integer</span><span class="w"> </span><span class="n">maxSequence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eventStoreMapper</span><span class="p">.</span><span class="na">selectMaxSequenceNumber</span><span class="p">(</span><span class="n">aggregateId</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">maxSequence</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">maxSequence</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">DomainEvent</span><span class="w"> </span><span class="nf">toDomainEvent</span><span class="p">(</span><span class="n">EventStoreEntity</span><span class="w"> </span><span class="n">entity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">entity</span><span class="p">.</span><span class="na">getEventType</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;JournalEntryCreatedEvent&quot;</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="n">objectMapper</span><span class="p">.</span><span class="na">readValue</span><span class="p">(</span><span class="n">entity</span><span class="p">.</span><span class="na">getEventData</span><span class="p">(),</span>
<span class="w">                        </span><span class="n">JournalEntryCreatedEvent</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;JournalEntryApprovedEvent&quot;</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="n">objectMapper</span><span class="p">.</span><span class="na">readValue</span><span class="p">(</span><span class="n">entity</span><span class="p">.</span><span class="na">getEventData</span><span class="p">(),</span>
<span class="w">                        </span><span class="n">JournalEntryApprovedEvent</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;JournalEntryCancelledEvent&quot;</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="n">objectMapper</span><span class="p">.</span><span class="na">readValue</span><span class="p">(</span><span class="n">entity</span><span class="p">.</span><span class="na">getEventData</span><span class="p">(),</span>
<span class="w">                        </span><span class="n">JournalEntryCancelledEvent</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="w">                </span><span class="k">default</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span>
<span class="w">                        </span><span class="s">&quot;Unknown event type: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">entity</span><span class="p">.</span><span class="na">getEventType</span><span class="p">());</span>
<span class="w">            </span><span class="p">};</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">JsonProcessingException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Failed to deserialize event&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="314-cqrs">31.4 CQRS パターン<a class="headerlink" href="#314-cqrs" title="Permanent link">&para;</a></h2>
<h3 id="cqrs">CQRS とは<a class="headerlink" href="#cqrs" title="Permanent link">&para;</a></h3>
<p>CQRS（Command Query Responsibility Segregation）は、データの「書き込み（Command）」と「読み取り（Query）」を分離するアーキテクチャパターンです。イベントソーシングと組み合わせることで、高いスケーラビリティと柔軟性を実現できます。</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjUzNnB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6ODUzcHg7aGVpZ2h0OjUzNnB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDg1MyA1MzYiIHdpZHRoPSI4NTNweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PHRpdGxlPkNRUlMgJiMxMjQ1MDsmIzEyNTQwOyYjMTI0NjE7JiMxMjQ4NjsmIzEyNDYzOyYjMTI0ODE7JiMxMjUxNTs8L3RpdGxlPjxkZWZzLz48Zz48ZyBjbGFzcz0idGl0bGUiIGRhdGEtc291cmNlLWxpbmU9IjEiPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNDUuOTEyNyIgeD0iMzQ2LjYwODciIHk9IjIyLjk5NTEiPkNRUlMgJiMxMjQ1MDsmIzEyNTQwOyYjMTI0NjE7JiMxMjQ4NjsmIzEyNDYzOyYjMTI0ODE7JiMxMjUxNTs8L3RleHQ+PC9nPjwhLS1jbHVzdGVyIGNvbW1hbmQtLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9ImNvbW1hbmQiIGRhdGEtc291cmNlLWxpbmU9IjYiIGRhdGEtdWlkPSJlbnQwMDAzIiBpZD0iY2x1c3Rlcl9jb21tYW5kIj48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjE4MCIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjM3Ni4zOSIgeD0iMjE5IiB5PSIyNzAuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTcuNzc2NCIgeD0iMzQ4LjMwNjgiIHk9IjI4NS4yOTIiPkNvbW1hbmQgU2lkZTwvdGV4dD48L2c+PCEtLWNsdXN0ZXIgcXVlcnktLT48ZyBjbGFzcz0iY2x1c3RlciIgZGF0YS1lbnRpdHk9InF1ZXJ5IiBkYXRhLXNvdXJjZS1saW5lPSIxMiIgZGF0YS11aWQ9ImVudDAwMDciIGlkPSJjbHVzdGVyX3F1ZXJ5Ij48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjE4MCIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjM4NC45MyIgeD0iNDYyLjIiIHk9IjQ0LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODYuNjY2IiB4PSI2MTEuMzMyIiB5PSI1OS4yOTIiPlF1ZXJ5IFNpZGU8L3RleHQ+PC9nPjwhLS1lbnRpdHkgPz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSIuLi4uIiBkYXRhLXNvdXJjZS1saW5lPSI3IiBkYXRhLXVpZD0iZW50MDAwNCIgaWQ9ImVudGl0eV8uLi4uIj48ZWxsaXBzZSBjeD0iMjg1LjU5NzgiIGN5PSIzOTIuMzAwNSIgZmlsbD0iI0YxRjFGMSIgcng9IjQyLjU5NzgiIHJ5PSIxNC41MjM2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1NS45OTk4IiB4PSIyNTcuNTk3OSIgeT0iMzk2Ljk0ODkiPiYjMjAxODE7JiMzNTM3OTsmIzIwMzE2OyYjMjUxMDQ7PC90ZXh0PjwvZz48IS0tZW50aXR5ID8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iOCIgZGF0YS11aWQ9ImVudDAwMDUiIGlkPSJlbnRpdHlfLi4uLiI+PGVsbGlwc2UgY3g9IjI4NS41OTc4IiBjeT0iMzI4LjMwMDUiIGZpbGw9IiNGMUYxRjEiIHJ4PSI0Mi41OTc4IiByeT0iMTQuNTIzNiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTUuOTk5OCIgeD0iMjU3LjU5NzkiIHk9IjMzMi45NDg5Ij4mIzIwMTgxOyYjMzUzNzk7JiMyNTIxNTsmIzM1NDY5OzwvdGV4dD48L2c+PCEtLWVudGl0eSA/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ii4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjkiIGRhdGEtdWlkPSJlbnQwMDA2IiBpZD0iZW50aXR5Xy4uLi4iPjxlbGxpcHNlIGN4PSI1MjguNzg3OCIgY3k9IjM5Mi4zMDA1IiBmaWxsPSIjRjFGMUYxIiByeD0iNDIuNTk3OCIgcnk9IjE0LjUyMzYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjU1Ljk5OTgiIHg9IjUwMC43ODc5IiB5PSIzOTYuOTQ4OSI+JiMyMDE4MTsmIzM1Mzc5OyYjMjE0NjI7JiMyODA0MDs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgPz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSIuLi4uIiBkYXRhLXNvdXJjZS1saW5lPSIxMyIgZGF0YS11aWQ9ImVudDAwMDgiIGlkPSJlbnRpdHlfLi4uLiI+PGVsbGlwc2UgY3g9IjUyOC43ODc4IiBjeT0iMTY2LjMwMDUiIGZpbGw9IiNGMUYxRjEiIHJ4PSI0Mi41OTc4IiByeT0iMTQuNTIzNiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTUuOTk5OCIgeD0iNTAwLjc4NzkiIHk9IjE3MC45NDg5Ij4mIzIwMTgxOyYjMzUzNzk7JiMxOTk2ODsmIzM1MjM5OzwvdGV4dD48L2c+PCEtLWVudGl0eSA/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ii4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjE0IiBkYXRhLXVpZD0iZW50MDAwOSIgaWQ9ImVudGl0eV8uLi4uIj48ZWxsaXBzZSBjeD0iNTI4Ljc4NzgiIGN5PSIxMDIuMzAwNSIgZmlsbD0iI0YxRjFGMSIgcng9IjQyLjU5NzgiIHJ5PSIxNC41MjM2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1NS45OTk4IiB4PSI1MDAuNzg3OSIgeT0iMTA2Ljk0ODkiPiYjMjc1MzE7JiMzOTY0MDsmIzI5MDMxOyYjMjAyNTA7PC90ZXh0PjwvZz48IS0tZW50aXR5ID8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTUiIGRhdGEtdWlkPSJlbnQwMDEwIiBpZD0iZW50aXR5Xy4uLi4iPjxlbGxpcHNlIGN4PSI3ODAuNTM3OCIgY3k9IjE2Ni4zMDA1IiBmaWxsPSIjRjFGMUYxIiByeD0iNDIuNTk3OCIgcnk9IjE0LjUyMzYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjU1Ljk5OTgiIHg9Ijc1Mi41Mzc5IiB5PSIxNzAuOTQ4OSI+JiMyMDgwMzsmIzI0MTE1OyYjMjkwMzE7JiMyMDI1MDs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgY2xpZW50LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9ImNsaWVudCIgZGF0YS1zb3VyY2UtbGluZT0iNCIgZGF0YS11aWQ9ImVudDAwMDIiIGlkPSJlbnRpdHlfY2xpZW50Ij48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjEwMy45OTk2IiB4PSI3IiB5PSIzMDguMTQ2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjgzLjk5OTYiIHg9IjE3IiB5PSIzMzEuMTQyIj4mIzEyNDYzOyYjMTI1MjE7JiMxMjQ1MjsmIzEyNDUwOyYjMTI1MzE7JiMxMjQ4ODs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgZXMtLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iZXMiIGRhdGEtc291cmNlLWxpbmU9IjE4IiBkYXRhLXVpZD0iZW50MDAxMSIgaWQ9ImVudGl0eV9lcyI+PHBhdGggZD0iTTQ3Ny44Niw0ODQuNjQ2OSBDNDc3Ljg2LDQ3NC42NDY5IDUyOC43OTM2LDQ3NC42NDY5IDUyOC43OTM2LDQ3NC42NDY5IEM1MjguNzkzNiw0NzQuNjQ2OSA1NzkuNzI3Miw0NzQuNjQ2OSA1NzkuNzI3Miw0ODQuNjQ2OSBMNTc5LjcyNzIsNTA5Ljk0MzcgQzU3OS43MjcyLDUxOS45NDM3IDUyOC43OTM2LDUxOS45NDM3IDUyOC43OTM2LDUxOS45NDM3IEM1MjguNzkzNiw1MTkuOTQzNyA0NzcuODYsNTE5Ljk0MzcgNDc3Ljg2LDUwOS45NDM3IEw0NzcuODYsNDg0LjY0NjkiIGZpbGw9IiNGMUYxRjEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik00NzcuODYsNDg0LjY0NjkgQzQ3Ny44Niw0OTQuNjQ2OSA1MjguNzkzNiw0OTQuNjQ2OSA1MjguNzkzNiw0OTQuNjQ2OSBDNTI4Ljc5MzYsNDk0LjY0NjkgNTc5LjcyNzIsNDk0LjY0NjkgNTc5LjcyNzIsNDg0LjY0NjkiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjgxLjg2NzIiIHg9IjQ4Ny44NiIgeT0iNTExLjY0MiI+RXZlbnQgU3RvcmU8L3RleHQ+PC9nPjwhLS1lbnRpdHkgcm0tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0icm0iIGRhdGEtc291cmNlLWxpbmU9IjE5IiBkYXRhLXVpZD0iZW50MDAxMiIgaWQ9ImVudGl0eV9ybSI+PHBhdGggZD0iTTcyOS4zOSwzNDUuNjQ2OSBDNzI5LjM5LDMzNS42NDY5IDc4MC41MzU1LDMzNS42NDY5IDc4MC41MzU1LDMzNS42NDY5IEM3ODAuNTM1NSwzMzUuNjQ2OSA4MzEuNjgxLDMzNS42NDY5IDgzMS42ODEsMzQ1LjY0NjkgTDgzMS42ODEsMzcwLjk0MzcgQzgzMS42ODEsMzgwLjk0MzcgNzgwLjUzNTUsMzgwLjk0MzcgNzgwLjUzNTUsMzgwLjk0MzcgQzc4MC41MzU1LDM4MC45NDM3IDcyOS4zOSwzODAuOTQzNyA3MjkuMzksMzcwLjk0MzcgTDcyOS4zOSwzNDUuNjQ2OSIgZmlsbD0iI0YxRjFGMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHBhdGggZD0iTTcyOS4zOSwzNDUuNjQ2OSBDNzI5LjM5LDM1NS42NDY5IDc4MC41MzU1LDM1NS42NDY5IDc4MC41MzU1LDM1NS42NDY5IEM3ODAuNTM1NSwzNTUuNjQ2OSA4MzEuNjgxLDM1NS42NDY5IDgzMS42ODEsMzQ1LjY0NjkiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjgyLjI5MSIgeD0iNzM5LjM5IiB5PSIzNzIuNjQyIj5SZWFkIE1vZGVsPC90ZXh0PjwvZz48IS0tbGluayBjbGllbnQgdG8gY29tbWFuZC0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJjbGllbnQiIGRhdGEtZW50aXR5LTI9ImNvbW1hbmQiIGRhdGEtc291cmNlLWxpbmU9IjIxIiBkYXRhLXVpZD0ibG5rMTMiIGlkPSJsaW5rX2NsaWVudF9jb21tYW5kIj48cGF0aCBkPSJNODEuNzUsMzQ0Ljg2NjkgQzEwOC41NSwzNjYuNzg2OSAxNTYuMjgsNDAyLjg1NjkgMjAzLDQyMy4yOTY5IEMyMDcuMTMxMyw0MjUuMTA0NCAyMTEuNDU4NCw0MjYuNzUyOCAyMTUuODczNSw0MjguMjU0MiBDMjE2LjQyNTQsNDI4LjQ0MTkgMjE2Ljk3ODcsNDI4LjYyNzIgMjE3LjUzMzEsNDI4LjgxMDMgQzIxNy44MTAzLDQyOC45MDE5IDIxOC4wODc4LDQyOC45OTI5IDIxOC4zNjU2LDQyOS4wODMzIEMyMTguNTA0NSw0MjkuMTI4NSAyMTIuOTM0Miw0MjcuMzI4NSAyMTMuMDczMiw0MjcuMzczNCIgZmlsbD0ibm9uZSIgaWQ9ImNsaWVudC10by1jb21tYW5kIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyMTguNzgyNCw0MjkuMjE4NSwyMTEuNDQ4Niw0MjIuNjQ0NywyMTQuMDI0Nyw0MjcuNjgwOSwyMDguOTg4NSw0MzAuMjU3LDIxOC43ODI0LDQyOS4yMTg1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTIuMDAwMSIgeD0iMTQyIiB5PSIzODQuODQzOCI+JiMxMjQ2NzsmIzEyNTEwOyYjMTI1MzE7JiMxMjQ4OTs8L3RleHQ+PC9nPjwhLS1saW5rIGNsaWVudCB0byBxdWVyeS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJjbGllbnQiIGRhdGEtZW50aXR5LTI9InF1ZXJ5IiBkYXRhLXNvdXJjZS1saW5lPSIyMiIgZGF0YS11aWQ9ImxuazE0IiBpZD0ibGlua19jbGllbnRfcXVlcnkiPjxwYXRoIGQ9Ik0xMTEuNCwzMTQuMjA2OSBDMTcxLjY4NSwzMDAuMDMxOSAyNzQuNjM1LDI3NS44MjQ0IDM2My4wODEzLDI1NS4wMjY5IEM0MDcuMzA0NCwyNDQuNjI4MSA0NDcuOTAxNiwyMzUuMDgxOSA0NzcuNzI2NywyMjguMDY4NCBDNDgxLjQ1NDksMjI3LjE5MTggNDg1LjAxNDcsMjI2LjM1NDcgNDg4LjM5MjMsMjI1LjU2MDQgQzQ5MC4wODEsMjI1LjE2MzMgNDg1Ljg4MzYsMjI2LjE1MDMgNDg3LjQ3OTUsMjI1Ljc3NTEiIGZpbGw9Im5vbmUiIGlkPSJjbGllbnQtdG8tcXVlcnkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjQ5My4zMjAyLDIyNC40MDE2LDQ4My42NDM1LDIyMi41NjgsNDg4LjQ1MjksMjI1LjU0NjEsNDg1LjQ3NDgsMjMwLjM1NTYsNDkzLjMyMDIsMjI0LjQwMTYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIzOSIgeD0iMjY2LjEiIHk9IjI2MC4wNTM4Ij4mIzEyNDYzOyYjMTI0NTY7JiMxMjUyMjs8L3RleHQ+PC9nPjwhLS1saW5rIGNvbW1hbmQgdG8gZXMtLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iY29tbWFuZCIgZGF0YS1lbnRpdHktMj0iZXMiIGRhdGEtc291cmNlLWxpbmU9IjI0IiBkYXRhLXVpZD0ibG5rMTUiIGlkPSJsaW5rX2NvbW1hbmRfZXMiPjxwYXRoIGQ9Ik0zMjIuMjY3Miw0NTAuNDM0MyBDMzIyLjc1MDgsNDUwLjU0NDYgMzIzLjIzODIsNDUwLjY1NTcgMzIzLjcyOTEsNDUwLjc2NzcgQzMyNS42OTI5LDQ1MS4yMTU2IDMyNy43MTQ3LDQ1MS42NzY2IDMyOS43ODk0LDQ1Mi4xNDk3IEMzMzguMDg4MSw0NTQuMDQyMyAzNDcuMjMzOCw0NTYuMTI3OCAzNTYuOTA1LDQ1OC4zMzMxIEMzOTUuNTksNDY3LjE1NDQgNDM2LjgzNSw0NzYuNTU4NSA0NzEuNzgsNDg0LjUyMzUiIGZpbGw9Im5vbmUiIGlkPSJjb21tYW5kLXRvLWVzIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI0NzcuNjMsNDg1Ljg1NjksNDY5Ljc0NCw0NzkuOTU2OCw0NzIuNzU1LDQ4NC43NDU3LDQ2Ny45NjYxLDQ4Ny43NTY4LDQ3Ny42Myw0ODUuODU2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc4LjAwMDEiIHg9IjM1OS4yIiB5PSI0NTYuMTUzOCI+JiMxMjQ1MjsmIzEyNTA1OyYjMTI1MzE7JiMxMjQ4ODsmIzIwNDQ1OyYjMjMzODQ7PC90ZXh0PjwvZz48IS0tbGluayBlcyB0byBybS0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJlcyIgZGF0YS1lbnRpdHktMj0icm0iIGRhdGEtc291cmNlLWxpbmU9IjI1IiBkYXRhLXVpZD0ibG5rMTYiIGlkPSJsaW5rX2VzX3JtIj48cGF0aCBkPSJNNTcxLjMxLDQ3NC4xODY5IEM2MTcuNjQsNDQ4LjQwNjkgNjg2Ljg4NzYsNDA5Ljg2NTQgNzMzLjA4NzYsMzg0LjE0NTQiIGZpbGw9Im5vbmUiIGlkPSJlcy10by1ybSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNzM4LjMzLDM4MS4yMjY5LDcyOC41MjA4LDM4Mi4xMDk3LDczMy45NjE0LDM4My42NTg5LDczMi40MTIxLDM4OS4wOTk1LDczOC4zMywzODEuMjI2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc4LjAwMDEiIHg9IjYyMC4zOSIgeT0iMzk5LjMyMzgiPiYjMTI0NTI7JiMxMjUwNTsmIzEyNTMxOyYjMTI0ODg7JiMyMTUxNjsmIzI2Mzk5OzwvdGV4dD48L2c+PCEtLWxpbmsgcXVlcnkgdG8gcm0tLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0icXVlcnkiIGRhdGEtZW50aXR5LTI9InJtIiBkYXRhLXNvdXJjZS1saW5lPSIyNiIgZGF0YS11aWQ9ImxuazE3IiBpZD0ibGlua19xdWVyeV9ybSI+PHBhdGggZD0iTTU0NC4xODg0LDIyNC40ODUxIEM1NDcuMDUyOCwyMjYuMTEzNyA1NTAuMjkxOCwyMjcuOTU1NCA1NTMuODU2NywyMjkuOTgyMyBDNTY4LjExNjYsMjM4LjA5MDMgNTg3LjU5MTksMjQ5LjE2MzcgNjA5LjE2NjMsMjYxLjQzMDYgQzY1Mi4zMTUsMjg1Ljk2NDQgNjk4LjY0NDEsMzEyLjMwNjQgNzMzLjY1NDEsMzMyLjIxMTQiIGZpbGw9Im5vbmUiIGlkPSJxdWVyeS10by1ybSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNzM4Ljg3LDMzNS4xNzY5LDczMy4wMjMxLDMyNy4yNTEzLDczNC41MjM0LDMzMi43MDU2LDcyOS4wNjkxLDMzNC4yMDU5LDczOC44NywzMzUuMTc2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjUyLjAwMDEiIHg9IjYzMy4zOSIgeT0iMjY2LjQ3MzgiPiYjMzU1MDE7JiMxMjQxNTsmIzIxNDYyOyYjMTI0MjY7PC90ZXh0PjwvZz48IS0tU1JDPVtOUDNESWlEMDU4TnR5bkgzTHRSSDV0M1hmaFhxcVVPOW5jUWlXVm5XQ1hMNDE5a1hhbGczdElYTGdlOE1Nb0VuWXUwS2hFSFhSWEJaTXBYOXNoSHJEc1ZFa0hfdDdnT21iVTlnaEl2WGk5LTFweTNzVzktMUZHN1UxbHcyTEJoN0MzRW1nSkp0NlBPTGFwUU9Pa1c4ZkctWUR5THFBS2tfV0p0QzQzdm1mdUk5WEhrZ0dkTXNiZ21RY2FQcTZLa0FKRkZDX0VDT1JPSFZEeWRPM3h5N2lUQ2hCc0pTM0hCdGdmM0h6TXR5d1BKSG9IZ3JyZ0JjcVA5dmFDYWJTTmdRbDh1NDhsd3UtN3RsX3RINnVVblVvQVozZXdjX2E4OGU0cVBzWUlNMHN1VFlTSW1ubXlvOXI1ZW53dko4VUNVR2dQZnZmZVBHVllja0xCUUFXcFA1ZHdBOW53b0Z4Y2VZTm9fcjlzMkZXUmpZVlp3S3NqSkFsMjdta3hwQkM3WThsM3VJX3dialFsX2lnN1NQM3Z2R0pZcUlZVWoxRW4xcldOdC0xbTAwXS0tPjwvZz48L3N2Zz4=" class="uml" alt="uml diagram" title="" /></p>
<h3 id="command-side">Command Side の実装<a class="headerlink" href="#command-side" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// application/service/JournalEntryCommandService.java</span>
<span class="nd">@Service</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JournalEntryCommandService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">EventStoreRepository</span><span class="w"> </span><span class="n">eventStoreRepository</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ApplicationEventPublisher</span><span class="w"> </span><span class="n">eventPublisher</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Transactional</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">createJournalEntry</span><span class="p">(</span><span class="n">CreateJournalEntryCommand</span><span class="w"> </span><span class="n">command</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">();</span>

<span class="w">        </span><span class="n">JournalEntryAggregate</span><span class="w"> </span><span class="n">aggregate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JournalEntryAggregate</span><span class="p">.</span><span class="na">create</span><span class="p">(</span>
<span class="w">            </span><span class="n">id</span><span class="p">,</span>
<span class="w">            </span><span class="n">command</span><span class="p">.</span><span class="na">getEntryDate</span><span class="p">(),</span>
<span class="w">            </span><span class="n">command</span><span class="p">.</span><span class="na">getDescription</span><span class="p">(),</span>
<span class="w">            </span><span class="n">command</span><span class="p">.</span><span class="na">getLineItems</span><span class="p">(),</span>
<span class="w">            </span><span class="n">command</span><span class="p">.</span><span class="na">getUserId</span><span class="p">()</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="c1">// イベントをイベントストアに保存</span>
<span class="w">        </span><span class="n">eventStoreRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span>
<span class="w">            </span><span class="n">id</span><span class="p">,</span>
<span class="w">            </span><span class="n">aggregate</span><span class="p">.</span><span class="na">getUncommittedEvents</span><span class="p">(),</span>
<span class="w">            </span><span class="mi">0</span><span class="w">  </span><span class="c1">// 新規作成なので expectedVersion = 0</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 読み取りモデル更新のためにイベントを発行</span>
<span class="w">        </span><span class="n">aggregate</span><span class="p">.</span><span class="na">getUncommittedEvents</span><span class="p">().</span><span class="na">forEach</span><span class="p">(</span><span class="n">eventPublisher</span><span class="p">::</span><span class="n">publishEvent</span><span class="p">);</span>
<span class="w">        </span><span class="n">aggregate</span><span class="p">.</span><span class="na">markEventsAsCommitted</span><span class="p">();</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Transactional</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">approveJournalEntry</span><span class="p">(</span><span class="n">ApproveJournalEntryCommand</span><span class="w"> </span><span class="n">command</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DomainEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">events</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eventStoreRepository</span><span class="p">.</span><span class="na">getEvents</span><span class="p">(</span><span class="n">command</span><span class="p">.</span><span class="na">getJournalEntryId</span><span class="p">());</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">events</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JournalNotFoundException</span><span class="p">(</span><span class="n">command</span><span class="p">.</span><span class="na">getJournalEntryId</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">JournalEntryAggregate</span><span class="w"> </span><span class="n">aggregate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JournalEntryAggregate</span><span class="p">.</span><span class="na">replay</span><span class="p">(</span><span class="n">events</span><span class="p">);</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">currentVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aggregate</span><span class="p">.</span><span class="na">getVersion</span><span class="p">();</span>

<span class="w">        </span><span class="n">aggregate</span><span class="p">.</span><span class="na">approve</span><span class="p">(</span><span class="n">command</span><span class="p">.</span><span class="na">getApprovedBy</span><span class="p">(),</span><span class="w"> </span><span class="n">command</span><span class="p">.</span><span class="na">getComment</span><span class="p">());</span>

<span class="w">        </span><span class="n">eventStoreRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span>
<span class="w">            </span><span class="n">command</span><span class="p">.</span><span class="na">getJournalEntryId</span><span class="p">(),</span>
<span class="w">            </span><span class="n">aggregate</span><span class="p">.</span><span class="na">getUncommittedEvents</span><span class="p">(),</span>
<span class="w">            </span><span class="n">currentVersion</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="n">aggregate</span><span class="p">.</span><span class="na">getUncommittedEvents</span><span class="p">().</span><span class="na">forEach</span><span class="p">(</span><span class="n">eventPublisher</span><span class="p">::</span><span class="n">publishEvent</span><span class="p">);</span>
<span class="w">        </span><span class="n">aggregate</span><span class="p">.</span><span class="na">markEventsAsCommitted</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="query-side">Query Side（読み取りモデル）の実装<a class="headerlink" href="#query-side" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// infrastructure/projection/JournalEntryProjection.java</span>
<span class="nd">@Component</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JournalEntryProjection</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">JournalEntryReadModelRepository</span><span class="w"> </span><span class="n">readModelRepository</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@EventListener</span>
<span class="w">    </span><span class="nd">@Transactional</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">on</span><span class="p">(</span><span class="n">JournalEntryCreatedEvent</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">JournalEntryReadModel</span><span class="w"> </span><span class="n">readModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JournalEntryReadModel</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">journalEntryId</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">getJournalEntryId</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">entryDate</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">getEntryDate</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">description</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">getDescription</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="s">&quot;DRAFT&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">totalDebit</span><span class="p">(</span><span class="n">calculateTotalDebit</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">getLineItems</span><span class="p">()))</span>
<span class="w">            </span><span class="p">.</span><span class="na">totalCredit</span><span class="p">(</span><span class="n">calculateTotalCredit</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">getLineItems</span><span class="p">()))</span>
<span class="w">            </span><span class="p">.</span><span class="na">createdAt</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">getOccurredAt</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">createdBy</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">getUserId</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>

<span class="w">        </span><span class="n">readModelRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">readModel</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@EventListener</span>
<span class="w">    </span><span class="nd">@Transactional</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">on</span><span class="p">(</span><span class="n">JournalEntryApprovedEvent</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">readModelRepository</span><span class="p">.</span><span class="na">updateStatus</span><span class="p">(</span>
<span class="w">            </span><span class="n">event</span><span class="p">.</span><span class="na">getJournalEntryId</span><span class="p">(),</span>
<span class="w">            </span><span class="s">&quot;APPROVED&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">event</span><span class="p">.</span><span class="na">getApprovedBy</span><span class="p">(),</span>
<span class="w">            </span><span class="n">event</span><span class="p">.</span><span class="na">getOccurredAt</span><span class="p">()</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@EventListener</span>
<span class="w">    </span><span class="nd">@Transactional</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">on</span><span class="p">(</span><span class="n">JournalEntryCancelledEvent</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">readModelRepository</span><span class="p">.</span><span class="na">updateStatus</span><span class="p">(</span>
<span class="w">            </span><span class="n">event</span><span class="p">.</span><span class="na">getJournalEntryId</span><span class="p">(),</span>
<span class="w">            </span><span class="s">&quot;CANCELLED&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">event</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span>
<span class="w">            </span><span class="n">event</span><span class="p">.</span><span class="na">getOccurredAt</span><span class="p">()</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_10">読み取りモデルのテーブル<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- 読み取り専用モデル（非正規化）</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">journal_entry_read_model</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">journal_entry_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">entry_date</span><span class="w"> </span><span class="nb">DATE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">description</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span>
<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">total_debit</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">total_credit</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_by</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">approved_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">,</span>
<span class="w">    </span><span class="n">approved_by</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
<span class="w">    </span><span class="n">cancelled_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="p">,</span>
<span class="w">    </span><span class="n">cancelled_by</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="p">);</span>

<span class="c1">-- 検索用インデックス</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_journal_read_entry_date</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">journal_entry_read_model</span><span class="p">(</span><span class="n">entry_date</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_journal_read_status</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">journal_entry_read_model</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
</code></pre></div>
<h3 id="query-service">Query Service<a class="headerlink" href="#query-service" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// application/service/JournalEntryQueryService.java</span>
<span class="nd">@Service</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JournalEntryQueryService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">JournalEntryReadModelRepository</span><span class="w"> </span><span class="n">readModelRepository</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">JournalEntryReadModel</span><span class="w"> </span><span class="nf">getJournalEntry</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">journalEntryId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">readModelRepository</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">journalEntryId</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JournalNotFoundException</span><span class="p">(</span><span class="n">journalEntryId</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">JournalEntryReadModel</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">searchJournalEntries</span><span class="p">(</span>
<span class="w">            </span><span class="n">LocalDate</span><span class="w"> </span><span class="n">fromDate</span><span class="p">,</span>
<span class="w">            </span><span class="n">LocalDate</span><span class="w"> </span><span class="n">toDate</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">readModelRepository</span><span class="p">.</span><span class="na">search</span><span class="p">(</span><span class="n">fromDate</span><span class="p">,</span><span class="w"> </span><span class="n">toDate</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">JournalEntryReadModel</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getPendingApprovals</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">readModelRepository</span><span class="p">.</span><span class="na">findByStatus</span><span class="p">(</span><span class="s">&quot;DRAFT&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="315">31.5 スナップショットと最適化<a class="headerlink" href="#315" title="Permanent link">&para;</a></h2>
<h3 id="_11">スナップショットの必要性<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<p>イベント数が増加すると、毎回すべてのイベントを再生するのはパフォーマンス上の問題になります。スナップショットを使用することで、この問題を解決できます。</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjIzOXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6Nzg4cHg7aGVpZ2h0OjIzOXB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDc4OCAyMzkiIHdpZHRoPSI3ODhweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PHRpdGxlPiYjMTI0NzM7JiMxMjQ5MDsmIzEyNDgzOyYjMTI1MDM7JiMxMjQ3MTsmIzEyNTE5OyYjMTI0ODM7JiMxMjQ4ODsmIzEyMzk1OyYjMTI0MjQ7JiMxMjQyNzsmIzI2MzY4OyYjMzY5Njk7JiMyMTI3MDs8L3RpdGxlPjxkZWZzLz48Zz48ZyBjbGFzcz0idGl0bGUiIGRhdGEtc291cmNlLWxpbmU9IjEiPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxOTUuOTk5MSIgeD0iMjg5LjE3MzEiIHk9IjIyLjk5NTEiPiYjMTI0NzM7JiMxMjQ5MDsmIzEyNDgzOyYjMTI1MDM7JiMxMjQ3MTsmIzEyNTE5OyYjMTI0ODM7JiMxMjQ4ODsmIzEyMzk1OyYjMTI0MjQ7JiMxMjQyNzsmIzI2MzY4OyYjMzY5Njk7JiMyMTI3MDs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgd2l0aG91dC0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJ3aXRob3V0IiBkYXRhLXNvdXJjZS1saW5lPSI0IiBkYXRhLXVpZD0iZW50MDAwMiIgaWQ9ImVudGl0eV93aXRob3V0Ij48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjE1OS45OTk0IiB4PSI3IiB5PSIxMTUuOTc2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzOS45OTk0IiB4PSIxNyIgeT0iMTM4Ljk3MiI+JiMxMjQ3MzsmIzEyNDkwOyYjMTI0ODM7JiMxMjUwMzsmIzEyNDcxOyYjMTI1MTk7JiMxMjQ4MzsmIzEyNDg4OyYjMTIzOTQ7JiMxMjM3NTs8L3RleHQ+PC9nPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSJHTU4zIiBkYXRhLXNvdXJjZS1saW5lPSI2IiBkYXRhLXVpZD0iZW50MDAwNCIgaWQ9ImVudGl0eV9HTU4zIj48cGF0aCBkPSJNMzQ2LDQzLjI5NjkgTDM0Niw5NC44MDY5IEwxNjcuNDMsMTIzLjIzNjkgTDM0NiwxMDIuODA2OSBMMzQ2LDEyOC45NjA5IEEwLDAgMCAwIDAgMzQ2LDEyOC45NjA5IEw1MzIuMTA5LDEyOC45NjA5IEEwLDAgMCAwIDAgNTMyLjEwOSwxMjguOTYwOSBMNTMyLjEwOSw1My4yOTY5IEw1MjIuMTA5LDQzLjI5NjkgTDM0Niw0My4yOTY5IEEwLDAgMCAwIDAgMzQ2LDQzLjI5NjkiIGZpbGw9IiNGRUZGREQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik01MjIuMTA5LDQzLjI5NjkgTDUyMi4xMDksNTMuMjk2OSBMNTMyLjEwOSw1My4yOTY5IEw1MjIuMTA5LDQzLjI5NjkiIGZpbGw9IiNGRUZGREQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQ5LjY0NSIgeD0iMzUyIiB5PSI2MC4zNjM4Ij5FdmVudCAxPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQ5LjY0NSIgeD0iMzUyIiB5PSI3NS40OTY2Ij5FdmVudCAyPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjMwLjA0MzUiIHg9IjM1MiIgeT0iOTAuNjI5NCI+LSAuLi4gLTwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI3NC40NTgiIHg9IjM1MiIgeT0iMTA1Ljc2MjIiPkV2ZW50IDEwMDA8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTY1LjEwOSIgeD0iMzUyIiB5PSIxMjAuODk1Ij4mIzg1OTQ7IDEwMDAmIzEyNDUyOyYjMTI1MDU7JiMxMjUzMTsmIzEyNDg4OyYjMTI0MzQ7JiMyNzU5ODsmIzIyMjM4OyYjMjA4Nzc7JiMyOTk4Mzs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgd2l0aFNuYXBzaG90LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IndpdGhTbmFwc2hvdCIgZGF0YS1zb3VyY2UtbGluZT0iMTMiIGRhdGEtdWlkPSJlbnQwMDA2IiBpZD0iZW50aXR5X3dpdGhTbmFwc2hvdCI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNTkuOTk5NCIgeD0iMzU5LjA1IiB5PSIxNjMuOTc2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzOS45OTk0IiB4PSIzNjkuMDUiIHk9IjE4Ni45NzIiPiYjMTI0NzM7JiMxMjQ5MDsmIzEyNDgzOyYjMTI1MDM7JiMxMjQ3MTsmIzEyNTE5OyYjMTI0ODM7JiMxMjQ4ODsmIzEyMzU0OyYjMTI0MjY7PC90ZXh0PjwvZz48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iR01ONyIgZGF0YS1zb3VyY2UtbGluZT0iMTUiIGRhdGEtdWlkPSJlbnQwMDA4IiBpZD0iZW50aXR5X0dNTjciPjxwYXRoIGQ9Ik01OTMuMTEsMTMxLjcyNjkgTDU5My4xMSwxNzguMTI2OSBMNTE5LjMsMTgyLjEyNjkgTDU5My4xMSwxODYuMTI2OSBMNTkzLjExLDIzMi41MjM4IEEwLDAgMCAwIDAgNTkzLjExLDIzMi41MjM4IEw3ODEuMzQ1NCwyMzIuNTIzOCBBMCwwIDAgMCAwIDc4MS4zNDU0LDIzMi41MjM4IEw3ODEuMzQ1NCwxNDEuNzI2OSBMNzcxLjM0NTQsMTMxLjcyNjkgTDU5My4xMSwxMzEuNzI2OSBBMCwwIDAgMCAwIDU5My4xMSwxMzEuNzI2OSIgZmlsbD0iI0ZFRkZERCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHBhdGggZD0iTTc3MS4zNDU0LDEzMS43MjY5IEw3NzEuMzQ1NCwxNDEuNzI2OSBMNzgxLjM0NTQsMTQxLjcyNjkgTDc3MS4zNDU0LDEzMS43MjY5IiBmaWxsPSIjRkVGRkREIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNjcuMjM1NCIgeD0iNTk5LjExIiB5PSIxNDguNzkzOCI+U25hcHNob3QgKEV2ZW50IDkwMCYjMjYxNzg7JiMyODg1NzspPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY2LjE4NyIgeD0iNTk5LjExIiB5PSIxNjMuOTI2NiI+RXZlbnQgOTAxPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY2LjE4NyIgeD0iNTk5LjExIiB5PSIxNzkuMDU5NCI+RXZlbnQgOTAyPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjMwLjA0MzUiIHg9IjU5OS4xMSIgeT0iMTk0LjE5MjIiPi0gLi4uIC08L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNzQuNDU4IiB4PSI1OTkuMTEiIHk9IjIwOS4zMjUiPkV2ZW50IDEwMDA8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTQzLjgzOCIgeD0iNTk5LjExIiB5PSIyMjQuNDU3OCI+JiM4NTk0OyAxMDAmIzEyNDUyOyYjMTI1MDU7JiMxMjUzMTsmIzEyNDg4OyYjMTIzOTg7JiMxMjQxNTsmIzIwODc3OyYjMjk5ODM7PC90ZXh0PjwvZz48IS0tbGluayB3aXRob3V0IHRvIHdpdGhTbmFwc2hvdC0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJ3aXRob3V0IiBkYXRhLWVudGl0eS0yPSJ3aXRoU25hcHNob3QiIGRhdGEtc291cmNlLWxpbmU9IjIzIiBkYXRhLXVpZD0ibG5rMTAiIGlkPSJsaW5rX3dpdGhvdXRfd2l0aFNuYXBzaG90Ij48cGF0aCBkPSJNMTY3LjQzLDE0NS4wMTY5IEMyMjQuNjIsMTUyLjg2NjkgMjk1LjUwNTYsMTYyLjU4MTggMzUyLjY4NTYsMTcwLjQyMTgiIGZpbGw9Im5vbmUiIGlkPSJ3aXRob3V0LXRvLXdpdGhTbmFwc2hvdCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzU4LjYzLDE3MS4yMzY5LDM1MC4yNTY4LDE2Ni4wNTE0LDM1My42NzYzLDE3MC41NTc3LDM0OS4xNzAxLDE3My45NzcyLDM1OC42MywxNzEuMjM2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExNy4wMDAxIiB4PSIxOTgiIHk9IjE0NS43MjM4Ij4mIzEyNDk3OyYjMTI1MDE7JiMxMjQ1NzsmIzEyNTQwOyYjMTI1MTA7JiMxMjUzMTsmIzEyNDczOyYjMjU5MTM7JiMyMTg5Mjs8L3RleHQ+PC9nPjwhLS1TUkM9W1pQM0RJaUQwNThOdHluSU5oZElIQzdNZDJ0Uy1XS3lHeEJHOWIxYmZIenJzeGZMSXdXek9RYWpId2FRR0FrWjJYR0c0dHdNTmZGV01jZmU0WVotdWNleXBTRU94T29GUkxDME9DX01QWTZkQy1DOXFqLUdVa21WNjdrRDlVanJ2VHhGYVQySVFnY3gxNmNYNVpUMTJCTWdmRkhpUEJLRzZXTXZ5amJMLWh4amREd3YwcThRWm84UmNtMGZqaENneEpCckNUbXdMamIzRHBtdFhXVV94dTFNdmI1QkNrdUNiQ0R1b0pQWVVpdHVTZjRfZG9US3F3UHVqWFpUMndIZmEzX25KM1hkeGZUb2szbFJSZVZkOWlCbWcwRFEtbjNRYkoyVXVtN1hUNTQ2cmZCek1oOG5tWi1wVWxZdDhsbU95UnRqNTBoUTB3T0JmYWQ3NnpDZXFwTWVtSmVUbkNaaC0wMDAwXS0tPjwvZz48L3N2Zz4=" class="uml" alt="uml diagram" title="" /></p>
<h3 id="_12">スナップショットテーブル<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">aggregate_snapshot</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">aggregate_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">aggregate_type</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">snapshot_version</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">snapshot_data</span><span class="w"> </span><span class="n">JSONB</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span>
<span class="p">);</span>
</code></pre></div>
<h3 id="_13">スナップショットの実装<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// domain/repository/SnapshotRepository.java</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">SnapshotRepository</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">AggregateSnapshot</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getSnapshot</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">aggregateId</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">saveSnapshot</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">aggregateId</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">version</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">aggregateState</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// infrastructure/persistence/SnapshotRepositoryImpl.java</span>
<span class="nd">@Repository</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SnapshotRepositoryImpl</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">SnapshotRepository</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">SnapshotMapper</span><span class="w"> </span><span class="n">snapshotMapper</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ObjectMapper</span><span class="w"> </span><span class="n">objectMapper</span><span class="p">;</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">SNAPSHOT_THRESHOLD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">AggregateSnapshot</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getSnapshot</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">aggregateId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">SnapshotEntity</span><span class="w"> </span><span class="n">entity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">snapshotMapper</span><span class="p">.</span><span class="na">selectByAggregateId</span><span class="p">(</span><span class="n">aggregateId</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">entity</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">AggregateSnapshot</span><span class="p">(</span>
<span class="w">            </span><span class="n">entity</span><span class="p">.</span><span class="na">getAggregateId</span><span class="p">(),</span>
<span class="w">            </span><span class="n">entity</span><span class="p">.</span><span class="na">getSnapshotVersion</span><span class="p">(),</span>
<span class="w">            </span><span class="n">entity</span><span class="p">.</span><span class="na">getSnapshotData</span><span class="p">()</span>
<span class="w">        </span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">saveSnapshot</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">aggregateId</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">version</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">aggregateState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">snapshotData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toJson</span><span class="p">(</span><span class="n">aggregateState</span><span class="p">);</span>
<span class="w">        </span><span class="n">snapshotMapper</span><span class="p">.</span><span class="na">upsertSnapshot</span><span class="p">(</span>
<span class="w">            </span><span class="n">aggregateId</span><span class="p">,</span>
<span class="w">            </span><span class="s">&quot;JournalEntry&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">version</span><span class="p">,</span>
<span class="w">            </span><span class="n">snapshotData</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">shouldTakeSnapshot</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">version</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">SNAPSHOT_THRESHOLD</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="aggregate_1">スナップショット対応の Aggregate 再生<a class="headerlink" href="#aggregate_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// application/service/JournalEntryEventSourcingService.java</span>
<span class="nd">@Service</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JournalEntryEventSourcingService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">EventStoreRepository</span><span class="w"> </span><span class="n">eventStoreRepository</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">SnapshotRepository</span><span class="w"> </span><span class="n">snapshotRepository</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">JournalEntryAggregate</span><span class="w"> </span><span class="nf">loadAggregate</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">aggregateId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 1. スナップショットを取得</span>
<span class="w">        </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">AggregateSnapshot</span><span class="o">&gt;</span><span class="w"> </span><span class="n">snapshotOpt</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">snapshotRepository</span><span class="p">.</span><span class="na">getSnapshot</span><span class="p">(</span><span class="n">aggregateId</span><span class="p">);</span>

<span class="w">        </span><span class="n">JournalEntryAggregate</span><span class="w"> </span><span class="n">aggregate</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">fromVersion</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">snapshotOpt</span><span class="p">.</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// スナップショットから復元</span>
<span class="w">            </span><span class="n">AggregateSnapshot</span><span class="w"> </span><span class="n">snapshot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">snapshotOpt</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
<span class="w">            </span><span class="n">aggregate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deserializeAggregate</span><span class="p">(</span><span class="n">snapshot</span><span class="p">.</span><span class="na">getSnapshotData</span><span class="p">());</span>
<span class="w">            </span><span class="n">fromVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">snapshot</span><span class="p">.</span><span class="na">getVersion</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// スナップショットなし、最初から再生</span>
<span class="w">            </span><span class="n">aggregate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JournalEntryAggregate</span><span class="p">();</span>
<span class="w">            </span><span class="n">fromVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 2. スナップショット以降のイベントを取得して再生</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DomainEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">events</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eventStoreRepository</span>
<span class="w">            </span><span class="p">.</span><span class="na">getEventsFromVersion</span><span class="p">(</span><span class="n">aggregateId</span><span class="p">,</span><span class="w"> </span><span class="n">fromVersion</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">DomainEvent</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">events</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">aggregate</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 3. 必要に応じてスナップショットを保存</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">currentVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aggregate</span><span class="p">.</span><span class="na">getVersion</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">snapshotRepository</span><span class="p">.</span><span class="na">shouldTakeSnapshot</span><span class="p">(</span><span class="n">currentVersion</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">snapshotRepository</span><span class="p">.</span><span class="na">saveSnapshot</span><span class="p">(</span>
<span class="w">                </span><span class="n">aggregateId</span><span class="p">,</span>
<span class="w">                </span><span class="n">currentVersion</span><span class="p">,</span>
<span class="w">                </span><span class="n">aggregate</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">aggregate</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="316-tdd">31.6 TDD による実装例<a class="headerlink" href="#316-tdd" title="Permanent link">&para;</a></h2>
<h3 id="_14">イベントソーシングのテスト<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nd">@SpringBootTest</span>
<span class="nd">@ActiveProfiles</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">)</span>
<span class="kd">class</span> <span class="nc">JournalEntryEventSourcingTest</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">JournalEntryCommandService</span><span class="w"> </span><span class="n">commandService</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">EventStoreRepository</span><span class="w"> </span><span class="n">eventStoreRepository</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;仕訳を作成するとJournalEntryCreatedEventが保存される&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldCreateJournalEntry</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Given</span>
<span class="w">        </span><span class="n">CreateJournalEntryCommand</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateJournalEntryCommand</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">entryDate</span><span class="p">(</span><span class="n">LocalDate</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">))</span>
<span class="w">            </span><span class="p">.</span><span class="na">description</span><span class="p">(</span><span class="s">&quot;売上計上&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">lineItems</span><span class="p">(</span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span>
<span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">LineItem</span><span class="p">(</span><span class="s">&quot;1111&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">DebitCredit</span><span class="p">.</span><span class="na">DEBIT</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">(</span><span class="s">&quot;100000&quot;</span><span class="p">)),</span>
<span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">LineItem</span><span class="p">(</span><span class="s">&quot;4111&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">DebitCredit</span><span class="p">.</span><span class="na">CREDIT</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">(</span><span class="s">&quot;100000&quot;</span><span class="p">))</span>
<span class="w">            </span><span class="p">))</span>
<span class="w">            </span><span class="p">.</span><span class="na">userId</span><span class="p">(</span><span class="s">&quot;user-001&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// When</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">journalId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">commandService</span><span class="p">.</span><span class="na">createJournalEntry</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Then</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DomainEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">events</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eventStoreRepository</span><span class="p">.</span><span class="na">getEvents</span><span class="p">(</span><span class="n">journalId</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">events</span><span class="p">).</span><span class="na">hasSize</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">events</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)).</span><span class="na">isInstanceOf</span><span class="p">(</span><span class="n">JournalEntryCreatedEvent</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

<span class="w">        </span><span class="n">JournalEntryCreatedEvent</span><span class="w"> </span><span class="n">createdEvent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">JournalEntryCreatedEvent</span><span class="p">)</span><span class="w"> </span><span class="n">events</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">createdEvent</span><span class="p">.</span><span class="na">getDescription</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="s">&quot;売上計上&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">createdEvent</span><span class="p">.</span><span class="na">getLineItems</span><span class="p">()).</span><span class="na">hasSize</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;仕訳を承認するとJournalEntryApprovedEventが追加される&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldApproveJournalEntry</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Given</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">journalId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createTestJournalEntry</span><span class="p">();</span>

<span class="w">        </span><span class="n">ApproveJournalEntryCommand</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ApproveJournalEntryCommand</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">journalEntryId</span><span class="p">(</span><span class="n">journalId</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">approvedBy</span><span class="p">(</span><span class="s">&quot;manager-001&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">comment</span><span class="p">(</span><span class="s">&quot;承認します&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// When</span>
<span class="w">        </span><span class="n">commandService</span><span class="p">.</span><span class="na">approveJournalEntry</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Then</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DomainEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">events</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eventStoreRepository</span><span class="p">.</span><span class="na">getEvents</span><span class="p">(</span><span class="n">journalId</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">events</span><span class="p">).</span><span class="na">hasSize</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">events</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="na">isInstanceOf</span><span class="p">(</span><span class="n">JournalEntryApprovedEvent</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;イベント再生で過去の状態を復元できる&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldReplayEvents</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Given</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">journalId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createTestJournalEntry</span><span class="p">();</span>
<span class="w">        </span><span class="n">approveJournalEntry</span><span class="p">(</span><span class="n">journalId</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// When</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DomainEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">events</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eventStoreRepository</span><span class="p">.</span><span class="na">getEvents</span><span class="p">(</span><span class="n">journalId</span><span class="p">);</span>
<span class="w">        </span><span class="n">JournalEntryAggregate</span><span class="w"> </span><span class="n">aggregate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JournalEntryAggregate</span><span class="p">.</span><span class="na">replay</span><span class="p">(</span><span class="n">events</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Then</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">aggregate</span><span class="p">.</span><span class="na">getStatus</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">JournalEntryStatus</span><span class="p">.</span><span class="na">APPROVED</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">aggregate</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;特定時点の状態を復元できる&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldReplayEventsUntilPointInTime</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Given</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">journalId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createTestJournalEntry</span><span class="p">();</span>
<span class="w">        </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">beforeApproval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>

<span class="w">        </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span><span class="w">  </span><span class="c1">// 時間経過</span>
<span class="w">        </span><span class="n">approveJournalEntry</span><span class="p">(</span><span class="n">journalId</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// When: 承認前の時点の状態を復元</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DomainEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">eventsUntil</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">eventStoreRepository</span><span class="p">.</span><span class="na">getEventsUntil</span><span class="p">(</span><span class="n">journalId</span><span class="p">,</span><span class="w"> </span><span class="n">beforeApproval</span><span class="p">);</span>
<span class="w">        </span><span class="n">JournalEntryAggregate</span><span class="w"> </span><span class="n">aggregate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JournalEntryAggregate</span><span class="p">.</span><span class="na">replay</span><span class="p">(</span><span class="n">eventsUntil</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Then</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">aggregate</span><span class="p">.</span><span class="na">getStatus</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">JournalEntryStatus</span><span class="p">.</span><span class="na">DRAFT</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;楽観ロックにより同時更新が検出される&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldDetectConcurrentModification</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Given</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">journalId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createTestJournalEntry</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// ユーザー1とユーザー2が同時にイベントを取得</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DomainEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">events1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eventStoreRepository</span><span class="p">.</span><span class="na">getEvents</span><span class="p">(</span><span class="n">journalId</span><span class="p">);</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DomainEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">events2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eventStoreRepository</span><span class="p">.</span><span class="na">getEvents</span><span class="p">(</span><span class="n">journalId</span><span class="p">);</span>

<span class="w">        </span><span class="n">JournalEntryAggregate</span><span class="w"> </span><span class="n">aggregate1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JournalEntryAggregate</span><span class="p">.</span><span class="na">replay</span><span class="p">(</span><span class="n">events1</span><span class="p">);</span>
<span class="w">        </span><span class="n">JournalEntryAggregate</span><span class="w"> </span><span class="n">aggregate2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JournalEntryAggregate</span><span class="p">.</span><span class="na">replay</span><span class="p">(</span><span class="n">events2</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// ユーザー1が先に承認</span>
<span class="w">        </span><span class="n">aggregate1</span><span class="p">.</span><span class="na">approve</span><span class="p">(</span><span class="s">&quot;user1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;承認1&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">eventStoreRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span>
<span class="w">            </span><span class="n">journalId</span><span class="p">,</span>
<span class="w">            </span><span class="n">aggregate1</span><span class="p">.</span><span class="na">getUncommittedEvents</span><span class="p">(),</span>
<span class="w">            </span><span class="n">aggregate1</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="c1">// When/Then: ユーザー2が同じバージョンで更新しようとするとエラー</span>
<span class="w">        </span><span class="n">aggregate2</span><span class="p">.</span><span class="na">approve</span><span class="p">(</span><span class="s">&quot;user2&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;承認2&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThatThrownBy</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">eventStoreRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span>
<span class="w">                </span><span class="n">journalId</span><span class="p">,</span>
<span class="w">                </span><span class="n">aggregate2</span><span class="p">.</span><span class="na">getUncommittedEvents</span><span class="p">(),</span>
<span class="w">                </span><span class="n">aggregate2</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">            </span><span class="p">))</span>
<span class="w">            </span><span class="p">.</span><span class="na">isInstanceOf</span><span class="p">(</span><span class="n">ConcurrentModificationException</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="317">31.7 まとめ<a class="headerlink" href="#317" title="Permanent link">&para;</a></h2>
<p>本章では、イベントソーシングパターンについて解説しました。</p>
<h3 id="_15">学んだこと<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>イベントソーシングの基礎</strong>: 状態ではなくイベントを保存する設計パターン</li>
<li><strong>CRUD との違い</strong>: Append-Only、イベント再生、タイムトラベル</li>
<li><strong>イベントストアの設計</strong>: PostgreSQL JSONB、インデックス戦略、バージョニング</li>
<li><strong>Aggregate パターン</strong>: コマンドからイベントを発行、イベントを適用して状態を更新</li>
<li><strong>CQRS パターン</strong>: Command と Query の分離、読み取りモデルの構築</li>
<li><strong>スナップショット</strong>: パフォーマンス最適化のための状態保存</li>
</ol>
<h3 id="_16">財務会計システムへの適用<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>観点</th>
<th>イベントソーシングの利点</th>
</tr>
</thead>
<tbody>
<tr>
<td>監査証跡</td>
<td>すべての変更が自動的に記録される</td>
</tr>
<tr>
<td>法令対応</td>
<td>電子帳簿保存法、J-SOX 要件を満たす</td>
</tr>
<tr>
<td>タイムトラベル</td>
<td>期末残高、過去時点の状態を正確に復元</td>
</tr>
<tr>
<td>デバッグ</td>
<td>問題の原因をイベントから特定</td>
</tr>
<tr>
<td>柔軟性</td>
<td>新しいレポート要件に過去イベントで対応</td>
</tr>
</tbody>
</table>
<h3 id="_17">導入の判断基準<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>イベントソーシングを導入すべきか？

✅ 監査証跡が法的に必要 → 導入を検討
✅ 過去時点の状態復元が必要 → 導入を検討
✅ 複雑なドメインロジック → DDD + ES で効果的
✅ イベント駆動アーキテクチャを採用 → 自然な選択

❌ シンプルな CRUD で十分 → 不要
❌ チームの経験不足 → 段階的導入または見送り
❌ パフォーマンス最優先 → 慎重に検討
</code></pre></div>
<p>次章では、境界付けられたコンテキスト（Bounded Context）と DDD 戦略的設計について解説します。</p>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/k2works/case-study-accounting" target="_blank" rel="noopener" title="財務会計システム ケーススタディ" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../../assets/js/extra.js"></script>
      
    
  </body>
</html>