
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="財務会計システムの設計・開発ドキュメント">
      
      
        <meta name="author" content="Project Team">
      
      
      
        <link rel="prev" href="../chapter26/">
      
      
        <link rel="next" href="../chapter28/">
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>第27章 - 財務会計システム ケーススタディ</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#27-3-" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="財務会計システム ケーススタディ" class="md-header__button md-logo" aria-label="財務会計システム ケーススタディ" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            財務会計システム ケーススタディ
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              第27章
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/k2works/case-study-accounting" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    case-study-accounting
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../requirements/requirements_definition/" class="md-tabs__link">
          
  
  
  要件定義

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../design/architecture_backend/" class="md-tabs__link">
          
  
  
  設計

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../development/release_plan/" class="md-tabs__link">
          
  
  
  開発

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../operation/dev_env/" class="md-tabs__link">
          
  
  
  運用

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../reference/%E9%96%8B%E7%99%BA%E3%82%AC%E3%82%A4%E3%83%89/" class="md-tabs__link">
          
  
  
  リファレンス

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../template/ADR/" class="md-tabs__link">
          
  
  
  テンプレート

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../" class="md-tabs__link">
          
  
  
  実践ガイド

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../functional-java/" class="md-tabs__link">
          
  
  
  関数型プログラミング実践ガイド

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="財務会計システム ケーススタディ" class="md-nav__button md-logo" aria-label="財務会計システム ケーススタディ" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    財務会計システム ケーススタディ
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/k2works/case-study-accounting" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    case-study-accounting
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    要件定義
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    要件定義
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../requirements/requirements_definition/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    要件定義書
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../requirements/business_usecase/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ビジネスユースケース
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../requirements/system_usecase/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    システムユースケース
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../requirements/user_story/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ユーザーストーリー
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    設計
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    設計
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    アーキテクチャ
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    アーキテクチャ
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/architecture_backend/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    バックエンド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/architecture_frontend/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    フロントエンド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/architecture_infrastructure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    インフラストラクチャ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    モデル設計
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    モデル設計
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/data-model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    データモデル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/domain-model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ドメインモデル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/ui-design/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    UI 設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/test_strategy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    テスト戦略
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/non_functional/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    非機能要件
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/operation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    運用要件
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/tech_stack/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    技術スタック選定
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    開発
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    開発
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../development/release_plan/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    リリース計画
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    イテレーション計画
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    イテレーション計画
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../development/iteration_plan-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    イテレーション1
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    運用
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    運用
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/dev_env/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    開発環境解説
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/dev_container/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    開発コンテナ構築手順書
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/backend_setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    バックエンド構築手順書
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/backend_demo_env/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    バックエンドデモ環境
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/frontend_setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    フロントエンド構築手順書
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/frontend_dev/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    フロントエンド開発手順
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/frontend_common_ui/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    フロントエンド共通 UI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/frontend_demo_env/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    フロントエンドデモ環境
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/deploy_demo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    デモ環境デプロイ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/third_party_service/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    外部サービス連携
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/sonarqube_setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SonarQube セットアップガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/e2e_test/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    E2E テスト実行手順書
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/github_project/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    GitHub Project 運用ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    リファレンス
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    リファレンス
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E9%96%8B%E7%99%BA%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    開発ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%82%88%E3%81%84%E3%82%BD%E3%83%95%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A2%E3%81%A8%E3%81%AF/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    よいソフトウェアとは
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%82%B3%E3%83%BC%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0%E3%81%A8%E3%83%86%E3%82%B9%E3%83%88%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    コーディングとテストガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3%E8%A8%AD%E8%A8%88%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    アーキテクチャ設計ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%83%87%E3%83%BC%E3%82%BF%E3%83%A2%E3%83%87%E3%83%AB%E8%A8%AD%E8%A8%88%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    データモデル設計ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%83%A2%E3%83%87%E3%83%AB%E8%A8%AD%E8%A8%88%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ドメインモデル設計ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/UI%E8%A8%AD%E8%A8%88%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    UI設計ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%83%86%E3%82%B9%E3%83%88%E6%88%A6%E7%95%A5%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    テスト戦略ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E9%9D%9E%E6%A9%9F%E8%83%BD%E8%A6%81%E4%BB%B6%E5%AE%9A%E7%BE%A9%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    非機能要件定義ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E9%81%8B%E7%94%A8%E8%A6%81%E4%BB%B6%E5%AE%9A%E7%BE%A9%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    運用要件定義ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E8%A6%81%E4%BB%B6%E5%AE%9A%E7%BE%A9%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    要件定義ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%83%A6%E3%83%BC%E3%82%B9%E3%82%B1%E3%83%BC%E3%82%B9%E4%BD%9C%E6%88%90%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ユースケース作成ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%83%AA%E3%83%AA%E3%83%BC%E3%82%B9%E3%83%BB%E3%82%A4%E3%83%86%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E8%A8%88%E7%94%BB%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    リリース・イテレーション計画ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%A0%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    エクストリームプログラミング
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%82%A4%E3%83%B3%E3%83%95%E3%83%A9%E8%A8%AD%E8%A8%88%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    インフラ設計ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/Java%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Javaアプリケーション環境構築ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/TypeScript%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    TypeScriptアプリケーション環境構築ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    テンプレート
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    テンプレート
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../template/ADR/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../template/%E3%82%A4%E3%83%86%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E5%AE%8C%E4%BA%86%E5%A0%B1%E5%91%8A%E6%9B%B8/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    イテレーション完了報告書
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../template/%E3%82%A4%E3%83%B3%E3%82%BB%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%87%E3%83%83%E3%82%AD/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    インセプションデッキ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../template/%E3%81%BE%E3%81%9A%E3%81%93%E3%82%8C%E3%82%92%E8%AA%AD%E3%82%82%E3%81%86%E3%83%AA%E3%82%B9%E3%83%88/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    まずこれを読もうリスト
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../template/%E5%AE%8C%E5%85%A8%E5%BD%A2%E5%BC%8F%E3%81%AE%E3%83%A6%E3%83%BC%E3%82%B9%E3%82%B1%E3%83%BC%E3%82%B9/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    完全形式のユースケース
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../template/%E8%A6%81%E4%BB%B6%E5%AE%9A%E7%BE%A9/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    要件定義
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../template/%E8%A8%AD%E8%A8%88/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    実践ガイド
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    実践ガイド
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2" checked>
        
          
          <label class="md-nav__link" for="__nav_8_2" id="__nav_8_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    バックエンド編（Java版）
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    バックエンド編（Java版）
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter00/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    はじめに
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter01/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第1章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter02/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第2章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter03/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第3章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter04/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第4章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter05/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第5章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter06/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第6章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter07/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第7章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter08/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第8章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter09/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第9章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter10/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第10章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter11/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第11章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter12/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第12章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter13/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第13章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter14/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第14章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter15/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第15章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter16/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第16章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter17/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第17章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter18/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第18章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter19/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第19章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter20/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第20章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter21/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第21章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter22/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第22章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter23/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第23章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter24/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第24章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter25/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第25章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter26/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第26章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    第27章
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    第27章
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#271" class="md-nav__link">
    <span class="md-ellipsis">
      
        27.1 監査ログの重要性
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="27.1 監査ログの重要性">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        財務会計における監査証跡
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        法的要件
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        ビジネス要件
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#272" class="md-nav__link">
    <span class="md-ellipsis">
      
        27.2 監査ログの設計原則
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="27.2 監査ログの設計原則">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#5w1h" class="md-nav__link">
    <span class="md-ellipsis">
      
        5W1H の記録
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        設計原則
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#273" class="md-nav__link">
    <span class="md-ellipsis">
      
        27.3 監査ログのドメインモデル
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="27.3 監査ログのドメインモデル">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        監査ログエンティティ
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#auditaction" class="md-nav__link">
    <span class="md-ellipsis">
      
        AuditAction 列挙型
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#auditlog" class="md-nav__link">
    <span class="md-ellipsis">
      
        AuditLog ドメインモデル
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#274" class="md-nav__link">
    <span class="md-ellipsis">
      
        27.4 監査ログテーブルの設計
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="27.4 監査ログテーブルの設計">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      
        データベーススキーマ
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jsonb" class="md-nav__link">
    <span class="md-ellipsis">
      
        JSONB 型の活用
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#275" class="md-nav__link">
    <span class="md-ellipsis">
      
        27.5 ドメインイベントによる自動記録
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="27.5 ドメインイベントによる自動記録">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spring-events" class="md-nav__link">
    <span class="md-ellipsis">
      
        Spring Events の活用
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      
        ドメインイベントの定義
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      
        仕訳イベント
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      
        イベントハンドラー
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      
        非同期設定
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#276" class="md-nav__link">
    <span class="md-ellipsis">
      
        27.6 監査ログサービスの実装
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="27.6 監査ログサービスの実装">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#repository" class="md-nav__link">
    <span class="md-ellipsis">
      
        Repository インターフェース
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#application-service" class="md-nav__link">
    <span class="md-ellipsis">
      
        Application Service
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      
        統計情報
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#277-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        27.7 監査ログ API の実装
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="27.7 監査ログ API の実装">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rest" class="md-nav__link">
    <span class="md-ellipsis">
      
        REST コントローラ
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dto" class="md-nav__link">
    <span class="md-ellipsis">
      
        レスポンスDTO
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#278-aop" class="md-nav__link">
    <span class="md-ellipsis">
      
        27.8 AOPによる自動監査記録
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="27.8 AOPによる自動監査記録">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      
        監査アノテーション
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      
        監査アスペクト
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      
        使用例
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#279" class="md-nav__link">
    <span class="md-ellipsis">
      
        27.9 監査レポート機能
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="27.9 監査レポート機能">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      
        監査レポートサービス
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dto_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        レポートDTO
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      
        まとめ
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="まとめ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      
        重要なポイント
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      
        法的要件への対応状況
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      
        財務会計固有の監査対象
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter28/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第28章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter29/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第29章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter30/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第30章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter31/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第31章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter32/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第32章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_3" >
        
          
          <label class="md-nav__link" for="__nav_8_3" id="__nav_8_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    フロントエンド編（React版）
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    フロントエンド編（React版）
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter00/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    はじめに
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter01/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第1章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter02/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第2章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter03/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第3章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter04/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第4章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter05/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第5章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter06/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第6章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter07/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第7章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter08/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第8章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter09/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第9章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter10/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第10章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter11/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第11章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter12/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第12章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter13/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第13章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter14/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第14章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter15/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第15章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter16/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第16章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter17/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第17章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter18/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第18章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter19/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第19章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter20/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第20章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter21/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第21章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter22/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第22章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter23/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第23章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter24/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第24章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    関数型プログラミング実践ガイド
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    関数型プログラミング実践ガイド
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1" >
        
          
          <label class="md-nav__link" for="__nav_9_1" id="__nav_9_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    関数型プログラミング（Java版）
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_9_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    関数型プログラミング（Java版）
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../functional-java/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    はじめに
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../functional-java/part-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part I 基礎
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../functional-java/part-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part II 関数型スタイル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../functional-java/part-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part III エラーハンドリング
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../functional-java/part-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part IV IO と副作用
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../functional-java/part-5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part V 並行処理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../functional-java/part-6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part VI 実践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="27-3-">第27章: 非機能要件 3 - 監査ログとトレーサビリティ<a class="headerlink" href="#27-3-" title="Permanent link">&para;</a></h1>
<h2 id="271">27.1 監査ログの重要性<a class="headerlink" href="#271" title="Permanent link">&para;</a></h2>
<h3 id="_1">財務会計における監査証跡<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<p>財務会計システムにおいて、監査証跡（Audit Trail）は法的要件であり、ビジネスの信頼性確保の基盤です。「誰が」「いつ」「何を」実行したかを記録することは、セキュリティ、コンプライアンス、トラブルシューティングの観点から必須の機能です。</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkRFU0NSSVBUSU9OIiBoZWlnaHQ9IjQ5M3B4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NjcwcHg7aGVpZ2h0OjQ5M3B4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDY3MCA0OTMiIHdpZHRoPSI2NzBweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PHRpdGxlPiYjMzA0MzU7JiMyNjYxOTsmIzM1Mzg4OyYjMzYzMjE7JiMxMjM5ODsmIzMwNDQ2OyYjMzAzNDA7PC90aXRsZT48ZGVmcy8+PGc+PGcgY2xhc3M9InRpdGxlIiBkYXRhLXNvdXJjZS1saW5lPSIxIj48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTcuOTk5NiIgeD0iMjc5LjAwMDIiIHk9IjIyLjk5NTEiPiYjMzA0MzU7JiMyNjYxOTsmIzM1Mzg4OyYjMzYzMjE7JiMxMjM5ODsmIzMwNDQ2OyYjMzAzNDA7PC90ZXh0PjwvZz48IS0tY2x1c3RlciA/Pz8/LS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSIuLi4uIiBkYXRhLXNvdXJjZS1saW5lPSIzIiBkYXRhLXVpZD0iZW50MDAwMiIgaWQ9ImNsdXN0ZXJfLi4uLiI+PHJlY3QgZmlsbD0ibm9uZSIgaGVpZ2h0PSI0NDMuNDciIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI2NTciIHg9IjciIHk9IjQ0LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTUuOTk5OCIgeD0iMzA3LjUwMDEiIHk9IjU5LjI5MiI+JiMzMDQzNTsmIzI2NjE5OyYjMzUzODg7JiMzNjMyMTs8L3RleHQ+PC9nPjwhLS1jbHVzdGVyIHNlYy0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0ic2VjIiBkYXRhLXNvdXJjZS1saW5lPSI0IiBkYXRhLXVpZD0iZW50MDAwMyIgaWQ9ImNsdXN0ZXJfc2VjIj48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjE3Ni4yMyIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjM0NyIgeD0iMzEiIHk9Ijg3LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODMuOTk5NiIgeD0iMTYyLjUwMDIiIHk9IjEwMi4yOTIiPiYjMTI0NzU7JiMxMjQ2MTsmIzEyNTE3OyYjMTI1MjI7JiMxMjQ4NjsmIzEyNDUxOzwvdGV4dD48L2c+PCEtLWNsdXN0ZXIgY29tcC0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLWVudGl0eT0iY29tcCIgZGF0YS1zb3VyY2UtbGluZT0iMTAiIGRhdGEtdWlkPSJlbnQwMDA3IiBpZD0iY2x1c3Rlcl9jb21wIj48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjE3Mi45MyIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjIzOCIgeD0iNDAyIiB5PSI5MC43NzY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMS45OTk1IiB4PSI0NjUuMDAwMiIgeT0iMTA1Ljc3MiI+JiMxMjQ2NzsmIzEyNTMxOyYjMTI1MDM7JiMxMjUyMTsmIzEyNDUyOyYjMTI0NTA7JiMxMjUzMTsmIzEyNDczOzwvdGV4dD48L2c+PCEtLWNsdXN0ZXIgb3BzLS0+PGcgY2xhc3M9ImNsdXN0ZXIiIGRhdGEtZW50aXR5PSJvcHMiIGRhdGEtc291cmNlLWxpbmU9IjE2IiBkYXRhLXVpZD0iZW50MDAxMSIgaWQ9ImNsdXN0ZXJfb3BzIj48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjE3Ni4wNiIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjMwOSIgeD0iNjYiIHk9IjI4Ny43MDY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjI3Ljk5OTkiIHg9IjIwNi41MDAxIiB5PSIzMDIuNzAyIj4mIzM2OTM5OyYjMjk5OTI7PC90ZXh0PjwvZz48IS0tZW50aXR5ID8/Pz8/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSIuLi4uLi4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjUiIGRhdGEtdWlkPSJlbnQwMDA0IiBpZD0iZW50aXR5Xy4uLi4uLi4uLiI+PGVsbGlwc2UgY3g9IjEyNC45OTU5IiBjeT0iMTQwLjI5MjEiIGZpbGw9IiNGMUYxRjEiIHJ4PSI3OC4wMjU5IiByeT0iMTguMDA1MiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTI1Ljk5OTUiIHg9IjYxLjk5NjIiIHk9IjE0NC45NDA1Ij4mIzE5OTgxOyYjMjc0OTE7JiMxMjQ1MDsmIzEyNDYzOyYjMTI0NzU7JiMxMjQ3MzsmIzEyMzk4OyYjMjY5MDg7JiMzMDY5Mzs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgPz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ii4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iNiIgZGF0YS11aWQ9ImVudDAwMDUiIGlkPSJlbnRpdHlfLi4uLi4uIj48ZWxsaXBzZSBjeD0iMzAwLjAwNDIiIGN5PSIxNDAuMjk5NyIgZmlsbD0iI0YxRjFGMSIgcng9IjYxLjUxNDIiIHJ5PSIxNC43MDI4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI4My45OTk2IiB4PSIyNTguMDA0NCIgeT0iMTQ0Ljk0ODIiPiYjMjU4MDU7JiMyMDMxNjsmIzMyNzczOyYjMTIzOTg7JiMyOTMwNTsmIzIzNDUwOzwvdGV4dD48L2c+PCEtLWVudGl0eSA/Pz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSIuLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iNyIgZGF0YS11aWQ9ImVudDAwMDYiIGlkPSJlbnRpdHlfLi4uLi4iPjxlbGxpcHNlIGN4PSIxMjQuOTk3MyIgY3k9IjIzMy4wMTA1IiBmaWxsPSIjRjFGMUYxIiByeD0iNTIuNDk3MyIgcnk9IjE0LjUyMzYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY5Ljk5OTciIHg9Ijg5Ljk5NzQiIHk9IjIzNy42NTg5Ij4mIzI1OTEzOyYjMTIzNzQ7JiMxMjQzNTsmIzM4NDUwOyYjMjc0OTA7PC90ZXh0PjwvZz48IS0tZW50aXR5ID8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTEiIGRhdGEtdWlkPSJlbnQwMDA4IiBpZD0iZW50aXR5Xy4uLi4iPjxlbGxpcHNlIGN4PSI0NjAuOTk3OCIgY3k9IjE0MC4zMDA1IiBmaWxsPSIjRjFGMUYxIiByeD0iNDIuNTk3OCIgcnk9IjE0LjUyMzYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjU1Ljk5OTgiIHg9IjQzMi45OTc5IiB5PSIxNDQuOTQ4OSI+JiMyNzg2MTsmIzIwMTk2OyYjMzY5ODE7JiMyMzQzMjs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgPz8/Py0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtZW50aXR5PSIuLi4uIiBkYXRhLXNvdXJjZS1saW5lPSIxMiIgZGF0YS11aWQ9ImVudDAwMDkiIGlkPSJlbnRpdHlfLi4uLiI+PGVsbGlwc2UgY3g9IjU4MC45OTc4IiBjeT0iMTQwLjMwMDUiIGZpbGw9IiNGMUYxRjEiIHJ4PSI0Mi41OTc4IiByeT0iMTQuNTIzNiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTUuOTk5OCIgeD0iNTUyLjk5NzkiIHk9IjE0NC45NDg5Ij4mIzIwODY5OyYjMzcwOTY7JiMzMjExMzsmIzIxMDQ2OzwvdGV4dD48L2c+PCEtLWVudGl0eSA/Pz8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iLi4uLi4uIiBkYXRhLXNvdXJjZS1saW5lPSIxMyIgZGF0YS11aWQ9ImVudDAwMTAiIGlkPSJlbnRpdHlfLi4uLi4uIj48ZWxsaXBzZSBjeD0iNDgwLjAwNDIiIGN5PSIyMzMuMDA5NyIgZmlsbD0iI0YxRjFGMSIgcng9IjYxLjUxNDIiIHJ5PSIxNC43MDI4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI4My45OTk2IiB4PSI0MzguMDA0NCIgeT0iMjM3LjY1ODIiPiYjMjI4MDY7JiMzNzA5NjsmIzMwNDM1OyYjMjY2MTk7JiMyMzU1MDsmIzI0NTQwOzwvdGV4dD48L2c+PCEtLWVudGl0eSA/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ii4uLi4iIGRhdGEtc291cmNlLWxpbmU9IjE3IiBkYXRhLXVpZD0iZW50MDAxMiIgaWQ9ImVudGl0eV8uLi4uIj48ZWxsaXBzZSBjeD0iMTI0Ljk5NzgiIGN5PSIzNDAuNzIwNSIgZmlsbD0iI0YxRjFGMSIgcng9IjQyLjU5NzgiIHJ5PSIxNC41MjM2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1NS45OTk4IiB4PSI5Ni45OTc5IiB5PSIzNDUuMzY4OSI+JiMzODU1NjsmIzIzNDc1OyYjMzU1MTk7JiMyNjYxOTs8L3RleHQ+PC9nPjwhLS1lbnRpdHkgPz8/Pz8/Pz8/LS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9Ii4uLi4uLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTgiIGRhdGEtdWlkPSJlbnQwMDEzIiBpZD0iZW50aXR5Xy4uLi4uLi4uLiI+PGVsbGlwc2UgY3g9IjI4MC45OTU5IiBjeT0iMzQwLjcxMjEiIGZpbGw9IiNGMUYxRjEiIHJ4PSI3OC4wMjU5IiByeT0iMTguMDA1MiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTI1Ljk5OTUiIHg9IjIxNy45OTYyIiB5PSIzNDUuMzYwNSI+JiMxMjQ5NzsmIzEyNTAxOyYjMTI0NTc7JiMxMjU0MDsmIzEyNTEwOyYjMTI1MzE7JiMxMjQ3MzsmIzIwOTk4OyYjMjY1MTI7PC90ZXh0PjwvZz48IS0tZW50aXR5ID8/Pz8tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iLi4uLiIgZGF0YS1zb3VyY2UtbGluZT0iMTkiIGRhdGEtdWlkPSJlbnQwMDE0IiBpZD0iZW50aXR5Xy4uLi4iPjxlbGxpcHNlIGN4PSIxMjQuOTk3OCIgY3k9IjQzMy4yNTA1IiBmaWxsPSIjRjFGMUYxIiByeD0iNDIuNTk3OCIgcnk9IjE0LjUyMzYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjU1Ljk5OTgiIHg9Ijk2Ljk5NzkiIHk9IjQzNy44OTg5Ij4mIzI2OTg5OyYjMjEyMDk7JiMyNTkxMzsmIzIxODkyOzwvdGV4dD48L2c+PCEtLVNSQz1bTk9fSFFpOG01OFJsLW5JYkxfZk9LaWVPUjVGTXRXclhKUkhxWUIyWHJncU1QUlE1QVpJbzVSVUxFZHNPcW9Kak1vcGZSam1XRHRfb3ZfbEVpSXdqQXFGYll2MmpZWWV2TDktbE8xRS04RG1WQUNnamVMa1RjbWpIcUN1UmNkZnRfV0llMDlHMlpXNWwwSmswR2F0amNBZmZ3QUJOQWhfNkIwcTFoRzdqY2NPazEybUEtMmZrQW9xczZQVlZHTktfYkRRN2QxOVZOYXY1bm1DcWdQX1ZNUmZrQXR0YmhveTNCQ3VTeTBQRzlENFllaG9ud2p0aGRqSW9SNU9NS010bEFONDVhWmgzNllUeV9xUlQzbmFaSnlQYzl4ZXhxYkZtTnJCUjhwdkQ2Y0l0UHFmWXhHVUtQRE5zOUZ1ODFFMGRtM0QwNnkwN21DbFY0UVpoaUVNWk4yNUV3VVg1QjRBeldLSnRWbTAwXS0tPjwvZz48L3N2Zz4=" class="uml" alt="uml diagram" title="" /></p>
<h3 id="_2">法的要件<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>財務会計システムでは、以下の法令に基づいて監査証跡が要求されます。</p>
<table>
<thead>
<tr>
<th>法律</th>
<th>要件</th>
<th>保存期間</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>会社法</strong></td>
<td>会計帳簿の作成・保存義務</td>
<td>10年間</td>
</tr>
<tr>
<td><strong>金融商品取引法</strong></td>
<td>有価証券報告書の信頼性確保</td>
<td>5年間</td>
</tr>
<tr>
<td><strong>電子帳簿保存法</strong></td>
<td>電子データの真実性・可視性・検索性</td>
<td>7年間</td>
</tr>
<tr>
<td><strong>J-SOX（内部統制）</strong></td>
<td>財務報告プロセスの文書化</td>
<td>継続的</td>
</tr>
</tbody>
</table>
<h3 id="_3">ビジネス要件<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>不正検出</strong>: 不正な取引や改ざんの検出</li>
<li><strong>問題調査</strong>: エラーや不整合の原因追跡</li>
<li><strong>コンプライアンス</strong>: 監査法人による外部監査対応</li>
<li><strong>説明責任</strong>: ステークホルダーへの説明義務</li>
</ol>
<hr />
<h2 id="272">27.2 監査ログの設計原則<a class="headerlink" href="#272" title="Permanent link">&para;</a></h2>
<h3 id="5w1h">5W1H の記録<a class="headerlink" href="#5w1h" title="Permanent link">&para;</a></h3>
<p>監査証跡では、すべての操作について 5W1H を記録します。</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkNMQVNTIiBoZWlnaHQ9IjMzMXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6Mjc5cHg7aGVpZ2h0OjMzMXB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDI3OSAzMzEiIHdpZHRoPSIyNzlweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PHRpdGxlPiYjMzA0MzU7JiMyNjYxOTsmIzM1Mzg4OyYjMzYzMjE7JiMxMjM5ODs1VzFIPC90aXRsZT48ZGVmcy8+PGc+PGcgY2xhc3M9InRpdGxlIiBkYXRhLXNvdXJjZS1saW5lPSIxIj48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTE2LjY0MTMiIHg9Ijc3LjMwNDgiIHk9IjIyLjk5NTEiPiYjMzA0MzU7JiMyNjYxOTsmIzM1Mzg4OyYjMzYzMjE7JiMxMjM5ODs1VzFIPC90ZXh0PjwvZz48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0ibG9nIiBkYXRhLXNvdXJjZS1saW5lPSIzIiBkYXRhLXVpZD0iZW50MDAwMiIgaWQ9ImVudGl0eV9sb2ciPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMjcyLjc1IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIyNTguMjUxIiB4PSI3IiB5PSI0NC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTUuOTk5OCIgeD0iMTA4LjEyNTYiIHk9IjU5LjI5MiI+JiMzMDQzNTsmIzI2NjE5OyYjMTI1MjU7JiMxMjQ2NDs8L3RleHQ+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iOCIgeDI9IjI2NC4yNTEiIHkxPSI2NC41OTM4IiB5Mj0iNjQuNTkzOCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIzNS4wMjczIiB4PSIxMyIgeT0iODEuNTg4OSI+V2hvPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjM4LjkyMzciIHg9IjUyLjQ3NzUiIHk9IjgxLjU4ODkiPigmIzM1NTA0OyYjMTIzNjQ7KTwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNDguMTY4OSIgeD0iMTMiIHk9Ijk3Ljg4NTciPnVzZXJJZDogIkFDQzAwMDAwMSI8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTQ5Ljg4NDUiIHg9IjEzIiB5PSIxMTQuMTgyNiI+dXNlck5hbWU6ICImIzIzNjY1OyYjMzAwMDA7JiMyMjgyNjsmIzM3MDcwOyI8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQ0Ljg3MTEiIHg9IjEzIiB5PSIxMzAuNDc5NSI+V2hlbjwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIzOC45MjM3IiB4PSI2Mi4zMjEzIiB5PSIxMzAuNDc5NSI+KCYjMTIzNTY7JiMxMjM4ODspPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjI0Ni4yNTEiIHg9IjEzIiB5PSIxNDYuNzc2NCI+dGltZXN0YW1wOiAiMjAyNS0wMS0xNSAxMDozMDo0NSI8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQxLjU0ODgiIHg9IjEzIiB5PSIxNjMuMDczMiI+V2hhdDwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIzOC45MjM3IiB4PSI1OC45OTkiIHk9IjE2My4wNzMyIj4oJiMyMDMwOTsmIzEyNDM0Oyk8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTgyLjkzNjUiIHg9IjEzIiB5PSIxNzkuMzcwMSI+ZW50aXR5VHlwZTogIkpvdXJuYWxFbnRyeSI8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjAwLjYxNDMiIHg9IjEzIiB5PSIxOTUuNjY3Ij5lbnRpdHlJZDogIkpFMjAyNTAxMTUtMDAwMSI8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQ4LjQ3MzYiIHg9IjEzIiB5PSIyMTEuOTYzOSI+V2hpY2g8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjYuOTIzNiIgeD0iNjUuOTIzOCIgeT0iMjExLjk2MzkiPigmIzEyMzkzOyYjMTIzOTg7JiMyNTgwNTsmIzIwMzE2Oyk8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTIxLjU4NCIgeD0iMTMiIHk9IjIyOC4yNjA3Ij5hY3Rpb246ICJVUERBVEUiPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIzNC41MzUyIiB4PSIxMyIgeT0iMjQ0LjU1NzYiPldoeTwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIzOC45MjM3IiB4PSI1MS45ODU0IiB5PSIyNDQuNTU3NiI+KCYjMTIzOTQ7JiMxMjM4MDspPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyNS43MjYzIiB4PSIxMyIgeT0iMjYwLjg1NDUiPnJlYXNvbjogIiYjMzczMjk7JiMzODk4OTsmIzIwNDYyOyYjMjc0OTE7IjwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMzQuMjY4NiIgeD0iMTMiIHk9IjI3Ny4xNTE0Ij5Ib3c8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjYuOTIzNiIgeD0iNTEuNzE4OCIgeT0iMjc3LjE1MTQiPigmIzEyMzkzOyYjMTIzNTg7JiMyMjc5MzsmIzI2MzU2Oyk8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjI3LjQzMTYiIHg9IjEzIiB5PSIyOTMuNDQ4MiI+b2xkVmFsdWVzOiB7dG90YWxEZWJpdDogMTAwMDAwfTwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMzUuMDI2NCIgeD0iMTMiIHk9IjMwOS43NDUxIj5uZXdWYWx1ZXM6IHt0b3RhbERlYml0OiAxNTAwMDB9PC90ZXh0PjwvZz48IS0tU1JDPVtST19EUWk5MDU4TnR5bkgzTGFyMG9EWGNhdnNlTzVzS0JjblRacGhLYjlZSFA0STJrOFlNYmE4anpDVUxYSUF3UTBMNWVUMTVBdHNPcVFYbHFTYjRra2ZUdGxFVFN5emI1aEM5dDBuNnVVbE56a3J4LXBkYW1TbWVlWG0wajdIOW9XbWdpU1l4S3p3UEFuMXhxQU9OaTBLcWhMWWJjV09GamZDdjMtdktxRjI4VXJtbmVQOUFmX0xlYTI5dDl4WDZuN1F6TTZvVXYtbG5QRFV6THUycTRvVm95LTJBMXNDTENBajZGOFBoVEc0ZHpRSUhxNTQyNkgzZnZnNWs3WGJ4M3NRSFB4Tml5eXdaMmVaM0JFT05fN2ZxOEt5UmhlRmpoQ0RTTnpiQmliMC02LU5mMjhiQ01LaWNNVUxnVkZ2VGwxbS16TFJCNW5OV0NoRWU4cG5kZnZiSzhSajdfSFlTeTQwV0JpNlVIN090M3hqWFJfS3Ayd1NaMlVQZXlvX25VWnMtM0dTVkFnMXN2SHBSM1VBUGlDS2VtdFE2YjJuY1loLVlRR0U3REZfTlpMWGxfbTgwXS0tPjwvZz48L3N2Zz4=" class="uml" alt="uml diagram" title="" /></p>
<h3 id="_4">設計原則<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>監査ログは以下の5つの原則に従って設計します。</p>
<p><strong>1. 完全性（Completeness）</strong></p>
<p>すべての重要な操作を漏れなく記録します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 記録対象の操作</span>
<span class="o">-</span><span class="w"> </span><span class="n">CREATE</span><span class="p">:</span><span class="w"> </span><span class="n">新規登録時</span><span class="err">（</span><span class="n">仕訳作成</span><span class="err">、</span><span class="n">勘定科目追加など</span><span class="err">）</span>
<span class="o">-</span><span class="w"> </span><span class="n">UPDATE</span><span class="p">:</span><span class="w"> </span><span class="n">更新時</span><span class="err">（</span><span class="n">仕訳修正</span><span class="err">、</span><span class="n">承認ステータス変更など</span><span class="err">）</span>
<span class="o">-</span><span class="w"> </span><span class="n">DELETE</span><span class="p">:</span><span class="w"> </span><span class="n">削除時</span><span class="err">（</span><span class="n">論理削除</span><span class="err">・</span><span class="n">物理削除の両方</span><span class="err">）</span>
<span class="o">-</span><span class="w"> </span><span class="n">APPROVE</span><span class="p">:</span><span class="w"> </span><span class="n">承認時</span><span class="err">（</span><span class="n">仕訳承認</span><span class="err">、</span><span class="n">確定など</span><span class="err">）</span>
<span class="o">-</span><span class="w"> </span><span class="n">CANCEL</span><span class="p">:</span><span class="w"> </span><span class="n">取消時</span><span class="err">（</span><span class="n">仕訳取消など</span><span class="err">）</span>
</code></pre></div>
<p><strong>2. 正確性（Accuracy）</strong></p>
<p>変更前後の値を正確に記録します。</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;oldValues&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;totalDebit&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100000</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;DRAFT&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;newValues&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;totalDebit&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">150000</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;APPROVED&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>3. 不変性（Immutability）</strong></p>
<p>一度記録されたログは変更・削除不可とします。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 不変性を保証する設計</span>
<span class="o">-</span><span class="w"> </span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="n">シーケンス</span><span class="err">（</span><span class="n">連番</span><span class="err">）</span><span class="n">で自動採番</span>
<span class="o">-</span><span class="w"> </span><span class="n">更新</span><span class="err">・</span><span class="n">削除の</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">は提供しない</span>
<span class="o">-</span><span class="w"> </span><span class="n">データベース権限で</span><span class="w"> </span><span class="n">INSERT</span><span class="w"> </span><span class="n">のみ許可</span>
<span class="o">-</span><span class="w"> </span><span class="nd">@Value</span><span class="w"> </span><span class="n">アノテーションで不変オブジェクト</span>
</code></pre></div>
<p><strong>4. トレーサビリティ（Traceability）</strong></p>
<p>操作の連鎖を追跡可能にします。</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;entityType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;JournalEntry&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;entityId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;JE20250115-0001&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;relatedEntities&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;JournalLine&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;JournalLine&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2&quot;</span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>5. 検索可能性（Searchability）</strong></p>
<p>効率的な検索を実現するインデックス設計を行います。</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_audit_log_entity</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">audit_log</span><span class="p">(</span><span class="n">entity_type</span><span class="p">,</span><span class="w"> </span><span class="n">entity_id</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_audit_log_user</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">audit_log</span><span class="p">(</span><span class="n">user_id</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_audit_log_timestamp</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">audit_log</span><span class="p">(</span><span class="k">timestamp</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_audit_log_action</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">audit_log</span><span class="p">(</span><span class="n">action</span><span class="p">);</span>
</code></pre></div>
<hr />
<h2 id="273">27.3 監査ログのドメインモデル<a class="headerlink" href="#273" title="Permanent link">&para;</a></h2>
<h3 id="_5">監査ログエンティティ<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkNMQVNTIiBoZWlnaHQ9IjU3NHB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6Mjc0cHg7aGVpZ2h0OjU3NHB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDI3NCA1NzQiIHdpZHRoPSIyNzRweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PHRpdGxlPiYjMzA0MzU7JiMyNjYxOTsmIzEyNTI1OyYjMTI0NjQ7JiMxMjQ4OTsmIzEyNTEzOyYjMTI0NTI7JiMxMjUzMTsmIzEyNTE0OyYjMTI0ODc7JiMxMjUyMzs8L3RpdGxlPjxkZWZzLz48Zz48ZyBjbGFzcz0idGl0bGUiIGRhdGEtc291cmNlLWxpbmU9IjEiPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNTMuOTk5MyIgeD0iNTMuMTA2OCIgeT0iMjIuOTk1MSI+JiMzMDQzNTsmIzI2NjE5OyYjMTI1MjU7JiMxMjQ2NDsmIzEyNDg5OyYjMTI1MTM7JiMxMjQ1MjsmIzEyNTMxOyYjMTI1MTQ7JiMxMjQ4NzsmIzEyNTIzOzwvdGV4dD48L2c+PCEtLWNsYXNzIEF1ZGl0TG9nLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1lbnRpdHk9IkF1ZGl0TG9nIiBkYXRhLXNvdXJjZS1saW5lPSIzIiBkYXRhLXVpZD0iZW50MDAwMiIgaWQ9ImVudGl0eV9BdWRpdExvZyI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzMDAuNzE4OCIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjYwLjIxMjkiIHg9IjciIHk9IjQ0LjI5NjkiLz48ZWxsaXBzZSBjeD0iMTAxLjg3MjYiIGN5PSI2NC40Mjk3IiBmaWxsPSIjQUREMUIyIiByeD0iMTEiIHJ5PSIxMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwYXRoIGQ9Ik0xMDQuODQxMyw3MC4wNzAzIFExMDQuMjYzMiw3MC4zNjcyIDEwMy42MjI2LDcwLjUwNzggUTEwMi45ODE5LDcwLjY2NDEgMTAyLjI3ODgsNzAuNjY0MSBROTkuNzc4OCw3MC42NjQxIDk4LjQ1MDcsNjkuMDIzNCBROTcuMTM4Miw2Ny4zNjcyIDk3LjEzODIsNjQuMjQyMiBROTcuMTM4Miw2MS4xMTcyIDk4LjQ1MDcsNTkuNDYwOSBROTkuNzc4OCw1Ny44MDQ3IDEwMi4yNzg4LDU3LjgwNDcgUTEwMi45ODE5LDU3LjgwNDcgMTAzLjYyMjYsNTcuOTYwOSBRMTA0LjI3ODgsNTguMTE3MiAxMDQuODQxMyw1OC40MTQxIEwxMDQuODQxMyw2MS4xMzI4IFExMDQuMjE2Myw2MC41NTQ3IDEwMy42MjI2LDYwLjI4OTEgUTEwMy4wMjg4LDYwLjAwNzggMTAyLjQwMzgsNjAuMDA3OCBRMTAxLjA2MDEsNjAuMDA3OCAxMDAuMzcyNiw2MS4wODU5IFE5OS42ODUxLDYyLjE0ODQgOTkuNjg1MSw2NC4yNDIyIFE5OS42ODUxLDY2LjMzNTkgMTAwLjM3MjYsNjcuNDE0MSBRMTAxLjA2MDEsNjguNDc2NiAxMDIuNDAzOCw2OC40NzY2IFExMDMuMDI4OCw2OC40NzY2IDEwMy42MjI2LDY4LjIxMDkgUTEwNC4yMTYzLDY3LjkyOTcgMTA0Ljg0MTMsNjcuMzUxNiBMMTA0Ljg0MTMsNzAuMDcwMyBaICIgZmlsbD0iIzAwMDAwMCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBmb250LXN0eWxlPSJpdGFsaWMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDkuNzE2OCIgeD0iMTI4LjQ5OCIgeT0iNjAuNDM1NSI+JiMxNzE7RW50aXR5JiMxODc7PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjYxLjk2NzgiIHg9IjEyMi4zNzI2IiB5PSI3Ni4yNjA3Ij5BdWRpdExvZzwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI4IiB4Mj0iMjY2LjIxMjkiIHkxPSI4NC41NjI1IiB5Mj0iODQuNTYyNSIvPjxyZWN0IGZpbGw9Im5vbmUiIGhlaWdodD0iNiIgc3R5bGU9InN0cm9rZTojQzgyOTMwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjYiIHg9IjE1IiB5PSI5NS4yMTA5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTYuMDY4NCIgeD0iMjciIHk9IjEwMS41NTc2Ij5pZDogTG9uZzwvdGV4dD48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjYiIHN0eWxlPSJzdHJva2U6I0M4MjkzMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI2IiB4PSIxNSIgeT0iMTExLjUwNzgiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjUuOTI0OCIgeD0iMjciIHk9IjExNy44NTQ1Ij5lbnRpdHlUeXBlOiBTdHJpbmc8L3RleHQ+PHJlY3QgZmlsbD0ibm9uZSIgaGVpZ2h0PSI2IiBzdHlsZT0ic3Ryb2tlOiNDODI5MzA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iNiIgeD0iMTUiIHk9IjEyNy44MDQ3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTA0LjYwMzUiIHg9IjI3IiB5PSIxMzQuMTUxNCI+ZW50aXR5SWQ6IFN0cmluZzwvdGV4dD48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjYiIHN0eWxlPSJzdHJva2U6I0M4MjkzMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI2IiB4PSIxNSIgeT0iMTQ0LjEwMTYiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMzMuMDY4NCIgeD0iMjciIHk9IjE1MC40NDgyIj5hY3Rpb246IEF1ZGl0QWN0aW9uPC90ZXh0PjxyZWN0IGZpbGw9Im5vbmUiIGhlaWdodD0iNiIgc3R5bGU9InN0cm9rZTojQzgyOTMwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjYiIHg9IjE1IiB5PSIxNjAuMzk4NCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk0LjUiIHg9IjI3IiB5PSIxNjYuNzQ1MSI+dXNlcklkOiBTdHJpbmc8L3RleHQ+PHJlY3QgZmlsbD0ibm9uZSIgaGVpZ2h0PSI2IiBzdHlsZT0ic3Ryb2tlOiNDODI5MzA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iNiIgeD0iMTUiIHk9IjE3Ni42OTUzIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTIyLjc4NzEiIHg9IjI3IiB5PSIxODMuMDQyIj51c2VyTmFtZTogU3RyaW5nPC90ZXh0PjxyZWN0IGZpbGw9Im5vbmUiIGhlaWdodD0iNiIgc3R5bGU9InN0cm9rZTojQzgyOTMwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjYiIHg9IjE1IiB5PSIxOTIuOTkyMiIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE4OS4zNjkxIiB4PSIyNyIgeT0iMTk5LjMzODkiPnRpbWVzdGFtcDogTG9jYWxEYXRlVGltZTwvdGV4dD48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjYiIHN0eWxlPSJzdHJva2U6I0M4MjkzMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI2IiB4PSIxNSIgeT0iMjA5LjI4OTEiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMjYuNjE4MiIgeD0iMjciIHk9IjIxNS42MzU3Ij5vbGRWYWx1ZXM6IE1hcCZsdDtTdHJpbmcsIE9iamVjdCZndDs8L3RleHQ+PHJlY3QgZmlsbD0ibm9uZSIgaGVpZ2h0PSI2IiBzdHlsZT0ic3Ryb2tlOiNDODI5MzA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iNiIgeD0iMTUiIHk9IjIyNS41ODU5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjM0LjIxMjkiIHg9IjI3IiB5PSIyMzEuOTMyNiI+bmV3VmFsdWVzOiBNYXAmbHQ7U3RyaW5nLCBPYmplY3QmZ3Q7PC90ZXh0PjxyZWN0IGZpbGw9Im5vbmUiIGhlaWdodD0iNiIgc3R5bGU9InN0cm9rZTojQzgyOTMwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjYiIHg9IjE1IiB5PSIyNDEuODgyOCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk4LjYyODkiIHg9IjI3IiB5PSIyNDguMjI5NSI+cmVhc29uOiBTdHJpbmc8L3RleHQ+PHJlY3QgZmlsbD0ibm9uZSIgaGVpZ2h0PSI2IiBzdHlsZT0ic3Ryb2tlOiNDODI5MzA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iNiIgeD0iMTUiIHk9IjI1OC4xNzk3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTIwLjAzMjIiIHg9IjI3IiB5PSIyNjQuNTI2NCI+aXBBZGRyZXNzOiBTdHJpbmc8L3RleHQ+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iOCIgeDI9IjI2Ni4yMTI5IiB5MT0iMjcxLjgyODEiIHkyPSIyNzEuODI4MSIvPjxlbGxpcHNlIGN4PSIxOCIgY3k9IjI4NS40NzY2IiBmaWxsPSIjODRCRTg0IiByeD0iMyIgcnk9IjMiIHN0eWxlPSJzdHJva2U6IzAzODA0ODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjYuODA2NiIgeD0iMjciIHk9IjI4OC44MjMyIj5jcmVhdGUoKTogQXVkaXRMb2c8L3RleHQ+PGVsbGlwc2UgY3g9IjE4IiBjeT0iMzAxLjc3MzQiIGZpbGw9IiM4NEJFODQiIHJ4PSIzIiByeT0iMyIgc3R5bGU9InN0cm9rZTojMDM4MDQ4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE5OS44ODI4IiB4PSIyNyIgeT0iMzA1LjEyMDEiPmNyZWF0ZUZvclVwZGF0ZSgpOiBBdWRpdExvZzwvdGV4dD48ZWxsaXBzZSBjeD0iMTgiIGN5PSIzMTguMDcwMyIgZmlsbD0iIzg0QkU4NCIgcng9IjMiIHJ5PSIzIiBzdHlsZT0ic3Ryb2tlOiMwMzgwNDg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTk1LjE3OTciIHg9IjI3IiB5PSIzMjEuNDE3Ij5jcmVhdGVGb3JEZWxldGUoKTogQXVkaXRMb2c8L3RleHQ+PGVsbGlwc2UgY3g9IjE4IiBjeT0iMzM0LjM2NzIiIGZpbGw9IiM4NEJFODQiIHJ4PSIzIiByeT0iMyIgc3R5bGU9InN0cm9rZTojMDM4MDQ4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE1Mi41MTY2IiB4PSIyNyIgeT0iMzM3LjcxMzkiPmdldFN1bW1hcnkoKTogU3RyaW5nPC90ZXh0PjwvZz48IS0tY2xhc3MgQXVkaXRBY3Rpb24tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLWVudGl0eT0iQXVkaXRBY3Rpb24iIGRhdGEtc291cmNlLWxpbmU9IjIxIiBkYXRhLXVpZD0iZW50MDAwMyIgaWQ9ImVudGl0eV9BdWRpdEFjdGlvbiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIxNjIuMDc4MSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTEyLjgwNzYiIHg9IjgwLjciIHk9IjQwNS4wMTY5Ii8+PGVsbGlwc2UgY3g9Ijk1LjciIGN5PSI0MjEuMDE2OSIgZmlsbD0iI0VCOTM3RiIgcng9IjExIiByeT0iMTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cGF0aCBkPSJNOTkuODA5NCw0MjcuMDE2OSBMOTIuMDkwNiw0MjcuMDE2OSBMOTIuMDkwNiw0MTQuNjI2MiBMOTkuODA5NCw0MTQuNjI2MiBMOTkuODA5NCw0MTYuNzgyNSBMOTQuNTQzOCw0MTYuNzgyNSBMOTQuNTQzOCw0MTkuNDU0NCBMOTkuMzA5NCw0MTkuNDU0NCBMOTkuMzA5NCw0MjEuNjEwNiBMOTQuNTQzOCw0MjEuNjEwNiBMOTQuNTQzOCw0MjQuODYwNiBMOTkuODA5NCw0MjQuODYwNiBMOTkuODA5NCw0MjcuMDE2OSBaICIgZmlsbD0iIzAwMDAwMCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjgwLjgwNzYiIHg9IjEwOS43IiB5PSI0MjUuODYzNiI+QXVkaXRBY3Rpb248L3RleHQ+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iODEuNyIgeDI9IjE5Mi41MDc2IiB5MT0iNDM3LjAxNjkiIHkyPSI0MzcuMDE2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjU1LjMyMzIiIHg9Ijg2LjciIHk9IjQ1NC4wMTIiPkNSRUFURTwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1Ni40NDQzIiB4PSI4Ni43IiB5PSI0NzAuMzA4OSI+VVBEQVRFPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjUzLjY2ODkiIHg9Ijg2LjciIHk9IjQ4Ni42MDU3Ij5ERUxFVEU8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNjUuNjMxOCIgeD0iODYuNyIgeT0iNTAyLjkwMjYiPkFQUFJPVkU8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTYuMjQ2MSIgeD0iODYuNyIgeT0iNTE5LjE5OTUiPkNBTkNFTDwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0NC4yNjk1IiB4PSI4Ni43IiB5PSI1MzUuNDk2NCI+TE9HSU48L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTkuNDg2MyIgeD0iODYuNyIgeT0iNTUxLjc5MzIiPkxPR09VVDwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI4MS43IiB4Mj0iMTkyLjUwNzYiIHkxPSI1NTkuMDk1IiB5Mj0iNTU5LjA5NSIvPjwvZz48IS0tbGluayBBdWRpdExvZyB0byBBdWRpdEFjdGlvbi0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJBdWRpdExvZyIgZGF0YS1lbnRpdHktMj0iQXVkaXRBY3Rpb24iIGRhdGEtc291cmNlLWxpbmU9IjMxIiBkYXRhLXVpZD0ibG5rNCIgaWQ9ImxpbmtfQXVkaXRMb2dfQXVkaXRBY3Rpb24iPjxwYXRoIGNvZGVMaW5lPSIzMSIgZD0iTTEzNy4xMSwzNDUuNDQ2OSBDMTM3LjExLDM2NS44NTY5IDEzNy4xMSwzODAuMTM2OSAxMzcuMTEsMzk4LjY0NjkiIGZpbGw9Im5vbmUiIGlkPSJBdWRpdExvZy10by1BdWRpdEFjdGlvbiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTM3LjExLDQwNC42NDY5LDE0MS4xMSwzOTUuNjQ2OSwxMzcuMTEsMzk5LjY0NjksMTMzLjExLDM5NS42NDY5LDEzNy4xMSw0MDQuNjQ2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tU1JDPVtWUDdESWlHbTU4TnRVT2VpNVBxTkE0RVhKQUNDcjZjUHdTbS1EZlNYcVotUU13SThjeWIyVjBPTnVpekUxQzZiWm5DT055RGFIYWY1YzRya3lmc0pTeUNESWlvMVZaLXlSMS1fWjd1dGNtLVp4dXItQ2ZqTmVwLURWWlJ3cGtXdEdoQVNBcU0zTGFZQ2daS1RacmM5NFpsVmZwVGFIQU5tUTVJTFF4azU3Sy14Nlpvd200T0V1NUdDNEN6R0xnTXRabW5zMXFqUjFTcVZjbUNwTldwM0sxUVdhMVVyd3ZkbkZFRzhnTUxNZ2RBbnVkYUJvZ0NObDF4bGh2cEktRjhBQ2xJamVPSmhtdU82azdCRndobDlFWDJZMFFMd1RhOHB3cTh1RWxSd1dWSm1oNmdNakpZV1hmMzNGdEtEazZZQldaVVQ0dHh4dDE4MlBMaUM5c0k3RlBjcDg2TGFjT0lrWDJuWWpXSDlDZXpOWjRvMnNPSDU5OGhGZnBFdG5pbEtuVkpWRFhodm14V1ZdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<h3 id="auditaction">AuditAction 列挙型<a class="headerlink" href="#auditaction" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.audit</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 監査アクション種別</span>
<span class="cm"> */</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">enum</span><span class="w"> </span><span class="n">AuditAction</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="n">CREATE</span><span class="p">(</span><span class="s">&quot;作成&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">UPDATE</span><span class="p">(</span><span class="s">&quot;更新&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">DELETE</span><span class="p">(</span><span class="s">&quot;削除&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">APPROVE</span><span class="p">(</span><span class="s">&quot;承認&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">CONFIRM</span><span class="p">(</span><span class="s">&quot;確定&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">CANCEL</span><span class="p">(</span><span class="s">&quot;取消&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">LOGIN</span><span class="p">(</span><span class="s">&quot;ログイン&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">LOGOUT</span><span class="p">(</span><span class="s">&quot;ログアウト&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">displayName</span><span class="p">;</span>

<span class="w">    </span><span class="n">AuditAction</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">displayName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">displayName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">displayName</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getDisplayName</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">displayName</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="auditlog">AuditLog ドメインモデル<a class="headerlink" href="#auditlog" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.audit</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.Builder</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.Value</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDateTime</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 監査ログエンティティ</span>
<span class="cm"> *</span>
<span class="cm"> * 財務会計システムにおける全ての重要な操作を記録する。</span>
<span class="cm"> * 一度作成されたら変更不可（不変オブジェクト）。</span>
<span class="cm"> */</span>
<span class="nd">@Value</span>
<span class="nd">@Builder</span><span class="p">(</span><span class="n">toBuilder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AuditLog</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">entityType</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">entityId</span><span class="p">;</span>
<span class="w">    </span><span class="n">AuditAction</span><span class="w"> </span><span class="n">action</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">userName</span><span class="p">;</span>
<span class="w">    </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">timestamp</span><span class="p">;</span>
<span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">oldValues</span><span class="p">;</span>
<span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">newValues</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">reason</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">ipAddress</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">userAgent</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * CREATE操作の監査ログを作成</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">AuditLog</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">entityType</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">entityId</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">userName</span><span class="p">,</span>
<span class="w">            </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">newValues</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">ipAddress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">AuditLog</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">entityType</span><span class="p">(</span><span class="n">entityType</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">entityId</span><span class="p">(</span><span class="n">entityId</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">action</span><span class="p">(</span><span class="n">AuditAction</span><span class="p">.</span><span class="na">CREATE</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">userId</span><span class="p">(</span><span class="n">userId</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">userName</span><span class="p">(</span><span class="n">userName</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">timestamp</span><span class="p">(</span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">newValues</span><span class="p">(</span><span class="n">newValues</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">ipAddress</span><span class="p">(</span><span class="n">ipAddress</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * UPDATE操作の監査ログを作成</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">AuditLog</span><span class="w"> </span><span class="nf">createForUpdate</span><span class="p">(</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">entityType</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">entityId</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">userName</span><span class="p">,</span>
<span class="w">            </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">oldValues</span><span class="p">,</span>
<span class="w">            </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">newValues</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">ipAddress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">AuditLog</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">entityType</span><span class="p">(</span><span class="n">entityType</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">entityId</span><span class="p">(</span><span class="n">entityId</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">action</span><span class="p">(</span><span class="n">AuditAction</span><span class="p">.</span><span class="na">UPDATE</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">userId</span><span class="p">(</span><span class="n">userId</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">userName</span><span class="p">(</span><span class="n">userName</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">timestamp</span><span class="p">(</span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">oldValues</span><span class="p">(</span><span class="n">oldValues</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">newValues</span><span class="p">(</span><span class="n">newValues</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">ipAddress</span><span class="p">(</span><span class="n">ipAddress</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * DELETE操作の監査ログを作成</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">AuditLog</span><span class="w"> </span><span class="nf">createForDelete</span><span class="p">(</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">entityType</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">entityId</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">userName</span><span class="p">,</span>
<span class="w">            </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">deletedValues</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">reason</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">ipAddress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">AuditLog</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">entityType</span><span class="p">(</span><span class="n">entityType</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">entityId</span><span class="p">(</span><span class="n">entityId</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">action</span><span class="p">(</span><span class="n">AuditAction</span><span class="p">.</span><span class="na">DELETE</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">userId</span><span class="p">(</span><span class="n">userId</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">userName</span><span class="p">(</span><span class="n">userName</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">timestamp</span><span class="p">(</span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">oldValues</span><span class="p">(</span><span class="n">deletedValues</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">reason</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">ipAddress</span><span class="p">(</span><span class="n">ipAddress</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * APPROVE操作の監査ログを作成</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">AuditLog</span><span class="w"> </span><span class="nf">createForApprove</span><span class="p">(</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">entityType</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">entityId</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">userName</span><span class="p">,</span>
<span class="w">            </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">approvedData</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">ipAddress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">AuditLog</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">entityType</span><span class="p">(</span><span class="n">entityType</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">entityId</span><span class="p">(</span><span class="n">entityId</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">action</span><span class="p">(</span><span class="n">AuditAction</span><span class="p">.</span><span class="na">APPROVE</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">userId</span><span class="p">(</span><span class="n">userId</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">userName</span><span class="p">(</span><span class="n">userName</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">timestamp</span><span class="p">(</span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">newValues</span><span class="p">(</span><span class="n">approvedData</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">ipAddress</span><span class="p">(</span><span class="n">ipAddress</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * サマリー文字列を生成</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getSummary</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;%s %s を%s&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">entityType</span><span class="p">,</span>
<span class="w">            </span><span class="n">entityId</span><span class="p">,</span>
<span class="w">            </span><span class="n">action</span><span class="p">.</span><span class="na">getDisplayName</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="274">27.4 監査ログテーブルの設計<a class="headerlink" href="#274" title="Permanent link">&para;</a></h2>
<h3 id="_6">データベーススキーマ<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- V27__create_audit_log_table.sql</span>

<span class="c1">-- 監査ログテーブル（Append-Only）</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="err">監査ログ</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="err">エンティティ種別</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="err">エンティティ</span><span class="n">ID</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="err">アクション</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="err">ユーザー</span><span class="n">ID</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="err">ユーザー名</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="err">タイムスタンプ</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span>
<span class="w">    </span><span class="err">変更前</span><span class="w"> </span><span class="n">JSONB</span><span class="p">,</span>
<span class="w">    </span><span class="err">変更後</span><span class="w"> </span><span class="n">JSONB</span><span class="p">,</span>
<span class="w">    </span><span class="err">理由</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">IPアドレス</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">45</span><span class="p">),</span>
<span class="w">    </span><span class="err">ユーザーエージェント</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="err">作成日時</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span>
<span class="p">);</span>

<span class="c1">-- インデックス作成</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_audit_log_entity</span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="err">監査ログ</span><span class="p">(</span><span class="err">エンティティ種別</span><span class="p">,</span><span class="w"> </span><span class="err">エンティティ</span><span class="n">ID</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_audit_log_user</span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="err">監査ログ</span><span class="p">(</span><span class="err">ユーザー</span><span class="n">ID</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_audit_log_timestamp</span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="err">監査ログ</span><span class="p">(</span><span class="err">タイムスタンプ</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_audit_log_action</span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="err">監査ログ</span><span class="p">(</span><span class="err">アクション</span><span class="p">);</span>

<span class="c1">-- JSONB 列へのGINインデックス（特定キーの検索用）</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_audit_log_old_values</span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="err">監査ログ</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">GIN</span><span class="w"> </span><span class="p">(</span><span class="err">変更前</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_audit_log_new_values</span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="err">監査ログ</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">GIN</span><span class="w"> </span><span class="p">(</span><span class="err">変更後</span><span class="p">);</span>

<span class="c1">-- コメント</span>
<span class="k">COMMENT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="err">監査ログ</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="s1">&#39;監査ログテーブル（Append-Onlyで不変）&#39;</span><span class="p">;</span>
<span class="k">COMMENT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="err">監査ログ</span><span class="p">.</span><span class="err">エンティティ種別</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="s1">&#39;エンティティ種別（JournalEntry, Account等）&#39;</span><span class="p">;</span>
<span class="k">COMMENT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="err">監査ログ</span><span class="p">.</span><span class="err">エンティティ</span><span class="n">ID</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="s1">&#39;エンティティID&#39;</span><span class="p">;</span>
<span class="k">COMMENT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="err">監査ログ</span><span class="p">.</span><span class="err">アクション</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="s1">&#39;操作種別（CREATE, UPDATE, DELETE, APPROVE等）&#39;</span><span class="p">;</span>
<span class="k">COMMENT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="err">監査ログ</span><span class="p">.</span><span class="err">変更前</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="s1">&#39;変更前の値（UPDATE, DELETE時）&#39;</span><span class="p">;</span>
<span class="k">COMMENT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="err">監査ログ</span><span class="p">.</span><span class="err">変更後</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="s1">&#39;変更後の値（CREATE, UPDATE時）&#39;</span><span class="p">;</span>
<span class="k">COMMENT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="err">監査ログ</span><span class="p">.</span><span class="err">理由</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="s1">&#39;操作理由（任意）&#39;</span><span class="p">;</span>
</code></pre></div>
<h3 id="jsonb">JSONB 型の活用<a class="headerlink" href="#jsonb" title="Permanent link">&para;</a></h3>
<p>PostgreSQL の JSONB 型を使用することで、柔軟かつ効率的な変更履歴を保存できます。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// JSONBの利点</span>
<span class="mf">1.</span><span class="w"> </span><span class="n">スキーマ変更に強い</span><span class="err">（</span><span class="n">カラム追加不要</span><span class="err">）</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">複雑なオブジェクトをそのまま保存可能</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">JSONB</span><span class="w"> </span><span class="n">はバイナリ形式で高速</span>
<span class="mf">4.</span><span class="w"> </span><span class="n">インデックスとクエリをサポート</span>
</code></pre></div>
<p><strong>仕訳の変更履歴の例</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;journalNumber&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;JE20250115-0001&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;journalDate&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-01-15&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;売上計上&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;APPROVED&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;totalDebit&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">150000</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;totalCredit&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">150000</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;lines&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;lineNumber&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;accountCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1101&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;accountName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;現金&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;debitAmount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">150000</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;lineNumber&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;accountCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;4001&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;accountName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;売上高&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;creditAmount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">150000</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="275">27.5 ドメインイベントによる自動記録<a class="headerlink" href="#275" title="Permanent link">&para;</a></h2>
<h3 id="spring-events">Spring Events の活用<a class="headerlink" href="#spring-events" title="Permanent link">&para;</a></h3>
<p>Spring Events を使用して、エンティティの変更を自動的に監査ログに記録します。</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IlNFUVVFTkNFIiBoZWlnaHQ9IjM3M3B4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6Nzc2cHg7aGVpZ2h0OjM3M3B4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDc3NiAzNzMiIHdpZHRoPSI3NzZweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PHRpdGxlPiYjMTI0ODk7JiMxMjUxMzsmIzEyNDUyOyYjMTI1MzE7JiMxMjQ1MjsmIzEyNTA1OyYjMTI1MzE7JiMxMjQ4ODsmIzEyMzk1OyYjMTI0MjQ7JiMxMjQyNzsmIzMwNDM1OyYjMjY2MTk7JiMxMjUyNTsmIzEyNDY0OyYjMzUzNTI7JiMzNzY4Mjs8L3RpdGxlPjxkZWZzLz48Zz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjM3Ljk5OSIgeD0iMjY5LjM5MzciIHk9IjI3Ljk5NTEiPiYjMTI0ODk7JiMxMjUxMzsmIzEyNDUyOyYjMTI1MzE7JiMxMjQ1MjsmIzEyNTA1OyYjMTI1MzE7JiMxMjQ4ODsmIzEyMzk1OyYjMTI0MjQ7JiMxMjQyNzsmIzMwNDM1OyYjMjY2MTk7JiMxMjUyNTsmIzEyNDY0OyYjMzUzNTI7JiMzNzY4Mjs8L3RleHQ+PGc+PHRpdGxlPkpvdXJuYWxTZXJ2aWNlPC90aXRsZT48cmVjdCBmaWxsPSIjMDAwMDAwIiBmaWxsLW9wYWNpdHk9IjAuMDAwMDAiIGhlaWdodD0iMTkwLjY2NDEiIHdpZHRoPSI4IiB4PSI1OC4yMDMxIiB5PSIxMDQuNTkzOCIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41O3N0cm9rZS1kYXNoYXJyYXk6NSw1OyIgeDE9IjYyIiB4Mj0iNjIiIHkxPSIxMDQuNTkzOCIgeTI9IjI5NS4yNTc4Ii8+PC9nPjxnPjx0aXRsZT5FdmVudFB1Ymxpc2hlcjwvdGl0bGU+PHJlY3QgZmlsbD0iIzAwMDAwMCIgZmlsbC1vcGFjaXR5PSIwLjAwMDAwIiBoZWlnaHQ9IjE5MC42NjQxIiB3aWR0aD0iOCIgeD0iMzEwLjczMTQiIHk9IjEwNC41OTM4Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7c3Ryb2tlLWRhc2hhcnJheTo1LDU7IiB4MT0iMzE0LjQxOTQiIHgyPSIzMTQuNDE5NCIgeTE9IjEwNC41OTM4IiB5Mj0iMjk1LjI1NzgiLz48L2c+PGc+PHRpdGxlPkF1ZGl0RXZlbnRIYW5kbGVyPC90aXRsZT48cmVjdCBmaWxsPSIjMDAwMDAwIiBmaWxsLW9wYWNpdHk9IjAuMDAwMDAiIGhlaWdodD0iMTkwLjY2NDEiIHdpZHRoPSI4IiB4PSI0ODYuMTA0IiB5PSIxMDQuNTkzOCIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41O3N0cm9rZS1kYXNoYXJyYXk6NSw1OyIgeDE9IjQ4OS4xMzA0IiB4Mj0iNDg5LjEzMDQiIHkxPSIxMDQuNTkzOCIgeTI9IjI5NS4yNTc4Ii8+PC9nPjxnPjx0aXRsZT5BdWRpdExvZ1NlcnZpY2U8L3RpdGxlPjxyZWN0IGZpbGw9IiMwMDAwMDAiIGZpbGwtb3BhY2l0eT0iMC4wMDAwMCIgaGVpZ2h0PSIxOTAuNjY0MSIgd2lkdGg9IjgiIHg9IjYzMi45MzIxIiB5PSIxMDQuNTkzOCIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41O3N0cm9rZS1kYXNoYXJyYXk6NSw1OyIgeDE9IjYzNi4wNzc2IiB4Mj0iNjM2LjA3NzYiIHkxPSIxMDQuNTkzOCIgeTI9IjI5NS4yNTc4Ii8+PC9nPjxnPjx0aXRsZT4uLi4uPC90aXRsZT48cmVjdCBmaWxsPSIjMDAwMDAwIiBmaWxsLW9wYWNpdHk9IjAuMDAwMDAiIGhlaWdodD0iMTkwLjY2NDEiIHdpZHRoPSI4IiB4PSI3MzcuNzg2NSIgeT0iMTA0LjU5MzgiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTtzdHJva2UtZGFzaGFycmF5OjUsNTsiIHgxPSI3NDAuNzg2NiIgeDI9Ijc0MC43ODY2IiB5MT0iMTA0LjU5MzgiIHkyPSIyOTUuMjU3OCIvPjwvZz48ZyBjbGFzcz0icGFydGljaXBhbnQgcGFydGljaXBhbnQtaGVhZCIgZGF0YS1wYXJ0aWNpcGFudD0ic3ZjIj48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjExNC40MDYzIiB4PSI1IiB5PSI3My4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTAwLjQwNjMiIHg9IjEyIiB5PSI5My4yOTIiPkpvdXJuYWxTZXJ2aWNlPC90ZXh0PjwvZz48ZyBjbGFzcz0icGFydGljaXBhbnQgcGFydGljaXBhbnQtdGFpbCIgZGF0YS1wYXJ0aWNpcGFudD0ic3ZjIj48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjExNC40MDYzIiB4PSI1IiB5PSIyOTQuMjU3OCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwMC40MDYzIiB4PSIxMiIgeT0iMzE0LjI1MjkiPkpvdXJuYWxTZXJ2aWNlPC90ZXh0PjwvZz48ZyBjbGFzcz0icGFydGljaXBhbnQgcGFydGljaXBhbnQtaGVhZCIgZGF0YS1wYXJ0aWNpcGFudD0icHViIj48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjExOC42MjQiIHg9IjI1NS40MTk0IiB5PSI3My4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTA0LjYyNCIgeD0iMjYyLjQxOTQiIHk9IjkzLjI5MiI+RXZlbnRQdWJsaXNoZXI8L3RleHQ+PC9nPjxnIGNsYXNzPSJwYXJ0aWNpcGFudCBwYXJ0aWNpcGFudC10YWlsIiBkYXRhLXBhcnRpY2lwYW50PSJwdWIiPjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTE4LjYyNCIgeD0iMjU1LjQxOTQiIHk9IjI5NC4yNTc4Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTA0LjYyNCIgeD0iMjYyLjQxOTQiIHk9IjMxNC4yNTI5Ij5FdmVudFB1Ymxpc2hlcjwvdGV4dD48L2c+PGcgY2xhc3M9InBhcnRpY2lwYW50IHBhcnRpY2lwYW50LWhlYWQiIGRhdGEtcGFydGljaXBhbnQ9ImhhbmRsZXIiPjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTQ1Ljk0NzMiIHg9IjQxNy4xMzA0IiB5PSI3My4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTMxLjk0NzMiIHg9IjQyNC4xMzA0IiB5PSI5My4yOTIiPkF1ZGl0RXZlbnRIYW5kbGVyPC90ZXh0PjwvZz48ZyBjbGFzcz0icGFydGljaXBhbnQgcGFydGljaXBhbnQtdGFpbCIgZGF0YS1wYXJ0aWNpcGFudD0iaGFuZGxlciI+PHJlY3QgZmlsbD0iI0UyRTJGMCIgaGVpZ2h0PSIzMC4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNDUuOTQ3MyIgeD0iNDE3LjEzMDQiIHk9IjI5NC4yNTc4Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTMxLjk0NzMiIHg9IjQyNC4xMzA0IiB5PSIzMTQuMjUyOSI+QXVkaXRFdmVudEhhbmRsZXI8L3RleHQ+PC9nPjxnIGNsYXNzPSJwYXJ0aWNpcGFudCBwYXJ0aWNpcGFudC1oZWFkIiBkYXRhLXBhcnRpY2lwYW50PSJhdWRpdCI+PHJlY3QgZmlsbD0iI0UyRTJGMCIgaGVpZ2h0PSIzMC4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxMjcuNzA5IiB4PSI1NzMuMDc3NiIgeT0iNzMuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMy43MDkiIHg9IjU4MC4wNzc2IiB5PSI5My4yOTIiPkF1ZGl0TG9nU2VydmljZTwvdGV4dD48L2c+PGcgY2xhc3M9InBhcnRpY2lwYW50IHBhcnRpY2lwYW50LXRhaWwiIGRhdGEtcGFydGljaXBhbnQ9ImF1ZGl0Ij48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjEyNy43MDkiIHg9IjU3My4wNzc2IiB5PSIyOTQuMjU3OCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMy43MDkiIHg9IjU4MC4wNzc2IiB5PSIzMTQuMjUyOSI+QXVkaXRMb2dTZXJ2aWNlPC90ZXh0PjwvZz48ZyBjbGFzcz0icGFydGljaXBhbnQgcGFydGljaXBhbnQtaGVhZCIgZGF0YS1wYXJ0aWNpcGFudD0iZGIiPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjU1Ljk5OTgiIHg9IjcxMC43ODY2IiB5PSIxMDEuMjkyIj4mIzMwNDM1OyYjMjY2MTk7JiMxMjUyNTsmIzEyNDY0OzwvdGV4dD48cGF0aCBkPSJNNzIzLjc4NjUsNTIuMjk2OSBDNzIzLjc4NjUsNDIuMjk2OSA3NDEuNzg2NSw0Mi4yOTY5IDc0MS43ODY1LDQyLjI5NjkgQzc0MS43ODY1LDQyLjI5NjkgNzU5Ljc4NjUsNDIuMjk2OSA3NTkuNzg2NSw1Mi4yOTY5IEw3NTkuNzg2NSw3OC4yOTY5IEM3NTkuNzg2NSw4OC4yOTY5IDc0MS43ODY1LDg4LjI5NjkgNzQxLjc4NjUsODguMjk2OSBDNzQxLjc4NjUsODguMjk2OSA3MjMuNzg2NSw4OC4yOTY5IDcyMy43ODY1LDc4LjI5NjkgTDcyMy43ODY1LDUyLjI5NjkiIGZpbGw9IiNFMkUyRjAiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik03MjMuNzg2NSw1Mi4yOTY5IEM3MjMuNzg2NSw2Mi4yOTY5IDc0MS43ODY1LDYyLjI5NjkgNzQxLjc4NjUsNjIuMjk2OSBDNzQxLjc4NjUsNjIuMjk2OSA3NTkuNzg2NSw2Mi4yOTY5IDc1OS43ODY1LDUyLjI5NjkiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjwvZz48ZyBjbGFzcz0icGFydGljaXBhbnQgcGFydGljaXBhbnQtdGFpbCIgZGF0YS1wYXJ0aWNpcGFudD0iZGIiPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjU1Ljk5OTgiIHg9IjcxMC43ODY2IiB5PSIzMDcuMjUyOSI+JiMzMDQzNTsmIzI2NjE5OyYjMTI1MjU7JiMxMjQ2NDs8L3RleHQ+PHBhdGggZD0iTTcyMy43ODY1LDMyMC41NTQ3IEM3MjMuNzg2NSwzMTAuNTU0NyA3NDEuNzg2NSwzMTAuNTU0NyA3NDEuNzg2NSwzMTAuNTU0NyBDNzQxLjc4NjUsMzEwLjU1NDcgNzU5Ljc4NjUsMzEwLjU1NDcgNzU5Ljc4NjUsMzIwLjU1NDcgTDc1OS43ODY1LDM0Ni41NTQ3IEM3NTkuNzg2NSwzNTYuNTU0NyA3NDEuNzg2NSwzNTYuNTU0NyA3NDEuNzg2NSwzNTYuNTU0NyBDNzQxLjc4NjUsMzU2LjU1NDcgNzIzLjc4NjUsMzU2LjU1NDcgNzIzLjc4NjUsMzQ2LjU1NDcgTDcyMy43ODY1LDMyMC41NTQ3IiBmaWxsPSIjRTJFMkYwIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNNzIzLjc4NjUsMzIwLjU1NDcgQzcyMy43ODY1LDMzMC41NTQ3IDc0MS43ODY1LDMzMC41NTQ3IDc0MS43ODY1LDMzMC41NTQ3IEM3NDEuNzg2NSwzMzAuNTU0NyA3NTkuNzg2NSwzMzAuNTU0NyA3NTkuNzg2NSwzMjAuNTU0NyIgZmlsbD0ibm9uZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PC9nPjxnIGNsYXNzPSJtZXNzYWdlIiBkYXRhLXBhcnRpY2lwYW50LTE9InN2YyIgZGF0YS1wYXJ0aWNpcGFudC0yPSJzdmMiPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHgxPSI2Mi4yMDMxIiB4Mj0iMTA0LjIwMzEiIHkxPSIxMzUuNzI2NiIgeTI9IjEzNS43MjY2Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgeDE9IjEwNC4yMDMxIiB4Mj0iMTA0LjIwMzEiIHkxPSIxMzUuNzI2NiIgeTI9IjE0OC43MjY2Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgeDE9IjYzLjIwMzEiIHgyPSIxMDQuMjAzMSIgeTE9IjE0OC43MjY2IiB5Mj0iMTQ4LjcyNjYiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjczLjIwMzEsMTQ0LjcyNjYsNjMuMjAzMSwxNDguNzI2Niw3My4yMDMxLDE1Mi43MjY2LDY5LjIwMzEsMTQ4LjcyNjYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5Ni44ODQzIiB4PSI2OS4yMDMxIiB5PSIxMzAuNjYwNiI+Y3JlYXRlSm91cm5hbCgpPC90ZXh0PjwvZz48ZyBjbGFzcz0ibWVzc2FnZSIgZGF0YS1wYXJ0aWNpcGFudC0xPSJzdmMiIGRhdGEtcGFydGljaXBhbnQtMj0icHViIj48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjMwMi43MzE0LDE3Ni44NTk0LDMxMi43MzE0LDE4MC44NTk0LDMwMi43MzE0LDE4NC44NTk0LDMwNi43MzE0LDE4MC44NTk0IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgeDE9IjYyLjIwMzEiIHgyPSIzMDguNzMxNCIgeTE9IjE4MC44NTk0IiB5Mj0iMTgwLjg1OTQiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMjguNTI4MyIgeD0iNjkuMjAzMSIgeT0iMTc1Ljc5MzUiPnB1Ymxpc2hFdmVudChKb3VybmFsQ3JlYXRlZEV2ZW50KTwvdGV4dD48L2c+PHBhdGggZD0iTTMxOSwxNjEuNzI2NiBMMzE5LDE4Ni43MjY2IEw0ODMsMTg2LjcyNjYgTDQ4MywxNzEuNzI2NiBMNDczLDE2MS43MjY2IEwzMTksMTYxLjcyNjYiIGZpbGw9IiNGRUZGREQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik00NzMsMTYxLjcyNjYgTDQ3MywxNzEuNzI2NiBMNDgzLDE3MS43MjY2IEw0NzMsMTYxLjcyNjYiIGZpbGw9IiNGRUZGREQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0My4wMDAyIiB4PSIzMjUiIHk9IjE3OC43OTM1Ij4mIzEyNTEzOyYjMTI0NTI7JiMxMjUzMTsmIzEyNDg4OyYjMTI1MjE7JiMxMjUzMTsmIzEyNDcwOyYjMTI0NjM7JiMxMjQ3MTsmIzEyNTE5OyYjMTI1MzE7PC90ZXh0PjxnIGNsYXNzPSJtZXNzYWdlIiBkYXRhLXBhcnRpY2lwYW50LTE9InB1YiIgZGF0YS1wYXJ0aWNpcGFudC0yPSJoYW5kbGVyIj48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjQ3OC4xMDQsMjExLjk5MjIsNDg4LjEwNCwyMTUuOTkyMiw0NzguMTA0LDIxOS45OTIyLDQ4Mi4xMDQsMjE1Ljk5MjIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7IiB4MT0iMzE0LjczMTQiIHgyPSI0ODQuMTA0IiB5MT0iMjE1Ljk5MjIiIHkyPSIyMTUuOTkyMiIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE1MS4zNzI2IiB4PSIzMjEuNzMxNCIgeT0iMjEwLjkyNjMiPmhhbmRsZUpvdXJuYWxDcmVhdGVkKCk8L3RleHQ+PC9nPjxwYXRoIGQ9Ik00OTUsMTk2Ljg1OTQgTDQ5NSwyMjEuODU5NCBMNjg1LDIyMS44NTk0IEw2ODUsMjA2Ljg1OTQgTDY3NSwxOTYuODU5NCBMNDk1LDE5Ni44NTk0IiBmaWxsPSIjRkVGRkREIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNNjc1LDE5Ni44NTk0IEw2NzUsMjA2Ljg1OTQgTDY4NSwyMDYuODU5NCBMNjc1LDE5Ni44NTk0IiBmaWxsPSIjRkVGRkREIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNjkuMDAwMiIgeD0iNTAxIiB5PSIyMTMuOTI2MyI+JiMzODc1MDsmIzIxNTE2OyYjMjYzOTk7JiMxMjUzOTsmIzIxMDI5OyYjMTI0ODg7JiMxMjUyMTsmIzEyNTMxOyYjMTI0NzA7JiMxMjQ2MzsmIzEyNDcxOyYjMTI1MTk7JiMxMjUzMTs8L3RleHQ+PGcgY2xhc3M9Im1lc3NhZ2UiIGRhdGEtcGFydGljaXBhbnQtMT0iaGFuZGxlciIgZGF0YS1wYXJ0aWNpcGFudC0yPSJhdWRpdCI+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI2MjQuOTMyMSwyNDQuMTI1LDYzNC45MzIxLDI0OC4xMjUsNjI0LjkzMjEsMjUyLjEyNSw2MjguOTMyMSwyNDguMTI1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgeDE9IjQ5MC4xMDQiIHgyPSI2MzAuOTMyMSIgeTE9IjI0OC4xMjUiIHkyPSIyNDguMTI1Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTA5LjcyNTYiIHg9IjQ5Ny4xMDQiIHk9IjI0My4wNTkxIj5yZWNvcmQoQXVkaXRMb2cpPC90ZXh0PjwvZz48ZyBjbGFzcz0ibWVzc2FnZSIgZGF0YS1wYXJ0aWNpcGFudC0xPSJhdWRpdCIgZGF0YS1wYXJ0aWNpcGFudC0yPSJkYiI+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI3MjkuNzg2NSwyNzMuMjU3OCw3MzkuNzg2NSwyNzcuMjU3OCw3MjkuNzg2NSwyODEuMjU3OCw3MzMuNzg2NSwyNzcuMjU3OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHgxPSI2MzYuOTMyMSIgeDI9IjczNS43ODY1IiB5MT0iMjc3LjI1NzgiIHkyPSIyNzcuMjU3OCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQ2Ljk5OCIgeD0iNjQzLjkzMjEiIHk9IjI3Mi4xOTE5Ij5JTlNFUlQ8L3RleHQ+PC9nPjwhLS1TUkM9W1RQM0ZJaUdtNENSbFVPaEdLdGxtMVZPV1kyb2VZOFpoMndIRHMwUEFNekFxVHZsQllkbG1nRlhkNEhLTDRNSzVGVXBaM0Jrd1ItNHFSTjRCVVdjSmNMLSAtIC1WOWZnSUQxbUhvM2tPN28zaW94RlMtaG1lcFd3MWRBNFBHZE5uVXRZeWFDcDBrS1J6LUZQeWxuYjkyS0FJcTNjUjlPS3NTZG9MTkNlZTVHWEdvNEdyYjZpb0JlQ2xyMm43ZV96b0VQWEs5UDlpdHpCaEVIU3dhamtDTFk3WkxPTURUX2VCbDlTN0tkZ3RnNEN5cnliV2RnaEZnczBGUzlHTURxUlJ0b0h0aXFLODlmcVRYdGxOUThuZDJPcmNRajd4VFhEa3EzUmRpVVlIQ2pnOUIzS0ZWZVJ1SU9kN2NvTU52MC1HaGI5dlc3bDY5Y0E4bGdwTnptR3JycmZUc2t4RkJnVWR1d05ibkVtQ3BjZV9sX25MakxONjFwRzdhYldhSG5qdXRBOF9LMDJMeHpSdGpscTN5dV8wNDBdLS0+PC9nPjwvc3ZnPg==" class="uml" alt="uml diagram" title="" /></p>
<h3 id="_7">ドメインイベントの定義<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.domain.event</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.Getter</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDateTime</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.UUID</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * ドメインイベント基底クラス</span>
<span class="cm"> */</span>
<span class="nd">@Getter</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DomainEvent</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">eventId</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">occurredAt</span><span class="p">;</span>

<span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="nf">DomainEvent</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">eventId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">();</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">occurredAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getEventType</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_8">仕訳イベント<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.domain.event</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.Getter</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 仕訳作成イベント</span>
<span class="cm"> */</span>
<span class="nd">@Getter</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JournalCreatedEvent</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">DomainEvent</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">journalNumber</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">journalData</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">userName</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">ipAddress</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">JournalCreatedEvent</span><span class="p">(</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">journalNumber</span><span class="p">,</span>
<span class="w">            </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">journalData</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">userName</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">ipAddress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">super</span><span class="p">();</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">journalNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">journalNumber</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">journalData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">journalData</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userId</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">userName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userName</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">ipAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ipAddress</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getEventType</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;JournalCreated&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * 仕訳承認イベント</span>
<span class="cm"> */</span>
<span class="nd">@Getter</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JournalApprovedEvent</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">DomainEvent</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">journalNumber</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">journalData</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">approverId</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">approverName</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">ipAddress</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">JournalApprovedEvent</span><span class="p">(</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">journalNumber</span><span class="p">,</span>
<span class="w">            </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">journalData</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">approverId</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">approverName</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">ipAddress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">super</span><span class="p">();</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">journalNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">journalNumber</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">journalData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">journalData</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">approverId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">approverId</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">approverName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">approverName</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">ipAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ipAddress</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getEventType</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;JournalApproved&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * 仕訳更新イベント</span>
<span class="cm"> */</span>
<span class="nd">@Getter</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JournalUpdatedEvent</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">DomainEvent</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">journalNumber</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">oldValues</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">newValues</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">userName</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">ipAddress</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">JournalUpdatedEvent</span><span class="p">(</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">journalNumber</span><span class="p">,</span>
<span class="w">            </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">oldValues</span><span class="p">,</span>
<span class="w">            </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">newValues</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">userName</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">ipAddress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">super</span><span class="p">();</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">journalNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">journalNumber</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">oldValues</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oldValues</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">newValues</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newValues</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userId</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">userName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userName</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">ipAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ipAddress</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getEventType</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;JournalUpdated&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_9">イベントハンドラー<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.application.event</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.application.AuditLogService</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.event.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.audit.AuditLog</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.RequiredArgsConstructor</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.extern.slf4j.Slf4j</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.scheduling.annotation.Async</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.stereotype.Component</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.transaction.event.TransactionPhase</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.transaction.event.TransactionalEventListener</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 監査イベントハンドラー</span>
<span class="cm"> *</span>
<span class="cm"> * ドメインイベントを受信し、監査ログを自動記録する。</span>
<span class="cm"> */</span>
<span class="nd">@Component</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AuditEventHandler</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AuditLogService</span><span class="w"> </span><span class="n">auditLogService</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 仕訳作成イベントのハンドリング</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="nd">@TransactionalEventListener</span><span class="p">(</span><span class="n">phase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TransactionPhase</span><span class="p">.</span><span class="na">AFTER_COMMIT</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@Async</span><span class="p">(</span><span class="s">&quot;auditExecutor&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleJournalCreated</span><span class="p">(</span><span class="n">JournalCreatedEvent</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Handling JournalCreatedEvent: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="na">getJournalNumber</span><span class="p">());</span>

<span class="w">        </span><span class="n">AuditLog</span><span class="w"> </span><span class="n">auditLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AuditLog</span><span class="p">.</span><span class="na">create</span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;JournalEntry&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">event</span><span class="p">.</span><span class="na">getJournalNumber</span><span class="p">(),</span>
<span class="w">            </span><span class="n">event</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span>
<span class="w">            </span><span class="n">event</span><span class="p">.</span><span class="na">getUserName</span><span class="p">(),</span>
<span class="w">            </span><span class="n">event</span><span class="p">.</span><span class="na">getJournalData</span><span class="p">(),</span>
<span class="w">            </span><span class="n">event</span><span class="p">.</span><span class="na">getIpAddress</span><span class="p">()</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="n">auditLogService</span><span class="p">.</span><span class="na">record</span><span class="p">(</span><span class="n">auditLog</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 仕訳承認イベントのハンドリング</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="nd">@TransactionalEventListener</span><span class="p">(</span><span class="n">phase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TransactionPhase</span><span class="p">.</span><span class="na">AFTER_COMMIT</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@Async</span><span class="p">(</span><span class="s">&quot;auditExecutor&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleJournalApproved</span><span class="p">(</span><span class="n">JournalApprovedEvent</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Handling JournalApprovedEvent: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="na">getJournalNumber</span><span class="p">());</span>

<span class="w">        </span><span class="n">AuditLog</span><span class="w"> </span><span class="n">auditLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AuditLog</span><span class="p">.</span><span class="na">createForApprove</span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;JournalEntry&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">event</span><span class="p">.</span><span class="na">getJournalNumber</span><span class="p">(),</span>
<span class="w">            </span><span class="n">event</span><span class="p">.</span><span class="na">getApproverId</span><span class="p">(),</span>
<span class="w">            </span><span class="n">event</span><span class="p">.</span><span class="na">getApproverName</span><span class="p">(),</span>
<span class="w">            </span><span class="n">event</span><span class="p">.</span><span class="na">getJournalData</span><span class="p">(),</span>
<span class="w">            </span><span class="n">event</span><span class="p">.</span><span class="na">getIpAddress</span><span class="p">()</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="n">auditLogService</span><span class="p">.</span><span class="na">record</span><span class="p">(</span><span class="n">auditLog</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 仕訳更新イベントのハンドリング</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="nd">@TransactionalEventListener</span><span class="p">(</span><span class="n">phase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TransactionPhase</span><span class="p">.</span><span class="na">AFTER_COMMIT</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@Async</span><span class="p">(</span><span class="s">&quot;auditExecutor&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleJournalUpdated</span><span class="p">(</span><span class="n">JournalUpdatedEvent</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Handling JournalUpdatedEvent: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="na">getJournalNumber</span><span class="p">());</span>

<span class="w">        </span><span class="n">AuditLog</span><span class="w"> </span><span class="n">auditLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AuditLog</span><span class="p">.</span><span class="na">createForUpdate</span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;JournalEntry&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">event</span><span class="p">.</span><span class="na">getJournalNumber</span><span class="p">(),</span>
<span class="w">            </span><span class="n">event</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span>
<span class="w">            </span><span class="n">event</span><span class="p">.</span><span class="na">getUserName</span><span class="p">(),</span>
<span class="w">            </span><span class="n">event</span><span class="p">.</span><span class="na">getOldValues</span><span class="p">(),</span>
<span class="w">            </span><span class="n">event</span><span class="p">.</span><span class="na">getNewValues</span><span class="p">(),</span>
<span class="w">            </span><span class="n">event</span><span class="p">.</span><span class="na">getIpAddress</span><span class="p">()</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="n">auditLogService</span><span class="p">.</span><span class="na">record</span><span class="p">(</span><span class="n">auditLog</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 勘定科目更新イベントのハンドリング</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="nd">@TransactionalEventListener</span><span class="p">(</span><span class="n">phase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TransactionPhase</span><span class="p">.</span><span class="na">AFTER_COMMIT</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@Async</span><span class="p">(</span><span class="s">&quot;auditExecutor&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleAccountUpdated</span><span class="p">(</span><span class="n">AccountUpdatedEvent</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Handling AccountUpdatedEvent: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="na">getAccountCode</span><span class="p">());</span>

<span class="w">        </span><span class="n">AuditLog</span><span class="w"> </span><span class="n">auditLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AuditLog</span><span class="p">.</span><span class="na">createForUpdate</span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;Account&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">event</span><span class="p">.</span><span class="na">getAccountCode</span><span class="p">(),</span>
<span class="w">            </span><span class="n">event</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span>
<span class="w">            </span><span class="n">event</span><span class="p">.</span><span class="na">getUserName</span><span class="p">(),</span>
<span class="w">            </span><span class="n">event</span><span class="p">.</span><span class="na">getOldValues</span><span class="p">(),</span>
<span class="w">            </span><span class="n">event</span><span class="p">.</span><span class="na">getNewValues</span><span class="p">(),</span>
<span class="w">            </span><span class="n">event</span><span class="p">.</span><span class="na">getIpAddress</span><span class="p">()</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="n">auditLogService</span><span class="p">.</span><span class="na">record</span><span class="p">(</span><span class="n">auditLog</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_10">非同期設定<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.config</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.context.annotation.Bean</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.context.annotation.Configuration</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.scheduling.annotation.EnableAsync</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.Executor</span><span class="p">;</span>

<span class="nd">@Configuration</span>
<span class="nd">@EnableAsync</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AsyncConfig</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 監査ログ記録用のスレッドプール</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="nd">@Bean</span><span class="p">(</span><span class="s">&quot;auditExecutor&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Executor</span><span class="w"> </span><span class="nf">auditExecutor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ThreadPoolTaskExecutor</span><span class="w"> </span><span class="n">executor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ThreadPoolTaskExecutor</span><span class="p">();</span>
<span class="w">        </span><span class="n">executor</span><span class="p">.</span><span class="na">setCorePoolSize</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="n">executor</span><span class="p">.</span><span class="na">setMaxPoolSize</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="w">        </span><span class="n">executor</span><span class="p">.</span><span class="na">setQueueCapacity</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="w">        </span><span class="n">executor</span><span class="p">.</span><span class="na">setThreadNamePrefix</span><span class="p">(</span><span class="s">&quot;audit-&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">executor</span><span class="p">.</span><span class="na">setRejectedExecutionHandler</span><span class="p">(</span>
<span class="w">            </span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// キューが満杯の場合は同期実行</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">.</span><span class="na">isShutdown</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">r</span><span class="p">.</span><span class="na">run</span><span class="p">();</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">        </span><span class="n">executor</span><span class="p">.</span><span class="na">initialize</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">executor</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="276">27.6 監査ログサービスの実装<a class="headerlink" href="#276" title="Permanent link">&para;</a></h2>
<h3 id="repository">Repository インターフェース<a class="headerlink" href="#repository" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.audit</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDateTime</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 監査ログリポジトリ</span>
<span class="cm"> */</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">AuditLogRepository</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 監査ログを保存</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">AuditLog</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">AuditLog</span><span class="w"> </span><span class="n">auditLog</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * エンティティの変更履歴を取得</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuditLog</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findByEntity</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">entityType</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">entityId</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * ユーザーの操作履歴を取得</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuditLog</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findByUser</span><span class="p">(</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span>
<span class="w">        </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">startDate</span><span class="p">,</span>
<span class="w">        </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">endDate</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 期間別の監査ログを取得</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuditLog</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findByPeriod</span><span class="p">(</span>
<span class="w">        </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">startDate</span><span class="p">,</span>
<span class="w">        </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">endDate</span><span class="p">,</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">limit</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * アクション別の監査ログを取得</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuditLog</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findByAction</span><span class="p">(</span>
<span class="w">        </span><span class="n">AuditAction</span><span class="w"> </span><span class="n">action</span><span class="p">,</span>
<span class="w">        </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">startDate</span><span class="p">,</span>
<span class="w">        </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">endDate</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 監査ログの件数を取得</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="nf">count</span><span class="p">(</span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">startDate</span><span class="p">,</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">endDate</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="application-service">Application Service<a class="headerlink" href="#application-service" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.application</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.audit.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.RequiredArgsConstructor</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.extern.slf4j.Slf4j</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.transaction.annotation.Propagation</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDateTime</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 監査ログサービス</span>
<span class="cm"> */</span>
<span class="nd">@Service</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AuditLogService</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AuditLogRepository</span><span class="w"> </span><span class="n">auditLogRepository</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 監査ログを記録</span>
<span class="cm">     *</span>
<span class="cm">     * 新しいトランザクションで実行し、メイン処理に影響を与えない</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="nd">@Transactional</span><span class="p">(</span><span class="n">propagation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Propagation</span><span class="p">.</span><span class="na">REQUIRES_NEW</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">record</span><span class="p">(</span><span class="n">AuditLog</span><span class="w"> </span><span class="n">auditLog</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">auditLogRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">auditLog</span><span class="p">);</span>
<span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;Audit log recorded: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">auditLog</span><span class="p">.</span><span class="na">getSummary</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 監査ログの記録失敗はメイン処理に影響させない</span>
<span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Failed to record audit log: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">auditLog</span><span class="p">.</span><span class="na">getSummary</span><span class="p">(),</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * エンティティの変更履歴を取得</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuditLog</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getEntityHistory</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">entityType</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">entityId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">auditLogRepository</span><span class="p">.</span><span class="na">findByEntity</span><span class="p">(</span><span class="n">entityType</span><span class="p">,</span><span class="w"> </span><span class="n">entityId</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * ユーザーの操作履歴を取得</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuditLog</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getUserActivity</span><span class="p">(</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span>
<span class="w">            </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">startDate</span><span class="p">,</span>
<span class="w">            </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">endDate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">auditLogRepository</span><span class="p">.</span><span class="na">findByUser</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">startDate</span><span class="p">,</span><span class="w"> </span><span class="n">endDate</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 期間別の監査ログを取得</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuditLog</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getAuditLogsForPeriod</span><span class="p">(</span>
<span class="w">            </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">startDate</span><span class="p">,</span>
<span class="w">            </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">endDate</span><span class="p">,</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">limit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">auditLogRepository</span><span class="p">.</span><span class="na">findByPeriod</span><span class="p">(</span><span class="n">startDate</span><span class="p">,</span><span class="w"> </span><span class="n">endDate</span><span class="p">,</span><span class="w"> </span><span class="n">limit</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * アクション別の監査ログを取得</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuditLog</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getAuditLogsByAction</span><span class="p">(</span>
<span class="w">            </span><span class="n">AuditAction</span><span class="w"> </span><span class="n">action</span><span class="p">,</span>
<span class="w">            </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">startDate</span><span class="p">,</span>
<span class="w">            </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">endDate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">auditLogRepository</span><span class="p">.</span><span class="na">findByAction</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">startDate</span><span class="p">,</span><span class="w"> </span><span class="n">endDate</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 仕訳の全履歴を取得</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuditLog</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getJournalHistory</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">journalNumber</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">auditLogRepository</span><span class="p">.</span><span class="na">findByEntity</span><span class="p">(</span><span class="s">&quot;JournalEntry&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">journalNumber</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 監査統計を取得</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">AuditStatistics</span><span class="w"> </span><span class="nf">getStatistics</span><span class="p">(</span>
<span class="w">            </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">startDate</span><span class="p">,</span>
<span class="w">            </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">endDate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">totalCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">auditLogRepository</span><span class="p">.</span><span class="na">count</span><span class="p">(</span><span class="n">startDate</span><span class="p">,</span><span class="w"> </span><span class="n">endDate</span><span class="p">);</span>

<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuditLog</span><span class="o">&gt;</span><span class="w"> </span><span class="n">creates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">auditLogRepository</span><span class="p">.</span><span class="na">findByAction</span><span class="p">(</span>
<span class="w">            </span><span class="n">AuditAction</span><span class="p">.</span><span class="na">CREATE</span><span class="p">,</span><span class="w"> </span><span class="n">startDate</span><span class="p">,</span><span class="w"> </span><span class="n">endDate</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuditLog</span><span class="o">&gt;</span><span class="w"> </span><span class="n">updates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">auditLogRepository</span><span class="p">.</span><span class="na">findByAction</span><span class="p">(</span>
<span class="w">            </span><span class="n">AuditAction</span><span class="p">.</span><span class="na">UPDATE</span><span class="p">,</span><span class="w"> </span><span class="n">startDate</span><span class="p">,</span><span class="w"> </span><span class="n">endDate</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuditLog</span><span class="o">&gt;</span><span class="w"> </span><span class="n">deletes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">auditLogRepository</span><span class="p">.</span><span class="na">findByAction</span><span class="p">(</span>
<span class="w">            </span><span class="n">AuditAction</span><span class="p">.</span><span class="na">DELETE</span><span class="p">,</span><span class="w"> </span><span class="n">startDate</span><span class="p">,</span><span class="w"> </span><span class="n">endDate</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuditLog</span><span class="o">&gt;</span><span class="w"> </span><span class="n">approves</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">auditLogRepository</span><span class="p">.</span><span class="na">findByAction</span><span class="p">(</span>
<span class="w">            </span><span class="n">AuditAction</span><span class="p">.</span><span class="na">APPROVE</span><span class="p">,</span><span class="w"> </span><span class="n">startDate</span><span class="p">,</span><span class="w"> </span><span class="n">endDate</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AuditStatistics</span><span class="p">(</span>
<span class="w">            </span><span class="n">totalCount</span><span class="p">,</span>
<span class="w">            </span><span class="n">creates</span><span class="p">.</span><span class="na">size</span><span class="p">(),</span>
<span class="w">            </span><span class="n">updates</span><span class="p">.</span><span class="na">size</span><span class="p">(),</span>
<span class="w">            </span><span class="n">deletes</span><span class="p">.</span><span class="na">size</span><span class="p">(),</span>
<span class="w">            </span><span class="n">approves</span><span class="p">.</span><span class="na">size</span><span class="p">()</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_11">統計情報<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.audit</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 監査統計情報</span>
<span class="cm"> */</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">record</span> <span class="nc">AuditStatistics</span><span class="p">(</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">totalCount</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">createCount</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">updateCount</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">deleteCount</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">approveCount</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nf">getCreateRatio</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">totalCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="w"> </span><span class="n">createCount</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">totalCount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nf">getUpdateRatio</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">totalCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="w"> </span><span class="n">updateCount</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">totalCount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nf">getDeleteRatio</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">totalCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="w"> </span><span class="n">deleteCount</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">totalCount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nf">getApproveRatio</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">totalCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="w"> </span><span class="n">approveCount</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">totalCount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="277-api">27.7 監査ログ API の実装<a class="headerlink" href="#277-api" title="Permanent link">&para;</a></h2>
<h3 id="rest">REST コントローラ<a class="headerlink" href="#rest" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.presentation.api</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.application.AuditLogService</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.audit.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io.swagger.v3.oas.annotations.Operation</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io.swagger.v3.oas.annotations.tags.Tag</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.RequiredArgsConstructor</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.format.annotation.DateTimeFormat</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.http.ResponseEntity</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.access.prepost.PreAuthorize</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.*</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDateTime</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 監査ログAPIコントローラ</span>
<span class="cm"> */</span>
<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;/api/audit-logs&quot;</span><span class="p">)</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@Tag</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;監査ログ&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;監査ログの検索・レポート&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AuditLogController</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AuditLogService</span><span class="w"> </span><span class="n">auditLogService</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/entity/{entityType}/{entityId}&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@Operation</span><span class="p">(</span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;エンティティの変更履歴を取得&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@PreAuthorize</span><span class="p">(</span><span class="s">&quot;hasAuthority(&#39;AUDIT_READ&#39;)&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuditLogResponse</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">getEntityHistory</span><span class="p">(</span>
<span class="w">            </span><span class="nd">@PathVariable</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">entityType</span><span class="p">,</span>
<span class="w">            </span><span class="nd">@PathVariable</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">entityId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuditLog</span><span class="o">&gt;</span><span class="w"> </span><span class="n">logs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">auditLogService</span><span class="p">.</span><span class="na">getEntityHistory</span><span class="p">(</span><span class="n">entityType</span><span class="p">,</span><span class="w"> </span><span class="n">entityId</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span>
<span class="w">            </span><span class="n">logs</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">map</span><span class="p">(</span><span class="n">AuditLogResponse</span><span class="p">::</span><span class="n">from</span><span class="p">).</span><span class="na">toList</span><span class="p">()</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/user/{userId}&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@Operation</span><span class="p">(</span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ユーザーの操作履歴を取得&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@PreAuthorize</span><span class="p">(</span><span class="s">&quot;hasAuthority(&#39;AUDIT_READ&#39;)&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuditLogResponse</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">getUserActivity</span><span class="p">(</span>
<span class="w">            </span><span class="nd">@PathVariable</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span>
<span class="w">            </span><span class="nd">@RequestParam</span><span class="w"> </span><span class="nd">@DateTimeFormat</span><span class="p">(</span><span class="n">iso</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DateTimeFormat</span><span class="p">.</span><span class="na">ISO</span><span class="p">.</span><span class="na">DATE_TIME</span><span class="p">)</span>
<span class="w">                </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">startDate</span><span class="p">,</span>
<span class="w">            </span><span class="nd">@RequestParam</span><span class="w"> </span><span class="nd">@DateTimeFormat</span><span class="p">(</span><span class="n">iso</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DateTimeFormat</span><span class="p">.</span><span class="na">ISO</span><span class="p">.</span><span class="na">DATE_TIME</span><span class="p">)</span>
<span class="w">                </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">endDate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuditLog</span><span class="o">&gt;</span><span class="w"> </span><span class="n">logs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">auditLogService</span><span class="p">.</span><span class="na">getUserActivity</span><span class="p">(</span>
<span class="w">            </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">startDate</span><span class="p">,</span><span class="w"> </span><span class="n">endDate</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span>
<span class="w">            </span><span class="n">logs</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">map</span><span class="p">(</span><span class="n">AuditLogResponse</span><span class="p">::</span><span class="n">from</span><span class="p">).</span><span class="na">toList</span><span class="p">()</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/period&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@Operation</span><span class="p">(</span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;期間別の監査ログを取得&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@PreAuthorize</span><span class="p">(</span><span class="s">&quot;hasAuthority(&#39;AUDIT_READ&#39;)&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuditLogResponse</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">getAuditLogsByPeriod</span><span class="p">(</span>
<span class="w">            </span><span class="nd">@RequestParam</span><span class="w"> </span><span class="nd">@DateTimeFormat</span><span class="p">(</span><span class="n">iso</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DateTimeFormat</span><span class="p">.</span><span class="na">ISO</span><span class="p">.</span><span class="na">DATE_TIME</span><span class="p">)</span>
<span class="w">                </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">startDate</span><span class="p">,</span>
<span class="w">            </span><span class="nd">@RequestParam</span><span class="w"> </span><span class="nd">@DateTimeFormat</span><span class="p">(</span><span class="n">iso</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DateTimeFormat</span><span class="p">.</span><span class="na">ISO</span><span class="p">.</span><span class="na">DATE_TIME</span><span class="p">)</span>
<span class="w">                </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">endDate</span><span class="p">,</span>
<span class="w">            </span><span class="nd">@RequestParam</span><span class="p">(</span><span class="n">defaultValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;100&quot;</span><span class="p">)</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">limit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuditLog</span><span class="o">&gt;</span><span class="w"> </span><span class="n">logs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">auditLogService</span><span class="p">.</span><span class="na">getAuditLogsForPeriod</span><span class="p">(</span>
<span class="w">            </span><span class="n">startDate</span><span class="p">,</span><span class="w"> </span><span class="n">endDate</span><span class="p">,</span><span class="w"> </span><span class="n">limit</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span>
<span class="w">            </span><span class="n">logs</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">map</span><span class="p">(</span><span class="n">AuditLogResponse</span><span class="p">::</span><span class="n">from</span><span class="p">).</span><span class="na">toList</span><span class="p">()</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/action/{action}&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@Operation</span><span class="p">(</span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;アクション別の監査ログを取得&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@PreAuthorize</span><span class="p">(</span><span class="s">&quot;hasAuthority(&#39;AUDIT_READ&#39;)&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuditLogResponse</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">getAuditLogsByAction</span><span class="p">(</span>
<span class="w">            </span><span class="nd">@PathVariable</span><span class="w"> </span><span class="n">AuditAction</span><span class="w"> </span><span class="n">action</span><span class="p">,</span>
<span class="w">            </span><span class="nd">@RequestParam</span><span class="w"> </span><span class="nd">@DateTimeFormat</span><span class="p">(</span><span class="n">iso</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DateTimeFormat</span><span class="p">.</span><span class="na">ISO</span><span class="p">.</span><span class="na">DATE_TIME</span><span class="p">)</span>
<span class="w">                </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">startDate</span><span class="p">,</span>
<span class="w">            </span><span class="nd">@RequestParam</span><span class="w"> </span><span class="nd">@DateTimeFormat</span><span class="p">(</span><span class="n">iso</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DateTimeFormat</span><span class="p">.</span><span class="na">ISO</span><span class="p">.</span><span class="na">DATE_TIME</span><span class="p">)</span>
<span class="w">                </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">endDate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuditLog</span><span class="o">&gt;</span><span class="w"> </span><span class="n">logs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">auditLogService</span><span class="p">.</span><span class="na">getAuditLogsByAction</span><span class="p">(</span>
<span class="w">            </span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">startDate</span><span class="p">,</span><span class="w"> </span><span class="n">endDate</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span>
<span class="w">            </span><span class="n">logs</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">map</span><span class="p">(</span><span class="n">AuditLogResponse</span><span class="p">::</span><span class="n">from</span><span class="p">).</span><span class="na">toList</span><span class="p">()</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/journal/{journalNumber}&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@Operation</span><span class="p">(</span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;仕訳の全履歴を取得&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@PreAuthorize</span><span class="p">(</span><span class="s">&quot;hasAuthority(&#39;JOURNAL_READ&#39;)&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuditLogResponse</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">getJournalHistory</span><span class="p">(</span>
<span class="w">            </span><span class="nd">@PathVariable</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">journalNumber</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuditLog</span><span class="o">&gt;</span><span class="w"> </span><span class="n">logs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">auditLogService</span><span class="p">.</span><span class="na">getJournalHistory</span><span class="p">(</span><span class="n">journalNumber</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span>
<span class="w">            </span><span class="n">logs</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">map</span><span class="p">(</span><span class="n">AuditLogResponse</span><span class="p">::</span><span class="n">from</span><span class="p">).</span><span class="na">toList</span><span class="p">()</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/statistics&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@Operation</span><span class="p">(</span><span class="n">summary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;監査統計を取得&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@PreAuthorize</span><span class="p">(</span><span class="s">&quot;hasAuthority(&#39;AUDIT_READ&#39;)&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">AuditStatisticsResponse</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getStatistics</span><span class="p">(</span>
<span class="w">            </span><span class="nd">@RequestParam</span><span class="w"> </span><span class="nd">@DateTimeFormat</span><span class="p">(</span><span class="n">iso</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DateTimeFormat</span><span class="p">.</span><span class="na">ISO</span><span class="p">.</span><span class="na">DATE_TIME</span><span class="p">)</span>
<span class="w">                </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">startDate</span><span class="p">,</span>
<span class="w">            </span><span class="nd">@RequestParam</span><span class="w"> </span><span class="nd">@DateTimeFormat</span><span class="p">(</span><span class="n">iso</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DateTimeFormat</span><span class="p">.</span><span class="na">ISO</span><span class="p">.</span><span class="na">DATE_TIME</span><span class="p">)</span>
<span class="w">                </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">endDate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="n">AuditStatistics</span><span class="w"> </span><span class="n">statistics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">auditLogService</span><span class="p">.</span><span class="na">getStatistics</span><span class="p">(</span>
<span class="w">            </span><span class="n">startDate</span><span class="p">,</span><span class="w"> </span><span class="n">endDate</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="n">AuditStatisticsResponse</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="n">statistics</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="dto">レスポンスDTO<a class="headerlink" href="#dto" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.presentation.api.dto</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.audit.AuditLog</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.audit.AuditStatistics</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.fasterxml.jackson.annotation.JsonFormat</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.Builder</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.Data</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDateTime</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 監査ログレスポンス</span>
<span class="cm"> */</span>
<span class="nd">@Data</span>
<span class="nd">@Builder</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AuditLogResponse</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">entityType</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">entityId</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">action</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">actionDisplayName</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">userName</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@JsonFormat</span><span class="p">(</span><span class="n">pattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;yyyy-MM-dd&#39;T&#39;HH:mm:ss&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">timestamp</span><span class="p">;</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">oldValues</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">newValues</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">reason</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">summary</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">AuditLogResponse</span><span class="w"> </span><span class="nf">from</span><span class="p">(</span><span class="n">AuditLog</span><span class="w"> </span><span class="n">log</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">AuditLogResponse</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">id</span><span class="p">(</span><span class="n">log</span><span class="p">.</span><span class="na">getId</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">entityType</span><span class="p">(</span><span class="n">log</span><span class="p">.</span><span class="na">getEntityType</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">entityId</span><span class="p">(</span><span class="n">log</span><span class="p">.</span><span class="na">getEntityId</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">action</span><span class="p">(</span><span class="n">log</span><span class="p">.</span><span class="na">getAction</span><span class="p">().</span><span class="na">name</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">actionDisplayName</span><span class="p">(</span><span class="n">log</span><span class="p">.</span><span class="na">getAction</span><span class="p">().</span><span class="na">getDisplayName</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">userId</span><span class="p">(</span><span class="n">log</span><span class="p">.</span><span class="na">getUserId</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">userName</span><span class="p">(</span><span class="n">log</span><span class="p">.</span><span class="na">getUserName</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">timestamp</span><span class="p">(</span><span class="n">log</span><span class="p">.</span><span class="na">getTimestamp</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">oldValues</span><span class="p">(</span><span class="n">log</span><span class="p">.</span><span class="na">getOldValues</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">newValues</span><span class="p">(</span><span class="n">log</span><span class="p">.</span><span class="na">getNewValues</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">reason</span><span class="p">(</span><span class="n">log</span><span class="p">.</span><span class="na">getReason</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">summary</span><span class="p">(</span><span class="n">log</span><span class="p">.</span><span class="na">getSummary</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * 監査統計レスポンス</span>
<span class="cm"> */</span>
<span class="nd">@Data</span>
<span class="nd">@Builder</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AuditStatisticsResponse</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">totalCount</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">createCount</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">updateCount</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">deleteCount</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">approveCount</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">createRatio</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">updateRatio</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">deleteRatio</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">approveRatio</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">AuditStatisticsResponse</span><span class="w"> </span><span class="nf">from</span><span class="p">(</span><span class="n">AuditStatistics</span><span class="w"> </span><span class="n">stats</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">AuditStatisticsResponse</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">totalCount</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="na">totalCount</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">createCount</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="na">createCount</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">updateCount</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="na">updateCount</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">deleteCount</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="na">deleteCount</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">approveCount</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="na">approveCount</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">createRatio</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="na">getCreateRatio</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">updateRatio</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="na">getUpdateRatio</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">deleteRatio</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="na">getDeleteRatio</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">approveRatio</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="na">getApproveRatio</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="278-aop">27.8 AOPによる自動監査記録<a class="headerlink" href="#278-aop" title="Permanent link">&para;</a></h2>
<h3 id="_12">監査アノテーション<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.audit</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.audit.AuditAction</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.annotation.ElementType</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.annotation.Retention</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.annotation.RetentionPolicy</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.annotation.Target</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 監査対象メソッドを示すアノテーション</span>
<span class="cm"> */</span>
<span class="nd">@Target</span><span class="p">(</span><span class="n">ElementType</span><span class="p">.</span><span class="na">METHOD</span><span class="p">)</span>
<span class="nd">@Retention</span><span class="p">(</span><span class="n">RetentionPolicy</span><span class="p">.</span><span class="na">RUNTIME</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="nd">@interface</span><span class="w"> </span><span class="n">Audited</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * エンティティ種別</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="nf">entityType</span><span class="p">();</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * アクション種別</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">AuditAction</span><span class="w"> </span><span class="nf">action</span><span class="p">();</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * エンティティIDを取得するSpEL式</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="nf">entityIdExpression</span><span class="p">()</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_13">監査アスペクト<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.audit</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.application.AuditLogService</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.audit.AuditLog</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.servlet.http.HttpServletRequest</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.RequiredArgsConstructor</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.extern.slf4j.Slf4j</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.aspectj.lang.ProceedingJoinPoint</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.aspectj.lang.annotation.Around</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.aspectj.lang.annotation.Aspect</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.expression.EvaluationContext</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.expression.ExpressionParser</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.expression.spel.standard.SpelExpressionParser</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.expression.spel.support.StandardEvaluationContext</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.core.context.SecurityContextHolder</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.stereotype.Component</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.context.request.RequestContextHolder</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.context.request.ServletRequestAttributes</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 監査アスペクト</span>
<span class="cm"> *</span>
<span class="cm"> * @Audited アノテーションが付与されたメソッドの実行を監査ログに記録する。</span>
<span class="cm"> */</span>
<span class="nd">@Aspect</span>
<span class="nd">@Component</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AuditAspect</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AuditLogService</span><span class="w"> </span><span class="n">auditLogService</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ExpressionParser</span><span class="w"> </span><span class="n">parser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SpelExpressionParser</span><span class="p">();</span>

<span class="w">    </span><span class="nd">@Around</span><span class="p">(</span><span class="s">&quot;@annotation(audited)&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">audit</span><span class="p">(</span><span class="n">ProceedingJoinPoint</span><span class="w"> </span><span class="n">joinPoint</span><span class="p">,</span><span class="w"> </span><span class="n">Audited</span><span class="w"> </span><span class="n">audited</span><span class="p">)</span>
<span class="w">            </span><span class="kd">throws</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="c1">// ユーザー情報取得</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCurrentUserId</span><span class="p">();</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">userName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCurrentUserName</span><span class="p">();</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">ipAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getClientIpAddress</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// エンティティID取得</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">entityId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">evaluateEntityId</span><span class="p">(</span>
<span class="w">            </span><span class="n">audited</span><span class="p">.</span><span class="na">entityIdExpression</span><span class="p">(),</span>
<span class="w">            </span><span class="n">joinPoint</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Audit start: {} {} {} by {}&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">audited</span><span class="p">.</span><span class="na">action</span><span class="p">(),</span>
<span class="w">            </span><span class="n">audited</span><span class="p">.</span><span class="na">entityType</span><span class="p">(),</span>
<span class="w">            </span><span class="n">entityId</span><span class="p">,</span>
<span class="w">            </span><span class="n">userId</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// メソッド実行</span>
<span class="w">            </span><span class="n">Object</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">joinPoint</span><span class="p">.</span><span class="na">proceed</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// 成功時の監査ログ記録</span>
<span class="w">            </span><span class="n">AuditLog</span><span class="w"> </span><span class="n">auditLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AuditLog</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">entityType</span><span class="p">(</span><span class="n">audited</span><span class="p">.</span><span class="na">entityType</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">entityId</span><span class="p">(</span><span class="n">entityId</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">action</span><span class="p">(</span><span class="n">audited</span><span class="p">.</span><span class="na">action</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">userId</span><span class="p">(</span><span class="n">userId</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">userName</span><span class="p">(</span><span class="n">userName</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">timestamp</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">time</span><span class="p">.</span><span class="na">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">newValues</span><span class="p">(</span><span class="n">extractResultData</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">ipAddress</span><span class="p">(</span><span class="n">ipAddress</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>

<span class="w">            </span><span class="n">auditLogService</span><span class="p">.</span><span class="na">record</span><span class="p">(</span><span class="n">auditLog</span><span class="p">);</span>

<span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Audit complete: {} {} {}&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">audited</span><span class="p">.</span><span class="na">action</span><span class="p">(),</span>
<span class="w">                </span><span class="n">audited</span><span class="p">.</span><span class="na">entityType</span><span class="p">(),</span>
<span class="w">                </span><span class="n">entityId</span>
<span class="w">            </span><span class="p">);</span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>

<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Audit failed: {} {} {} - {}&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">audited</span><span class="p">.</span><span class="na">action</span><span class="p">(),</span>
<span class="w">                </span><span class="n">audited</span><span class="p">.</span><span class="na">entityType</span><span class="p">(),</span>
<span class="w">                </span><span class="n">entityId</span><span class="p">,</span>
<span class="w">                </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">()</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getCurrentUserId</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">auth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SecurityContextHolder</span><span class="p">.</span><span class="na">getContext</span><span class="p">().</span><span class="na">getAuthentication</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">auth</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">auth</span><span class="p">.</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&quot;SYSTEM&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getCurrentUserName</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 実際にはUserDetailsから取得</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;システムユーザー&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getClientIpAddress</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ServletRequestAttributes</span><span class="w"> </span><span class="n">attrs</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="p">(</span><span class="n">ServletRequestAttributes</span><span class="p">)</span><span class="w"> </span><span class="n">RequestContextHolder</span><span class="p">.</span><span class="na">getRequestAttributes</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">attrs</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">attrs</span><span class="p">.</span><span class="na">getRequest</span><span class="p">();</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">xff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getHeader</span><span class="p">(</span><span class="s">&quot;X-Forwarded-For&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">xff</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">xff</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getRemoteAddr</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">evaluateEntityId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">expression</span><span class="p">,</span><span class="w"> </span><span class="n">ProceedingJoinPoint</span><span class="w"> </span><span class="n">jp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">expression</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">expression</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;unknown&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">EvaluationContext</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StandardEvaluationContext</span><span class="p">();</span>
<span class="w">        </span><span class="n">Object</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jp</span><span class="p">.</span><span class="na">getArgs</span><span class="p">();</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">context</span><span class="p">.</span><span class="na">setVariable</span><span class="p">(</span><span class="s">&quot;arg&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">parser</span><span class="p">.</span><span class="na">parseExpression</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">getValue</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;Failed to evaluate entity ID expression: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">expression</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;unknown&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@SuppressWarnings</span><span class="p">(</span><span class="s">&quot;unchecked&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">extractResultData</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// 実際にはObjectMapperでMapに変換</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;result&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_14">使用例<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nd">@Service</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JournalService</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Audited</span><span class="p">(</span>
<span class="w">        </span><span class="n">entityType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;JournalEntry&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AuditAction</span><span class="p">.</span><span class="na">CREATE</span><span class="p">,</span>
<span class="w">        </span><span class="n">entityIdExpression</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;#result.journalNumber.value&quot;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">JournalEntry</span><span class="w"> </span><span class="nf">createJournal</span><span class="p">(</span><span class="n">CreateJournalCommand</span><span class="w"> </span><span class="n">command</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 仕訳作成ロジック</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">journalRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Audited</span><span class="p">(</span>
<span class="w">        </span><span class="n">entityType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;JournalEntry&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AuditAction</span><span class="p">.</span><span class="na">APPROVE</span><span class="p">,</span>
<span class="w">        </span><span class="n">entityIdExpression</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;#arg0&quot;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">JournalEntry</span><span class="w"> </span><span class="nf">approveJournal</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">journalNumber</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 仕訳承認ロジック</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">journalRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">journal</span><span class="p">.</span><span class="na">approve</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="279">27.9 監査レポート機能<a class="headerlink" href="#279" title="Permanent link">&para;</a></h2>
<h3 id="_15">監査レポートサービス<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.application</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.audit.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.RequiredArgsConstructor</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDate</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDateTime</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.stream.Collectors</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 監査レポートサービス</span>
<span class="cm"> */</span>
<span class="nd">@Service</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AuditReportService</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AuditLogRepository</span><span class="w"> </span><span class="n">auditLogRepository</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 日次監査レポートを生成</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">DailyAuditReport</span><span class="w"> </span><span class="nf">generateDailyReport</span><span class="p">(</span><span class="n">LocalDate</span><span class="w"> </span><span class="n">date</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">startOfDay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">date</span><span class="p">.</span><span class="na">atStartOfDay</span><span class="p">();</span>
<span class="w">        </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">endOfDay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">date</span><span class="p">.</span><span class="na">plusDays</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="na">atStartOfDay</span><span class="p">();</span>

<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuditLog</span><span class="o">&gt;</span><span class="w"> </span><span class="n">logs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">auditLogRepository</span><span class="p">.</span><span class="na">findByPeriod</span><span class="p">(</span>
<span class="w">            </span><span class="n">startOfDay</span><span class="p">,</span><span class="w"> </span><span class="n">endOfDay</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">MAX_VALUE</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="c1">// アクション別集計</span>
<span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">AuditAction</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">actionCounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logs</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">groupingBy</span><span class="p">(</span>
<span class="w">                </span><span class="n">AuditLog</span><span class="p">::</span><span class="n">getAction</span><span class="p">,</span>
<span class="w">                </span><span class="n">Collectors</span><span class="p">.</span><span class="na">counting</span><span class="p">()</span>
<span class="w">            </span><span class="p">));</span>

<span class="w">        </span><span class="c1">// エンティティ種別別集計</span>
<span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">entityCounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logs</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">groupingBy</span><span class="p">(</span>
<span class="w">                </span><span class="n">AuditLog</span><span class="p">::</span><span class="n">getEntityType</span><span class="p">,</span>
<span class="w">                </span><span class="n">Collectors</span><span class="p">.</span><span class="na">counting</span><span class="p">()</span>
<span class="w">            </span><span class="p">));</span>

<span class="w">        </span><span class="c1">// ユーザー別集計</span>
<span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">userCounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logs</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">groupingBy</span><span class="p">(</span>
<span class="w">                </span><span class="n">AuditLog</span><span class="p">::</span><span class="n">getUserId</span><span class="p">,</span>
<span class="w">                </span><span class="n">Collectors</span><span class="p">.</span><span class="na">counting</span><span class="p">()</span>
<span class="w">            </span><span class="p">));</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DailyAuditReport</span><span class="p">(</span>
<span class="w">            </span><span class="n">date</span><span class="p">,</span>
<span class="w">            </span><span class="n">logs</span><span class="p">.</span><span class="na">size</span><span class="p">(),</span>
<span class="w">            </span><span class="n">actionCounts</span><span class="p">,</span>
<span class="w">            </span><span class="n">entityCounts</span><span class="p">,</span>
<span class="w">            </span><span class="n">userCounts</span><span class="p">,</span>
<span class="w">            </span><span class="n">logs</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * ユーザー操作履歴レポートを生成</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">UserActivityReport</span><span class="w"> </span><span class="nf">generateUserActivityReport</span><span class="p">(</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span>
<span class="w">            </span><span class="n">LocalDate</span><span class="w"> </span><span class="n">startDate</span><span class="p">,</span>
<span class="w">            </span><span class="n">LocalDate</span><span class="w"> </span><span class="n">endDate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuditLog</span><span class="o">&gt;</span><span class="w"> </span><span class="n">logs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">auditLogRepository</span><span class="p">.</span><span class="na">findByUser</span><span class="p">(</span>
<span class="w">            </span><span class="n">userId</span><span class="p">,</span>
<span class="w">            </span><span class="n">startDate</span><span class="p">.</span><span class="na">atStartOfDay</span><span class="p">(),</span>
<span class="w">            </span><span class="n">endDate</span><span class="p">.</span><span class="na">plusDays</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="na">atStartOfDay</span><span class="p">()</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 日別集計</span>
<span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">LocalDate</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dailyCounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logs</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">groupingBy</span><span class="p">(</span>
<span class="w">                </span><span class="n">log</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">log</span><span class="p">.</span><span class="na">getTimestamp</span><span class="p">().</span><span class="na">toLocalDate</span><span class="p">(),</span>
<span class="w">                </span><span class="n">Collectors</span><span class="p">.</span><span class="na">counting</span><span class="p">()</span>
<span class="w">            </span><span class="p">));</span>

<span class="w">        </span><span class="c1">// アクション別集計</span>
<span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">AuditAction</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">actionCounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logs</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">groupingBy</span><span class="p">(</span>
<span class="w">                </span><span class="n">AuditLog</span><span class="p">::</span><span class="n">getAction</span><span class="p">,</span>
<span class="w">                </span><span class="n">Collectors</span><span class="p">.</span><span class="na">counting</span><span class="p">()</span>
<span class="w">            </span><span class="p">));</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UserActivityReport</span><span class="p">(</span>
<span class="w">            </span><span class="n">userId</span><span class="p">,</span>
<span class="w">            </span><span class="n">startDate</span><span class="p">,</span>
<span class="w">            </span><span class="n">endDate</span><span class="p">,</span>
<span class="w">            </span><span class="n">logs</span><span class="p">.</span><span class="na">size</span><span class="p">(),</span>
<span class="w">            </span><span class="n">dailyCounts</span><span class="p">,</span>
<span class="w">            </span><span class="n">actionCounts</span><span class="p">,</span>
<span class="w">            </span><span class="n">logs</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 変更履歴レポートを生成</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">EntityChangeReport</span><span class="w"> </span><span class="nf">generateEntityChangeReport</span><span class="p">(</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">entityType</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">entityId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuditLog</span><span class="o">&gt;</span><span class="w"> </span><span class="n">logs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">auditLogRepository</span><span class="p">.</span><span class="na">findByEntity</span><span class="p">(</span><span class="n">entityType</span><span class="p">,</span><span class="w"> </span><span class="n">entityId</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">EntityChangeReport</span><span class="p">(</span>
<span class="w">            </span><span class="n">entityType</span><span class="p">,</span>
<span class="w">            </span><span class="n">entityId</span><span class="p">,</span>
<span class="w">            </span><span class="n">logs</span><span class="p">.</span><span class="na">size</span><span class="p">(),</span>
<span class="w">            </span><span class="n">logs</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">logs</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="na">getTimestamp</span><span class="p">(),</span>
<span class="w">            </span><span class="n">logs</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">logs</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">logs</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">).</span><span class="na">getTimestamp</span><span class="p">(),</span>
<span class="w">            </span><span class="n">logs</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="dto_1">レポートDTO<a class="headerlink" href="#dto_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.audit</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDate</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDateTime</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 日次監査レポート</span>
<span class="cm"> */</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">record</span> <span class="nc">DailyAuditReport</span><span class="p">(</span>
<span class="w">    </span><span class="n">LocalDate</span><span class="w"> </span><span class="n">date</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">totalCount</span><span class="p">,</span>
<span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">AuditAction</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">actionCounts</span><span class="p">,</span>
<span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">entityCounts</span><span class="p">,</span>
<span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">userCounts</span><span class="p">,</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuditLog</span><span class="o">&gt;</span><span class="w"> </span><span class="n">logs</span>
<span class="p">)</span><span class="w"> </span><span class="p">{}</span>

<span class="cm">/**</span>
<span class="cm"> * ユーザー操作履歴レポート</span>
<span class="cm"> */</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">record</span> <span class="nc">UserActivityReport</span><span class="p">(</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span>
<span class="w">    </span><span class="n">LocalDate</span><span class="w"> </span><span class="n">startDate</span><span class="p">,</span>
<span class="w">    </span><span class="n">LocalDate</span><span class="w"> </span><span class="n">endDate</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">totalCount</span><span class="p">,</span>
<span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">LocalDate</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dailyCounts</span><span class="p">,</span>
<span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">AuditAction</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">actionCounts</span><span class="p">,</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuditLog</span><span class="o">&gt;</span><span class="w"> </span><span class="n">logs</span>
<span class="p">)</span><span class="w"> </span><span class="p">{}</span>

<span class="cm">/**</span>
<span class="cm"> * エンティティ変更履歴レポート</span>
<span class="cm"> */</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">record</span> <span class="nc">EntityChangeReport</span><span class="p">(</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">entityType</span><span class="p">,</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">entityId</span><span class="p">,</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">changeCount</span><span class="p">,</span>
<span class="w">    </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">firstChange</span><span class="p">,</span>
<span class="w">    </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">lastChange</span><span class="p">,</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuditLog</span><span class="o">&gt;</span><span class="w"> </span><span class="n">history</span>
<span class="p">)</span><span class="w"> </span><span class="p">{}</span>
</code></pre></div>
<hr />
<h2 id="_16">まとめ<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h2>
<p>本章では、財務会計システムにおける監査ログとトレーサビリティ機能について解説しました。</p>
<h3 id="_17">重要なポイント<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p><strong>法的要件への対応</strong>: 会社法、金融商品取引法、電子帳簿保存法、J-SOX に準拠した監査証跡を実装しました。</p>
</li>
<li>
<p><strong>5つの設計原則</strong>: 完全性、正確性、不変性、トレーサビリティ、検索可能性を満たす設計を行いました。</p>
</li>
<li>
<p><strong>ドメインイベント駆動</strong>: Spring Events を活用し、エンティティの変更を自動的に監査ログに記録する仕組みを実装しました。</p>
</li>
<li>
<p><strong>AOP による自動記録</strong>: <code>@Audited</code> アノテーションにより、ビジネスロジックと監査ロジックを分離しました。</p>
</li>
<li>
<p><strong>JSONB による柔軟な保存</strong>: PostgreSQL の JSONB 型を活用し、スキーマ変更に強い変更履歴の保存を実現しました。</p>
</li>
</ol>
<h3 id="_18">法的要件への対応状況<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>要件</th>
<th>実装</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>完全性</strong></td>
<td>すべての重要操作をイベント駆動で自動記録</td>
</tr>
<tr>
<td><strong>正確性</strong></td>
<td>変更前後の値を JSONB で正確に保存</td>
</tr>
<tr>
<td><strong>不変性</strong></td>
<td><code>@Value</code>（Lombok）と Append-Only テーブル</td>
</tr>
<tr>
<td><strong>長期保存</strong></td>
<td>パーティショニングで10年保存に対応可能</td>
</tr>
<tr>
<td><strong>検索可能性</strong></td>
<td>適切なインデックス設計で効率的な検索</td>
</tr>
<tr>
<td><strong>トレーサビリティ</strong></td>
<td>5W1H（誰が、いつ、何を、なぜ、どう）を記録</td>
</tr>
</tbody>
</table>
<h3 id="_19">財務会計固有の監査対象<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>エンティティ</th>
<th>主な監査対象操作</th>
</tr>
</thead>
<tbody>
<tr>
<td>仕訳（JournalEntry）</td>
<td>作成、更新、承認、確定、取消</td>
</tr>
<tr>
<td>勘定科目（Account）</td>
<td>作成、更新、削除</td>
</tr>
<tr>
<td>財務諸表</td>
<td>生成、ダウンロード</td>
</tr>
<tr>
<td>ユーザー</td>
<td>ログイン、ログアウト、権限変更</td>
</tr>
</tbody>
</table>
<p>次章では、楽観ロックの実装について解説します。</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/k2works/case-study-accounting" target="_blank" rel="noopener" title="財務会計システム ケーススタディ" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../../assets/js/extra.js"></script>
      
    
  </body>
</html>