
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="財務会計システムの設計・開発ドキュメント">
      
      
        <meta name="author" content="Project Team">
      
      
      
        <link rel="prev" href="../chapter27/">
      
      
        <link rel="next" href="../chapter29/">
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>chapter28 - 財務会計システム ケーススタディ</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#28-4-" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="財務会計システム ケーススタディ" class="md-header__button md-logo" aria-label="財務会計システム ケーススタディ" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            財務会計システム ケーススタディ
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              chapter28
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/k2works/case-study-accounting" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    case-study-accounting
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../requirements/requirements_definition/" class="md-tabs__link">
          
  
  
  要件定義

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../design/architecture_backend/" class="md-tabs__link">
          
  
  
  設計

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../development/release_plan/" class="md-tabs__link">
          
  
  
  開発

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../operation/dev_env/" class="md-tabs__link">
          
  
  
  運用

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../reference/%E9%96%8B%E7%99%BA%E3%82%AC%E3%82%A4%E3%83%89/" class="md-tabs__link">
          
  
  
  リファレンス

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../template/ADR/" class="md-tabs__link">
          
  
  
  テンプレート

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../" class="md-tabs__link">
          
  
  
  実践ガイド

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../functional-java/" class="md-tabs__link">
          
  
  
  関数型プログラミング実践ガイド

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="財務会計システム ケーススタディ" class="md-nav__button md-logo" aria-label="財務会計システム ケーススタディ" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    財務会計システム ケーススタディ
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/k2works/case-study-accounting" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    case-study-accounting
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    要件定義
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    要件定義
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../requirements/requirements_definition/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    要件定義書
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../requirements/business_usecase/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ビジネスユースケース
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../requirements/system_usecase/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    システムユースケース
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../requirements/user_story/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ユーザーストーリー
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    設計
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    設計
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    アーキテクチャ
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    アーキテクチャ
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/architecture_backend/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    バックエンド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/architecture_frontend/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    フロントエンド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/architecture_infrastructure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    インフラストラクチャ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    モデル設計
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    モデル設計
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/data-model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    データモデル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/domain-model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ドメインモデル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/ui-design/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    UI 設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/test_strategy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    テスト戦略
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/non_functional/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    非機能要件
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/operation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    運用要件
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/tech_stack/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    技術スタック選定
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    開発
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    開発
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../development/release_plan/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    リリース計画
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    イテレーション計画
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    イテレーション計画
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../development/iteration_plan-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    イテレーション1
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    ふりかえり
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    ふりかえり
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../development/retrospective-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    イテレーション1
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    運用
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    運用
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/dev_env/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    開発環境解説
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/dev_container/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    開発コンテナ構築手順書
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/backend_setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    バックエンド構築手順書
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/backend_demo_env/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    バックエンドデモ環境
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/frontend_setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    フロントエンド構築手順書
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/frontend_dev/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    フロントエンド開発手順
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/frontend_common_ui/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    フロントエンド共通 UI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/frontend_demo_env/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    フロントエンドデモ環境
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/deploy_demo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    デモ環境デプロイ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/third_party_service/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    外部サービス連携
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/sonarqube_setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SonarQube セットアップガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/e2e_test/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    E2E テスト実行手順書
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../operation/github_project/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    GitHub Project 運用ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    リファレンス
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    リファレンス
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1" >
        
          
          <label class="md-nav__link" for="__nav_6_1" id="__nav_6_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    開発ガイドライン
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    開発ガイドライン
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E9%96%8B%E7%99%BA%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    開発ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%82%88%E3%81%84%E3%82%BD%E3%83%95%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A2%E3%81%A8%E3%81%AF/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    よいソフトウェアとは
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%82%B3%E3%83%BC%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0%E3%81%A8%E3%83%86%E3%82%B9%E3%83%88%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    コーディングとテストガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%A0%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    エクストリームプログラミング
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2" >
        
          
          <label class="md-nav__link" for="__nav_6_2" id="__nav_6_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    分析・設計ガイド
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    分析・設計ガイド
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E8%A6%81%E4%BB%B6%E5%AE%9A%E7%BE%A9%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    要件定義ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%83%A6%E3%83%BC%E3%82%B9%E3%82%B1%E3%83%BC%E3%82%B9%E4%BD%9C%E6%88%90%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ユースケース作成ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3%E8%A8%AD%E8%A8%88%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    アーキテクチャ設計ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%83%87%E3%83%BC%E3%82%BF%E3%83%A2%E3%83%87%E3%83%AB%E8%A8%AD%E8%A8%88%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    データモデル設計ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%83%A2%E3%83%87%E3%83%AB%E8%A8%AD%E8%A8%88%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ドメインモデル設計ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/UI%E8%A8%AD%E8%A8%88%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    UI設計ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%82%A4%E3%83%B3%E3%83%95%E3%83%A9%E8%A8%AD%E8%A8%88%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    インフラ設計ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3" >
        
          
          <label class="md-nav__link" for="__nav_6_3" id="__nav_6_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    非機能・運用ガイド
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    非機能・運用ガイド
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%83%86%E3%82%B9%E3%83%88%E6%88%A6%E7%95%A5%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    テスト戦略ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E9%9D%9E%E6%A9%9F%E8%83%BD%E8%A6%81%E4%BB%B6%E5%AE%9A%E7%BE%A9%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    非機能要件定義ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E9%81%8B%E7%94%A8%E8%A6%81%E4%BB%B6%E5%AE%9A%E7%BE%A9%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    運用要件定義ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/%E3%83%AA%E3%83%AA%E3%83%BC%E3%82%B9%E3%83%BB%E3%82%A4%E3%83%86%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E8%A8%88%E7%94%BB%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    リリース・イテレーション計画ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4" >
        
          
          <label class="md-nav__link" for="__nav_6_4" id="__nav_6_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    環境構築ガイド
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    環境構築ガイド
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/Java%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Javaアプリケーション環境構築ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/TypeScript%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89%E3%82%AC%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    TypeScriptアプリケーション環境構築ガイド
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/CodexCLIMCP%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E8%A8%AD%E5%AE%9A%E6%89%8B%E9%A0%86/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Codex CLI MCP サーバー設定手順
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    テンプレート
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    テンプレート
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../template/ADR/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../template/%E3%82%A4%E3%83%86%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E5%AE%8C%E4%BA%86%E5%A0%B1%E5%91%8A%E6%9B%B8/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    イテレーション完了報告書
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../template/%E3%82%A4%E3%83%B3%E3%82%BB%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%87%E3%83%83%E3%82%AD/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    インセプションデッキ
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../template/%E3%81%BE%E3%81%9A%E3%81%93%E3%82%8C%E3%82%92%E8%AA%AD%E3%82%82%E3%81%86%E3%83%AA%E3%82%B9%E3%83%88/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    まずこれを読もうリスト
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../template/%E5%AE%8C%E5%85%A8%E5%BD%A2%E5%BC%8F%E3%81%AE%E3%83%A6%E3%83%BC%E3%82%B9%E3%82%B1%E3%83%BC%E3%82%B9/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    完全形式のユースケース
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../template/%E8%A6%81%E4%BB%B6%E5%AE%9A%E7%BE%A9/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    要件定義
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../template/%E8%A8%AD%E8%A8%88/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    設計
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    実践ガイド
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    実践ガイド
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概要
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2" checked>
        
          
          <label class="md-nav__link" for="__nav_8_2" id="__nav_8_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    バックエンド編（Java版）
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    バックエンド編（Java版）
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter00/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    はじめに
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter01/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第1章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter02/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第2章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter03/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第3章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter04/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第4章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter05/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第5章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter06/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第6章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter07/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第7章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter08/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第8章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter09/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第9章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter10/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第10章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter11/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第11章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter12/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第12章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter13/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第13章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter14/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第14章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter15/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第15章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter16/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第16章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter17/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第17章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter18/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第18章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter19/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第19章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter20/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第20章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter21/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第21章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter22/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第22章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter23/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第23章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter24/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第24章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter25/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第25章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter26/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第26章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter27/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第27章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    第28章
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    第28章
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#281" class="md-nav__link">
    <span class="md-ellipsis">
      
        28.1 排他制御の概要
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="28.1 排他制御の概要">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        同時実行制御の必要性
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vs" class="md-nav__link">
    <span class="md-ellipsis">
      
        悲観ロック vs 楽観ロック
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        財務会計システムにおける楽観ロックの適用
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#282" class="md-nav__link">
    <span class="md-ellipsis">
      
        28.2 楽観ロックの設計
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="28.2 楽観ロックの設計">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        バージョン番号方式
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        テーブル設計
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#version" class="md-nav__link">
    <span class="md-ellipsis">
      
        既存テーブルへの version 列追加
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#283-version" class="md-nav__link">
    <span class="md-ellipsis">
      
        28.3 ドメインモデルへの version 追加
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="28.3 ドメインモデルへの version 追加">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#versionable" class="md-nav__link">
    <span class="md-ellipsis">
      
        Versionable インターフェース
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#account" class="md-nav__link">
    <span class="md-ellipsis">
      
        Account ドメインモデルへの適用
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#journalentry" class="md-nav__link">
    <span class="md-ellipsis">
      
        JournalEntry ドメインモデルへの適用
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#284" class="md-nav__link">
    <span class="md-ellipsis">
      
        28.4 楽観ロック例外の定義
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="28.4 楽観ロック例外の定義">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        例外クラス階層
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      
        例外クラスの実装
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#285-entity-version" class="md-nav__link">
    <span class="md-ellipsis">
      
        28.5 Entity への version 追加
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="28.5 Entity への version 追加">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#accountentity" class="md-nav__link">
    <span class="md-ellipsis">
      
        AccountEntity
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#journalentity" class="md-nav__link">
    <span class="md-ellipsis">
      
        JournalEntity
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#286-mybatis-mapper" class="md-nav__link">
    <span class="md-ellipsis">
      
        28.6 MyBatis Mapper の実装
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="28.6 MyBatis Mapper の実装">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#update" class="md-nav__link">
    <span class="md-ellipsis">
      
        楽観ロック対応の UPDATE 文
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mapper-xml" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mapper XML
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#journalmapper" class="md-nav__link">
    <span class="md-ellipsis">
      
        JournalMapper
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#287-repository" class="md-nav__link">
    <span class="md-ellipsis">
      
        28.7 Repository 実装
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="28.7 Repository 実装">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#accountrepositoryimpl" class="md-nav__link">
    <span class="md-ellipsis">
      
        AccountRepositoryImpl
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#journalentryrepositoryimpl" class="md-nav__link">
    <span class="md-ellipsis">
      
        JournalEntryRepositoryImpl
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#288-application-service" class="md-nav__link">
    <span class="md-ellipsis">
      
        28.8 Application Service での楽観ロック処理
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="28.8 Application Service での楽観ロック処理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#accountservice" class="md-nav__link">
    <span class="md-ellipsis">
      
        AccountService
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#journalentryservice" class="md-nav__link">
    <span class="md-ellipsis">
      
        JournalEntryService
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#289-rest-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        28.9 REST API でのエラーハンドリング
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="28.9 REST API でのエラーハンドリング">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      
        例外ハンドラ
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#controller-version" class="md-nav__link">
    <span class="md-ellipsis">
      
        Controller での version の扱い
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dto-version" class="md-nav__link">
    <span class="md-ellipsis">
      
        DTO への version 追加
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2810-tdd" class="md-nav__link">
    <span class="md-ellipsis">
      
        28.10 TDD による実装例
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="28.10 TDD による実装例">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      
        楽観ロックのテスト
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      
        仕訳承認ワークフローのテスト
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#e2e" class="md-nav__link">
    <span class="md-ellipsis">
      
        E2E テスト
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2811" class="md-nav__link">
    <span class="md-ellipsis">
      
        28.11 まとめ
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="28.11 まとめ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      
        学んだこと
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      
        設計のポイント
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      
        実装チェックリスト
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter29/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第29章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter30/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第30章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter31/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第31章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter32/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第32章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_3" >
        
          
          <label class="md-nav__link" for="__nav_8_3" id="__nav_8_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    フロントエンド編（React版）
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    フロントエンド編（React版）
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter00/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    はじめに
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter01/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第1章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter02/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第2章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter03/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第3章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter04/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第4章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter05/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第5章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter06/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第6章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter07/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第7章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter08/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第8章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter09/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第9章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter10/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第10章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter11/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第11章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter12/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第12章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter13/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第13章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter14/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第14章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter15/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第15章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter16/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第16章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter17/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第17章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter18/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第18章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter19/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第19章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter20/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第20章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter21/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第21章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter22/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第22章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter23/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第23章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frontend/chapter24/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    第24章
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    関数型プログラミング実践ガイド
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    関数型プログラミング実践ガイド
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_1" >
        
          
          <label class="md-nav__link" for="__nav_9_1" id="__nav_9_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    関数型プログラミング（Java版）
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_9_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    関数型プログラミング（Java版）
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../functional-java/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    はじめに
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../functional-java/part-1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part I 基礎
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../functional-java/part-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part II 関数型スタイル
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../functional-java/part-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part III エラーハンドリング
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../functional-java/part-4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part IV IO と副作用
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../functional-java/part-5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part V 並行処理
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../functional-java/part-6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part VI 実践
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="28-4-">第28章: 非機能要件 4 - 楽観ロックの実装<a class="headerlink" href="#28-4-" title="Permanent link">&para;</a></h1>
<h2 id="281">28.1 排他制御の概要<a class="headerlink" href="#281" title="Permanent link">&para;</a></h2>
<h3 id="_1">同時実行制御の必要性<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<p>財務会計システムでは、複数のユーザーが同時に同じデータを更新しようとする状況が発生します。適切な排他制御がないと、データの不整合や更新の消失（Lost Update）が発生する可能性があります。</p>
<p><img src="data:image/svg+xml;base64,PD9wbGFudHVtbCAxLjIwMjYuMD8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IlNFUVVFTkNFIiBoZWlnaHQ9IjY3NXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NzM5cHg7aGVpZ2h0OjY3NXB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDczOSA2NzUiIHdpZHRoPSI3MzlweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PHRpdGxlPkxvc3QgVXBkYXRlICYjMjE4Mzk7JiMzODk4ODs8L3RpdGxlPjxkZWZzLz48Zz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTI4LjM1ODMiIHg9IjMwNy4wNjIzIiB5PSIyNy45OTUxIj5Mb3N0IFVwZGF0ZSAmIzIxODM5OyYjMzg5ODg7PC90ZXh0PjxnIGNsYXNzPSJwYXJ0aWNpcGFudC1saWZlbGluZSIgZGF0YS1lbnRpdHktdWlkPSJwYXJ0MSIgZGF0YS1xdWFsaWZpZWQtbmFtZT0idXNlckEiIGlkPSJwYXJ0MS1saWZlbGluZSI+PGc+PHRpdGxlPi4uLi5BPC90aXRsZT48cmVjdCBmaWxsPSIjMDAwMDAwIiBmaWxsLW9wYWNpdHk9IjAuMDAwMDAiIGhlaWdodD0iNDkyLjEyNSIgd2lkdGg9IjgiIHg9IjQwLjc4ODUiIHk9IjEwNC41OTM4Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7c3Ryb2tlLWRhc2hhcnJheTo1LDU7IiB4MT0iNDQiIHgyPSI0NCIgeTE9IjEwNC41OTM4IiB5Mj0iNTk2LjcxODgiLz48L2c+PC9nPjxnIGNsYXNzPSJwYXJ0aWNpcGFudC1saWZlbGluZSIgZGF0YS1lbnRpdHktdWlkPSJwYXJ0MiIgZGF0YS1xdWFsaWZpZWQtbmFtZT0ic3lzIiBpZD0icGFydDItbGlmZWxpbmUiPjxnPjx0aXRsZT4uLi4uPC90aXRsZT48cmVjdCBmaWxsPSIjMDAwMDAwIiBmaWxsLW9wYWNpdHk9IjAuMDAwMDAiIGhlaWdodD0iNDkyLjEyNSIgd2lkdGg9IjgiIHg9IjI0OC43ODgxIiB5PSIxMDQuNTkzOCIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41O3N0cm9rZS1kYXNoYXJyYXk6NSw1OyIgeDE9IjI1MS43ODgyIiB4Mj0iMjUxLjc4ODIiIHkxPSIxMDQuNTkzOCIgeTI9IjU5Ni43MTg4Ii8+PC9nPjwvZz48ZyBjbGFzcz0icGFydGljaXBhbnQtbGlmZWxpbmUiIGRhdGEtZW50aXR5LXVpZD0icGFydDMiIGRhdGEtcXVhbGlmaWVkLW5hbWU9InVzZXJCIiBpZD0icGFydDMtbGlmZWxpbmUiPjxnPjx0aXRsZT4uLi4uQjwvdGl0bGU+PHJlY3QgZmlsbD0iIzAwMDAwMCIgZmlsbC1vcGFjaXR5PSIwLjAwMDAwIiBoZWlnaHQ9IjQ5Mi4xMjUiIHdpZHRoPSI4IiB4PSI0NTYuNzg3OCIgeT0iMTA0LjU5MzgiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTtzdHJva2UtZGFzaGFycmF5OjUsNTsiIHgxPSI0NTkuOTg1NyIgeDI9IjQ1OS45ODU3IiB5MT0iMTA0LjU5MzgiIHkyPSI1OTYuNzE4OCIvPjwvZz48L2c+PGcgY2xhc3M9InBhcnRpY2lwYW50LWxpZmVsaW5lIiBkYXRhLWVudGl0eS11aWQ9InBhcnQ0IiBkYXRhLXF1YWxpZmllZC1uYW1lPSJkYiIgaWQ9InBhcnQ0LWxpZmVsaW5lIj48Zz48dGl0bGU+Li4uLi4uPC90aXRsZT48cmVjdCBmaWxsPSIjMDAwMDAwIiBmaWxsLW9wYWNpdHk9IjAuMDAwMDAiIGhlaWdodD0iNDkyLjEyNSIgd2lkdGg9IjgiIHg9IjU1MS41ODk3IiB5PSIxMDQuNTkzOCIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41O3N0cm9rZS1kYXNoYXJyYXk6NSw1OyIgeDE9IjU1NC41ODk5IiB4Mj0iNTU0LjU4OTkiIHkxPSIxMDQuNTkzOCIgeTI9IjU5Ni43MTg4Ii8+PC9nPjwvZz48ZyBjbGFzcz0icGFydGljaXBhbnQgcGFydGljaXBhbnQtaGVhZCIgZGF0YS1lbnRpdHktdWlkPSJwYXJ0MSIgZGF0YS1xdWFsaWZpZWQtbmFtZT0idXNlckEiIGlkPSJwYXJ0MS1oZWFkIj48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9Ijc5LjU3NjkiIHg9IjUiIHk9IjczLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2NS41NzY5IiB4PSIxMiIgeT0iOTMuMjkyIj4mIzEyNTE4OyYjMTI1NDA7JiMxMjQ3MDsmIzEyNTQwO0E8L3RleHQ+PC9nPjxnIGNsYXNzPSJwYXJ0aWNpcGFudCBwYXJ0aWNpcGFudC10YWlsIiBkYXRhLWVudGl0eS11aWQ9InBhcnQxIiBkYXRhLXF1YWxpZmllZC1uYW1lPSJ1c2VyQSIgaWQ9InBhcnQxLXRhaWwiPjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNzkuNTc2OSIgeD0iNSIgeT0iNTk1LjcxODgiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2NS41NzY5IiB4PSIxMiIgeT0iNjE1LjcxMzkiPiYjMTI1MTg7JiMxMjU0MDsmIzEyNDcwOyYjMTI1NDA7QTwvdGV4dD48L2c+PGcgY2xhc3M9InBhcnRpY2lwYW50IHBhcnRpY2lwYW50LWhlYWQiIGRhdGEtZW50aXR5LXVpZD0icGFydDIiIGRhdGEtcXVhbGlmaWVkLW5hbWU9InN5cyIgaWQ9InBhcnQyLWhlYWQiPjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNjkuOTk5OCIgeD0iMjE3Ljc4ODIiIHk9IjczLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1NS45OTk4IiB4PSIyMjQuNzg4MiIgeT0iOTMuMjkyIj4mIzEyNDcxOyYjMTI0NzM7JiMxMjQ4NjsmIzEyNTEyOzwvdGV4dD48L2c+PGcgY2xhc3M9InBhcnRpY2lwYW50IHBhcnRpY2lwYW50LXRhaWwiIGRhdGEtZW50aXR5LXVpZD0icGFydDIiIGRhdGEtcXVhbGlmaWVkLW5hbWU9InN5cyIgaWQ9InBhcnQyLXRhaWwiPjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNjkuOTk5OCIgeD0iMjE3Ljc4ODIiIHk9IjU5NS43MTg4Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTUuOTk5OCIgeD0iMjI0Ljc4ODIiIHk9IjYxNS43MTM5Ij4mIzEyNDcxOyYjMTI0NzM7JiMxMjQ4NjsmIzEyNTEyOzwvdGV4dD48L2c+PGcgY2xhc3M9InBhcnRpY2lwYW50IHBhcnRpY2lwYW50LWhlYWQiIGRhdGEtZW50aXR5LXVpZD0icGFydDMiIGRhdGEtcXVhbGlmaWVkLW5hbWU9InVzZXJCIiBpZD0icGFydDMtaGVhZCI+PHJlY3QgZmlsbD0iI0UyRTJGMCIgaGVpZ2h0PSIzMC4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI3OS42MDQyIiB4PSI0MjAuOTg1NyIgeT0iNzMuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY1LjYwNDIiIHg9IjQyNy45ODU3IiB5PSI5My4yOTIiPiYjMTI1MTg7JiMxMjU0MDsmIzEyNDcwOyYjMTI1NDA7QjwvdGV4dD48L2c+PGcgY2xhc3M9InBhcnRpY2lwYW50IHBhcnRpY2lwYW50LXRhaWwiIGRhdGEtZW50aXR5LXVpZD0icGFydDMiIGRhdGEtcXVhbGlmaWVkLW5hbWU9InVzZXJCIiBpZD0icGFydDMtdGFpbCI+PHJlY3QgZmlsbD0iI0UyRTJGMCIgaGVpZ2h0PSIzMC4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI3OS42MDQyIiB4PSI0MjAuOTg1NyIgeT0iNTk1LjcxODgiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2NS42MDQyIiB4PSI0MjcuOTg1NyIgeT0iNjE1LjcxMzkiPiYjMTI1MTg7JiMxMjU0MDsmIzEyNDcwOyYjMTI1NDA7QjwvdGV4dD48L2c+PGcgY2xhc3M9InBhcnRpY2lwYW50IHBhcnRpY2lwYW50LWhlYWQiIGRhdGEtZW50aXR5LXVpZD0icGFydDQiIGRhdGEtcXVhbGlmaWVkLW5hbWU9ImRiIiBpZD0icGFydDQtaGVhZCI+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODMuOTk5NiIgeD0iNTEwLjU4OTkiIHk9IjEwMS4yOTIiPiYjMTI0ODc7JiMxMjU0MDsmIzEyNDc5OyYjMTI1MDU7JiMxMjU0MDsmIzEyNDczOzwvdGV4dD48cGF0aCBkPSJNNTM3LjU4OTcsNTIuMjk2OSBDNTM3LjU4OTcsNDIuMjk2OSA1NTUuNTg5Nyw0Mi4yOTY5IDU1NS41ODk3LDQyLjI5NjkgQzU1NS41ODk3LDQyLjI5NjkgNTczLjU4OTcsNDIuMjk2OSA1NzMuNTg5Nyw1Mi4yOTY5IEw1NzMuNTg5Nyw3OC4yOTY5IEM1NzMuNTg5Nyw4OC4yOTY5IDU1NS41ODk3LDg4LjI5NjkgNTU1LjU4OTcsODguMjk2OSBDNTU1LjU4OTcsODguMjk2OSA1MzcuNTg5Nyw4OC4yOTY5IDUzNy41ODk3LDc4LjI5NjkgTDUzNy41ODk3LDUyLjI5NjkiIGZpbGw9IiNFMkUyRjAiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik01MzcuNTg5Nyw1Mi4yOTY5IEM1MzcuNTg5Nyw2Mi4yOTY5IDU1NS41ODk3LDYyLjI5NjkgNTU1LjU4OTcsNjIuMjk2OSBDNTU1LjU4OTcsNjIuMjk2OSA1NzMuNTg5Nyw2Mi4yOTY5IDU3My41ODk3LDUyLjI5NjkiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjwvZz48ZyBjbGFzcz0icGFydGljaXBhbnQgcGFydGljaXBhbnQtdGFpbCIgZGF0YS1lbnRpdHktdWlkPSJwYXJ0NCIgZGF0YS1xdWFsaWZpZWQtbmFtZT0iZGIiIGlkPSJwYXJ0NC10YWlsIj48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI4My45OTk2IiB4PSI1MTAuNTg5OSIgeT0iNjA4LjcxMzkiPiYjMTI0ODc7JiMxMjU0MDsmIzEyNDc5OyYjMTI1MDU7JiMxMjU0MDsmIzEyNDczOzwvdGV4dD48cGF0aCBkPSJNNTM3LjU4OTcsNjIyLjAxNTYgQzUzNy41ODk3LDYxMi4wMTU2IDU1NS41ODk3LDYxMi4wMTU2IDU1NS41ODk3LDYxMi4wMTU2IEM1NTUuNTg5Nyw2MTIuMDE1NiA1NzMuNTg5Nyw2MTIuMDE1NiA1NzMuNTg5Nyw2MjIuMDE1NiBMNTczLjU4OTcsNjQ4LjAxNTYgQzU3My41ODk3LDY1OC4wMTU2IDU1NS41ODk3LDY1OC4wMTU2IDU1NS41ODk3LDY1OC4wMTU2IEM1NTUuNTg5Nyw2NTguMDE1NiA1MzcuNTg5Nyw2NTguMDE1NiA1MzcuNTg5Nyw2NDguMDE1NiBMNTM3LjU4OTcsNjIyLjAxNTYiIGZpbGw9IiNFMkUyRjAiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik01MzcuNTg5Nyw2MjIuMDE1NiBDNTM3LjU4OTcsNjMyLjAxNTYgNTU1LjU4OTcsNjMyLjAxNTYgNTU1LjU4OTcsNjMyLjAxNTYgQzU1NS41ODk3LDYzMi4wMTU2IDU3My41ODk3LDYzMi4wMTU2IDU3My41ODk3LDYyMi4wMTU2IiBmaWxsPSJub25lIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48L2c+PGcgY2xhc3M9Im1lc3NhZ2UiIGRhdGEtZW50aXR5LTE9InBhcnQxIiBkYXRhLWVudGl0eS0yPSJwYXJ0MiIgaWQ9Im1zZzEiPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjQwLjc4ODEsMTMxLjcyNjYsMjUwLjc4ODEsMTM1LjcyNjYsMjQwLjc4ODEsMTM5LjcyNjYsMjQ0Ljc4ODEsMTM1LjcyNjYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7IiB4MT0iNDQuNzg4NSIgeDI9IjI0Ni43ODgxIiB5MT0iMTM1LjcyNjYiIHkyPSIxMzUuNzI2NiIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE4My45OTk3IiB4PSI1MS43ODg1IiB5PSIxMzAuNjYwNiI+JiMyMDE4MTsmIzM1Mzc5OyYjMTI0MzQ7JiMyMTQ2MjsmIzI0NDcxOyYjNjUyODg7JiMyNzUzMTsmIzM5NjQwOzogMTAsMDAwJiMyMDg3MDsmIzY1Mjg5OzwvdGV4dD48L2c+PGcgY2xhc3M9Im1lc3NhZ2UiIGRhdGEtZW50aXR5LTE9InBhcnQyIiBkYXRhLWVudGl0eS0yPSJwYXJ0NCIgaWQ9Im1zZzIiPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNTQzLjU4OTcsMTYwLjg1OTQsNTUzLjU4OTcsMTY0Ljg1OTQsNTQzLjU4OTcsMTY4Ljg1OTQsNTQ3LjU4OTcsMTY0Ljg1OTQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7IiB4MT0iMjUyLjc4ODEiIHgyPSI1NDkuNTg5NyIgeTE9IjE2NC44NTk0IiB5Mj0iMTY0Ljg1OTQiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0OC45NDA0IiB4PSIyNTkuNzg4MSIgeT0iMTU5Ljc5MzUiPlNFTEVDVDwvdGV4dD48L2c+PGcgY2xhc3M9Im1lc3NhZ2UiIGRhdGEtZW50aXR5LTE9InBhcnQ0IiBkYXRhLWVudGl0eS0yPSJwYXJ0MiIgaWQ9Im1zZzMiPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjYzLjc4ODEsMTg5Ljk5MjIsMjUzLjc4ODEsMTkzLjk5MjIsMjYzLjc4ODEsMTk3Ljk5MjIsMjU5Ljc4ODEsMTkzLjk5MjIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheToyLDI7IiB4MT0iMjU3Ljc4ODEiIHgyPSI1NTQuNTg5NyIgeTE9IjE5My45OTIyIiB5Mj0iMTkzLjk5MjIiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5MC42NDQ2IiB4PSIyNjkuNzg4MSIgeT0iMTg4LjkyNjMiPiYjMjc1MzE7JiMzOTY0MDsgPSAxMCwwMDA8L3RleHQ+PC9nPjxnIGNsYXNzPSJtZXNzYWdlIiBkYXRhLWVudGl0eS0xPSJwYXJ0MiIgZGF0YS1lbnRpdHktMj0icGFydDEiIGlkPSJtc2c0Ij48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjU1Ljc4ODUsMjE5LjEyNSw0NS43ODg1LDIyMy4xMjUsNTUuNzg4NSwyMjcuMTI1LDUxLjc4ODUsMjIzLjEyNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjIsMjsiIHgxPSI0OS43ODg1IiB4Mj0iMjUxLjc4ODEiIHkxPSIyMjMuMTI1IiB5Mj0iMjIzLjEyNSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjkwLjY0NDYiIHg9IjYxLjc4ODUiIHk9IjIxOC4wNTkxIj4mIzI3NTMxOyYjMzk2NDA7ID0gMTAsMDAwPC90ZXh0PjwvZz48ZyBjbGFzcz0ibWVzc2FnZSIgZGF0YS1lbnRpdHktMT0icGFydDMiIGRhdGEtZW50aXR5LTI9InBhcnQyIiBpZD0ibXNnNSI+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyNjMuNzg4MSwyNDguMjU3OCwyNTMuNzg4MSwyNTIuMjU3OCwyNjMuNzg4MSwyNTYuMjU3OCwyNTkuNzg4MSwyNTIuMjU3OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHgxPSIyNTcuNzg4MSIgeDI9IjQ1OS43ODc4IiB5MT0iMjUyLjI1NzgiIHkyPSIyNTIuMjU3OCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE4My45OTk3IiB4PSIyNjkuNzg4MSIgeT0iMjQ3LjE5MTkiPiYjMjAxODE7JiMzNTM3OTsmIzEyNDM0OyYjMjE0NjI7JiMyNDQ3MTsmIzY1Mjg4OyYjMjc1MzE7JiMzOTY0MDs6IDEwLDAwMCYjMjA4NzA7JiM2NTI4OTs8L3RleHQ+PC9nPjxnIGNsYXNzPSJtZXNzYWdlIiBkYXRhLWVudGl0eS0xPSJwYXJ0MiIgZGF0YS1lbnRpdHktMj0icGFydDQiIGlkPSJtc2c2Ij48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjU0My41ODk3LDI3Ny4zOTA2LDU1My41ODk3LDI4MS4zOTA2LDU0My41ODk3LDI4NS4zOTA2LDU0Ny41ODk3LDI4MS4zOTA2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgeDE9IjI1Mi43ODgxIiB4Mj0iNTQ5LjU4OTciIHkxPSIyODEuMzkwNiIgeTI9IjI4MS4zOTA2Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDguOTQwNCIgeD0iMjU5Ljc4ODEiIHk9IjI3Ni4zMjQ3Ij5TRUxFQ1Q8L3RleHQ+PC9nPjxnIGNsYXNzPSJtZXNzYWdlIiBkYXRhLWVudGl0eS0xPSJwYXJ0NCIgZGF0YS1lbnRpdHktMj0icGFydDIiIGlkPSJtc2c3Ij48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjI2My43ODgxLDMwNi41MjM0LDI1My43ODgxLDMxMC41MjM0LDI2My43ODgxLDMxNC41MjM0LDI1OS43ODgxLDMxMC41MjM0IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6MiwyOyIgeDE9IjI1Ny43ODgxIiB4Mj0iNTU0LjU4OTciIHkxPSIzMTAuNTIzNCIgeTI9IjMxMC41MjM0Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTAuNjQ0NiIgeD0iMjY5Ljc4ODEiIHk9IjMwNS40NTc1Ij4mIzI3NTMxOyYjMzk2NDA7ID0gMTAsMDAwPC90ZXh0PjwvZz48ZyBjbGFzcz0ibWVzc2FnZSIgZGF0YS1lbnRpdHktMT0icGFydDIiIGRhdGEtZW50aXR5LTI9InBhcnQzIiBpZD0ibXNnOCI+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI0NDguNzg3OCwzMzUuNjU2Myw0NTguNzg3OCwzMzkuNjU2Myw0NDguNzg3OCwzNDMuNjU2Myw0NTIuNzg3OCwzMzkuNjU2MyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjIsMjsiIHgxPSIyNTIuNzg4MSIgeDI9IjQ1NC43ODc4IiB5MT0iMzM5LjY1NjMiIHkyPSIzMzkuNjU2MyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjkwLjY0NDYiIHg9IjI1OS43ODgxIiB5PSIzMzQuNTkwMyI+JiMyNzUzMTsmIzM5NjQwOyA9IDEwLDAwMDwvdGV4dD48L2c+PGcgY2xhc3M9Im1lc3NhZ2UiIGRhdGEtZW50aXR5LTE9InBhcnQxIiBkYXRhLWVudGl0eS0yPSJwYXJ0MiIgaWQ9Im1zZzkiPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjQwLjc4ODEsMzY0Ljc4OTEsMjUwLjc4ODEsMzY4Ljc4OTEsMjQwLjc4ODEsMzcyLjc4OTEsMjQ0Ljc4ODEsMzY4Ljc4OTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7IiB4MT0iNDQuNzg4NSIgeDI9IjI0Ni43ODgxIiB5MT0iMzY4Ljc4OTEiIHkyPSIzNjguNzg5MSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0MC42MTk3IiB4PSI1MS43ODg1IiB5PSIzNjMuNzIzMSI+JiMyNzUzMTsmIzM5NjQwOyYjMTI0MzQ7IDE1LDAwMCYjMjA4NzA7JiMxMjM5NTsmIzI2MzU2OyYjMjYwMzI7PC90ZXh0PjwvZz48ZyBjbGFzcz0ibWVzc2FnZSIgZGF0YS1lbnRpdHktMT0icGFydDIiIGRhdGEtZW50aXR5LTI9InBhcnQ0IiBpZD0ibXNnMTAiPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNTQzLjU4OTcsMzkzLjkyMTksNTUzLjU4OTcsMzk3LjkyMTksNTQzLjU4OTcsNDAxLjkyMTksNTQ3LjU4OTcsMzk3LjkyMTkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7IiB4MT0iMjUyLjc4ODEiIHgyPSI1NDkuNTg5NyIgeTE9IjM5Ny45MjE5IiB5Mj0iMzk3LjkyMTkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNzUuNzI4NSIgeD0iMjU5Ljc4ODEiIHk9IjM5Mi44NTYiPlVQREFURSBTRVQgJiMyNzUzMTsmIzM5NjQwOyA9IDE1LDAwMDwvdGV4dD48L2c+PGcgY2xhc3M9Im1lc3NhZ2UiIGRhdGEtZW50aXR5LTE9InBhcnQ0IiBkYXRhLWVudGl0eS0yPSJwYXJ0MiIgaWQ9Im1zZzExIj48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjI2My43ODgxLDQyMy4wNTQ3LDI1My43ODgxLDQyNy4wNTQ3LDI2My43ODgxLDQzMS4wNTQ3LDI1OS43ODgxLDQyNy4wNTQ3IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6MiwyOyIgeDE9IjI1Ny43ODgxIiB4Mj0iNTU0LjU4OTciIHkxPSI0MjcuMDU0NyIgeTI9IjQyNy4wNTQ3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTguNzU3MyIgeD0iMjY5Ljc4ODEiIHk9IjQyMS45ODg4Ij5PSzwvdGV4dD48L2c+PGcgY2xhc3M9Im1lc3NhZ2UiIGRhdGEtZW50aXR5LTE9InBhcnQyIiBkYXRhLWVudGl0eS0yPSJwYXJ0MSIgaWQ9Im1zZzEyIj48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjU1Ljc4ODUsNDUyLjE4NzUsNDUuNzg4NSw0NTYuMTg3NSw1NS43ODg1LDQ2MC4xODc1LDUxLjc4ODUsNDU2LjE4NzUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheToyLDI7IiB4MT0iNDkuNzg4NSIgeDI9IjI1MS43ODgxIiB5MT0iNDU2LjE4NzUiIHkyPSI0NTYuMTg3NSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjUyLjAwMDEiIHg9IjYxLjc4ODUiIHk9IjQ1MS4xMjE2Ij4mIzI2MzU2OyYjMjYwMzI7JiMyNTEwNDsmIzIxMTUxOzwvdGV4dD48L2c+PGcgY2xhc3M9Im1lc3NhZ2UiIGRhdGEtZW50aXR5LTE9InBhcnQzIiBkYXRhLWVudGl0eS0yPSJwYXJ0MiIgaWQ9Im1zZzEzIj48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjI2My43ODgxLDQ4MS4zMjAzLDI1My43ODgxLDQ4NS4zMjAzLDI2My43ODgxLDQ4OS4zMjAzLDI1OS43ODgxLDQ4NS4zMjAzIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgeDE9IjI1Ny43ODgxIiB4Mj0iNDU5Ljc4NzgiIHkxPSI0ODUuMzIwMyIgeTI9IjQ4NS4zMjAzIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTMyLjM0ODciIHg9IjI2OS43ODgxIiB5PSI0ODAuMjU0NCI+JiMyNzUzMTsmIzM5NjQwOyYjMTI0MzQ7IDgsMDAwJiMyMDg3MDsmIzEyMzk1OyYjMjYzNTY7JiMyNjAzMjs8L3RleHQ+PC9nPjxnIGNsYXNzPSJtZXNzYWdlIiBkYXRhLWVudGl0eS0xPSJwYXJ0MiIgZGF0YS1lbnRpdHktMj0icGFydDQiIGlkPSJtc2cxNCI+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI1NDMuNTg5Nyw1MTMuNDUzMSw1NTMuNTg5Nyw1MTcuNDUzMSw1NDMuNTg5Nyw1MjEuNDUzMSw1NDcuNTg5Nyw1MTcuNDUzMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHgxPSIyNTIuNzg4MSIgeDI9IjU0OS41ODk3IiB5MT0iNTE3LjQ1MzEiIHkyPSI1MTcuNDUzMSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE2Ny40NTc2IiB4PSIyNTkuNzg4MSIgeT0iNTEyLjM4NzIiPlVQREFURSBTRVQgJiMyNzUzMTsmIzM5NjQwOyA9IDgsMDAwPC90ZXh0PjwvZz48cGF0aCBkPSJNNTYwLDQ5OC4zMjAzIEw1NjAsNTIzLjMyMDMgTDczMiw1MjMuMzIwMyBMNzMyLDUwOC4zMjAzIEw3MjIsNDk4LjMyMDMgTDU2MCw0OTguMzIwMyIgZmlsbD0iI0ZFRkZERCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHBhdGggZD0iTTcyMiw0OTguMzIwMyBMNzIyLDUwOC4zMjAzIEw3MzIsNTA4LjMyMDMgTDcyMiw0OTguMzIwMyIgZmlsbD0iI0ZFRkZERCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTUxLjg5MzIiIHg9IjU2NiIgeT0iNTE1LjM4NzIiPiYjMTI1MTg7JiMxMjU0MDsmIzEyNDcwOyYjMTI1NDA7QSYjMTIzOTg7JiMyNjM1NjsmIzI2MDMyOyYjMTIzNjQ7JiMyODA0MDsmIzIyODMzOyYjNjUyODE7PC90ZXh0PjxnIGNsYXNzPSJtZXNzYWdlIiBkYXRhLWVudGl0eS0xPSJwYXJ0NCIgZGF0YS1lbnRpdHktMj0icGFydDIiIGlkPSJtc2cxNiI+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyNjMuNzg4MSw1NDUuNTg1OSwyNTMuNzg4MSw1NDkuNTg1OSwyNjMuNzg4MSw1NTMuNTg1OSwyNTkuNzg4MSw1NDkuNTg1OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjIsMjsiIHgxPSIyNTcuNzg4MSIgeDI9IjU1NC41ODk3IiB5MT0iNTQ5LjU4NTkiIHkyPSI1NDkuNTg1OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE4Ljc1NzMiIHg9IjI2OS43ODgxIiB5PSI1NDQuNTIiPk9LPC90ZXh0PjwvZz48ZyBjbGFzcz0ibWVzc2FnZSIgZGF0YS1lbnRpdHktMT0icGFydDIiIGRhdGEtZW50aXR5LTI9InBhcnQzIiBpZD0ibXNnMTciPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNDQ4Ljc4NzgsNTc0LjcxODgsNDU4Ljc4NzgsNTc4LjcxODgsNDQ4Ljc4NzgsNTgyLjcxODgsNDUyLjc4NzgsNTc4LjcxODgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheToyLDI7IiB4MT0iMjUyLjc4ODEiIHgyPSI0NTQuNzg3OCIgeTE9IjU3OC43MTg4IiB5Mj0iNTc4LjcxODgiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1Mi4wMDAxIiB4PSIyNTkuNzg4MSIgeT0iNTczLjY1MjgiPiYjMjYzNTY7JiMyNjAzMjsmIzI1MTA0OyYjMjExNTE7PC90ZXh0PjwvZz48P3BsYW50dW1sLXNyYyBBeWFpb0tiTHlDYWxCYjQ4QktYOUI0YkxVM2dyXy1OMjdZd2tXaUlZYWlwYXA4QjRsMTg1ZlNWRG9udXR4dGRTajByOEVZZWY5MU9oYjFRZDVaY1lBTWhRX2hYZnYtRmNqaVZEMnkxZ1lZa0JTSGxaMTNWNllHamVTTTlJT2Q0Z0k0S3hNQ04tbnlxcG1Pb1RPNktmSUxuU08xaUxURXIwbllmT0FKcFBGVk41WWlzRmNvT3p4UF9zVERfcXp0aXdkZ3RoVmhid1hmTTJlTzZFV083MXF4UXN6dGl3a0syQVdOZklhZTFRV2Jyek45cjNrODFpTlJXbjQ0cUFqYjFUNEZMME1PWGpjRjlXUHBaSHJIYkVrOW8xNTFlR1VRMHA1MG5EZVRPLVJicHpSRlFNUHpDc2U1V1U2azNZNkU4QVQ0QzhhZmJXQlFXRXlsVjYzMGdtUVN5dzlacGpjZXlIM1dXN005MWlGclc3THJ1LUNGS0xQUVBkYjVXZmVBSXRudXRoODBPelJrbnZqZ3Rad1BBRHhfU3F1ZE1qNHZmaDBHMDA/PjwvZz48L3N2Zz4=" class="uml" alt="uml diagram" title="" /></p>
<h3 id="vs">悲観ロック vs 楽観ロック<a class="headerlink" href="#vs" title="Permanent link">&para;</a></h3>
<p>排他制御には主に2つのアプローチがあります。</p>
<table>
<thead>
<tr>
<th>方式</th>
<th>仕組み</th>
<th>メリット</th>
<th>デメリット</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>悲観ロック</strong></td>
<td>読み取り時にロックを取得</td>
<td>競合を確実に防止</td>
<td>パフォーマンス低下、デッドロックのリスク</td>
</tr>
<tr>
<td><strong>楽観ロック</strong></td>
<td>更新時にバージョンをチェック</td>
<td>パフォーマンス良好、デッドロックなし</td>
<td>競合時のリトライが必要</td>
</tr>
</tbody>
</table>
<p><img src="data:image/svg+xml;base64,PD9wbGFudHVtbCAxLjIwMjYuMD8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkNMQVNTIiBoZWlnaHQ9IjQ0MXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6MzUzcHg7aGVpZ2h0OjQ0MXB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDM1MyA0NDEiIHdpZHRoPSIzNTNweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PHRpdGxlPiYjMjU0OTA7JiMyMDE4MjsmIzIxMDQ2OyYjMjQ0ODE7JiMxMjM5ODsmIzI3NjA0OyYjMzY2MTE7PC90aXRsZT48ZGVmcy8+PGc+PGcgY2xhc3M9InRpdGxlIiBkYXRhLXNvdXJjZS1saW5lPSIxIj48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTcuOTk5NiIgeD0iMTIwLjUwMDMiIHk9IjIyLjk5NTEiPiYjMjU0OTA7JiMyMDE4MjsmIzIxMDQ2OyYjMjQ0ODE7JiMxMjM5ODsmIzI3NjA0OyYjMzY2MTE7PC90ZXh0PjwvZz48IS0tY2x1c3RlciBwZXNzaW1pc3RpYy0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLXF1YWxpZmllZC1uYW1lPSJwZXNzaW1pc3RpYyIgZGF0YS1zb3VyY2UtbGluZT0iMyIgaWQ9ImVudDAwMDIiPjxyZWN0IGZpbGw9Im5vbmUiIGhlaWdodD0iMTA3LjI3IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iMjQxIiB4PSI3IiB5PSI0NC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY5Ljk5OTciIHg9IjkyLjUwMDIiIHk9IjU5LjI5MiI+JiMyNDc1NDsmIzM1MjUxOyYjMTI1MjU7JiMxMjQ4MzsmIzEyNDYzOzwvdGV4dD48L2c+PCEtLWNsdXN0ZXIgb3B0aW1pc3RpYy0tPjxnIGNsYXNzPSJjbHVzdGVyIiBkYXRhLXF1YWxpZmllZC1uYW1lPSJvcHRpbWlzdGljIiBkYXRhLXNvdXJjZS1saW5lPSI3IiBpZD0iZW50MDAwNCI+PHJlY3QgZmlsbD0ibm9uZSIgaGVpZ2h0PSIxMDcuMjYiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSIxOTMiIHg9IjU1IiB5PSIyMzEuNTY2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2OS45OTk3IiB4PSIxMTYuNTAwMiIgeT0iMjQ2LjU2MiI+JiMyNzAwNTsmIzM1MjUxOyYjMTI1MjU7JiMxMjQ4MzsmIzEyNDYzOzwvdGV4dD48L2c+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1xdWFsaWZpZWQtbmFtZT0icGVzc2ltaXN0aWMubjEiIGRhdGEtc291cmNlLWxpbmU9IjQiIGlkPSJlbnQwMDAzIj48cGF0aCBkPSJNMzEuMDYsODcuMjk2OSBMMzEuMDYsMTI3LjU2MjUgTDIwNC45NDk2LDEyNy41NjI1IEwyMDQuOTQ5Niw5Ny4yOTY5IEwxOTQuOTQ5Niw4Ny4yOTY5IEwzMS4wNiw4Ny4yOTY5IiBmaWxsPSIjRkVGRkREIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNMTk0Ljk0OTYsODcuMjk2OSBMMTk0Ljk0OTYsOTcuMjk2OSBMMjA0Ljk0OTYsOTcuMjk2OSBMMTk0Ljk0OTYsODcuMjk2OSIgZmlsbD0iI0ZFRkZERCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE1Mi44ODk2IiB4PSIzNy4wNiIgeT0iMTA0LjM2MzgiPlNFTEVDVCAuLi4gRk9SIFVQREFURTwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5MS4wMDAxIiB4PSIzNy4wNiIgeT0iMTE5LjQ5NjYiPiYjMTIzOTE7JiMzNDg5MjsmIzEyNTI1OyYjMTI0ODM7JiMxMjQ2MzsmIzIxNDYyOyYjMjQ0NzE7PC90ZXh0PjwvZz48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLXF1YWxpZmllZC1uYW1lPSJvcHRpbWlzdGljLm4yIiBkYXRhLXNvdXJjZS1saW5lPSI4IiBpZD0iZW50MDAwNSI+PHBhdGggZD0iTTc5LjUsMjc0LjU2NjkgTDc5LjUsMzE0LjgzMjUgTDIwNC41MDAxLDMxNC44MzI1IEwyMDQuNTAwMSwyODQuNTY2OSBMMTk0LjUwMDEsMjc0LjU2NjkgTDc5LjUsMjc0LjU2NjkiIGZpbGw9IiNGRUZGREQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIvPjxwYXRoIGQ9Ik0xOTQuNTAwMSwyNzQuNTY2OSBMMTk0LjUwMDEsMjg0LjU2NjkgTDIwNC41MDAxLDI4NC41NjY5IEwxOTQuNTAwMSwyNzQuNTY2OSIgZmlsbD0iI0ZFRkZERCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwNC4wMDAxIiB4PSI4NS41IiB5PSIyOTEuNjMzOCI+JiMxMjQ5NjsmIzEyNTQwOyYjMTI0NzI7JiMxMjUxOTsmIzEyNTMxOyYjMzAwNTg7JiMyMTQ5NTsmIzEyMzkxOzwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2NS4wMDAxIiB4PSI4NS41IiB5PSIzMDYuNzY2NiI+JiMzMTQ3ODsmIzIxNTEyOyYjMTI0MzQ7JiMyNjkwODsmIzIwOTg2OzwvdGV4dD48L2c+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1xdWFsaWZpZWQtbmFtZT0iR01ONyIgZGF0YS1zb3VyY2UtbGluZT0iMTQiIGlkPSJlbnQwMDA4Ij48cGF0aCBkPSJNMTY0LjUsMzkzLjgyNjkgTDE2NC41LDQzNC4wOTI1IEwzMTUuNTAwMiw0MzQuMDkyNSBMMzE1LjUwMDIsNDAzLjgyNjkgTDMwNS41MDAyLDM5My44MjY5IEwxNjQuNSwzOTMuODI2OSIgZmlsbD0iI0ZFRkZERCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHBhdGggZD0iTTMwNS41MDAyLDM5My44MjY5IEwzMDUuNTAwMiw0MDMuODI2OSBMMzE1LjUwMDIsNDAzLjgyNjkgTDMwNS41MDAyLDM5My44MjY5IiBmaWxsPSIjRkVGRkREIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTMwLjAwMDIiIHg9IjE3MC41IiB5PSI0MTAuODkzOCI+JiMzNjAwMTsmIzIxMjA5OyYjMjAyNTA7JiMzNTMzNjsmIzEyNDcxOyYjMTI0NzM7JiMxMjQ4NjsmIzEyNTEyOyYjMTIzOTE7JiMxMjM5OTs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTA0LjAwMDEiIHg9IjE3MC41IiB5PSI0MjYuMDI2NiI+JiMyNzAwNTsmIzM1MjUxOyYjMTI1MjU7JiMxMjQ4MzsmIzEyNDYzOyYjMTI0MzQ7JiMyNTUwNTsmIzI5OTkyOzwvdGV4dD48L2c+PCEtLWxpbmsgcGVzc2ltaXN0aWMgdG8gb3B0aW1pc3RpYy0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJlbnQwMDAyIiBkYXRhLWVudGl0eS0yPSJlbnQwMDA0IiBkYXRhLWxpbmstdHlwZT0iZGVwZW5kZW5jeSIgZGF0YS1zb3VyY2UtbGluZT0iMTEiIGlkPSJsbms2Ij48cGF0aCBjb2RlTGluZT0iMTEiIGQ9Ik0yNDAsMTUxLjkxNDYgQzI0MCwxNTIuMjE3MSAyNDAsMTUyLjUyMDUgMjQwLDE1Mi44MjQ5IEMyNDAsMTU3LjY5NTEgMjQwLDE2Mi44MTIgMjQwLDE2OC4wOTM0IEMyNDAsMTc4LjY1NjMgMjQwLDE4OS44NzY5IDI0MCwyMDEuMDk2OSBDMjQwLDIwNi43MDY5IDI0MCwyMTIuMzE2NyAyNDAsMjE3Ljg0NDEgQzI0MCwyMjAuNjA3OCAyNDAsMjIzLjM1MDkgMjQwLDIyNi4wNjMgQzI0MCwyMjcuNDE5MSAyNDAsMjI4Ljc2NzUgMjQwLDIzMC4xMDY4IEMyNDAsMjMwLjQ0MTcgMjQwLDIyNC43NzU5IDI0MCwyMjUuMTA5NiIgZmlsbD0ibm9uZSIgaWQ9InBlc3NpbWlzdGljLXRvLW9wdGltaXN0aWMiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjI0MCwyMzEuMTA5NiwyNDQsMjIyLjEwOTYsMjQwLDIyNi4xMDk2LDIzNiwyMjIuMTA5NiwyNDAsMjMxLjEwOTYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5OC4yMzY0IiB4PSIyNDMuODgxOSIgeT0iMTg4LjYzMzgiPldlYiAmIzEyNDUwOyYjMTI1MDM7JiMxMjUyMjsmIzEyMzkxOyYjMTIzOTk7PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwNC4wMDAxIiB4PSIyNDEiIHk9IjIwMy43NjY2Ij4mIzI3MDA1OyYjMzUyNTE7JiMxMjUyNTsmIzEyNDgzOyYjMTI0NjM7JiMxMjM2NDsmIzI1NTEyOyYjMjI4ODg7PC90ZXh0PjwvZz48IS0tbGluayBvcHRpbWlzdGljIHRvIEdNTjctLT48ZyBjbGFzcz0ibGluayIgZGF0YS1lbnRpdHktMT0iZW50MDAwNCIgZGF0YS1lbnRpdHktMj0iZW50MDAwOCIgZGF0YS1saW5rLXR5cGU9ImFzc29jaWF0aW9uIiBkYXRhLXNvdXJjZS1saW5lPSIxNCIgaWQ9ImxuazkiPjxwYXRoIGQ9Ik0yNDAsMzM5LjAxNSBDMjQwLDMzOS42NTg1IDI0MCwzNDAuMzA0NiAyNDAsMzQwLjk1MzEgQzI0MCwzNDMuNTQ2OCAyNDAsMzQ2LjE3NzUgMjQwLDM0OC44MjMyIEMyNDAsMzU0LjExNDcgMjQwLDM1OS40NjY2IDI0MCwzNjQuNzA0NCBDMjQwLDM3NS4xOCAyNDAsMzg1LjE5OTQgMjQwLDM5My4zNjY5IiBmaWxsPSJub25lIiBpZD0ib3B0aW1pc3RpYy1HTU43IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheTo3LDc7Ii8+PC9nPjw/cGxhbnR1bWwtc3JjIFBPeERJaUQwNTRSdHluSDN6bXRlcWVLVzZiVTJlWEt0c1JHcklpMUVZZmNUazRXa1FDNkliYjlSNTFUNmgwcUwzUkpHLVhGeENoVUp2MzZTNmYxT3p6enRwazQ2Rno1ZnZCUGNkbnJINnVrZlhfUGg1QklKNDBXdnJTa3lvOHhiODFTdm0tSGZYRjIyMEVXNEVMZ3FRNU10QkFEWU1EbWVxcEYySjJ2dFUtZ01rYndXWWdCR3BVclRraC1waUxQR0RPUHNGXzdnbHRWSHc4WGZ6bVYyYmladk5yRmx3dl85aEY5NTRLOEo4S0pkM1E2RkM4Z2wxdzhuYUhnRG5TelpxUW9YcXVlVXh5SmJIc2ZQZGJrb21WZHlRWFF4R1dfcTRhTmQwUTZCQzkwV2owRURCU0lXTk96U05fSHlhYlFLSkN4RDJaTUZDWVlJMzNyblRKQ0JSbkRWTGFwR1VLVXVHQlhGY01HSEFKalRCc3h4SDZVN1Q0eHoxVzAwPz48L2c+PC9zdmc+" class="uml" alt="uml diagram" title="" /></p>
<h3 id="_2">財務会計システムにおける楽観ロックの適用<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>財務会計システムでは、以下の理由から楽観ロックを採用します。</p>
<ol>
<li><strong>Web アプリケーションの特性</strong>: 画面表示から更新までの時間が長い</li>
<li><strong>競合頻度</strong>: 同じデータを同時に更新する頻度は比較的低い</li>
<li><strong>スケーラビリティ</strong>: データベースコネクションの保持時間を最小化</li>
<li><strong>ユーザー体験</strong>: 競合時に明確なエラーメッセージを表示可能</li>
</ol>
<hr />
<h2 id="282">28.2 楽観ロックの設計<a class="headerlink" href="#282" title="Permanent link">&para;</a></h2>
<h3 id="_3">バージョン番号方式<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>楽観ロックの最も一般的な実装は、バージョン番号（または更新日時）を使用する方式です。</p>
<p><img src="data:image/svg+xml;base64,PD9wbGFudHVtbCAxLjIwMjYuMD8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IlNFUVVFTkNFIiBoZWlnaHQ9IjcwNXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6Njg0cHg7aGVpZ2h0OjcwNXB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDY4NCA3MDUiIHdpZHRoPSI2ODRweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PHRpdGxlPiYjMTI0OTY7JiMxMjU0MDsmIzEyNDcyOyYjMTI1MTk7JiMxMjUzMTsmIzMwMDU4OyYjMjE0OTU7JiMxMjM5NTsmIzEyNDI0OyYjMTI0Mjc7JiMyNzAwNTsmIzM1MjUxOyYjMTI1MjU7JiMxMjQ4MzsmIzEyNDYzOzwvdGl0bGU+PGRlZnMvPjxnPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMDkuOTk5MSIgeD0iMjM4LjYxOTkiIHk9IjI3Ljk5NTEiPiYjMTI0OTY7JiMxMjU0MDsmIzEyNDcyOyYjMTI1MTk7JiMxMjUzMTsmIzMwMDU4OyYjMjE0OTU7JiMxMjM5NTsmIzEyNDI0OyYjMTI0Mjc7JiMyNzAwNTsmIzM1MjUxOyYjMTI1MjU7JiMxMjQ4MzsmIzEyNDYzOzwvdGV4dD48ZyBjbGFzcz0icGFydGljaXBhbnQtbGlmZWxpbmUiIGRhdGEtZW50aXR5LXVpZD0icGFydDEiIGRhdGEtcXVhbGlmaWVkLW5hbWU9InVzZXJBIiBpZD0icGFydDEtbGlmZWxpbmUiPjxnPjx0aXRsZT4uLi4uQTwvdGl0bGU+PHJlY3QgZmlsbD0iIzAwMDAwMCIgZmlsbC1vcGFjaXR5PSIwLjAwMDAwIiBoZWlnaHQ9IjUyMi4zOTA2IiB3aWR0aD0iOCIgeD0iNDAuNzg4NSIgeT0iMTA0LjU5MzgiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTtzdHJva2UtZGFzaGFycmF5OjUsNTsiIHgxPSI0NCIgeDI9IjQ0IiB5MT0iMTA0LjU5MzgiIHkyPSI2MjYuOTg0NCIvPjwvZz48L2c+PGcgY2xhc3M9InBhcnRpY2lwYW50LWxpZmVsaW5lIiBkYXRhLWVudGl0eS11aWQ9InBhcnQyIiBkYXRhLXF1YWxpZmllZC1uYW1lPSJzeXMiIGlkPSJwYXJ0Mi1saWZlbGluZSI+PGc+PHRpdGxlPi4uLi48L3RpdGxlPjxyZWN0IGZpbGw9IiMwMDAwMDAiIGZpbGwtb3BhY2l0eT0iMC4wMDAwMCIgaGVpZ2h0PSI1MjIuMzkwNiIgd2lkdGg9IjgiIHg9IjIzOC43Mzk3IiB5PSIxMDQuNTkzOCIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41O3N0cm9rZS1kYXNoYXJyYXk6NSw1OyIgeDE9IjI0MS43Mzk4IiB4Mj0iMjQxLjczOTgiIHkxPSIxMDQuNTkzOCIgeTI9IjYyNi45ODQ0Ii8+PC9nPjwvZz48ZyBjbGFzcz0icGFydGljaXBhbnQtbGlmZWxpbmUiIGRhdGEtZW50aXR5LXVpZD0icGFydDMiIGRhdGEtcXVhbGlmaWVkLW5hbWU9InVzZXJCIiBpZD0icGFydDMtbGlmZWxpbmUiPjxnPjx0aXRsZT4uLi4uQjwvdGl0bGU+PHJlY3QgZmlsbD0iIzAwMDAwMCIgZmlsbC1vcGFjaXR5PSIwLjAwMDAwIiBoZWlnaHQ9IjUyMi4zOTA2IiB3aWR0aD0iOCIgeD0iNDM2LjY5MDkiIHk9IjEwNC41OTM4Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7c3Ryb2tlLWRhc2hhcnJheTo1LDU7IiB4MT0iNDM5Ljg4ODciIHgyPSI0MzkuODg4NyIgeTE9IjEwNC41OTM4IiB5Mj0iNjI2Ljk4NDQiLz48L2c+PC9nPjxnIGNsYXNzPSJwYXJ0aWNpcGFudC1saWZlbGluZSIgZGF0YS1lbnRpdHktdWlkPSJwYXJ0NCIgZGF0YS1xdWFsaWZpZWQtbmFtZT0iZGIiIGlkPSJwYXJ0NC1saWZlbGluZSI+PGc+PHRpdGxlPi4uLi4uLjwvdGl0bGU+PHJlY3QgZmlsbD0iIzAwMDAwMCIgZmlsbC1vcGFjaXR5PSIwLjAwMDAwIiBoZWlnaHQ9IjUyMi4zOTA2IiB3aWR0aD0iOCIgeD0iNTMxLjQ5MjgiIHk9IjEwNC41OTM4Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7c3Ryb2tlLWRhc2hhcnJheTo1LDU7IiB4MT0iNTM0LjQ5MyIgeDI9IjUzNC40OTMiIHkxPSIxMDQuNTkzOCIgeTI9IjYyNi45ODQ0Ii8+PC9nPjwvZz48ZyBjbGFzcz0icGFydGljaXBhbnQgcGFydGljaXBhbnQtaGVhZCIgZGF0YS1lbnRpdHktdWlkPSJwYXJ0MSIgZGF0YS1xdWFsaWZpZWQtbmFtZT0idXNlckEiIGlkPSJwYXJ0MS1oZWFkIj48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9Ijc5LjU3NjkiIHg9IjUiIHk9IjczLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2NS41NzY5IiB4PSIxMiIgeT0iOTMuMjkyIj4mIzEyNTE4OyYjMTI1NDA7JiMxMjQ3MDsmIzEyNTQwO0E8L3RleHQ+PC9nPjxnIGNsYXNzPSJwYXJ0aWNpcGFudCBwYXJ0aWNpcGFudC10YWlsIiBkYXRhLWVudGl0eS11aWQ9InBhcnQxIiBkYXRhLXF1YWxpZmllZC1uYW1lPSJ1c2VyQSIgaWQ9InBhcnQxLXRhaWwiPjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNzkuNTc2OSIgeD0iNSIgeT0iNjI1Ljk4NDQiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2NS41NzY5IiB4PSIxMiIgeT0iNjQ1Ljk3OTUiPiYjMTI1MTg7JiMxMjU0MDsmIzEyNDcwOyYjMTI1NDA7QTwvdGV4dD48L2c+PGcgY2xhc3M9InBhcnRpY2lwYW50IHBhcnRpY2lwYW50LWhlYWQiIGRhdGEtZW50aXR5LXVpZD0icGFydDIiIGRhdGEtcXVhbGlmaWVkLW5hbWU9InN5cyIgaWQ9InBhcnQyLWhlYWQiPjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNjkuOTk5OCIgeD0iMjA3LjczOTgiIHk9IjczLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1NS45OTk4IiB4PSIyMTQuNzM5OCIgeT0iOTMuMjkyIj4mIzEyNDcxOyYjMTI0NzM7JiMxMjQ4NjsmIzEyNTEyOzwvdGV4dD48L2c+PGcgY2xhc3M9InBhcnRpY2lwYW50IHBhcnRpY2lwYW50LXRhaWwiIGRhdGEtZW50aXR5LXVpZD0icGFydDIiIGRhdGEtcXVhbGlmaWVkLW5hbWU9InN5cyIgaWQ9InBhcnQyLXRhaWwiPjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNjkuOTk5OCIgeD0iMjA3LjczOTgiIHk9IjYyNS45ODQ0Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTUuOTk5OCIgeD0iMjE0LjczOTgiIHk9IjY0NS45Nzk1Ij4mIzEyNDcxOyYjMTI0NzM7JiMxMjQ4NjsmIzEyNTEyOzwvdGV4dD48L2c+PGcgY2xhc3M9InBhcnRpY2lwYW50IHBhcnRpY2lwYW50LWhlYWQiIGRhdGEtZW50aXR5LXVpZD0icGFydDMiIGRhdGEtcXVhbGlmaWVkLW5hbWU9InVzZXJCIiBpZD0icGFydDMtaGVhZCI+PHJlY3QgZmlsbD0iI0UyRTJGMCIgaGVpZ2h0PSIzMC4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI3OS42MDQyIiB4PSI0MDAuODg4NyIgeT0iNzMuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjY1LjYwNDIiIHg9IjQwNy44ODg3IiB5PSI5My4yOTIiPiYjMTI1MTg7JiMxMjU0MDsmIzEyNDcwOyYjMTI1NDA7QjwvdGV4dD48L2c+PGcgY2xhc3M9InBhcnRpY2lwYW50IHBhcnRpY2lwYW50LXRhaWwiIGRhdGEtZW50aXR5LXVpZD0icGFydDMiIGRhdGEtcXVhbGlmaWVkLW5hbWU9InVzZXJCIiBpZD0icGFydDMtdGFpbCI+PHJlY3QgZmlsbD0iI0UyRTJGMCIgaGVpZ2h0PSIzMC4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI3OS42MDQyIiB4PSI0MDAuODg4NyIgeT0iNjI1Ljk4NDQiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2NS42MDQyIiB4PSI0MDcuODg4NyIgeT0iNjQ1Ljk3OTUiPiYjMTI1MTg7JiMxMjU0MDsmIzEyNDcwOyYjMTI1NDA7QjwvdGV4dD48L2c+PGcgY2xhc3M9InBhcnRpY2lwYW50IHBhcnRpY2lwYW50LWhlYWQiIGRhdGEtZW50aXR5LXVpZD0icGFydDQiIGRhdGEtcXVhbGlmaWVkLW5hbWU9ImRiIiBpZD0icGFydDQtaGVhZCI+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODMuOTk5NiIgeD0iNDkwLjQ5MyIgeT0iMTAxLjI5MiI+JiMxMjQ4NzsmIzEyNTQwOyYjMTI0Nzk7JiMxMjUwNTsmIzEyNTQwOyYjMTI0NzM7PC90ZXh0PjxwYXRoIGQ9Ik01MTcuNDkyOCw1Mi4yOTY5IEM1MTcuNDkyOCw0Mi4yOTY5IDUzNS40OTI4LDQyLjI5NjkgNTM1LjQ5MjgsNDIuMjk2OSBDNTM1LjQ5MjgsNDIuMjk2OSA1NTMuNDkyOCw0Mi4yOTY5IDU1My40OTI4LDUyLjI5NjkgTDU1My40OTI4LDc4LjI5NjkgQzU1My40OTI4LDg4LjI5NjkgNTM1LjQ5MjgsODguMjk2OSA1MzUuNDkyOCw4OC4yOTY5IEM1MzUuNDkyOCw4OC4yOTY5IDUxNy40OTI4LDg4LjI5NjkgNTE3LjQ5MjgsNzguMjk2OSBMNTE3LjQ5MjgsNTIuMjk2OSIgZmlsbD0iI0UyRTJGMCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHBhdGggZD0iTTUxNy40OTI4LDUyLjI5NjkgQzUxNy40OTI4LDYyLjI5NjkgNTM1LjQ5MjgsNjIuMjk2OSA1MzUuNDkyOCw2Mi4yOTY5IEM1MzUuNDkyOCw2Mi4yOTY5IDU1My40OTI4LDYyLjI5NjkgNTUzLjQ5MjgsNTIuMjk2OSIgZmlsbD0ibm9uZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PC9nPjxnIGNsYXNzPSJwYXJ0aWNpcGFudCBwYXJ0aWNpcGFudC10YWlsIiBkYXRhLWVudGl0eS11aWQ9InBhcnQ0IiBkYXRhLXF1YWxpZmllZC1uYW1lPSJkYiIgaWQ9InBhcnQ0LXRhaWwiPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjgzLjk5OTYiIHg9IjQ5MC40OTMiIHk9IjYzOC45Nzk1Ij4mIzEyNDg3OyYjMTI1NDA7JiMxMjQ3OTsmIzEyNTA1OyYjMTI1NDA7JiMxMjQ3Mzs8L3RleHQ+PHBhdGggZD0iTTUxNy40OTI4LDY1Mi4yODEzIEM1MTcuNDkyOCw2NDIuMjgxMyA1MzUuNDkyOCw2NDIuMjgxMyA1MzUuNDkyOCw2NDIuMjgxMyBDNTM1LjQ5MjgsNjQyLjI4MTMgNTUzLjQ5MjgsNjQyLjI4MTMgNTUzLjQ5MjgsNjUyLjI4MTMgTDU1My40OTI4LDY3OC4yODEzIEM1NTMuNDkyOCw2ODguMjgxMyA1MzUuNDkyOCw2ODguMjgxMyA1MzUuNDkyOCw2ODguMjgxMyBDNTM1LjQ5MjgsNjg4LjI4MTMgNTE3LjQ5MjgsNjg4LjI4MTMgNTE3LjQ5MjgsNjc4LjI4MTMgTDUxNy40OTI4LDY1Mi4yODEzIiBmaWxsPSIjRTJFMkYwIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48cGF0aCBkPSJNNTE3LjQ5MjgsNjUyLjI4MTMgQzUxNy40OTI4LDY2Mi4yODEzIDUzNS40OTI4LDY2Mi4yODEzIDUzNS40OTI4LDY2Mi4yODEzIEM1MzUuNDkyOCw2NjIuMjgxMyA1NTMuNDkyOCw2NjIuMjgxMyA1NTMuNDkyOCw2NTIuMjgxMyIgZmlsbD0ibm9uZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PC9nPjxnIGNsYXNzPSJtZXNzYWdlIiBkYXRhLWVudGl0eS0xPSJwYXJ0MSIgZGF0YS1lbnRpdHktMj0icGFydDIiIGlkPSJtc2cxIj48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjIzMC43Mzk3LDEzMS43MjY2LDI0MC43Mzk3LDEzNS43MjY2LDIzMC43Mzk3LDEzOS43MjY2LDIzNC43Mzk3LDEzNS43MjY2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgeDE9IjQ0Ljc4ODUiIHgyPSIyMzYuNzM5NyIgeTE9IjEzNS43MjY2IiB5Mj0iMTM1LjcyNjYiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2NS4wMDAxIiB4PSI1MS43ODg1IiB5PSIxMzAuNjYwNiI+JiMyMDE4MTsmIzM1Mzc5OyYjMTI0MzQ7JiMyMTQ2MjsmIzI0NDcxOzwvdGV4dD48L2c+PGcgY2xhc3M9Im1lc3NhZ2UiIGRhdGEtZW50aXR5LTE9InBhcnQyIiBkYXRhLWVudGl0eS0yPSJwYXJ0NCIgaWQ9Im1zZzIiPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNTIzLjQ5MjgsMTYwLjg1OTQsNTMzLjQ5MjgsMTY0Ljg1OTQsNTIzLjQ5MjgsMTY4Ljg1OTQsNTI3LjQ5MjgsMTY0Ljg1OTQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7IiB4MT0iMjQyLjczOTciIHgyPSI1MjkuNDkyOCIgeTE9IjE2NC44NTk0IiB5Mj0iMTY0Ljg1OTQiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMzguMjU4MyIgeD0iMjQ5LjczOTciIHk9IjE1OS43OTM1Ij5TRUxFQ1QgKHZlcnNpb24gPSAxKTwvdGV4dD48L2c+PGcgY2xhc3M9Im1lc3NhZ2UiIGRhdGEtZW50aXR5LTE9InBhcnQ0IiBkYXRhLWVudGl0eS0yPSJwYXJ0MiIgaWQ9Im1zZzMiPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjUzLjczOTcsMTg5Ljk5MjIsMjQzLjczOTcsMTkzLjk5MjIsMjUzLjczOTcsMTk3Ljk5MjIsMjQ5LjczOTcsMTkzLjk5MjIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheToyLDI7IiB4MT0iMjQ3LjczOTciIHgyPSI1MzQuNDkyOCIgeTE9IjE5My45OTIyIiB5Mj0iMTkzLjk5MjIiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNzMuOTUxMiIgeD0iMjU5LjczOTciIHk9IjE4OC45MjYzIj4mIzI3NTMxOyYjMzk2NDA7ID0gMTAsMDAwLCB2ZXJzaW9uID0gMTwvdGV4dD48L2c+PGcgY2xhc3M9Im1lc3NhZ2UiIGRhdGEtZW50aXR5LTE9InBhcnQyIiBkYXRhLWVudGl0eS0yPSJwYXJ0MSIgaWQ9Im1zZzQiPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNTUuNzg4NSwyMTkuMTI1LDQ1Ljc4ODUsMjIzLjEyNSw1NS43ODg1LDIyNy4xMjUsNTEuNzg4NSwyMjMuMTI1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6MiwyOyIgeDE9IjQ5Ljc4ODUiIHgyPSIyNDEuNzM5NyIgeTE9IjIyMy4xMjUiIHkyPSIyMjMuMTI1Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTczLjk1MTIiIHg9IjYxLjc4ODUiIHk9IjIxOC4wNTkxIj4mIzI3NTMxOyYjMzk2NDA7ID0gMTAsMDAwLCB2ZXJzaW9uID0gMTwvdGV4dD48L2c+PGcgY2xhc3M9Im1lc3NhZ2UiIGRhdGEtZW50aXR5LTE9InBhcnQzIiBkYXRhLWVudGl0eS0yPSJwYXJ0MiIgaWQ9Im1zZzUiPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjUzLjczOTcsMjQ4LjI1NzgsMjQzLjczOTcsMjUyLjI1NzgsMjUzLjczOTcsMjU2LjI1NzgsMjQ5LjczOTcsMjUyLjI1NzgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7IiB4MT0iMjQ3LjczOTciIHgyPSI0MzkuNjkwOSIgeTE9IjI1Mi4yNTc4IiB5Mj0iMjUyLjI1NzgiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2NS4wMDAxIiB4PSIyNTkuNzM5NyIgeT0iMjQ3LjE5MTkiPiYjMjAxODE7JiMzNTM3OTsmIzEyNDM0OyYjMjE0NjI7JiMyNDQ3MTs8L3RleHQ+PC9nPjxnIGNsYXNzPSJtZXNzYWdlIiBkYXRhLWVudGl0eS0xPSJwYXJ0MiIgZGF0YS1lbnRpdHktMj0icGFydDQiIGlkPSJtc2c2Ij48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjUyMy40OTI4LDI3Ny4zOTA2LDUzMy40OTI4LDI4MS4zOTA2LDUyMy40OTI4LDI4NS4zOTA2LDUyNy40OTI4LDI4MS4zOTA2IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgeDE9IjI0Mi43Mzk3IiB4Mj0iNTI5LjQ5MjgiIHkxPSIyODEuMzkwNiIgeTI9IjI4MS4zOTA2Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTM4LjI1ODMiIHg9IjI0OS43Mzk3IiB5PSIyNzYuMzI0NyI+U0VMRUNUICh2ZXJzaW9uID0gMSk8L3RleHQ+PC9nPjxnIGNsYXNzPSJtZXNzYWdlIiBkYXRhLWVudGl0eS0xPSJwYXJ0NCIgZGF0YS1lbnRpdHktMj0icGFydDIiIGlkPSJtc2c3Ij48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjI1My43Mzk3LDMwNi41MjM0LDI0My43Mzk3LDMxMC41MjM0LDI1My43Mzk3LDMxNC41MjM0LDI0OS43Mzk3LDMxMC41MjM0IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6MiwyOyIgeDE9IjI0Ny43Mzk3IiB4Mj0iNTM0LjQ5MjgiIHkxPSIzMTAuNTIzNCIgeTI9IjMxMC41MjM0Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTczLjk1MTIiIHg9IjI1OS43Mzk3IiB5PSIzMDUuNDU3NSI+JiMyNzUzMTsmIzM5NjQwOyA9IDEwLDAwMCwgdmVyc2lvbiA9IDE8L3RleHQ+PC9nPjxnIGNsYXNzPSJtZXNzYWdlIiBkYXRhLWVudGl0eS0xPSJwYXJ0MiIgZGF0YS1lbnRpdHktMj0icGFydDMiIGlkPSJtc2c4Ij48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjQyOC42OTA5LDMzNS42NTYzLDQzOC42OTA5LDMzOS42NTYzLDQyOC42OTA5LDM0My42NTYzLDQzMi42OTA5LDMzOS42NTYzIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6MiwyOyIgeDE9IjI0Mi43Mzk3IiB4Mj0iNDM0LjY5MDkiIHkxPSIzMzkuNjU2MyIgeTI9IjMzOS42NTYzIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTczLjk1MTIiIHg9IjI0OS43Mzk3IiB5PSIzMzQuNTkwMyI+JiMyNzUzMTsmIzM5NjQwOyA9IDEwLDAwMCwgdmVyc2lvbiA9IDE8L3RleHQ+PC9nPjxnIGNsYXNzPSJtZXNzYWdlIiBkYXRhLWVudGl0eS0xPSJwYXJ0MSIgZGF0YS1lbnRpdHktMj0icGFydDIiIGlkPSJtc2c5Ij48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjIzMC43Mzk3LDM2NC43ODkxLDI0MC43Mzk3LDM2OC43ODkxLDIzMC43Mzk3LDM3Mi43ODkxLDIzNC43Mzk3LDM2OC43ODkxIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgeDE9IjQ0Ljc4ODUiIHgyPSIyMzYuNzM5NyIgeTE9IjM2OC43ODkxIiB5Mj0iMzY4Ljc4OTEiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNDAuNjE5NyIgeD0iNTEuNzg4NSIgeT0iMzYzLjcyMzEiPiYjMjc1MzE7JiMzOTY0MDsmIzEyNDM0OyAxNSwwMDAmIzIwODcwOyYjMTIzOTU7JiMyNjM1NjsmIzI2MDMyOzwvdGV4dD48L2c+PGcgY2xhc3M9Im1lc3NhZ2UiIGRhdGEtZW50aXR5LTE9InBhcnQyIiBkYXRhLWVudGl0eS0yPSJwYXJ0NCIgaWQ9Im1zZzEwIj48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjUyMy40OTI4LDQwOS4wNTQ3LDUzMy40OTI4LDQxMy4wNTQ3LDUyMy40OTI4LDQxNy4wNTQ3LDUyNy40OTI4LDQxMy4wNTQ3IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIgeDE9IjI0Mi43Mzk3IiB4Mj0iNTI5LjQ5MjgiIHkxPSI0MTMuMDU0NyIgeTI9IjQxMy4wNTQ3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjU5LjAzNTIiIHg9IjI0OS43Mzk3IiB5PSIzOTIuODU2Ij5VUERBVEUgU0VUICYjMjc1MzE7JiMzOTY0MDsgPSAxNSwwMDAsIHZlcnNpb24gPSAyPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyNy4yNjQyIiB4PSIyNDkuNzM5NyIgeT0iNDA3Ljk4ODgiPldIRVJFIHZlcnNpb24gPSAxPC90ZXh0PjwvZz48ZyBjbGFzcz0ibWVzc2FnZSIgZGF0YS1lbnRpdHktMT0icGFydDQiIGRhdGEtZW50aXR5LTI9InBhcnQyIiBpZD0ibXNnMTEiPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjUzLjczOTcsNDM4LjE4NzUsMjQzLjczOTcsNDQyLjE4NzUsMjUzLjczOTcsNDQ2LjE4NzUsMjQ5LjczOTcsNDQyLjE4NzUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheToyLDI7IiB4MT0iMjQ3LjczOTciIHgyPSI1MzQuNDkyOCIgeTE9IjQ0Mi4xODc1IiB5Mj0iNDQyLjE4NzUiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5NC41MjI5IiB4PSIyNTkuNzM5NyIgeT0iNDM3LjEyMTYiPjEgcm93IHVwZGF0ZWQ8L3RleHQ+PC9nPjxnIGNsYXNzPSJtZXNzYWdlIiBkYXRhLWVudGl0eS0xPSJwYXJ0MiIgZGF0YS1lbnRpdHktMj0icGFydDEiIGlkPSJtc2cxMiI+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI1NS43ODg1LDQ2Ny4zMjAzLDQ1Ljc4ODUsNDcxLjMyMDMsNTUuNzg4NSw0NzUuMzIwMyw1MS43ODg1LDQ3MS4zMjAzIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxO3N0cm9rZS1kYXNoYXJyYXk6MiwyOyIgeDE9IjQ5Ljc4ODUiIHgyPSIyNDEuNzM5NyIgeTE9IjQ3MS4zMjAzIiB5Mj0iNDcxLjMyMDMiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1Mi4wMDAxIiB4PSI2MS43ODg1IiB5PSI0NjYuMjU0NCI+JiMyNjM1NjsmIzI2MDMyOyYjMjUxMDQ7JiMyMTE1MTs8L3RleHQ+PC9nPjxnIGNsYXNzPSJtZXNzYWdlIiBkYXRhLWVudGl0eS0xPSJwYXJ0MyIgZGF0YS1lbnRpdHktMj0icGFydDIiIGlkPSJtc2cxMyI+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyNTMuNzM5Nyw0OTYuNDUzMSwyNDMuNzM5Nyw1MDAuNDUzMSwyNTMuNzM5Nyw1MDQuNDUzMSwyNDkuNzM5Nyw1MDAuNDUzMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiIHgxPSIyNDcuNzM5NyIgeDI9IjQzOS42OTA5IiB5MT0iNTAwLjQ1MzEiIHkyPSI1MDAuNDUzMSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzMi4zNDg3IiB4PSIyNTkuNzM5NyIgeT0iNDk1LjM4NzIiPiYjMjc1MzE7JiMzOTY0MDsmIzEyNDM0OyA4LDAwMCYjMjA4NzA7JiMxMjM5NTsmIzI2MzU2OyYjMjYwMzI7PC90ZXh0PjwvZz48ZyBjbGFzcz0ibWVzc2FnZSIgZGF0YS1lbnRpdHktMT0icGFydDIiIGRhdGEtZW50aXR5LTI9InBhcnQ0IiBpZD0ibXNnMTQiPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNTIzLjQ5MjgsNTQzLjcxODgsNTMzLjQ5MjgsNTQ3LjcxODgsNTIzLjQ5MjgsNTUxLjcxODgsNTI3LjQ5MjgsNTQ3LjcxODgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7IiB4MT0iMjQyLjczOTciIHgyPSI1MjkuNDkyOCIgeTE9IjU0Ny43MTg4IiB5Mj0iNTQ3LjcxODgiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyNTAuNzY0MiIgeD0iMjQ5LjczOTciIHk9IjUyNy41MiI+VVBEQVRFIFNFVCAmIzI3NTMxOyYjMzk2NDA7ID0gOCwwMDAsIHZlcnNpb24gPSAyPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyNy4yNjQyIiB4PSIyNDkuNzM5NyIgeT0iNTQyLjY1MjgiPldIRVJFIHZlcnNpb24gPSAxPC90ZXh0PjwvZz48cGF0aCBkPSJNNTQwLDUxMy40NTMxIEw1NDAsNTUzLjQ1MzEgTDY3Nyw1NTMuNDUzMSBMNjc3LDUyMy40NTMxIEw2NjcsNTEzLjQ1MzEgTDU0MCw1MTMuNDUzMSIgZmlsbD0iI0ZFRkZERCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHBhdGggZD0iTTY2Nyw1MTMuNDUzMSBMNjY3LDUyMy40NTMxIEw2NzcsNTIzLjQ1MzEgTDY2Nyw1MTMuNDUzMSIgZmlsbD0iI0ZFRkZERCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTE2Ljc0NjIiIHg9IjU0NiIgeT0iNTMwLjUyIj52ZXJzaW9uICYjMTIzNjQ7JiMxOTk4MTsmIzE5OTY4OyYjMzMyNjg7JiMxMjM5MTs8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODEuNTM1NyIgeD0iNTQ2IiB5PSI1NDUuNjUyOCI+JiMyNjM1NjsmIzI2MDMyOyYjMjM1NTA7JiMzNTkzNzsgMCAmIzIwMjE0OzwvdGV4dD48ZyBjbGFzcz0ibWVzc2FnZSIgZGF0YS1lbnRpdHktMT0icGFydDQiIGRhdGEtZW50aXR5LTI9InBhcnQyIiBpZD0ibXNnMTYiPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjUzLjczOTcsNTc1Ljg1MTYsMjQzLjczOTcsNTc5Ljg1MTYsMjUzLjczOTcsNTgzLjg1MTYsMjQ5LjczOTcsNTc5Ljg1MTYiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjE7c3Ryb2tlLWRhc2hhcnJheToyLDI7IiB4MT0iMjQ3LjczOTciIHgyPSI1MzQuNDkyOCIgeTE9IjU3OS44NTE2IiB5Mj0iNTc5Ljg1MTYiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5NC41MjI5IiB4PSIyNTkuNzM5NyIgeT0iNTc0Ljc4NTYiPjAgcm93IHVwZGF0ZWQ8L3RleHQ+PC9nPjxnIGNsYXNzPSJtZXNzYWdlIiBkYXRhLWVudGl0eS0xPSJwYXJ0MiIgZGF0YS1lbnRpdHktMj0icGFydDMiIGlkPSJtc2cxNyI+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI0MjguNjkwOSw2MDQuOTg0NCw0MzguNjkwOSw2MDguOTg0NCw0MjguNjkwOSw2MTIuOTg0NCw0MzIuNjkwOSw2MDguOTg0NCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTtzdHJva2UtZGFzaGFycmF5OjIsMjsiIHgxPSIyNDIuNzM5NyIgeDI9IjQzNC42OTA5IiB5MT0iNjA4Ljk4NDQiIHkyPSI2MDguOTg0NCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwNC4wMDAxIiB4PSIyNDkuNzM5NyIgeT0iNjAzLjkxODUiPiYjMjcwMDU7JiMzNTI1MTsmIzEyNTI1OyYjMTI0ODM7JiMxMjQ2MzsmIzEyNDU2OyYjMTI1MjE7JiMxMjU0MDs8L3RleHQ+PC9nPjw/cGxhbnR1bWwtc3JjIGxQRkZJbTkxNUNWbC1yU0NkR2VLcmEwR2VTMmpYR3VUZWVta05qUHNnT0xPUE5TamtrS0VnNklYMTVoSGVKZ2FiZkk1dVd5Zy1zRVVrc3RfSFJDWmNBajhUa2FvM0ZDLXl4eFZ6endDQmtqeDRXQVMxX202SFhqbTZOM3ppXzFXdmJnR2g4QUgwSURodFJ0UmZKaFdIeTBPWjFoM24wTExieFZia0EzZVEwUG1ZVHZqYVpLcVdtR0Q5Skg5M09yMEhXa0MzazBLdTFsQVE4VlF2M0pTODB0N1k4OGtIMExEU2VXcTlKdTBOejlEWHM5WWI2NmU4bDhrRWNiSDRGTFUydFFiM2lRUGNJa1F0TkY2RUlMMUNLZlk2X21nbG5INmlfa0lnaWFuMUlxV3RubjM4angxUlVpZi1yTXpTMEFpWHNMUDNuZjItd2E4c2JWeTFRUS1rN190bkt0YlF3WFZWUFp1R1p3X0d2a2Y1MWMtVFRNbVlpeWthdmpob3c0bUp4bzZYbUp5ZW1CcDRNTGhYTF9kTlBna0tkbjhaSHNXSDltQ0xuQjdVcWc1aEtwVUZCdVV3LTZGcnkyVmhHUWNTZ2g0VDBjZnlpd2s3WG9TR19BYXJweGpqT19pVDBFSXZPWklMcEhoTlZsYjVoNWFpYXJ0WFVwNDJrYnF0M3lBWjBoV1VfQWNsbTQwPz48L2c+PC9zdmc+" class="uml" alt="uml diagram" title="" /></p>
<h3 id="_4">テーブル設計<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>楽観ロックを実装するために、各テーブルにバージョン列を追加します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- 勘定科目マスタ</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="ss">&quot;勘定科目マスタ&quot;</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="ss">&quot;勘定科目コード&quot;</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;勘定科目名&quot;</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;勘定科目略称&quot;</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
<span class="w">    </span><span class="ss">&quot;勘定科目カナ&quot;</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
<span class="w">    </span><span class="ss">&quot;勘定科目BS区分&quot;</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;勘定科目貸借区分&quot;</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;勘定科目要素区分&quot;</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;表示順&quot;</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;version&quot;</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">    </span><span class="c1">-- 楽観ロック用</span>
<span class="w">    </span><span class="ss">&quot;作成日時&quot;</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;更新日時&quot;</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span>
<span class="p">);</span>

<span class="c1">-- 仕訳</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="ss">&quot;仕訳&quot;</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="ss">&quot;仕訳伝票番号&quot;</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;起票日&quot;</span><span class="w"> </span><span class="nb">DATE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;摘要&quot;</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span>
<span class="w">    </span><span class="ss">&quot;承認状態&quot;</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;DRAFT&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;version&quot;</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">    </span><span class="c1">-- 楽観ロック用</span>
<span class="w">    </span><span class="ss">&quot;作成日時&quot;</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;更新日時&quot;</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span>
<span class="p">);</span>

<span class="c1">-- 仕訳明細</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="ss">&quot;仕訳明細&quot;</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="ss">&quot;仕訳伝票番号&quot;</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;仕訳行番号&quot;</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;勘定科目コード&quot;</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="ss">&quot;消費税コード&quot;</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
<span class="w">    </span><span class="ss">&quot;摘要&quot;</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span>
<span class="w">    </span><span class="ss">&quot;version&quot;</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">    </span><span class="c1">-- 楽観ロック用</span>
<span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="ss">&quot;仕訳伝票番号&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;仕訳行番号&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="ss">&quot;仕訳伝票番号&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="ss">&quot;仕訳&quot;</span><span class="p">(</span><span class="ss">&quot;仕訳伝票番号&quot;</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div>
<h3 id="version">既存テーブルへの version 列追加<a class="headerlink" href="#version" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">-- Flyway マイグレーション: V202412160001__add_version_columns.sql</span>

<span class="c1">-- 勘定科目マスタ</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="ss">&quot;勘定科目マスタ&quot;</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="ss">&quot;version&quot;</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="c1">-- 仕訳</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="ss">&quot;仕訳&quot;</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="ss">&quot;version&quot;</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="c1">-- 仕訳明細</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="ss">&quot;仕訳明細&quot;</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="ss">&quot;version&quot;</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="c1">-- 日次残高</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="ss">&quot;日次残高&quot;</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="ss">&quot;version&quot;</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="c1">-- コメント</span>
<span class="k">COMMENT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="ss">&quot;勘定科目マスタ&quot;</span><span class="p">.</span><span class="ss">&quot;version&quot;</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="s1">&#39;楽観ロック用バージョン番号&#39;</span><span class="p">;</span>
<span class="k">COMMENT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="ss">&quot;仕訳&quot;</span><span class="p">.</span><span class="ss">&quot;version&quot;</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="s1">&#39;楽観ロック用バージョン番号&#39;</span><span class="p">;</span>
<span class="k">COMMENT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="ss">&quot;仕訳明細&quot;</span><span class="p">.</span><span class="ss">&quot;version&quot;</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="s1">&#39;楽観ロック用バージョン番号&#39;</span><span class="p">;</span>
<span class="k">COMMENT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="ss">&quot;日次残高&quot;</span><span class="p">.</span><span class="ss">&quot;version&quot;</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="s1">&#39;楽観ロック用バージョン番号&#39;</span><span class="p">;</span>
</code></pre></div>
<hr />
<h2 id="283-version">28.3 ドメインモデルへの version 追加<a class="headerlink" href="#283-version" title="Permanent link">&para;</a></h2>
<h3 id="versionable">Versionable インターフェース<a class="headerlink" href="#versionable" title="Permanent link">&para;</a></h3>
<p>楽観ロック対象のドメインモデルが実装するインターフェースを定義します。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// domain/model/shared/Versionable.java</span>
<span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.shared</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 楽観ロック対応ドメインモデルが実装するインターフェース</span>
<span class="cm"> */</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">Versionable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * バージョン番号を取得</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">Long</span><span class="w"> </span><span class="nf">getVersion</span><span class="p">();</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * バージョン番号をインクリメントした新しいインスタンスを生成</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">T</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Versionable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">incrementVersion</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="account">Account ドメインモデルへの適用<a class="headerlink" href="#account" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// domain/model/account/Account.java</span>
<span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.account</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.shared.Versionable</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.Value</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.With</span><span class="p">;</span>

<span class="nd">@Value</span>
<span class="nd">@With</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Account</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Versionable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">accountCode</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">accountName</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">accountAbbr</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">accountKana</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">bsplType</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">debitCreditType</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">elementType</span><span class="p">;</span>
<span class="w">    </span><span class="n">Integer</span><span class="w"> </span><span class="n">displayOrder</span><span class="p">;</span>
<span class="w">    </span><span class="n">Long</span><span class="w"> </span><span class="n">version</span><span class="p">;</span><span class="w">  </span><span class="c1">// 楽観ロック用</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 新規作成用ファクトリメソッド（version = 1）</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Account</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">accountCode</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">accountName</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">bsplType</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">debitCreditType</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">elementType</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Account</span><span class="p">(</span>
<span class="w">                </span><span class="n">accountCode</span><span class="p">,</span>
<span class="w">                </span><span class="n">accountName</span><span class="p">,</span>
<span class="w">                </span><span class="kc">null</span><span class="p">,</span><span class="w">  </span><span class="c1">// accountAbbr</span>
<span class="w">                </span><span class="kc">null</span><span class="p">,</span><span class="w">  </span><span class="c1">// accountKana</span>
<span class="w">                </span><span class="n">bsplType</span><span class="p">,</span>
<span class="w">                </span><span class="n">debitCreditType</span><span class="p">,</span>
<span class="w">                </span><span class="n">elementType</span><span class="p">,</span>
<span class="w">                </span><span class="kc">null</span><span class="p">,</span><span class="w">  </span><span class="c1">// displayOrder</span>
<span class="w">                </span><span class="mi">1L</span><span class="w">     </span><span class="c1">// 新規は version = 1</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 貸借対照表科目かどうか</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isBalanceSheetAccount</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;B&quot;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">bsplType</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 損益計算書科目かどうか</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isProfitLossAccount</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;P&quot;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">bsplType</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 借方残高科目かどうか</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isDebitBalance</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;借&quot;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">debitCreditType</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 貸方残高科目かどうか</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isCreditBalance</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;貸&quot;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">debitCreditType</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="nd">@SuppressWarnings</span><span class="p">(</span><span class="s">&quot;unchecked&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Account</span><span class="w"> </span><span class="nf">incrementVersion</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">withVersion</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">version</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="journalentry">JournalEntry ドメインモデルへの適用<a class="headerlink" href="#journalentry" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// domain/model/journal/JournalEntry.java</span>
<span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.journal</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.shared.Versionable</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.Value</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.With</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.math.BigDecimal</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDate</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span>

<span class="nd">@Value</span>
<span class="nd">@With</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JournalEntry</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Versionable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">journalNo</span><span class="p">;</span>
<span class="w">    </span><span class="n">LocalDate</span><span class="w"> </span><span class="n">journalDate</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">description</span><span class="p">;</span>
<span class="w">    </span><span class="n">ApprovalStatus</span><span class="w"> </span><span class="n">approvalStatus</span><span class="p">;</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">JournalDetail</span><span class="o">&gt;</span><span class="w"> </span><span class="n">details</span><span class="p">;</span>
<span class="w">    </span><span class="n">Long</span><span class="w"> </span><span class="n">version</span><span class="p">;</span><span class="w">  </span><span class="c1">// 楽観ロック用</span>

<span class="w">    </span><span class="c1">// コンストラクタで不変条件を保証</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">JournalEntry</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">journalNo</span><span class="p">,</span><span class="w"> </span><span class="n">LocalDate</span><span class="w"> </span><span class="n">journalDate</span><span class="p">,</span>
<span class="w">                        </span><span class="n">String</span><span class="w"> </span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="n">ApprovalStatus</span><span class="w"> </span><span class="n">approvalStatus</span><span class="p">,</span>
<span class="w">                        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">JournalDetail</span><span class="o">&gt;</span><span class="w"> </span><span class="n">details</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">version</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">details</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">details</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">&quot;仕訳明細は2件以上必要です&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">journalNo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">journalNo</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">journalDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">journalDate</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">description</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">approvalStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">approvalStatus</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">approvalStatus</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">ApprovalStatus</span><span class="p">.</span><span class="na">DRAFT</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">details</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">List</span><span class="p">.</span><span class="na">copyOf</span><span class="p">(</span><span class="n">details</span><span class="p">);</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">1L</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 新規作成用ファクトリメソッド</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">JournalEntry</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">journalNo</span><span class="p">,</span>
<span class="w">            </span><span class="n">LocalDate</span><span class="w"> </span><span class="n">journalDate</span><span class="p">,</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">description</span><span class="p">,</span>
<span class="w">            </span><span class="n">List</span><span class="o">&lt;</span><span class="n">JournalDetail</span><span class="o">&gt;</span><span class="w"> </span><span class="n">details</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JournalEntry</span><span class="p">(</span>
<span class="w">                </span><span class="n">journalNo</span><span class="p">,</span>
<span class="w">                </span><span class="n">journalDate</span><span class="p">,</span>
<span class="w">                </span><span class="n">description</span><span class="p">,</span>
<span class="w">                </span><span class="n">ApprovalStatus</span><span class="p">.</span><span class="na">DRAFT</span><span class="p">,</span>
<span class="w">                </span><span class="n">details</span><span class="p">,</span>
<span class="w">                </span><span class="mi">1L</span><span class="w">  </span><span class="c1">// 新規は version = 1</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 複式簿記の原則: 借方合計 = 貸方合計</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isBalanced</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getTotalDebit</span><span class="p">().</span><span class="na">compareTo</span><span class="p">(</span><span class="n">getTotalCredit</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 借方合計を計算</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="nf">getTotalDebit</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">details</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">flatMap</span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="na">getItems</span><span class="p">().</span><span class="na">stream</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">JournalItem</span><span class="p">::</span><span class="n">isDebit</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">JournalItem</span><span class="p">::</span><span class="n">getAmount</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">reduce</span><span class="p">(</span><span class="n">BigDecimal</span><span class="p">.</span><span class="na">ZERO</span><span class="p">,</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">::</span><span class="n">add</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 貸方合計を計算</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="nf">getTotalCredit</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">details</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">flatMap</span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="na">getItems</span><span class="p">().</span><span class="na">stream</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">JournalItem</span><span class="p">::</span><span class="n">isCredit</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">JournalItem</span><span class="p">::</span><span class="n">getAmount</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">reduce</span><span class="p">(</span><span class="n">BigDecimal</span><span class="p">.</span><span class="na">ZERO</span><span class="p">,</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">::</span><span class="n">add</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 承認可能かどうか</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">canApprove</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">approvalStatus</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ApprovalStatus</span><span class="p">.</span><span class="na">DRAFT</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">isBalanced</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 承認する</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">JournalEntry</span><span class="w"> </span><span class="nf">approve</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">canApprove</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;この仕訳は承認できません&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">withApprovalStatus</span><span class="p">(</span><span class="n">ApprovalStatus</span><span class="p">.</span><span class="na">APPROVED</span><span class="p">)</span>
<span class="w">                   </span><span class="p">.</span><span class="na">incrementVersion</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="nd">@SuppressWarnings</span><span class="p">(</span><span class="s">&quot;unchecked&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">JournalEntry</span><span class="w"> </span><span class="nf">incrementVersion</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">withVersion</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">version</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="284">28.4 楽観ロック例外の定義<a class="headerlink" href="#284" title="Permanent link">&para;</a></h2>
<h3 id="_5">例外クラス階層<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p><img src="data:image/svg+xml;base64,PD9wbGFudHVtbCAxLjIwMjYuMD8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgZGF0YS1kaWFncmFtLXR5cGU9IkNMQVNTIiBoZWlnaHQ9IjQyOXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NTYzcHg7aGVpZ2h0OjQyOXB4O2JhY2tncm91bmQ6I0ZGRkZGRjsiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDU2MyA0MjkiIHdpZHRoPSI1NjNweCIgem9vbUFuZFBhbj0ibWFnbmlmeSI+PHRpdGxlPiYjMjcwMDU7JiMzNTI1MTsmIzEyNTI1OyYjMTI0ODM7JiMxMjQ2MzsmIzIwMzYzOyYjMjI4MDY7JiMzODU0MjsmIzIzNjUyOzwvdGl0bGU+PGRlZnMvPjxnPjxnIGNsYXNzPSJ0aXRsZSIgZGF0YS1zb3VyY2UtbGluZT0iMSI+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyNS45OTk1IiB4PSIyMTEuNjA2OCIgeT0iMjIuOTk1MSI+JiMyNzAwNTsmIzM1MjUxOyYjMTI1MjU7JiMxMjQ4MzsmIzEyNDYzOyYjMjAzNjM7JiMyMjgwNjsmIzM4NTQyOyYjMjM2NTI7PC90ZXh0PjwvZz48IS0tY2xhc3MgRG9tYWluRXhjZXB0aW9uLS0+PGcgY2xhc3M9ImVudGl0eSIgZGF0YS1xdWFsaWZpZWQtbmFtZT0iRG9tYWluRXhjZXB0aW9uIiBkYXRhLXNvdXJjZS1saW5lPSIzIiBpZD0iZW50MDAwMiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI4MC41OTM4IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNTUuNDcwNyIgeD0iMjA1LjkiIHk9IjQ0LjI5NjkiLz48ZWxsaXBzZSBjeD0iMjIwLjkiIGN5PSI2MC4yOTY5IiBmaWxsPSIjQTlEQ0RGIiByeD0iMTEiIHJ5PSIxMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwYXRoIGQ9Ik0yMjEuMDA5NCw1NS42NDA2IEwyMTkuODUzMSw2MC43MTg4IEwyMjIuMTgxMyw2MC43MTg4IEwyMjEuMDA5NCw1NS42NDA2IFogTTIxOS41MjUsNTMuNDA2MyBMMjIyLjUwOTQsNTMuNDA2MyBMMjI1Ljg2ODgsNjUuNzk2OSBMMjIzLjQxNTYsNjUuNzk2OSBMMjIyLjY1LDYyLjczNDQgTDIxOS4zNjg4LDYyLjczNDQgTDIxOC42MTg4LDY1Ljc5NjkgTDIxNi4xODEzLDY1Ljc5NjkgTDIxOS41MjUsNTMuNDA2MyBaICIgZmlsbD0iIzAwMDAwMCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXN0eWxlPSJpdGFsaWMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTIzLjQ3MDciIHg9IjIzNC45IiB5PSI2NS4xNDM2Ij5Eb21haW5FeGNlcHRpb248L3RleHQ+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iMjA2LjkiIHgyPSIzNjAuMzcwNyIgeTE9Ijc2LjI5NjkiIHkyPSI3Ni4yOTY5Ii8+PGcgZGF0YS12aXNpYmlsaXR5LW1vZGlmaWVyPSJQUklWQVRFX0ZJRUxEIj48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjYiIHN0eWxlPSJzdHJva2U6I0M4MjkzMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI2IiB4PSIyMTMuOSIgeT0iODYuOTQ1MyIvPjwvZz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTMuODY2MiIgeD0iMjI1LjkiIHk9IjkzLjI5MiI+bWVzc2FnZTogU3RyaW5nPC90ZXh0PjxnIGRhdGEtdmlzaWJpbGl0eS1tb2RpZmllcj0iUFJJVkFURV9GSUVMRCI+PHJlY3QgZmlsbD0ibm9uZSIgaGVpZ2h0PSI2IiBzdHlsZT0ic3Ryb2tlOiNDODI5MzA7c3Ryb2tlLXdpZHRoOjE7IiB3aWR0aD0iNiIgeD0iMjEzLjkiIHk9IjEwMy4yNDIyIi8+PC9nPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijg0LjcxMDkiIHg9IjIyNS45IiB5PSIxMDkuNTg4OSI+Y29kZTogU3RyaW5nPC90ZXh0PjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgeDE9IjIwNi45IiB4Mj0iMzYwLjM3MDciIHkxPSIxMTYuODkwNiIgeTI9IjExNi44OTA2Ii8+PC9nPjwhLS1jbGFzcyBPcHRpbWlzdGljTG9ja0V4Y2VwdGlvbi0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtcXVhbGlmaWVkLW5hbWU9Ik9wdGltaXN0aWNMb2NrRXhjZXB0aW9uIiBkYXRhLXNvdXJjZS1saW5lPSI4IiBpZD0iZW50MDAwMyI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIxMTMuMTg3NSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjA0LjQ5OCIgeD0iMTgxLjM5IiB5PSIxODQuODk2OSIvPjxlbGxpcHNlIGN4PSIxOTYuMzkiIGN5PSIyMDAuODk2OSIgZmlsbD0iI0FERDFCMiIgcng9IjExIiByeT0iMTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cGF0aCBkPSJNMTk5LjM1ODgsMjA2LjUzNzUgUTE5OC43ODA2LDIwNi44MzQ0IDE5OC4xNCwyMDYuOTc1IFExOTcuNDk5NCwyMDcuMTMxMyAxOTYuNzk2MywyMDcuMTMxMyBRMTk0LjI5NjMsMjA3LjEzMTMgMTkyLjk2ODEsMjA1LjQ5MDYgUTE5MS42NTU2LDIwMy44MzQ0IDE5MS42NTU2LDIwMC43MDk0IFExOTEuNjU1NiwxOTcuNTg0NCAxOTIuOTY4MSwxOTUuOTI4MSBRMTk0LjI5NjMsMTk0LjI3MTkgMTk2Ljc5NjMsMTk0LjI3MTkgUTE5Ny40OTk0LDE5NC4yNzE5IDE5OC4xNCwxOTQuNDI4MSBRMTk4Ljc5NjMsMTk0LjU4NDQgMTk5LjM1ODgsMTk0Ljg4MTMgTDE5OS4zNTg4LDE5Ny42IFExOTguNzMzOCwxOTcuMDIxOSAxOTguMTQsMTk2Ljc1NjMgUTE5Ny41NDYzLDE5Ni40NzUgMTk2LjkyMTMsMTk2LjQ3NSBRMTk1LjU3NzUsMTk2LjQ3NSAxOTQuODksMTk3LjU1MzEgUTE5NC4yMDI1LDE5OC42MTU2IDE5NC4yMDI1LDIwMC43MDk0IFExOTQuMjAyNSwyMDIuODAzMSAxOTQuODksMjAzLjg4MTMgUTE5NS41Nzc1LDIwNC45NDM4IDE5Ni45MjEzLDIwNC45NDM4IFExOTcuNTQ2MywyMDQuOTQzOCAxOTguMTQsMjA0LjY3ODEgUTE5OC43MzM4LDIwNC4zOTY5IDE5OS4zNTg4LDIwMy44MTg4IEwxOTkuMzU4OCwyMDYuNTM3NSBaICIgZmlsbD0iIzAwMDAwMCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE3Mi40OTgiIHg9IjIxMC4zOSIgeT0iMjA1Ljc0MzYiPk9wdGltaXN0aWNMb2NrRXhjZXB0aW9uPC90ZXh0PjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgeDE9IjE4Mi4zOSIgeDI9IjM4NC44ODgiIHkxPSIyMTYuODk2OSIgeTI9IjIxNi44OTY5Ii8+PGcgZGF0YS12aXNpYmlsaXR5LW1vZGlmaWVyPSJQUklWQVRFX0ZJRUxEIj48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjYiIHN0eWxlPSJzdHJva2U6I0M4MjkzMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI2IiB4PSIxODkuMzkiIHk9IjIyNy41NDUzIi8+PC9nPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyNS45MjQ4IiB4PSIyMDEuMzkiIHk9IjIzMy44OTIiPmVudGl0eVR5cGU6IFN0cmluZzwvdGV4dD48ZyBkYXRhLXZpc2liaWxpdHktbW9kaWZpZXI9IlBSSVZBVEVfRklFTEQiPjxyZWN0IGZpbGw9Im5vbmUiIGhlaWdodD0iNiIgc3R5bGU9InN0cm9rZTojQzgyOTMwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjYiIHg9IjE4OS4zOSIgeT0iMjQzLjg0MjIiLz48L2c+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTA0LjYwMzUiIHg9IjIwMS4zOSIgeT0iMjUwLjE4ODkiPmVudGl0eUlkOiBTdHJpbmc8L3RleHQ+PGcgZGF0YS12aXNpYmlsaXR5LW1vZGlmaWVyPSJQUklWQVRFX0ZJRUxEIj48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjYiIHN0eWxlPSJzdHJva2U6I0M4MjkzMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI2IiB4PSIxODkuMzkiIHk9IjI2MC4xMzkxIi8+PC9nPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE2MC45NDUzIiB4PSIyMDEuMzkiIHk9IjI2Ni40ODU3Ij5leHBlY3RlZFZlcnNpb246IExvbmc8L3RleHQ+PGcgZGF0YS12aXNpYmlsaXR5LW1vZGlmaWVyPSJQUklWQVRFX0ZJRUxEIj48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjYiIHN0eWxlPSJzdHJva2U6I0M4MjkzMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI2IiB4PSIxODkuMzkiIHk9IjI3Ni40MzU5Ii8+PC9nPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEzOC45Njc4IiB4PSIyMDEuMzkiIHk9IjI4Mi43ODI2Ij5hY3R1YWxWZXJzaW9uOiBMb25nPC90ZXh0PjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgeDE9IjE4Mi4zOSIgeDI9IjM4NC44ODgiIHkxPSIyOTAuMDg0NCIgeTI9IjI5MC4wODQ0Ii8+PC9nPjwhLS1jbGFzcyBBY2NvdW50T3B0aW1pc3RpY0xvY2tFeGNlcHRpb24tLT48ZyBjbGFzcz0iZW50aXR5IiBkYXRhLXF1YWxpZmllZC1uYW1lPSJBY2NvdW50T3B0aW1pc3RpY0xvY2tFeGNlcHRpb24iIGRhdGEtc291cmNlLWxpbmU9IjE1IiBpZD0iZW50MDAwNCI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSI2NC4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIyNjEuMjcwNSIgeD0iNyIgeT0iMzU4LjA3NjkiLz48ZWxsaXBzZSBjeD0iMjIiIGN5PSIzNzQuMDc2OSIgZmlsbD0iI0FERDFCMiIgcng9IjExIiByeT0iMTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cGF0aCBkPSJNMjQuOTY4OCwzNzkuNzE3NSBRMjQuMzkwNiwzODAuMDE0NCAyMy43NSwzODAuMTU1IFEyMy4xMDk0LDM4MC4zMTEzIDIyLjQwNjMsMzgwLjMxMTMgUTE5LjkwNjMsMzgwLjMxMTMgMTguNTc4MSwzNzguNjcwNiBRMTcuMjY1NiwzNzcuMDE0NCAxNy4yNjU2LDM3My44ODk0IFExNy4yNjU2LDM3MC43NjQ0IDE4LjU3ODEsMzY5LjEwODEgUTE5LjkwNjMsMzY3LjQ1MTkgMjIuNDA2MywzNjcuNDUxOSBRMjMuMTA5NCwzNjcuNDUxOSAyMy43NSwzNjcuNjA4MSBRMjQuNDA2MywzNjcuNzY0NCAyNC45Njg4LDM2OC4wNjEzIEwyNC45Njg4LDM3MC43OCBRMjQuMzQzOCwzNzAuMjAxOSAyMy43NSwzNjkuOTM2MyBRMjMuMTU2MywzNjkuNjU1IDIyLjUzMTMsMzY5LjY1NSBRMjEuMTg3NSwzNjkuNjU1IDIwLjUsMzcwLjczMzEgUTE5LjgxMjUsMzcxLjc5NTYgMTkuODEyNSwzNzMuODg5NCBRMTkuODEyNSwzNzUuOTgzMSAyMC41LDM3Ny4wNjEzIFEyMS4xODc1LDM3OC4xMjM4IDIyLjUzMTMsMzc4LjEyMzggUTIzLjE1NjMsMzc4LjEyMzggMjMuNzUsMzc3Ljg1ODEgUTI0LjM0MzgsMzc3LjU3NjkgMjQuOTY4OCwzNzYuOTk4OCBMMjQuOTY4OCwzNzkuNzE3NSBaICIgZmlsbD0iIzAwMDAwMCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjIyOS4yNzA1IiB4PSIzNiIgeT0iMzc4LjkyMzYiPkFjY291bnRPcHRpbWlzdGljTG9ja0V4Y2VwdGlvbjwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI4IiB4Mj0iMjY3LjI3MDUiIHkxPSIzOTAuMDc2OSIgeTI9IjM5MC4wNzY5Ii8+PGcgZGF0YS12aXNpYmlsaXR5LW1vZGlmaWVyPSJQUklWQVRFX0ZJRUxEIj48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjYiIHN0eWxlPSJzdHJva2U6I0M4MjkzMDtzdHJva2Utd2lkdGg6MTsiIHdpZHRoPSI2IiB4PSIxNSIgeT0iNDAwLjcyNTMiLz48L2c+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTQyLjU2MzUiIHg9IjI3IiB5PSI0MDcuMDcyIj5hY2NvdW50Q29kZTogU3RyaW5nPC90ZXh0PjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgeDE9IjgiIHgyPSIyNjcuMjcwNSIgeTE9IjQxNC4zNzM4IiB5Mj0iNDE0LjM3MzgiLz48L2c+PCEtLWNsYXNzIEpvdXJuYWxPcHRpbWlzdGljTG9ja0V4Y2VwdGlvbi0tPjxnIGNsYXNzPSJlbnRpdHkiIGRhdGEtcXVhbGlmaWVkLW5hbWU9IkpvdXJuYWxPcHRpbWlzdGljTG9ja0V4Y2VwdGlvbiIgZGF0YS1zb3VyY2UtbGluZT0iMTkiIGlkPSJlbnQwMDA1Ij48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjY0LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjI1My4xNjMxIiB4PSIzMDMuMDUiIHk9IjM1OC4wNzY5Ii8+PGVsbGlwc2UgY3g9IjMxOC4wNSIgY3k9IjM3NC4wNzY5IiBmaWxsPSIjQUREMUIyIiByeD0iMTEiIHJ5PSIxMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwYXRoIGQ9Ik0zMjEuMDE4OCwzNzkuNzE3NSBRMzIwLjQ0MDYsMzgwLjAxNDQgMzE5LjgsMzgwLjE1NSBRMzE5LjE1OTQsMzgwLjMxMTMgMzE4LjQ1NjMsMzgwLjMxMTMgUTMxNS45NTYzLDM4MC4zMTEzIDMxNC42MjgxLDM3OC42NzA2IFEzMTMuMzE1NiwzNzcuMDE0NCAzMTMuMzE1NiwzNzMuODg5NCBRMzEzLjMxNTYsMzcwLjc2NDQgMzE0LjYyODEsMzY5LjEwODEgUTMxNS45NTYzLDM2Ny40NTE5IDMxOC40NTYzLDM2Ny40NTE5IFEzMTkuMTU5NCwzNjcuNDUxOSAzMTkuOCwzNjcuNjA4MSBRMzIwLjQ1NjMsMzY3Ljc2NDQgMzIxLjAxODgsMzY4LjA2MTMgTDMyMS4wMTg4LDM3MC43OCBRMzIwLjM5MzgsMzcwLjIwMTkgMzE5LjgsMzY5LjkzNjMgUTMxOS4yMDYzLDM2OS42NTUgMzE4LjU4MTMsMzY5LjY1NSBRMzE3LjIzNzUsMzY5LjY1NSAzMTYuNTUsMzcwLjczMzEgUTMxNS44NjI1LDM3MS43OTU2IDMxNS44NjI1LDM3My44ODk0IFEzMTUuODYyNSwzNzUuOTgzMSAzMTYuNTUsMzc3LjA2MTMgUTMxNy4yMzc1LDM3OC4xMjM4IDMxOC41ODEzLDM3OC4xMjM4IFEzMTkuMjA2MywzNzguMTIzOCAzMTkuOCwzNzcuODU4MSBRMzIwLjM5MzgsMzc3LjU3NjkgMzIxLjAxODgsMzc2Ljk5ODggTDMyMS4wMTg4LDM3OS43MTc1IFogIiBmaWxsPSIjMDAwMDAwIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjIxLjE2MzEiIHg9IjMzMi4wNSIgeT0iMzc4LjkyMzYiPkpvdXJuYWxPcHRpbWlzdGljTG9ja0V4Y2VwdGlvbjwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIzMDQuMDUiIHgyPSI1NTUuMjEzMSIgeTE9IjM5MC4wNzY5IiB5Mj0iMzkwLjA3NjkiLz48ZyBkYXRhLXZpc2liaWxpdHktbW9kaWZpZXI9IlBSSVZBVEVfRklFTEQiPjxyZWN0IGZpbGw9Im5vbmUiIGhlaWdodD0iNiIgc3R5bGU9InN0cm9rZTojQzgyOTMwO3N0cm9rZS13aWR0aDoxOyIgd2lkdGg9IjYiIHg9IjMxMS4wNSIgeT0iNDAwLjcyNTMiLz48L2c+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTE4LjQxMjEiIHg9IjMyMy4wNSIgeT0iNDA3LjA3MiI+am91cm5hbE5vOiBTdHJpbmc8L3RleHQ+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iMzA0LjA1IiB4Mj0iNTU1LjIxMzEiIHkxPSI0MTQuMzczOCIgeTI9IjQxNC4zNzM4Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgRG9tYWluRXhjZXB0aW9uIHRvIE9wdGltaXN0aWNMb2NrRXhjZXB0aW9uLS0+PGcgY2xhc3M9ImxpbmsiIGRhdGEtZW50aXR5LTE9ImVudDAwMDIiIGRhdGEtZW50aXR5LTI9ImVudDAwMDMiIGRhdGEtbGluay10eXBlPSJleHRlbnNpb24iIGRhdGEtc291cmNlLWxpbmU9IjIzIiBpZD0ibG5rNiI+PHBhdGggY29kZUxpbmU9IjIzIiBkPSJNMjgzLjY0LDE0My4wNzY5IEMyODMuNjQsMTYxLjA5NjkgMjgzLjY0LDE2NC43NTY5IDI4My42NCwxODQuNDE2OSIgZmlsbD0ibm9uZSIgaWQ9IkRvbWFpbkV4Y2VwdGlvbi1iYWNrdG8tT3B0aW1pc3RpY0xvY2tFeGNlcHRpb24iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MTsiLz48cG9seWdvbiBmaWxsPSJub25lIiBwb2ludHM9IjI4My42NCwxMjUuMDc2OSwyNzcuNjQsMTQzLjA3NjksMjg5LjY0LDE0My4wNzY5LDI4My42NCwxMjUuMDc2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tcmV2ZXJzZSBsaW5rIE9wdGltaXN0aWNMb2NrRXhjZXB0aW9uIHRvIEFjY291bnRPcHRpbWlzdGljTG9ja0V4Y2VwdGlvbi0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJlbnQwMDAzIiBkYXRhLWVudGl0eS0yPSJlbnQwMDA0IiBkYXRhLWxpbmstdHlwZT0iZXh0ZW5zaW9uIiBkYXRhLXNvdXJjZS1saW5lPSIyNCIgaWQ9ImxuazciPjxwYXRoIGNvZGVMaW5lPSIyNCIgZD0iTTIxNS4zMjcxLDMxMS4xMzk3IEMxOTUuMzQ3MSwzMzEuMjI5NyAxODYuMjEsMzQwLjQwNjkgMTY5LjAxLDM1Ny42OTY5IiBmaWxsPSJub25lIiBpZD0iT3B0aW1pc3RpY0xvY2tFeGNlcHRpb24tYmFja3RvLUFjY291bnRPcHRpbWlzdGljTG9ja0V4Y2VwdGlvbiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9Im5vbmUiIHBvaW50cz0iMjI4LjAyLDI5OC4zNzY5LDIxMS4wNzI4LDMwNi45MDg3LDIxOS41ODEzLDMxNS4zNzA3LDIyOC4wMiwyOTguMzc2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48IS0tcmV2ZXJzZSBsaW5rIE9wdGltaXN0aWNMb2NrRXhjZXB0aW9uIHRvIEpvdXJuYWxPcHRpbWlzdGljTG9ja0V4Y2VwdGlvbi0tPjxnIGNsYXNzPSJsaW5rIiBkYXRhLWVudGl0eS0xPSJlbnQwMDAzIiBkYXRhLWVudGl0eS0yPSJlbnQwMDA1IiBkYXRhLWxpbmstdHlwZT0iZXh0ZW5zaW9uIiBkYXRhLXNvdXJjZS1saW5lPSIyNSIgaWQ9ImxuazgiPjxwYXRoIGNvZGVMaW5lPSIyNSIgZD0iTTM1MS45NDI5LDMxMS4xMzk3IEMzNzEuOTIyOSwzMzEuMjI5NyAzODEuMDYsMzQwLjQwNjkgMzk4LjI2LDM1Ny42OTY5IiBmaWxsPSJub25lIiBpZD0iT3B0aW1pc3RpY0xvY2tFeGNlcHRpb24tYmFja3RvLUpvdXJuYWxPcHRpbWlzdGljTG9ja0V4Y2VwdGlvbiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjxwb2x5Z29uIGZpbGw9Im5vbmUiIHBvaW50cz0iMzM5LjI1LDI5OC4zNzY5LDM0Ny42ODg3LDMxNS4zNzA3LDM1Ni4xOTcyLDMwNi45MDg3LDMzOS4yNSwyOTguMzc2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxOyIvPjwvZz48P3BsYW50dW1sLXNyYyBWUDMxM2k1MDQ4Umwtbkp4MGRzMW5hTG04Q0Exa0FfZmZiZFF0UU94SkdXa1VmR3VFWlpaOVlCRWw0bUh0YUFaMklOaVNSX0N6eS1fV204ekpnX2h1c3JwSUU5ajRpVjlUN1MtcEl3aG5OcXZsLW5OWEIya25mMDFLbDJPcmhJaVYyUGFQRzB5R0E0YTdINkItYm5odmRBUmpaMEtxYXE5QUVWemQxMklrU3JLeU9MNjBOSzVfU3lDQmI3V2kzcUN5WjRQaDNmdkQwV3U4N1N3RkRJZlF6RXdVbEFxT1NJeUpfZlFOMEhHYUtKSlZmUURiN3VNaHdhZWJDbXAtUnJpZkE3b3psVW4yY0ZCLWRTNXlZX3pBUGJfTzdSRHhIeTA/PjwvZz48L3N2Zz4=" class="uml" alt="uml diagram" title="" /></p>
<h3 id="_6">例外クラスの実装<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// domain/exception/OptimisticLockException.java</span>
<span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.domain.exception</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.Getter</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 楽観ロック例外</span>
<span class="cm"> * 同時更新による競合が発生した場合にスローされる</span>
<span class="cm"> */</span>
<span class="nd">@Getter</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">OptimisticLockException</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">DomainException</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">entityType</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">entityId</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">expectedVersion</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">actualVersion</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">OptimisticLockException</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">entityType</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">entityId</span><span class="p">,</span>
<span class="w">                                   </span><span class="n">Long</span><span class="w"> </span><span class="n">expectedVersion</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">actualVersion</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span>
<span class="w">                </span><span class="s">&quot;%s (ID: %s) は他のユーザーによって更新されました。&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                </span><span class="s">&quot;期待バージョン: %d, 実際のバージョン: %d。&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                </span><span class="s">&quot;画面を更新して再度お試しください。&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">entityType</span><span class="p">,</span><span class="w"> </span><span class="n">entityId</span><span class="p">,</span><span class="w"> </span><span class="n">expectedVersion</span><span class="p">,</span><span class="w"> </span><span class="n">actualVersion</span><span class="p">),</span>
<span class="w">              </span><span class="s">&quot;OPTIMISTIC_LOCK_ERROR&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">entityType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entityType</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">entityId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entityId</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">expectedVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expectedVersion</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">actualVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">actualVersion</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">OptimisticLockException</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">entityType</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">entityId</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">expectedVersion</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span>
<span class="w">                </span><span class="s">&quot;%s (ID: %s) は他のユーザーによって更新または削除されました。&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                </span><span class="s">&quot;画面を更新して再度お試しください。&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">entityType</span><span class="p">,</span><span class="w"> </span><span class="n">entityId</span><span class="p">),</span>
<span class="w">              </span><span class="s">&quot;OPTIMISTIC_LOCK_ERROR&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">entityType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entityType</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">entityId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entityId</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">expectedVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expectedVersion</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">actualVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// domain/exception/AccountOptimisticLockException.java</span>
<span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.domain.exception</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 勘定科目の楽観ロック例外</span>
<span class="cm"> */</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AccountOptimisticLockException</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">OptimisticLockException</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">AccountOptimisticLockException</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">accountCode</span><span class="p">,</span>
<span class="w">                                          </span><span class="n">Long</span><span class="w"> </span><span class="n">expectedVersion</span><span class="p">,</span>
<span class="w">                                          </span><span class="n">Long</span><span class="w"> </span><span class="n">actualVersion</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="s">&quot;勘定科目&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">accountCode</span><span class="p">,</span><span class="w"> </span><span class="n">expectedVersion</span><span class="p">,</span><span class="w"> </span><span class="n">actualVersion</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">AccountOptimisticLockException</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">accountCode</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">expectedVersion</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="s">&quot;勘定科目&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">accountCode</span><span class="p">,</span><span class="w"> </span><span class="n">expectedVersion</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// domain/exception/JournalOptimisticLockException.java</span>
<span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.domain.exception</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 仕訳の楽観ロック例外</span>
<span class="cm"> */</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JournalOptimisticLockException</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">OptimisticLockException</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">JournalOptimisticLockException</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">journalNo</span><span class="p">,</span>
<span class="w">                                          </span><span class="n">Long</span><span class="w"> </span><span class="n">expectedVersion</span><span class="p">,</span>
<span class="w">                                          </span><span class="n">Long</span><span class="w"> </span><span class="n">actualVersion</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="s">&quot;仕訳&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">journalNo</span><span class="p">,</span><span class="w"> </span><span class="n">expectedVersion</span><span class="p">,</span><span class="w"> </span><span class="n">actualVersion</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">JournalOptimisticLockException</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">journalNo</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">expectedVersion</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="s">&quot;仕訳&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">journalNo</span><span class="p">,</span><span class="w"> </span><span class="n">expectedVersion</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="285-entity-version">28.5 Entity への version 追加<a class="headerlink" href="#285-entity-version" title="Permanent link">&para;</a></h2>
<h3 id="accountentity">AccountEntity<a class="headerlink" href="#accountentity" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// infrastructure/persistence/entity/AccountEntity.java</span>
<span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.persistence.entity</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.account.Account</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.Data</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDateTime</span><span class="p">;</span>

<span class="nd">@Data</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AccountEntity</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">accountCode</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">accountName</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">accountAbbr</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">accountKana</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">bsplType</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">debitCreditType</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">elementType</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">displayOrder</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">version</span><span class="p">;</span><span class="w">  </span><span class="c1">// 楽観ロック用</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">createdAt</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">updatedAt</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Entity から Domain Model への変換</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Account</span><span class="w"> </span><span class="nf">toDomain</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Account</span><span class="p">(</span>
<span class="w">                </span><span class="n">accountCode</span><span class="p">,</span>
<span class="w">                </span><span class="n">accountName</span><span class="p">,</span>
<span class="w">                </span><span class="n">accountAbbr</span><span class="p">,</span>
<span class="w">                </span><span class="n">accountKana</span><span class="p">,</span>
<span class="w">                </span><span class="n">bsplType</span><span class="p">,</span>
<span class="w">                </span><span class="n">debitCreditType</span><span class="p">,</span>
<span class="w">                </span><span class="n">elementType</span><span class="p">,</span>
<span class="w">                </span><span class="n">displayOrder</span><span class="p">,</span>
<span class="w">                </span><span class="n">version</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Domain Model から Entity への変換</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">AccountEntity</span><span class="w"> </span><span class="nf">from</span><span class="p">(</span><span class="n">Account</span><span class="w"> </span><span class="n">account</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">AccountEntity</span><span class="w"> </span><span class="n">entity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AccountEntity</span><span class="p">();</span>
<span class="w">        </span><span class="n">entity</span><span class="p">.</span><span class="na">setAccountCode</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="na">getAccountCode</span><span class="p">());</span>
<span class="w">        </span><span class="n">entity</span><span class="p">.</span><span class="na">setAccountName</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="na">getAccountName</span><span class="p">());</span>
<span class="w">        </span><span class="n">entity</span><span class="p">.</span><span class="na">setAccountAbbr</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="na">getAccountAbbr</span><span class="p">());</span>
<span class="w">        </span><span class="n">entity</span><span class="p">.</span><span class="na">setAccountKana</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="na">getAccountKana</span><span class="p">());</span>
<span class="w">        </span><span class="n">entity</span><span class="p">.</span><span class="na">setBsplType</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="na">getBsplType</span><span class="p">());</span>
<span class="w">        </span><span class="n">entity</span><span class="p">.</span><span class="na">setDebitCreditType</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="na">getDebitCreditType</span><span class="p">());</span>
<span class="w">        </span><span class="n">entity</span><span class="p">.</span><span class="na">setElementType</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="na">getElementType</span><span class="p">());</span>
<span class="w">        </span><span class="n">entity</span><span class="p">.</span><span class="na">setDisplayOrder</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="na">getDisplayOrder</span><span class="p">());</span>
<span class="w">        </span><span class="n">entity</span><span class="p">.</span><span class="na">setVersion</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="na">getVersion</span><span class="p">());</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">entity</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="journalentity">JournalEntity<a class="headerlink" href="#journalentity" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// infrastructure/persistence/entity/JournalEntity.java</span>
<span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.persistence.entity</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.journal.ApprovalStatus</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.journal.JournalEntry</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.Data</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDate</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDateTime</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.stream.Collectors</span><span class="p">;</span>

<span class="nd">@Data</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JournalEntity</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">journalNo</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">LocalDate</span><span class="w"> </span><span class="n">entryDate</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">description</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">approvalStatus</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">version</span><span class="p">;</span><span class="w">  </span><span class="c1">// 楽観ロック用</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">createdAt</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">updatedAt</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">JournalDetailEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">details</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Entity から Domain Model への変換</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">JournalEntry</span><span class="w"> </span><span class="nf">toDomain</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JournalEntry</span><span class="p">(</span>
<span class="w">                </span><span class="n">journalNo</span><span class="p">,</span>
<span class="w">                </span><span class="n">entryDate</span><span class="p">,</span>
<span class="w">                </span><span class="n">description</span><span class="p">,</span>
<span class="w">                </span><span class="n">ApprovalStatus</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">approvalStatus</span><span class="p">),</span>
<span class="w">                </span><span class="n">details</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
<span class="w">                        </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">JournalDetailEntity</span><span class="p">::</span><span class="n">toDomain</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">()),</span>
<span class="w">                </span><span class="n">version</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Domain Model から Entity への変換</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">JournalEntity</span><span class="w"> </span><span class="nf">from</span><span class="p">(</span><span class="n">JournalEntry</span><span class="w"> </span><span class="n">journal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">JournalEntity</span><span class="w"> </span><span class="n">entity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JournalEntity</span><span class="p">();</span>
<span class="w">        </span><span class="n">entity</span><span class="p">.</span><span class="na">setJournalNo</span><span class="p">(</span><span class="n">journal</span><span class="p">.</span><span class="na">getJournalNo</span><span class="p">());</span>
<span class="w">        </span><span class="n">entity</span><span class="p">.</span><span class="na">setEntryDate</span><span class="p">(</span><span class="n">journal</span><span class="p">.</span><span class="na">getJournalDate</span><span class="p">());</span>
<span class="w">        </span><span class="n">entity</span><span class="p">.</span><span class="na">setDescription</span><span class="p">(</span><span class="n">journal</span><span class="p">.</span><span class="na">getDescription</span><span class="p">());</span>
<span class="w">        </span><span class="n">entity</span><span class="p">.</span><span class="na">setApprovalStatus</span><span class="p">(</span><span class="n">journal</span><span class="p">.</span><span class="na">getApprovalStatus</span><span class="p">().</span><span class="na">name</span><span class="p">());</span>
<span class="w">        </span><span class="n">entity</span><span class="p">.</span><span class="na">setVersion</span><span class="p">(</span><span class="n">journal</span><span class="p">.</span><span class="na">getVersion</span><span class="p">());</span>
<span class="w">        </span><span class="n">entity</span><span class="p">.</span><span class="na">setDetails</span><span class="p">(</span>
<span class="w">                </span><span class="n">journal</span><span class="p">.</span><span class="na">getDetails</span><span class="p">().</span><span class="na">stream</span><span class="p">()</span>
<span class="w">                        </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">JournalDetailEntity</span><span class="p">::</span><span class="n">from</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">())</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">entity</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="286-mybatis-mapper">28.6 MyBatis Mapper の実装<a class="headerlink" href="#286-mybatis-mapper" title="Permanent link">&para;</a></h2>
<h3 id="update">楽観ロック対応の UPDATE 文<a class="headerlink" href="#update" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// infrastructure/persistence/mapper/AccountMapper.java</span>
<span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.persistence.mapper</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.persistence.entity.AccountEntity</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.ibatis.annotations.Mapper</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.ibatis.annotations.Param</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span>

<span class="nd">@Mapper</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">AccountMapper</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AccountEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">selectAll</span><span class="p">();</span>

<span class="w">    </span><span class="n">AccountEntity</span><span class="w"> </span><span class="nf">selectByCode</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">accountCode</span><span class="p">);</span>

<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AccountEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">selectByBsplType</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">bsplType</span><span class="p">);</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">insert</span><span class="p">(</span><span class="n">AccountEntity</span><span class="w"> </span><span class="n">entity</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 楽観ロック付き更新</span>
<span class="cm">     * @return 更新された行数（0 の場合は楽観ロックエラー）</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">updateWithVersion</span><span class="p">(</span><span class="n">AccountEntity</span><span class="w"> </span><span class="n">entity</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 楽観ロック付き削除</span>
<span class="cm">     * @return 削除された行数（0 の場合は楽観ロックエラー）</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">deleteWithVersion</span><span class="p">(</span><span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;accountCode&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">accountCode</span><span class="p">,</span>
<span class="w">                          </span><span class="nd">@Param</span><span class="p">(</span><span class="s">&quot;version&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">version</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="mapper-xml">Mapper XML<a class="headerlink" href="#mapper-xml" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="cm">&lt;!-- resources/mapper/AccountMapper.xml --&gt;</span>
<span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>

<span class="nt">&lt;mapper</span><span class="w"> </span><span class="na">namespace=</span><span class="s">&quot;com.example.accounting.infrastructure.persistence.mapper.AccountMapper&quot;</span><span class="nt">&gt;</span>

<span class="w">    </span><span class="nt">&lt;resultMap</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;accountResultMap&quot;</span>
<span class="w">               </span><span class="na">type=</span><span class="s">&quot;com.example.accounting.infrastructure.persistence.entity.AccountEntity&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;id</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;accountCode&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;勘定科目コード&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;accountName&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;勘定科目名&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;accountAbbr&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;勘定科目略称&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;accountKana&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;勘定科目カナ&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;bsplType&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;勘定科目BS区分&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;debitCreditType&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;勘定科目貸借区分&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;elementType&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;勘定科目要素区分&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;displayOrder&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;表示順&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;version&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;version&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;createdAt&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;作成日時&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;updatedAt&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;更新日時&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/resultMap&gt;</span>

<span class="w">    </span><span class="nt">&lt;select</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;selectAll&quot;</span><span class="w"> </span><span class="na">resultMap=</span><span class="s">&quot;accountResultMap&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span>SELECT<span class="w"> </span>*<span class="w"> </span>FROM<span class="w"> </span>&quot;勘定科目マスタ&quot;
<span class="w">        </span>ORDER<span class="w"> </span>BY<span class="w"> </span>&quot;表示順&quot;
<span class="w">    </span><span class="nt">&lt;/select&gt;</span>

<span class="w">    </span><span class="nt">&lt;select</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;selectByCode&quot;</span><span class="w"> </span><span class="na">resultMap=</span><span class="s">&quot;accountResultMap&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span>SELECT<span class="w"> </span>*<span class="w"> </span>FROM<span class="w"> </span>&quot;勘定科目マスタ&quot;
<span class="w">        </span>WHERE<span class="w"> </span>&quot;勘定科目コード&quot;<span class="w"> </span>=<span class="w"> </span>#{accountCode}
<span class="w">    </span><span class="nt">&lt;/select&gt;</span>

<span class="w">    </span><span class="nt">&lt;select</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;selectByBsplType&quot;</span><span class="w"> </span><span class="na">resultMap=</span><span class="s">&quot;accountResultMap&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span>SELECT<span class="w"> </span>*<span class="w"> </span>FROM<span class="w"> </span>&quot;勘定科目マスタ&quot;
<span class="w">        </span>WHERE<span class="w"> </span>&quot;勘定科目BS区分&quot;<span class="w"> </span>=<span class="w"> </span>#{bsplType}
<span class="w">        </span>ORDER<span class="w"> </span>BY<span class="w"> </span>&quot;表示順&quot;
<span class="w">    </span><span class="nt">&lt;/select&gt;</span>

<span class="w">    </span><span class="nt">&lt;insert</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;insert&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span>INSERT<span class="w"> </span>INTO<span class="w"> </span>&quot;勘定科目マスタ&quot;<span class="w"> </span>(
<span class="w">            </span>&quot;勘定科目コード&quot;,<span class="w"> </span>&quot;勘定科目名&quot;,<span class="w"> </span>&quot;勘定科目略称&quot;,<span class="w"> </span>&quot;勘定科目カナ&quot;,
<span class="w">            </span>&quot;勘定科目BS区分&quot;,<span class="w"> </span>&quot;勘定科目貸借区分&quot;,<span class="w"> </span>&quot;勘定科目要素区分&quot;,<span class="w"> </span>&quot;表示順&quot;,
<span class="w">            </span>&quot;version&quot;,<span class="w"> </span>&quot;作成日時&quot;,<span class="w"> </span>&quot;更新日時&quot;
<span class="w">        </span>)<span class="w"> </span>VALUES<span class="w"> </span>(
<span class="w">            </span>#{accountCode},<span class="w"> </span>#{accountName},<span class="w"> </span>#{accountAbbr},<span class="w"> </span>#{accountKana},
<span class="w">            </span>#{bsplType},<span class="w"> </span>#{debitCreditType},<span class="w"> </span>#{elementType},<span class="w"> </span>#{displayOrder},
<span class="w">            </span>1,<span class="w"> </span>CURRENT_TIMESTAMP,<span class="w"> </span>CURRENT_TIMESTAMP
<span class="w">        </span>)
<span class="w">    </span><span class="nt">&lt;/insert&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- 楽観ロック付き更新 --&gt;</span>
<span class="w">    </span><span class="nt">&lt;update</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;updateWithVersion&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span>UPDATE<span class="w"> </span>&quot;勘定科目マスタ&quot;
<span class="w">        </span>SET<span class="w"> </span>&quot;勘定科目名&quot;<span class="w"> </span>=<span class="w"> </span>#{accountName},
<span class="w">            </span>&quot;勘定科目略称&quot;<span class="w"> </span>=<span class="w"> </span>#{accountAbbr},
<span class="w">            </span>&quot;勘定科目カナ&quot;<span class="w"> </span>=<span class="w"> </span>#{accountKana},
<span class="w">            </span>&quot;勘定科目BS区分&quot;<span class="w"> </span>=<span class="w"> </span>#{bsplType},
<span class="w">            </span>&quot;勘定科目貸借区分&quot;<span class="w"> </span>=<span class="w"> </span>#{debitCreditType},
<span class="w">            </span>&quot;勘定科目要素区分&quot;<span class="w"> </span>=<span class="w"> </span>#{elementType},
<span class="w">            </span>&quot;表示順&quot;<span class="w"> </span>=<span class="w"> </span>#{displayOrder},
<span class="w">            </span>&quot;version&quot;<span class="w"> </span>=<span class="w"> </span>#{version}<span class="w"> </span>+<span class="w"> </span>1,
<span class="w">            </span>&quot;更新日時&quot;<span class="w"> </span>=<span class="w"> </span>CURRENT_TIMESTAMP
<span class="w">        </span>WHERE<span class="w"> </span>&quot;勘定科目コード&quot;<span class="w"> </span>=<span class="w"> </span>#{accountCode}
<span class="w">          </span>AND<span class="w"> </span>&quot;version&quot;<span class="w"> </span>=<span class="w"> </span>#{version}
<span class="w">    </span><span class="nt">&lt;/update&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- 楽観ロック付き削除 --&gt;</span>
<span class="w">    </span><span class="nt">&lt;delete</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;deleteWithVersion&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span>DELETE<span class="w"> </span>FROM<span class="w"> </span>&quot;勘定科目マスタ&quot;
<span class="w">        </span>WHERE<span class="w"> </span>&quot;勘定科目コード&quot;<span class="w"> </span>=<span class="w"> </span>#{accountCode}
<span class="w">          </span>AND<span class="w"> </span>&quot;version&quot;<span class="w"> </span>=<span class="w"> </span>#{version}
<span class="w">    </span><span class="nt">&lt;/delete&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</code></pre></div>
<h3 id="journalmapper">JournalMapper<a class="headerlink" href="#journalmapper" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="cm">&lt;!-- resources/mapper/JournalMapper.xml --&gt;</span>
<span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>

<span class="nt">&lt;mapper</span><span class="w"> </span><span class="na">namespace=</span><span class="s">&quot;com.example.accounting.infrastructure.persistence.mapper.JournalMapper&quot;</span><span class="nt">&gt;</span>

<span class="w">    </span><span class="nt">&lt;resultMap</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;journalResultMap&quot;</span>
<span class="w">               </span><span class="na">type=</span><span class="s">&quot;com.example.accounting.infrastructure.persistence.entity.JournalEntity&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;id</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;journalNo&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;仕訳伝票番号&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;entryDate&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;起票日&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;description&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;摘要&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;approvalStatus&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;承認状態&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;version&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;version&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;createdAt&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;作成日時&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;result</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;updatedAt&quot;</span><span class="w"> </span><span class="na">column=</span><span class="s">&quot;更新日時&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;collection</span><span class="w"> </span><span class="na">property=</span><span class="s">&quot;details&quot;</span>
<span class="w">                    </span><span class="na">ofType=</span><span class="s">&quot;com.example.accounting.infrastructure.persistence.entity.JournalDetailEntity&quot;</span>
<span class="w">                    </span><span class="na">select=</span><span class="s">&quot;selectDetailsByJournalNo&quot;</span>
<span class="w">                    </span><span class="na">column=</span><span class="s">&quot;仕訳伝票番号&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/resultMap&gt;</span>

<span class="w">    </span><span class="nt">&lt;select</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;selectByJournalNo&quot;</span><span class="w"> </span><span class="na">resultMap=</span><span class="s">&quot;journalResultMap&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span>SELECT<span class="w"> </span>*<span class="w"> </span>FROM<span class="w"> </span>&quot;仕訳&quot;
<span class="w">        </span>WHERE<span class="w"> </span>&quot;仕訳伝票番号&quot;<span class="w"> </span>=<span class="w"> </span>#{journalNo}
<span class="w">    </span><span class="nt">&lt;/select&gt;</span>

<span class="w">    </span><span class="nt">&lt;insert</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;insert&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span>INSERT<span class="w"> </span>INTO<span class="w"> </span>&quot;仕訳&quot;<span class="w"> </span>(
<span class="w">            </span>&quot;仕訳伝票番号&quot;,<span class="w"> </span>&quot;起票日&quot;,<span class="w"> </span>&quot;摘要&quot;,<span class="w"> </span>&quot;承認状態&quot;,
<span class="w">            </span>&quot;version&quot;,<span class="w"> </span>&quot;作成日時&quot;,<span class="w"> </span>&quot;更新日時&quot;
<span class="w">        </span>)<span class="w"> </span>VALUES<span class="w"> </span>(
<span class="w">            </span>#{journalNo},<span class="w"> </span>#{entryDate},<span class="w"> </span>#{description},<span class="w"> </span>#{approvalStatus},
<span class="w">            </span>1,<span class="w"> </span>CURRENT_TIMESTAMP,<span class="w"> </span>CURRENT_TIMESTAMP
<span class="w">        </span>)
<span class="w">    </span><span class="nt">&lt;/insert&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- 楽観ロック付き更新 --&gt;</span>
<span class="w">    </span><span class="nt">&lt;update</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;updateWithVersion&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span>UPDATE<span class="w"> </span>&quot;仕訳&quot;
<span class="w">        </span>SET<span class="w"> </span>&quot;起票日&quot;<span class="w"> </span>=<span class="w"> </span>#{entryDate},
<span class="w">            </span>&quot;摘要&quot;<span class="w"> </span>=<span class="w"> </span>#{description},
<span class="w">            </span>&quot;承認状態&quot;<span class="w"> </span>=<span class="w"> </span>#{approvalStatus},
<span class="w">            </span>&quot;version&quot;<span class="w"> </span>=<span class="w"> </span>#{version}<span class="w"> </span>+<span class="w"> </span>1,
<span class="w">            </span>&quot;更新日時&quot;<span class="w"> </span>=<span class="w"> </span>CURRENT_TIMESTAMP
<span class="w">        </span>WHERE<span class="w"> </span>&quot;仕訳伝票番号&quot;<span class="w"> </span>=<span class="w"> </span>#{journalNo}
<span class="w">          </span>AND<span class="w"> </span>&quot;version&quot;<span class="w"> </span>=<span class="w"> </span>#{version}
<span class="w">    </span><span class="nt">&lt;/update&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- 楽観ロック付き削除 --&gt;</span>
<span class="w">    </span><span class="nt">&lt;delete</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;deleteWithVersion&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span>DELETE<span class="w"> </span>FROM<span class="w"> </span>&quot;仕訳&quot;
<span class="w">        </span>WHERE<span class="w"> </span>&quot;仕訳伝票番号&quot;<span class="w"> </span>=<span class="w"> </span>#{journalNo}
<span class="w">          </span>AND<span class="w"> </span>&quot;version&quot;<span class="w"> </span>=<span class="w"> </span>#{version}
<span class="w">    </span><span class="nt">&lt;/delete&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</code></pre></div>
<hr />
<h2 id="287-repository">28.7 Repository 実装<a class="headerlink" href="#287-repository" title="Permanent link">&para;</a></h2>
<h3 id="accountrepositoryimpl">AccountRepositoryImpl<a class="headerlink" href="#accountrepositoryimpl" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// infrastructure/persistence/repository/AccountRepositoryImpl.java</span>
<span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.persistence.repository</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.application.port.out.AccountRepository</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.exception.AccountOptimisticLockException</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.account.Account</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.persistence.entity.AccountEntity</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.persistence.mapper.AccountMapper</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.RequiredArgsConstructor</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.stereotype.Repository</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Optional</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.stream.Collectors</span><span class="p">;</span>

<span class="nd">@Repository</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AccountRepositoryImpl</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">AccountRepository</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AccountMapper</span><span class="w"> </span><span class="n">accountMapper</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findAll</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">accountMapper</span><span class="p">.</span><span class="na">selectAll</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">AccountEntity</span><span class="p">::</span><span class="n">toDomain</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findByCode</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">accountCode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">AccountEntity</span><span class="w"> </span><span class="n">entity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accountMapper</span><span class="p">.</span><span class="na">selectByCode</span><span class="p">(</span><span class="n">accountCode</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">AccountEntity</span><span class="p">::</span><span class="n">toDomain</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findByBsplType</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">bsplType</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">accountMapper</span><span class="p">.</span><span class="na">selectByBsplType</span><span class="p">(</span><span class="n">bsplType</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">AccountEntity</span><span class="p">::</span><span class="n">toDomain</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Account</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">Account</span><span class="w"> </span><span class="n">account</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">AccountEntity</span><span class="w"> </span><span class="n">entity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AccountEntity</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="n">account</span><span class="p">);</span>

<span class="w">        </span><span class="n">AccountEntity</span><span class="w"> </span><span class="n">existing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accountMapper</span><span class="p">.</span><span class="na">selectByCode</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="na">getAccountCode</span><span class="p">());</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">existing</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 新規登録</span>
<span class="w">            </span><span class="n">accountMapper</span><span class="p">.</span><span class="na">insert</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">account</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 更新（楽観ロック付き）</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">updatedRows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accountMapper</span><span class="p">.</span><span class="na">updateWithVersion</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">updatedRows</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 楽観ロックエラー：他のユーザーが先に更新した</span>
<span class="w">                </span><span class="n">AccountEntity</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accountMapper</span><span class="p">.</span><span class="na">selectByCode</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="na">getAccountCode</span><span class="p">());</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// 既に削除されている</span>
<span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AccountOptimisticLockException</span><span class="p">(</span>
<span class="w">                            </span><span class="n">account</span><span class="p">.</span><span class="na">getAccountCode</span><span class="p">(),</span>
<span class="w">                            </span><span class="n">account</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()</span>
<span class="w">                    </span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// バージョン不一致</span>
<span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AccountOptimisticLockException</span><span class="p">(</span>
<span class="w">                            </span><span class="n">account</span><span class="p">.</span><span class="na">getAccountCode</span><span class="p">(),</span>
<span class="w">                            </span><span class="n">account</span><span class="p">.</span><span class="na">getVersion</span><span class="p">(),</span>
<span class="w">                            </span><span class="n">current</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()</span>
<span class="w">                    </span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// 更新後のバージョンを反映して返す</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">account</span><span class="p">.</span><span class="na">incrementVersion</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="n">Account</span><span class="w"> </span><span class="n">account</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">deletedRows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accountMapper</span><span class="p">.</span><span class="na">deleteWithVersion</span><span class="p">(</span>
<span class="w">                </span><span class="n">account</span><span class="p">.</span><span class="na">getAccountCode</span><span class="p">(),</span>
<span class="w">                </span><span class="n">account</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">deletedRows</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 楽観ロックエラー</span>
<span class="w">            </span><span class="n">AccountEntity</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accountMapper</span><span class="p">.</span><span class="na">selectByCode</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="na">getAccountCode</span><span class="p">());</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AccountOptimisticLockException</span><span class="p">(</span>
<span class="w">                        </span><span class="n">account</span><span class="p">.</span><span class="na">getAccountCode</span><span class="p">(),</span>
<span class="w">                        </span><span class="n">account</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()</span>
<span class="w">                </span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AccountOptimisticLockException</span><span class="p">(</span>
<span class="w">                        </span><span class="n">account</span><span class="p">.</span><span class="na">getAccountCode</span><span class="p">(),</span>
<span class="w">                        </span><span class="n">account</span><span class="p">.</span><span class="na">getVersion</span><span class="p">(),</span>
<span class="w">                        </span><span class="n">current</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()</span>
<span class="w">                </span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="journalentryrepositoryimpl">JournalEntryRepositoryImpl<a class="headerlink" href="#journalentryrepositoryimpl" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// infrastructure/persistence/repository/JournalEntryRepositoryImpl.java</span>
<span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.persistence.repository</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.application.port.out.JournalEntryRepository</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.exception.JournalOptimisticLockException</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.journal.JournalEntry</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.persistence.entity.JournalEntity</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.persistence.mapper.JournalMapper</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.RequiredArgsConstructor</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.stereotype.Repository</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Optional</span><span class="p">;</span>

<span class="nd">@Repository</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JournalEntryRepositoryImpl</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">JournalEntryRepository</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">JournalMapper</span><span class="w"> </span><span class="n">journalMapper</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">JournalEntry</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findByJournalNo</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">journalNo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">JournalEntity</span><span class="w"> </span><span class="n">entity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">journalMapper</span><span class="p">.</span><span class="na">selectByJournalNo</span><span class="p">(</span><span class="n">journalNo</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">ofNullable</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">JournalEntity</span><span class="p">::</span><span class="n">toDomain</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="nd">@Transactional</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">JournalEntry</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">JournalEntry</span><span class="w"> </span><span class="n">journal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">JournalEntity</span><span class="w"> </span><span class="n">entity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JournalEntity</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>

<span class="w">        </span><span class="n">JournalEntity</span><span class="w"> </span><span class="n">existing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">journalMapper</span><span class="p">.</span><span class="na">selectByJournalNo</span><span class="p">(</span><span class="n">journal</span><span class="p">.</span><span class="na">getJournalNo</span><span class="p">());</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">existing</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 新規登録</span>
<span class="w">            </span><span class="n">journalMapper</span><span class="p">.</span><span class="na">insert</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>
<span class="w">            </span><span class="n">insertDetails</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">journal</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 更新（楽観ロック付き）</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">updatedRows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">journalMapper</span><span class="p">.</span><span class="na">updateWithVersion</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">updatedRows</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">JournalEntity</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">journalMapper</span><span class="p">.</span><span class="na">selectByJournalNo</span><span class="p">(</span><span class="n">journal</span><span class="p">.</span><span class="na">getJournalNo</span><span class="p">());</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JournalOptimisticLockException</span><span class="p">(</span>
<span class="w">                            </span><span class="n">journal</span><span class="p">.</span><span class="na">getJournalNo</span><span class="p">(),</span>
<span class="w">                            </span><span class="n">journal</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()</span>
<span class="w">                    </span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JournalOptimisticLockException</span><span class="p">(</span>
<span class="w">                            </span><span class="n">journal</span><span class="p">.</span><span class="na">getJournalNo</span><span class="p">(),</span>
<span class="w">                            </span><span class="n">journal</span><span class="p">.</span><span class="na">getVersion</span><span class="p">(),</span>
<span class="w">                            </span><span class="n">current</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()</span>
<span class="w">                    </span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// 明細の更新（必要に応じて）</span>
<span class="w">            </span><span class="n">updateDetails</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">journal</span><span class="p">.</span><span class="na">incrementVersion</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">insertDetails</span><span class="p">(</span><span class="n">JournalEntry</span><span class="w"> </span><span class="n">journal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 明細の登録処理</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateDetails</span><span class="p">(</span><span class="n">JournalEntry</span><span class="w"> </span><span class="n">journal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 明細の更新処理</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="nd">@Transactional</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="n">JournalEntry</span><span class="w"> </span><span class="n">journal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 明細を先に削除</span>
<span class="w">        </span><span class="n">journalMapper</span><span class="p">.</span><span class="na">deleteDetailsByJournalNo</span><span class="p">(</span><span class="n">journal</span><span class="p">.</span><span class="na">getJournalNo</span><span class="p">());</span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">deletedRows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">journalMapper</span><span class="p">.</span><span class="na">deleteWithVersion</span><span class="p">(</span>
<span class="w">                </span><span class="n">journal</span><span class="p">.</span><span class="na">getJournalNo</span><span class="p">(),</span>
<span class="w">                </span><span class="n">journal</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">deletedRows</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JournalOptimisticLockException</span><span class="p">(</span>
<span class="w">                    </span><span class="n">journal</span><span class="p">.</span><span class="na">getJournalNo</span><span class="p">(),</span>
<span class="w">                    </span><span class="n">journal</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="288-application-service">28.8 Application Service での楽観ロック処理<a class="headerlink" href="#288-application-service" title="Permanent link">&para;</a></h2>
<h3 id="accountservice">AccountService<a class="headerlink" href="#accountservice" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// application/service/AccountService.java</span>
<span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.application.service</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.application.port.in.AccountUseCase</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.application.port.out.AccountRepository</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.exception.AccountNotFoundException</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.exception.AccountOptimisticLockException</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.account.Account</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.RequiredArgsConstructor</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.extern.slf4j.Slf4j</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span>

<span class="nd">@Service</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@Slf4j</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AccountService</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">AccountUseCase</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AccountRepository</span><span class="w"> </span><span class="n">accountRepository</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getAllAccounts</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">findAll</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Account</span><span class="w"> </span><span class="nf">getAccount</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">accountCode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">findByCode</span><span class="p">(</span><span class="n">accountCode</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AccountNotFoundException</span><span class="p">(</span><span class="n">accountCode</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Account</span><span class="w"> </span><span class="nf">createAccount</span><span class="p">(</span><span class="n">Account</span><span class="w"> </span><span class="n">account</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;勘定科目を登録します: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">account</span><span class="p">.</span><span class="na">getAccountCode</span><span class="p">());</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">account</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Account</span><span class="w"> </span><span class="nf">updateAccount</span><span class="p">(</span><span class="n">Account</span><span class="w"> </span><span class="n">account</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;勘定科目を更新します: {}, version: {}&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">account</span><span class="p">.</span><span class="na">getAccountCode</span><span class="p">(),</span><span class="w"> </span><span class="n">account</span><span class="p">.</span><span class="na">getVersion</span><span class="p">());</span>

<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Account</span><span class="w"> </span><span class="n">updated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">account</span><span class="p">);</span>
<span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;勘定科目を更新しました: {}, newVersion: {}&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">updated</span><span class="p">.</span><span class="na">getAccountCode</span><span class="p">(),</span><span class="w"> </span><span class="n">updated</span><span class="p">.</span><span class="na">getVersion</span><span class="p">());</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">updated</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">AccountOptimisticLockException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;楽観ロックエラー: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">deleteAccount</span><span class="p">(</span><span class="n">Account</span><span class="w"> </span><span class="n">account</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;勘定科目を削除します: {}, version: {}&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">account</span><span class="p">.</span><span class="na">getAccountCode</span><span class="p">(),</span><span class="w"> </span><span class="n">account</span><span class="p">.</span><span class="na">getVersion</span><span class="p">());</span>

<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">account</span><span class="p">);</span>
<span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;勘定科目を削除しました: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">account</span><span class="p">.</span><span class="na">getAccountCode</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">AccountOptimisticLockException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;楽観ロックエラー: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="journalentryservice">JournalEntryService<a class="headerlink" href="#journalentryservice" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// application/service/JournalEntryService.java</span>
<span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.application.service</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.application.port.in.JournalEntryUseCase</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.application.port.out.JournalEntryRepository</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.exception.JournalNotFoundException</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.exception.JournalOptimisticLockException</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.journal.JournalEntry</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.RequiredArgsConstructor</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.extern.slf4j.Slf4j</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="p">;</span>

<span class="nd">@Service</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@Slf4j</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JournalEntryService</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">JournalEntryUseCase</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">JournalEntryRepository</span><span class="w"> </span><span class="n">journalEntryRepository</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="nd">@Transactional</span><span class="p">(</span><span class="n">readOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">JournalEntry</span><span class="w"> </span><span class="nf">getJournalEntry</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">journalNo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">journalEntryRepository</span><span class="p">.</span><span class="na">findByJournalNo</span><span class="p">(</span><span class="n">journalNo</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JournalNotFoundException</span><span class="p">(</span><span class="n">journalNo</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">JournalEntry</span><span class="w"> </span><span class="nf">createJournalEntry</span><span class="p">(</span><span class="n">JournalEntry</span><span class="w"> </span><span class="n">journal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;仕訳を登録します: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">journal</span><span class="p">.</span><span class="na">getJournalNo</span><span class="p">());</span>

<span class="w">        </span><span class="c1">// 複式簿記の検証</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">journal</span><span class="p">.</span><span class="na">isBalanced</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span>
<span class="w">                    </span><span class="s">&quot;貸借が一致していません。借方: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">journal</span><span class="p">.</span><span class="na">getTotalDebit</span><span class="p">()</span><span class="w"> </span><span class="o">+</span>
<span class="w">                    </span><span class="s">&quot;, 貸方: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">journal</span><span class="p">.</span><span class="na">getTotalCredit</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">journalEntryRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">JournalEntry</span><span class="w"> </span><span class="nf">updateJournalEntry</span><span class="p">(</span><span class="n">JournalEntry</span><span class="w"> </span><span class="n">journal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;仕訳を更新します: {}, version: {}&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">journal</span><span class="p">.</span><span class="na">getJournalNo</span><span class="p">(),</span><span class="w"> </span><span class="n">journal</span><span class="p">.</span><span class="na">getVersion</span><span class="p">());</span>

<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">JournalEntry</span><span class="w"> </span><span class="n">updated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">journalEntryRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>
<span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;仕訳を更新しました: {}, newVersion: {}&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">updated</span><span class="p">.</span><span class="na">getJournalNo</span><span class="p">(),</span><span class="w"> </span><span class="n">updated</span><span class="p">.</span><span class="na">getVersion</span><span class="p">());</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">updated</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">JournalOptimisticLockException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;楽観ロックエラー: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">JournalEntry</span><span class="w"> </span><span class="nf">approveJournalEntry</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">journalNo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;仕訳を承認します: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">journalNo</span><span class="p">);</span>

<span class="w">        </span><span class="n">JournalEntry</span><span class="w"> </span><span class="n">journal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getJournalEntry</span><span class="p">(</span><span class="n">journalNo</span><span class="p">);</span>
<span class="w">        </span><span class="n">JournalEntry</span><span class="w"> </span><span class="n">approved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">journal</span><span class="p">.</span><span class="na">approve</span><span class="p">();</span><span class="w">  </span><span class="c1">// version もインクリメント</span>

<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">JournalEntry</span><span class="w"> </span><span class="n">saved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">journalEntryRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">approved</span><span class="p">);</span>
<span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;仕訳を承認しました: {}, newVersion: {}&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">saved</span><span class="p">.</span><span class="na">getJournalNo</span><span class="p">(),</span><span class="w"> </span><span class="n">saved</span><span class="p">.</span><span class="na">getVersion</span><span class="p">());</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">saved</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">JournalOptimisticLockException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;承認時に楽観ロックエラー: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="289-rest-api">28.9 REST API でのエラーハンドリング<a class="headerlink" href="#289-rest-api" title="Permanent link">&para;</a></h2>
<h3 id="_7">例外ハンドラ<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// infrastructure/web/exception/GlobalExceptionHandler.java</span>
<span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.web.exception</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.exception.OptimisticLockException</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.extern.slf4j.Slf4j</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.http.HttpStatus</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.http.ResponseEntity</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.ExceptionHandler</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.RestControllerAdvice</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDateTime</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span>

<span class="nd">@RestControllerAdvice</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">GlobalExceptionHandler</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 楽観ロックエラーのハンドリング</span>
<span class="cm">     * HTTP 409 Conflict を返す</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="nd">@ExceptionHandler</span><span class="p">(</span><span class="n">OptimisticLockException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">handleOptimisticLockException</span><span class="p">(</span>
<span class="w">            </span><span class="n">OptimisticLockException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">warn</span><span class="p">(</span><span class="s">&quot;楽観ロックエラー: entityType={}, entityId={}, expectedVersion={}, actualVersion={}&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">e</span><span class="p">.</span><span class="na">getEntityType</span><span class="p">(),</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getEntityId</span><span class="p">(),</span>
<span class="w">                </span><span class="n">e</span><span class="p">.</span><span class="na">getExpectedVersion</span><span class="p">(),</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getActualVersion</span><span class="p">());</span>

<span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span>
<span class="w">                </span><span class="s">&quot;timestamp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">().</span><span class="na">toString</span><span class="p">(),</span>
<span class="w">                </span><span class="s">&quot;status&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">CONFLICT</span><span class="p">.</span><span class="na">value</span><span class="p">(),</span>
<span class="w">                </span><span class="s">&quot;error&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Conflict&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s">&quot;code&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getCode</span><span class="p">(),</span>
<span class="w">                </span><span class="s">&quot;message&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">(),</span>
<span class="w">                </span><span class="s">&quot;entityType&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getEntityType</span><span class="p">(),</span>
<span class="w">                </span><span class="s">&quot;entityId&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getEntityId</span><span class="p">(),</span>
<span class="w">                </span><span class="s">&quot;expectedVersion&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getExpectedVersion</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getExpectedVersion</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&quot;N/A&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s">&quot;actualVersion&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getActualVersion</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getActualVersion</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&quot;N/A&quot;</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">CONFLICT</span><span class="p">).</span><span class="na">body</span><span class="p">(</span><span class="n">body</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="controller-version">Controller での version の扱い<a class="headerlink" href="#controller-version" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// infrastructure/web/controller/AccountController.java</span>
<span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.web.controller</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.application.port.in.AccountUseCase</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.account.Account</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.web.dto.AccountRequest</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.web.dto.AccountResponse</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.RequiredArgsConstructor</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.http.ResponseEntity</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.*</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">javax.validation.Valid</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.stream.Collectors</span><span class="p">;</span>

<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;/api/accounts&quot;</span><span class="p">)</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AccountController</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AccountUseCase</span><span class="w"> </span><span class="n">accountUseCase</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@GetMapping</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">AccountResponse</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getAllAccounts</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">accountUseCase</span><span class="p">.</span><span class="na">getAllAccounts</span><span class="p">().</span><span class="na">stream</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">AccountResponse</span><span class="p">::</span><span class="n">from</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/{accountCode}&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">AccountResponse</span><span class="w"> </span><span class="nf">getAccount</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">accountCode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Account</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accountUseCase</span><span class="p">.</span><span class="na">getAccount</span><span class="p">(</span><span class="n">accountCode</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">AccountResponse</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="n">account</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@PostMapping</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">AccountResponse</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">createAccount</span><span class="p">(</span>
<span class="w">            </span><span class="nd">@Valid</span><span class="w"> </span><span class="nd">@RequestBody</span><span class="w"> </span><span class="n">AccountRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Account</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">toDomain</span><span class="p">();</span>
<span class="w">        </span><span class="n">Account</span><span class="w"> </span><span class="n">created</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accountUseCase</span><span class="p">.</span><span class="na">createAccount</span><span class="p">(</span><span class="n">account</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="n">AccountResponse</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="n">created</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@PutMapping</span><span class="p">(</span><span class="s">&quot;/{accountCode}&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">AccountResponse</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">updateAccount</span><span class="p">(</span>
<span class="w">            </span><span class="nd">@PathVariable</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">accountCode</span><span class="p">,</span>
<span class="w">            </span><span class="nd">@Valid</span><span class="w"> </span><span class="nd">@RequestBody</span><span class="w"> </span><span class="n">AccountRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="c1">// リクエストに version が含まれていることを確認</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">&quot;version は必須です&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">Account</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">toDomain</span><span class="p">(</span><span class="n">accountCode</span><span class="p">);</span>
<span class="w">        </span><span class="n">Account</span><span class="w"> </span><span class="n">updated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accountUseCase</span><span class="p">.</span><span class="na">updateAccount</span><span class="p">(</span><span class="n">account</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="n">AccountResponse</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="n">updated</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@DeleteMapping</span><span class="p">(</span><span class="s">&quot;/{accountCode}&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">deleteAccount</span><span class="p">(</span>
<span class="w">            </span><span class="nd">@PathVariable</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">accountCode</span><span class="p">,</span>
<span class="w">            </span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">version</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="n">Account</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accountUseCase</span><span class="p">.</span><span class="na">getAccount</span><span class="p">(</span><span class="n">accountCode</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// version の検証</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">account</span><span class="p">.</span><span class="na">getVersion</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">version</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span>
<span class="w">                    </span><span class="s">&quot;version が一致しません。期待: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">account</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()</span><span class="w"> </span><span class="o">+</span>
<span class="w">                    </span><span class="s">&quot;, 指定: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">version</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">accountUseCase</span><span class="p">.</span><span class="na">deleteAccount</span><span class="p">(</span><span class="n">account</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="p">.</span><span class="na">noContent</span><span class="p">().</span><span class="na">build</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="dto-version">DTO への version 追加<a class="headerlink" href="#dto-version" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// infrastructure/web/dto/AccountRequest.java</span>
<span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.web.dto</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.account.Account</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.Data</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">javax.validation.constraints.NotBlank</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.validation.constraints.Pattern</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.validation.constraints.Size</span><span class="p">;</span>

<span class="nd">@Data</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AccountRequest</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@NotBlank</span><span class="p">(</span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;勘定科目コードは必須です&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@Size</span><span class="p">(</span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">accountCode</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@NotBlank</span><span class="p">(</span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;勘定科目名は必須です&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@Size</span><span class="p">(</span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">accountName</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@NotBlank</span>
<span class="w">    </span><span class="nd">@Pattern</span><span class="p">(</span><span class="n">regexp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;B|P&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;B/S または P/L を指定してください&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">bsplType</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@NotBlank</span>
<span class="w">    </span><span class="nd">@Pattern</span><span class="p">(</span><span class="n">regexp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;借|貸&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;借方 または 貸方 を指定してください&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">debitCreditType</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@NotBlank</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">elementType</span><span class="p">;</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">version</span><span class="p">;</span><span class="w">  </span><span class="c1">// 更新時に必須</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Account</span><span class="w"> </span><span class="nf">toDomain</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Account</span><span class="p">(</span>
<span class="w">                </span><span class="n">accountCode</span><span class="p">,</span>
<span class="w">                </span><span class="n">accountName</span><span class="p">,</span>
<span class="w">                </span><span class="kc">null</span><span class="p">,</span>
<span class="w">                </span><span class="kc">null</span><span class="p">,</span>
<span class="w">                </span><span class="n">bsplType</span><span class="p">,</span>
<span class="w">                </span><span class="n">debitCreditType</span><span class="p">,</span>
<span class="w">                </span><span class="n">elementType</span><span class="p">,</span>
<span class="w">                </span><span class="kc">null</span><span class="p">,</span>
<span class="w">                </span><span class="n">version</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">1L</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Account</span><span class="w"> </span><span class="nf">toDomain</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">accountCode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Account</span><span class="p">(</span>
<span class="w">                </span><span class="n">accountCode</span><span class="p">,</span>
<span class="w">                </span><span class="n">accountName</span><span class="p">,</span>
<span class="w">                </span><span class="kc">null</span><span class="p">,</span>
<span class="w">                </span><span class="kc">null</span><span class="p">,</span>
<span class="w">                </span><span class="n">bsplType</span><span class="p">,</span>
<span class="w">                </span><span class="n">debitCreditType</span><span class="p">,</span>
<span class="w">                </span><span class="n">elementType</span><span class="p">,</span>
<span class="w">                </span><span class="kc">null</span><span class="p">,</span>
<span class="w">                </span><span class="n">version</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// infrastructure/web/dto/AccountResponse.java</span>
<span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.web.dto</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.account.Account</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.Builder</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lombok.Value</span><span class="p">;</span>

<span class="nd">@Value</span>
<span class="nd">@Builder</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AccountResponse</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">accountCode</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">accountName</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">accountAbbr</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">accountKana</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">bsplType</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">debitCreditType</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">elementType</span><span class="p">;</span>
<span class="w">    </span><span class="n">Integer</span><span class="w"> </span><span class="n">displayOrder</span><span class="p">;</span>
<span class="w">    </span><span class="n">Long</span><span class="w"> </span><span class="n">version</span><span class="p">;</span><span class="w">  </span><span class="c1">// クライアントに返す</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">AccountResponse</span><span class="w"> </span><span class="nf">from</span><span class="p">(</span><span class="n">Account</span><span class="w"> </span><span class="n">account</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">AccountResponse</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">accountCode</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="na">getAccountCode</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">accountName</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="na">getAccountName</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">accountAbbr</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="na">getAccountAbbr</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">accountKana</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="na">getAccountKana</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">bsplType</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="na">getBsplType</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">debitCreditType</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="na">getDebitCreditType</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">elementType</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="na">getElementType</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">displayOrder</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="na">getDisplayOrder</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">version</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="na">getVersion</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="2810-tdd">28.10 TDD による実装例<a class="headerlink" href="#2810-tdd" title="Permanent link">&para;</a></h2>
<h3 id="_8">楽観ロックのテスト<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// AccountOptimisticLockTest.java</span>
<span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.persistence.repository</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.exception.AccountOptimisticLockException</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.account.Account</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.persistence.mapper.AccountMapper</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.BeforeEach</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.DisplayName</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.Nested</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.Test</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.test.context.SpringBootTest</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.test.context.ActiveProfiles</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="p">;</span>

<span class="kn">import static</span><span class="w"> </span><span class="nn">org.assertj.core.api.Assertions.*</span><span class="p">;</span>

<span class="nd">@SpringBootTest</span>
<span class="nd">@ActiveProfiles</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">)</span>
<span class="nd">@Transactional</span>
<span class="kd">class</span> <span class="nc">AccountOptimisticLockTest</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">AccountRepositoryImpl</span><span class="w"> </span><span class="n">accountRepository</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">AccountMapper</span><span class="w"> </span><span class="n">accountMapper</span><span class="p">;</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Account</span><span class="w"> </span><span class="n">testAccount</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@BeforeEach</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">setUp</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// テストデータの準備</span>
<span class="w">        </span><span class="n">testAccount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Account</span><span class="p">.</span><span class="na">create</span><span class="p">(</span>
<span class="w">                </span><span class="s">&quot;1001&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s">&quot;現金&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s">&quot;B&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s">&quot;借&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s">&quot;資産&quot;</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">        </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">testAccount</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Nested</span>
<span class="w">    </span><span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;更新時の楽観ロック&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">class</span> <span class="nc">UpdateWithOptimisticLock</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="nd">@Test</span>
<span class="w">        </span><span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;正しいバージョンで更新できること&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldUpdateWithCorrectVersion</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Given</span>
<span class="w">            </span><span class="n">Account</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">findByCode</span><span class="p">(</span><span class="s">&quot;1001&quot;</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">();</span>
<span class="w">            </span><span class="n">assertThat</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="mi">1L</span><span class="p">);</span>

<span class="w">            </span><span class="n">Account</span><span class="w"> </span><span class="n">updated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">account</span><span class="p">.</span><span class="na">withAccountName</span><span class="p">(</span><span class="s">&quot;現金・預金&quot;</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// When</span>
<span class="w">            </span><span class="n">Account</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">updated</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// Then</span>
<span class="w">            </span><span class="n">assertThat</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="mi">2L</span><span class="p">);</span>
<span class="w">            </span><span class="n">assertThat</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">getAccountName</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="s">&quot;現金・預金&quot;</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// データベースの値も確認</span>
<span class="w">            </span><span class="n">Account</span><span class="w"> </span><span class="n">fromDb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">findByCode</span><span class="p">(</span><span class="s">&quot;1001&quot;</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">();</span>
<span class="w">            </span><span class="n">assertThat</span><span class="p">(</span><span class="n">fromDb</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="mi">2L</span><span class="p">);</span>
<span class="w">            </span><span class="n">assertThat</span><span class="p">(</span><span class="n">fromDb</span><span class="p">.</span><span class="na">getAccountName</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="s">&quot;現金・預金&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nd">@Test</span>
<span class="w">        </span><span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;古いバージョンで更新すると楽観ロックエラーが発生すること&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldThrowOptimisticLockExceptionWithOldVersion</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Given: 2つのセッションで同じデータを取得</span>
<span class="w">            </span><span class="n">Account</span><span class="w"> </span><span class="n">session1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">findByCode</span><span class="p">(</span><span class="s">&quot;1001&quot;</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">();</span>
<span class="w">            </span><span class="n">Account</span><span class="w"> </span><span class="n">session2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">findByCode</span><span class="p">(</span><span class="s">&quot;1001&quot;</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// When: セッション1で更新</span>
<span class="w">            </span><span class="n">Account</span><span class="w"> </span><span class="n">updated1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session1</span><span class="p">.</span><span class="na">withAccountName</span><span class="p">(</span><span class="s">&quot;現金・預金&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">updated1</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// Then: セッション2で古いバージョンで更新しようとするとエラー</span>
<span class="w">            </span><span class="n">Account</span><span class="w"> </span><span class="n">updated2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session2</span><span class="p">.</span><span class="na">withAccountName</span><span class="p">(</span><span class="s">&quot;小口現金&quot;</span><span class="p">);</span>

<span class="w">            </span><span class="n">assertThatThrownBy</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">updated2</span><span class="p">))</span>
<span class="w">                    </span><span class="p">.</span><span class="na">isInstanceOf</span><span class="p">(</span><span class="n">AccountOptimisticLockException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<span class="w">                    </span><span class="p">.</span><span class="na">hasMessageContaining</span><span class="p">(</span><span class="s">&quot;他のユーザーによって更新されました&quot;</span><span class="p">)</span>
<span class="w">                    </span><span class="p">.</span><span class="na">satisfies</span><span class="p">(</span><span class="n">e</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">AccountOptimisticLockException</span><span class="w"> </span><span class="n">ex</span><span class="w"> </span><span class="o">=</span>
<span class="w">                                </span><span class="p">(</span><span class="n">AccountOptimisticLockException</span><span class="p">)</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
<span class="w">                        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="na">getExpectedVersion</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="mi">1L</span><span class="p">);</span>
<span class="w">                        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="na">getActualVersion</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="mi">2L</span><span class="p">);</span>
<span class="w">                    </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nd">@Test</span>
<span class="w">        </span><span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;連続した更新で version が正しくインクリメントされること&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldIncrementVersionOnConsecutiveUpdates</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Given</span>
<span class="w">            </span><span class="n">Account</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">findByCode</span><span class="p">(</span><span class="s">&quot;1001&quot;</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">();</span>
<span class="w">            </span><span class="n">assertThat</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="mi">1L</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// When: 3回連続で更新</span>
<span class="w">            </span><span class="n">Account</span><span class="w"> </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="na">withAccountName</span><span class="p">(</span><span class="s">&quot;名前v2&quot;</span><span class="p">));</span>
<span class="w">            </span><span class="n">assertThat</span><span class="p">(</span><span class="n">v2</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="mi">2L</span><span class="p">);</span>

<span class="w">            </span><span class="n">Account</span><span class="w"> </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">v2</span><span class="p">.</span><span class="na">withAccountName</span><span class="p">(</span><span class="s">&quot;名前v3&quot;</span><span class="p">));</span>
<span class="w">            </span><span class="n">assertThat</span><span class="p">(</span><span class="n">v3</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="mi">3L</span><span class="p">);</span>

<span class="w">            </span><span class="n">Account</span><span class="w"> </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">v3</span><span class="p">.</span><span class="na">withAccountName</span><span class="p">(</span><span class="s">&quot;名前v4&quot;</span><span class="p">));</span>
<span class="w">            </span><span class="n">assertThat</span><span class="p">(</span><span class="n">v4</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="mi">4L</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// Then</span>
<span class="w">            </span><span class="n">Account</span><span class="w"> </span><span class="n">fromDb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">findByCode</span><span class="p">(</span><span class="s">&quot;1001&quot;</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">();</span>
<span class="w">            </span><span class="n">assertThat</span><span class="p">(</span><span class="n">fromDb</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="mi">4L</span><span class="p">);</span>
<span class="w">            </span><span class="n">assertThat</span><span class="p">(</span><span class="n">fromDb</span><span class="p">.</span><span class="na">getAccountName</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="s">&quot;名前v4&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Nested</span>
<span class="w">    </span><span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;削除時の楽観ロック&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">class</span> <span class="nc">DeleteWithOptimisticLock</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="nd">@Test</span>
<span class="w">        </span><span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;正しいバージョンで削除できること&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldDeleteWithCorrectVersion</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Given</span>
<span class="w">            </span><span class="n">Account</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">findByCode</span><span class="p">(</span><span class="s">&quot;1001&quot;</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// When</span>
<span class="w">            </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">account</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// Then</span>
<span class="w">            </span><span class="n">assertThat</span><span class="p">(</span><span class="n">accountRepository</span><span class="p">.</span><span class="na">findByCode</span><span class="p">(</span><span class="s">&quot;1001&quot;</span><span class="p">)).</span><span class="na">isEmpty</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nd">@Test</span>
<span class="w">        </span><span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;古いバージョンで削除すると楽観ロックエラーが発生すること&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldThrowOptimisticLockExceptionOnDeleteWithOldVersion</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Given</span>
<span class="w">            </span><span class="n">Account</span><span class="w"> </span><span class="n">session1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">findByCode</span><span class="p">(</span><span class="s">&quot;1001&quot;</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">();</span>
<span class="w">            </span><span class="n">Account</span><span class="w"> </span><span class="n">session2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">findByCode</span><span class="p">(</span><span class="s">&quot;1001&quot;</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// When: セッション1で更新</span>
<span class="w">            </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">session1</span><span class="p">.</span><span class="na">withAccountName</span><span class="p">(</span><span class="s">&quot;更新済み&quot;</span><span class="p">));</span>

<span class="w">            </span><span class="c1">// Then: セッション2で古いバージョンで削除しようとするとエラー</span>
<span class="w">            </span><span class="n">assertThatThrownBy</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">session2</span><span class="p">))</span>
<span class="w">                    </span><span class="p">.</span><span class="na">isInstanceOf</span><span class="p">(</span><span class="n">AccountOptimisticLockException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<span class="w">                    </span><span class="p">.</span><span class="na">hasMessageContaining</span><span class="p">(</span><span class="s">&quot;他のユーザーによって更新されました&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nd">@Test</span>
<span class="w">        </span><span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;既に削除済みのデータを削除しようとするとエラー&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldThrowExceptionWhenAlreadyDeleted</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Given</span>
<span class="w">            </span><span class="n">Account</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">findByCode</span><span class="p">(</span><span class="s">&quot;1001&quot;</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">();</span>
<span class="w">            </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">account</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// Then</span>
<span class="w">            </span><span class="n">assertThatThrownBy</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">accountRepository</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">account</span><span class="p">))</span>
<span class="w">                    </span><span class="p">.</span><span class="na">isInstanceOf</span><span class="p">(</span><span class="n">AccountOptimisticLockException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<span class="w">                    </span><span class="p">.</span><span class="na">hasMessageContaining</span><span class="p">(</span><span class="s">&quot;更新または削除されました&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_9">仕訳承認ワークフローのテスト<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// JournalApprovalOptimisticLockTest.java</span>
<span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.application.service</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.exception.JournalOptimisticLockException</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.domain.model.journal.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.BeforeEach</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.DisplayName</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.Test</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.test.context.SpringBootTest</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.test.context.ActiveProfiles</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.math.BigDecimal</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDate</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span>

<span class="kn">import static</span><span class="w"> </span><span class="nn">org.assertj.core.api.Assertions.*</span><span class="p">;</span>

<span class="nd">@SpringBootTest</span>
<span class="nd">@ActiveProfiles</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">)</span>
<span class="nd">@Transactional</span>
<span class="kd">class</span> <span class="nc">JournalApprovalOptimisticLockTest</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">JournalEntryService</span><span class="w"> </span><span class="n">journalEntryService</span><span class="p">;</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">journalNo</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@BeforeEach</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">setUp</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// テスト用の仕訳を作成</span>
<span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">JournalDetail</span><span class="o">&gt;</span><span class="w"> </span><span class="n">details</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span>
<span class="w">                </span><span class="n">JournalDetail</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">                        </span><span class="p">.</span><span class="na">lineNo</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="na">accountCode</span><span class="p">(</span><span class="s">&quot;1001&quot;</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="na">items</span><span class="p">(</span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span>
<span class="w">                                </span><span class="k">new</span><span class="w"> </span><span class="n">JournalItem</span><span class="p">(</span><span class="s">&quot;D&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">(</span><span class="s">&quot;10000&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">.</span><span class="na">ZERO</span><span class="p">)</span>
<span class="w">                        </span><span class="p">))</span>
<span class="w">                        </span><span class="p">.</span><span class="na">build</span><span class="p">(),</span>
<span class="w">                </span><span class="n">JournalDetail</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">                        </span><span class="p">.</span><span class="na">lineNo</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="na">accountCode</span><span class="p">(</span><span class="s">&quot;4001&quot;</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="na">items</span><span class="p">(</span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span>
<span class="w">                                </span><span class="k">new</span><span class="w"> </span><span class="n">JournalItem</span><span class="p">(</span><span class="s">&quot;C&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">(</span><span class="s">&quot;10000&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">.</span><span class="na">ZERO</span><span class="p">)</span>
<span class="w">                        </span><span class="p">))</span>
<span class="w">                        </span><span class="p">.</span><span class="na">build</span><span class="p">()</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="n">JournalEntry</span><span class="w"> </span><span class="n">journal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JournalEntry</span><span class="p">.</span><span class="na">create</span><span class="p">(</span>
<span class="w">                </span><span class="s">&quot;J-2024-0001&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">LocalDate</span><span class="p">.</span><span class="na">now</span><span class="p">(),</span>
<span class="w">                </span><span class="s">&quot;テスト仕訳&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">details</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="n">JournalEntry</span><span class="w"> </span><span class="n">created</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">journalEntryService</span><span class="p">.</span><span class="na">createJournalEntry</span><span class="p">(</span><span class="n">journal</span><span class="p">);</span>
<span class="w">        </span><span class="n">journalNo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">created</span><span class="p">.</span><span class="na">getJournalNo</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;同時に承認しようとした場合、1人だけが成功する&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldAllowOnlyOneApprovalOnConcurrentAccess</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Given: 2人のユーザーが同じ仕訳を取得</span>
<span class="w">        </span><span class="n">JournalEntry</span><span class="w"> </span><span class="n">user1View</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">journalEntryService</span><span class="p">.</span><span class="na">getJournalEntry</span><span class="p">(</span><span class="n">journalNo</span><span class="p">);</span>
<span class="w">        </span><span class="n">JournalEntry</span><span class="w"> </span><span class="n">user2View</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">journalEntryService</span><span class="p">.</span><span class="na">getJournalEntry</span><span class="p">(</span><span class="n">journalNo</span><span class="p">);</span>

<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">user1View</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="mi">1L</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">user2View</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="mi">1L</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">user1View</span><span class="p">.</span><span class="na">getApprovalStatus</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">ApprovalStatus</span><span class="p">.</span><span class="na">DRAFT</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// When: ユーザー1が承認</span>
<span class="w">        </span><span class="n">JournalEntry</span><span class="w"> </span><span class="n">approved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">journalEntryService</span><span class="p">.</span><span class="na">approveJournalEntry</span><span class="p">(</span><span class="n">journalNo</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">approved</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="mi">2L</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">approved</span><span class="p">.</span><span class="na">getApprovalStatus</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">ApprovalStatus</span><span class="p">.</span><span class="na">APPROVED</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Then: ユーザー2が古いバージョンで更新しようとするとエラー</span>
<span class="w">        </span><span class="c1">// （承認済みの仕訳を再度承認しようとしても、ドメインルールでエラーになるが、</span>
<span class="w">        </span><span class="c1">//   別の更新を試みた場合は楽観ロックエラー）</span>
<span class="w">        </span><span class="n">JournalEntry</span><span class="w"> </span><span class="n">modified</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user2View</span><span class="p">.</span><span class="na">withDescription</span><span class="p">(</span><span class="s">&quot;変更された摘要&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="n">assertThatThrownBy</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="n">journalEntryService</span><span class="p">.</span><span class="na">updateJournalEntry</span><span class="p">(</span><span class="n">modified</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">isInstanceOf</span><span class="p">(</span><span class="n">JournalOptimisticLockException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">hasMessageContaining</span><span class="p">(</span><span class="s">&quot;他のユーザーによって更新されました&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;承認後にバージョンがインクリメントされること&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldIncrementVersionAfterApproval</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Given</span>
<span class="w">        </span><span class="n">JournalEntry</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">journalEntryService</span><span class="p">.</span><span class="na">getJournalEntry</span><span class="p">(</span><span class="n">journalNo</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">before</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="mi">1L</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// When</span>
<span class="w">        </span><span class="n">JournalEntry</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">journalEntryService</span><span class="p">.</span><span class="na">approveJournalEntry</span><span class="p">(</span><span class="n">journalNo</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Then</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">after</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="mi">2L</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// データベースからも確認</span>
<span class="w">        </span><span class="n">JournalEntry</span><span class="w"> </span><span class="n">fromDb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">journalEntryService</span><span class="p">.</span><span class="na">getJournalEntry</span><span class="p">(</span><span class="n">journalNo</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">fromDb</span><span class="p">.</span><span class="na">getVersion</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="mi">2L</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="e2e">E2E テスト<a class="headerlink" href="#e2e" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// AccountControllerOptimisticLockE2ETest.java</span>
<span class="kn">package</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.web.controller</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.web.dto.AccountRequest</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.example.accounting.infrastructure.web.dto.AccountResponse</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.BeforeEach</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.DisplayName</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.Test</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.test.context.SpringBootTest</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.test.web.client.TestRestTemplate</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.http.HttpEntity</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.http.HttpMethod</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.http.HttpStatus</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.http.ResponseEntity</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.test.context.ActiveProfiles</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span>

<span class="kn">import static</span><span class="w"> </span><span class="nn">org.assertj.core.api.Assertions.*</span><span class="p">;</span>

<span class="nd">@SpringBootTest</span><span class="p">(</span><span class="n">webEnvironment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SpringBootTest</span><span class="p">.</span><span class="na">WebEnvironment</span><span class="p">.</span><span class="na">RANDOM_PORT</span><span class="p">)</span>
<span class="nd">@ActiveProfiles</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">)</span>
<span class="kd">class</span> <span class="nc">AccountControllerOptimisticLockE2ETest</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">TestRestTemplate</span><span class="w"> </span><span class="n">restTemplate</span><span class="p">;</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">AccountResponse</span><span class="w"> </span><span class="n">createdAccount</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@BeforeEach</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">setUp</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// テスト用の勘定科目を作成</span>
<span class="w">        </span><span class="n">AccountRequest</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AccountRequest</span><span class="p">();</span>
<span class="w">        </span><span class="n">request</span><span class="p">.</span><span class="na">setAccountCode</span><span class="p">(</span><span class="s">&quot;9999&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">request</span><span class="p">.</span><span class="na">setAccountName</span><span class="p">(</span><span class="s">&quot;テスト科目&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">request</span><span class="p">.</span><span class="na">setBsplType</span><span class="p">(</span><span class="s">&quot;B&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">request</span><span class="p">.</span><span class="na">setDebitCreditType</span><span class="p">(</span><span class="s">&quot;借&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">request</span><span class="p">.</span><span class="na">setElementType</span><span class="p">(</span><span class="s">&quot;資産&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">AccountResponse</span><span class="o">&gt;</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">postForEntity</span><span class="p">(</span>
<span class="w">                </span><span class="s">&quot;/api/accounts&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">request</span><span class="p">,</span>
<span class="w">                </span><span class="n">AccountResponse</span><span class="p">.</span><span class="na">class</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="n">createdAccount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">getBody</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;正しいバージョンで更新リクエストが成功すること&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldUpdateWithCorrectVersion</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Given</span>
<span class="w">        </span><span class="n">AccountRequest</span><span class="w"> </span><span class="n">updateRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AccountRequest</span><span class="p">();</span>
<span class="w">        </span><span class="n">updateRequest</span><span class="p">.</span><span class="na">setAccountName</span><span class="p">(</span><span class="s">&quot;更新後の科目名&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">updateRequest</span><span class="p">.</span><span class="na">setBsplType</span><span class="p">(</span><span class="s">&quot;B&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">updateRequest</span><span class="p">.</span><span class="na">setDebitCreditType</span><span class="p">(</span><span class="s">&quot;借&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">updateRequest</span><span class="p">.</span><span class="na">setElementType</span><span class="p">(</span><span class="s">&quot;資産&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">updateRequest</span><span class="p">.</span><span class="na">setVersion</span><span class="p">(</span><span class="n">createdAccount</span><span class="p">.</span><span class="na">getVersion</span><span class="p">());</span>

<span class="w">        </span><span class="c1">// When</span>
<span class="w">        </span><span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">AccountResponse</span><span class="o">&gt;</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">exchange</span><span class="p">(</span>
<span class="w">                </span><span class="s">&quot;/api/accounts/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">createdAccount</span><span class="p">.</span><span class="na">getAccountCode</span><span class="p">(),</span>
<span class="w">                </span><span class="n">HttpMethod</span><span class="p">.</span><span class="na">PUT</span><span class="p">,</span>
<span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">HttpEntity</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">updateRequest</span><span class="p">),</span>
<span class="w">                </span><span class="n">AccountResponse</span><span class="p">.</span><span class="na">class</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Then</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">getStatusCode</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">getBody</span><span class="p">().</span><span class="na">getVersion</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="mi">2L</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">getBody</span><span class="p">().</span><span class="na">getAccountName</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="s">&quot;更新後の科目名&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;古いバージョンで更新リクエストすると409 Conflictが返ること&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@SuppressWarnings</span><span class="p">(</span><span class="s">&quot;unchecked&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldReturn409ConflictWithOldVersion</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Given: まず1回更新してバージョンを2に</span>
<span class="w">        </span><span class="n">AccountRequest</span><span class="w"> </span><span class="n">firstUpdate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AccountRequest</span><span class="p">();</span>
<span class="w">        </span><span class="n">firstUpdate</span><span class="p">.</span><span class="na">setAccountName</span><span class="p">(</span><span class="s">&quot;1回目の更新&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">firstUpdate</span><span class="p">.</span><span class="na">setBsplType</span><span class="p">(</span><span class="s">&quot;B&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">firstUpdate</span><span class="p">.</span><span class="na">setDebitCreditType</span><span class="p">(</span><span class="s">&quot;借&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">firstUpdate</span><span class="p">.</span><span class="na">setElementType</span><span class="p">(</span><span class="s">&quot;資産&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">firstUpdate</span><span class="p">.</span><span class="na">setVersion</span><span class="p">(</span><span class="mi">1L</span><span class="p">);</span>

<span class="w">        </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">exchange</span><span class="p">(</span>
<span class="w">                </span><span class="s">&quot;/api/accounts/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">createdAccount</span><span class="p">.</span><span class="na">getAccountCode</span><span class="p">(),</span>
<span class="w">                </span><span class="n">HttpMethod</span><span class="p">.</span><span class="na">PUT</span><span class="p">,</span>
<span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">HttpEntity</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">firstUpdate</span><span class="p">),</span>
<span class="w">                </span><span class="n">AccountResponse</span><span class="p">.</span><span class="na">class</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="c1">// When: 古いバージョン（1）で更新</span>
<span class="w">        </span><span class="n">AccountRequest</span><span class="w"> </span><span class="n">secondUpdate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AccountRequest</span><span class="p">();</span>
<span class="w">        </span><span class="n">secondUpdate</span><span class="p">.</span><span class="na">setAccountName</span><span class="p">(</span><span class="s">&quot;2回目の更新（競合）&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">secondUpdate</span><span class="p">.</span><span class="na">setBsplType</span><span class="p">(</span><span class="s">&quot;B&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">secondUpdate</span><span class="p">.</span><span class="na">setDebitCreditType</span><span class="p">(</span><span class="s">&quot;借&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">secondUpdate</span><span class="p">.</span><span class="na">setElementType</span><span class="p">(</span><span class="s">&quot;資産&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">secondUpdate</span><span class="p">.</span><span class="na">setVersion</span><span class="p">(</span><span class="mi">1L</span><span class="p">);</span><span class="w">  </span><span class="c1">// 古いバージョン</span>

<span class="w">        </span><span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&gt;</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">exchange</span><span class="p">(</span>
<span class="w">                </span><span class="s">&quot;/api/accounts/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">createdAccount</span><span class="p">.</span><span class="na">getAccountCode</span><span class="p">(),</span>
<span class="w">                </span><span class="n">HttpMethod</span><span class="p">.</span><span class="na">PUT</span><span class="p">,</span>
<span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">HttpEntity</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">secondUpdate</span><span class="p">),</span>
<span class="w">                </span><span class="n">Map</span><span class="p">.</span><span class="na">class</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Then</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">getStatusCode</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">CONFLICT</span><span class="p">);</span>
<span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">getBody</span><span class="p">();</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">body</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;code&quot;</span><span class="p">)).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="s">&quot;OPTIMISTIC_LOCK_ERROR&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">body</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;expectedVersion&quot;</span><span class="p">)).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">body</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;actualVersion&quot;</span><span class="p">)).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="nd">@DisplayName</span><span class="p">(</span><span class="s">&quot;削除時にバージョンが一致しないと409が返ること&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@SuppressWarnings</span><span class="p">(</span><span class="s">&quot;unchecked&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">shouldReturn409OnDeleteWithWrongVersion</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Given: 更新してバージョンを2に</span>
<span class="w">        </span><span class="n">AccountRequest</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AccountRequest</span><span class="p">();</span>
<span class="w">        </span><span class="n">update</span><span class="p">.</span><span class="na">setAccountName</span><span class="p">(</span><span class="s">&quot;更新&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">update</span><span class="p">.</span><span class="na">setBsplType</span><span class="p">(</span><span class="s">&quot;B&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">update</span><span class="p">.</span><span class="na">setDebitCreditType</span><span class="p">(</span><span class="s">&quot;借&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">update</span><span class="p">.</span><span class="na">setElementType</span><span class="p">(</span><span class="s">&quot;資産&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">update</span><span class="p">.</span><span class="na">setVersion</span><span class="p">(</span><span class="mi">1L</span><span class="p">);</span>

<span class="w">        </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">exchange</span><span class="p">(</span>
<span class="w">                </span><span class="s">&quot;/api/accounts/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">createdAccount</span><span class="p">.</span><span class="na">getAccountCode</span><span class="p">(),</span>
<span class="w">                </span><span class="n">HttpMethod</span><span class="p">.</span><span class="na">PUT</span><span class="p">,</span>
<span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="n">HttpEntity</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">update</span><span class="p">),</span>
<span class="w">                </span><span class="n">AccountResponse</span><span class="p">.</span><span class="na">class</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="c1">// When: 古いバージョンで削除</span>
<span class="w">        </span><span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&gt;</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">exchange</span><span class="p">(</span>
<span class="w">                </span><span class="s">&quot;/api/accounts/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">createdAccount</span><span class="p">.</span><span class="na">getAccountCode</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;?version=1&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">HttpMethod</span><span class="p">.</span><span class="na">DELETE</span><span class="p">,</span>
<span class="w">                </span><span class="kc">null</span><span class="p">,</span>
<span class="w">                </span><span class="n">Map</span><span class="p">.</span><span class="na">class</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Then</span>
<span class="w">        </span><span class="n">assertThat</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">getStatusCode</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">CONFLICT</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h2 id="2811">28.11 まとめ<a class="headerlink" href="#2811" title="Permanent link">&para;</a></h2>
<p>本章では、MyBatis を使用した楽観ロックの実装について解説しました。</p>
<h3 id="_10">学んだこと<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>楽観ロックの概念</strong>: バージョン番号を使用した同時実行制御</li>
<li><strong>テーブル設計</strong>: version 列の追加とマイグレーション</li>
<li><strong>ドメインモデル</strong>: Versionable インターフェースと incrementVersion()</li>
<li><strong>MyBatis 実装</strong>: UPDATE/DELETE 文での WHERE version = ? 条件</li>
<li><strong>Repository 層</strong>: 更新件数チェックと例外スロー</li>
<li><strong>例外設計</strong>: OptimisticLockException の階層構造</li>
<li><strong>REST API</strong>: HTTP 409 Conflict レスポンスとエラーハンドリング</li>
<li><strong>TDD</strong>: 競合シナリオのテスト実装</li>
</ol>
<h3 id="_11">設計のポイント<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>観点</th>
<th>ポイント</th>
</tr>
</thead>
<tbody>
<tr>
<td>バージョン管理</td>
<td>更新時に version + 1、ドメインモデルに version フィールド</td>
</tr>
<tr>
<td>SQL 条件</td>
<td>WHERE id = ? AND version = ? で楽観ロックを実現</td>
</tr>
<tr>
<td>エラー検出</td>
<td>更新件数が 0 の場合に楽観ロックエラー</td>
</tr>
<tr>
<td>HTTP ステータス</td>
<td>競合時は 409 Conflict</td>
</tr>
<tr>
<td>クライアント対応</td>
<td>version をレスポンスに含め、更新時に送信させる</td>
</tr>
</tbody>
</table>
<h3 id="_12">実装チェックリスト<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> 各テーブルに version 列を追加</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> ドメインモデルに version フィールドを追加</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> Versionable インターフェースを実装</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> MyBatis Mapper に楽観ロック付き UPDATE/DELETE を追加</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> Repository で更新件数をチェック</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> OptimisticLockException を定義</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> GlobalExceptionHandler で 409 を返す</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> DTO に version を追加</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> フロントエンドで version を保持・送信</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> 競合時のユーザーフレンドリーなエラーメッセージ</li>
</ul>
<p>次章では、リリース管理とバージョニングについて解説します。</p>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/k2works/case-study-accounting" target="_blank" rel="noopener" title="財務会計システム ケーススタディ" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../../assets/js/extra.js"></script>
      
    
  </body>
</html>