<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.accounting.infrastructure.persistence.mapper.TrialBalanceMapper">

    <resultMap id="trialBalanceResultMap"
               type="com.example.accounting.infrastructure.persistence.entity.TrialBalanceEntity">
        <result property="accountCode" column="account_code"/>
        <result property="accountName" column="account_name"/>
        <result property="bsplCategory" column="bspl_category"/>
        <result property="accountType" column="account_type"/>
        <result property="totalDebit" column="total_debit"/>
        <result property="totalCredit" column="total_credit"/>
        <result property="balance" column="balance"/>
    </resultMap>

    <select id="findTrialBalance" resultMap="trialBalanceResultMap">
        SELECT
            a.code AS account_code,
            a.name AS account_name,
            a.bspl_category,
            a.account_type,
            COALESCE(SUM(d.debit_amount), 0) AS total_debit,
            COALESCE(SUM(d.credit_amount), 0) AS total_credit,
            COALESCE(SUM(d.debit_amount), 0) - COALESCE(SUM(d.credit_amount), 0) AS balance
        FROM accounts a
        LEFT JOIN daily_account_balances d
            ON a.code = d.account_code
            AND d.is_closing_entry = 0
            <if test="date != null">
                AND d.posting_date &lt;= #{date}
            </if>
        GROUP BY a.code, a.name, a.bspl_category, a.account_type
        ORDER BY a.code
    </select>

</mapper>
